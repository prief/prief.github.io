<!DOCTYPE html>
<html lang="en">
  <head><meta name="generator" content="Hexo 3.9.0">
    
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,minimum-scale=1,maximum-scale=1">


<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">



  <meta name="description" content="webpack">




  <meta name="keywords" content="webpack,">





  <link rel="alternate" href="/atom.xml" title="prief">




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=1.1">



<link rel="canonical" href="https://prief.github.io/2019/08/17/webpack/">


<meta name="description" content="基础篇webpack及发展历史 目的 css的预处理 ES6等的支持 图片压缩 发布产物的压缩混淆   同类 rollup parcel   安装准备 brew install nvm , windows可以安装nvm-windows nvm install v10.16.3 node -v npm -v mkdir webpack-demo &amp;amp;&amp;amp; cd webpack-demo">
<meta name="keywords" content="webpack">
<meta property="og:type" content="article">
<meta property="og:title" content="webpack">
<meta property="og:url" content="https://prief.github.io/2019/08/17/webpack/index.html">
<meta property="og:site_name" content="prief">
<meta property="og:description" content="基础篇webpack及发展历史 目的 css的预处理 ES6等的支持 图片压缩 发布产物的压缩混淆   同类 rollup parcel   安装准备 brew install nvm , windows可以安装nvm-windows nvm install v10.16.3 node -v npm -v mkdir webpack-demo &amp;amp;&amp;amp; cd webpack-demo">
<meta property="og:locale" content="en">
<meta property="og:updated_time" content="2020-04-01T06:40:05.303Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="webpack">
<meta name="twitter:description" content="基础篇webpack及发展历史 目的 css的预处理 ES6等的支持 图片压缩 发布产物的压缩混淆   同类 rollup parcel   安装准备 brew install nvm , windows可以安装nvm-windows nvm install v10.16.3 node -v npm -v mkdir webpack-demo &amp;amp;&amp;amp; cd webpack-demo">


<link rel="stylesheet" type="text/css" href="/css/style.css?v=1.1">
<link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">





<script type="text/javascript">
  var themeConfig = {
    fancybox: {
      enable: false
    },
  };
</script>




  



    <title> webpack - prief </title>
  </head>

  <body>
    <div id="page">
      <header id="masthead"><div class="site-header-inner">
    <h1 class="site-title">
        <a href="/." class="logo">prief</a>
    </h1>

    <nav id="nav-top">
        
            <ul id="menu-top" class="nav-top-items">
                
                    <li class="menu-item">
                        <a href="/archives">
                            
                            
                                Archives
                            
                        </a>
                    </li>
                
                    <li class="menu-item">
                        <a href="/about">
                            
                            
                                About
                            
                        </a>
                    </li>
                
            </ul>
        
  </nav>
</div>

      </header>
      <div id="content">
        
    <div id="primary">
        
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          webpack
        
      </h1>

      <time class="post-time">
          Aug 17 2019
      </time>
    </header>



    
            <div class="post-content">
            <h1 id="基础篇"><a href="#基础篇" class="headerlink" title="基础篇"></a>基础篇</h1><h2 id="webpack及发展历史"><a href="#webpack及发展历史" class="headerlink" title="webpack及发展历史"></a>webpack及发展历史</h2><ul>
<li>目的<ul>
<li>css的预处理</li>
<li>ES6等的支持</li>
<li>图片压缩</li>
<li>发布产物的压缩混淆</li>
</ul>
</li>
<li>同类<ul>
<li>rollup</li>
<li>parcel</li>
</ul>
</li>
<li>安装准备<ul>
<li>brew install nvm , windows可以安装nvm-windows</li>
<li>nvm install v10.16.3</li>
<li>node -v</li>
<li>npm -v</li>
<li>mkdir webpack-demo &amp;&amp; cd webpack-demo</li>
<li>npm init -y</li>
<li>npm i -D webpack webpack-cli</li>
<li>./node_modules/.bin/webpack -v</li>
</ul>
</li>
<li>模块路径解析<ul>
<li>绝对路径（不推荐）</li>
<li>相对路径<ul>
<li>查找相对路径下的同名的文件或目录</li>
<li>是文件则直接加载</li>
<li>是目录则查找目录下的package.json中的main字段</li>
<li>有则按其加载</li>
<li>没有main字段或没有package.json则加载index.js</li>
</ul>
</li>
<li>模块名<ul>
<li>查找当前目录/上级目录中node_modules中的同名目录</li>
<li>查找全局node_modules中的模块</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="基础配置"><a href="#基础配置" class="headerlink" title="基础配置"></a>基础配置</h2><ul>
<li>基础<ul>
<li>mode</li>
<li>entry</li>
<li>output</li>
<li>module</li>
<li>plugins</li>
</ul>
</li>
<li>mode<ul>
<li>production 默认</li>
<li>development</li>
<li>none</li>
</ul>
</li>
<li>entry<ul>
<li>单入口 “path”</li>
<li>多入口 {name:path}</li>
</ul>
</li>
<li>output<ul>
<li>path 输出路径</li>
<li>filename 构建文件名称<ul>
<li>‘[name]’ 对应入口中的name</li>
<li>‘[hash]’ 对应文件的hash</li>
</ul>
</li>
</ul>
</li>
<li>loaders<ul>
<li>本质是一个函数，接收源文件作为参数输出转换后的结果</li>
<li>执行顺序<ul>
<li>同一个rule中多个loader从后到前执行</li>
<li>多个loader匹配时用enforce:pre|post约定顺序</li>
<li>行内loader，在require(‘loader1!./file.json’)</li>
<li>所有的loader按照前置loader/行内loader/普通loader/后置loader顺序执行</li>
</ul>
</li>
<li>babel-loader<ul>
<li>解析ES6/7</li>
<li>需要安装@babel/core @babel/preset-env @babel/proposal-class-properties等</li>
<li>配置文件.babelrc中增加presets和plugins</li>
</ul>
</li>
<li>style-loader<ul>
<li>将css插入head的style标签</li>
</ul>
</li>
<li>css-loader<ul>
<li>解析.css文件转换成commonjs对象</li>
</ul>
</li>
<li>less-loader<ul>
<li>解析less代码成css，依赖less</li>
</ul>
</li>
<li>file-loader<ul>
<li>解析各种文件资源（图片/字体等）</li>
<li>如果希望能把小资源转成base64可以使用url-loader的limit</li>
<li>把二进制文件转成base64后文件大小会增加二进制文件的1/3左右</li>
</ul>
</li>
<li>raw-loader 将文件以字符串内容形式导入</li>
<li>thread-loader</li>
</ul>
</li>
<li>plugins<ul>
<li>本质是一个类，实现了apply方法</li>
<li>CommonsChunkPlugin chunk相同代码抽取成公共js</li>
<li>CleanWebpackPlugin 清理构建目录</li>
<li>CopyWebpackPlugin</li>
<li>ZipWebpackPlugin 将打包出的资源生成一个zip包</li>
<li>HtmlWebpackPlugin </li>
<li>ExtractTextWebpackPlugin</li>
<li>MiniCssExtractPlugin 需要配合.loader替换style-loader进行css文件提取</li>
<li>OptimizeCssAssetsWebpackPlugin</li>
<li>UglifyjsWebpackPlugin</li>
</ul>
</li>
</ul>
<h2 id="高级配置"><a href="#高级配置" class="headerlink" title="高级配置"></a>高级配置</h2><ul>
<li><p>环境差异</p>
<ul>
<li>module.exports=(env,argv)=&gt;{console.log(argv.mode)}</li>
<li>生产环境<ul>
<li>压缩资源</li>
<li>分离资源</li>
</ul>
</li>
<li>开发环境<ul>
<li>debug</li>
<li>hotReload</li>
</ul>
</li>
<li>配置拆分<ul>
<li>base.js</li>
<li>dev.js</li>
<li>prod.js</li>
</ul>
</li>
</ul>
</li>
<li><p>构建监听</p>
<ul>
<li>webpack 命令行传 –watch</li>
<li>webpack.config.js中 watch:true</li>
<li>是通过轮询文件最后修改时间进行的，同时也有aggregateTimeout防止短时间多次修改，有poll指定每秒轮询多少次，ignore指定忽略，这些属性在watchOptions中</li>
</ul>
</li>
<li><p>WDS</p>
<ul>
<li>webpack-dev-server</li>
<li>WDS不输出文件都是存在内存中，所以不用手动刷新浏览器可实现HMR</li>
<li>dev: “webpack-dev-server –open”</li>
<li>webpack.config.js<ul>
<li>mode: ‘development’</li>
<li>plugins: [new webpack.HotModuleReplacementPlugin()]</li>
<li>devServer:{hot:true,contentBase:’./dist’,before(app){app.get(“path”,(req,res)=&gt;{res.json({})})},proxy:{“/api”:{target:’’,pathRewrite:{}}}}</li>
</ul>
</li>
<li>WDS灵活定制版WDM webapck-dev-middleware</li>
<li>HMR <ul>
<li>由compiler把源码编译成bundle和HMR的patch</li>
<li>bundle由本地的bundleServer返回给浏览器</li>
<li>HMR的patch由本地的HMRServer(WebSockt)返回浏览器的HMRRuntime</li>
<li>浏览器执行bundle和patch执行代码</li>
<li>核心api<ul>
<li>module.hot</li>
<li>module.hot.accept(“指定模块”,()=&gt;{})</li>
<li>module.hot.dispose((data)=&gt;{}) #当前模块</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p>文件指纹</p>
<ul>
<li>hash 和整个项目有关，只要项目内有变化hash就变，文件处理也可以用[hash:8]</li>
<li>chunkhash 不同的entry会生成不同的chunkhash，常用于js，常设置在output.filename中[chunkhash:8]</li>
<li>contenthash 文件内容不变contenthash不变，常用于css，常设置在MiniCssExtractPlugin的filename中[contenthash:8]</li>
</ul>
</li>
<li><p>代码压缩</p>
<ul>
<li>html 使用html-webpack-plugin的minify对象属性</li>
<li>css 使用optimize-css-assets-webpack-plugin和cssnano</li>
<li>js 内置了uglifyjs-webpack-plugin</li>
</ul>
</li>
<li><p>按需加载</p>
<ul>
<li>import(/* webpackChunkName: “lodash” */ ‘lodash’).then((_) =&gt; {})</li>
<li>webpackChunkName作为注释会告知webpack动态加载模块的名称，配合output.chunkFilename指定chunk输出的文件名，否则会以简单的数字标示</li>
<li>需要syntax-dynamic-import这个babel插件处理import()</li>
<li>按需动态加载的import()语法依赖promise，对于低版本的要promise的polyfill</li>
</ul>
</li>
<li><p>postcss</p>
<ul>
<li>autoprefixer<ul>
<li>o presto</li>
<li>ms trident</li>
<li>moz gecko</li>
<li>webkit webkit</li>
</ul>
</li>
<li>npm i -D postcss-loader autoprefixer</li>
</ul>
</li>
<li><p>屏幕分辨率</p>
<ul>
<li>rem: font-size of the root element，是相对单位</li>
<li>npm i -D px2rem-loader</li>
<li>options:{remUnit:75,remPrecision:8}</li>
<li>npm i lib-flexible lib-flexible在页面渲染时计算rem的值</li>
</ul>
</li>
<li><p>内联资源到html</p>
<ul>
<li>内联html/js<ul>
<li>raw-loader </li>
<li>html模版里写${ require(‘raw-loader!./meta.html’)} 直接内联html</li>
<li>script里写${ require(‘raw-loader!babel-loader!../node_modules/lib-flexible/flexible.js’) }内联js</li>
</ul>
</li>
<li>内联css<ul>
<li>style-loader options:{insertAt:’top’,singleton:true //所有style合并成1个 }</li>
<li>html-inline-css-webpack-plugin 将打包好的css内联</li>
</ul>
</li>
</ul>
</li>
<li><p>MPA</p>
<ul>
<li>手动的可增加1个entry，然后增加1个对应的htmlWP，不方便维护</li>
<li>通用的动态设置entry:glob.sync(path.join(__dirname,’./src/*/index.js’))和对应的htmlWP<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">const setMPA = () =&gt; &#123;</span><br><span class="line">    const entry = &#123;&#125;;</span><br><span class="line">    const htmlWebpackPlugins = [];</span><br><span class="line">    const entryFiles = glob.sync(path.join(__dirname, &apos;./src/*/index.js&apos;));</span><br><span class="line">    Object.keys(entryFiles)</span><br><span class="line">        .map((index) =&gt; &#123;</span><br><span class="line">            const entryFile = entryFiles[index];</span><br><span class="line">            const match = entryFile.match(/src\/(.*)\/index\.js/);</span><br><span class="line">            const pageName = match &amp;&amp; match[1];</span><br><span class="line"></span><br><span class="line">            entry[pageName] = entryFile;</span><br><span class="line">            htmlWebpackPlugins.push(</span><br><span class="line">                new HtmlWP(&#123;</span><br><span class="line">                    inlineSource: &apos;.css$&apos;,</span><br><span class="line">                    template: path.join(__dirname, `src/$&#123;pageName&#125;/index.html`),</span><br><span class="line">                    filename: `$&#123;pageName&#125;.html`,</span><br><span class="line">                    chunks: [&apos;vendors&apos;, pageName],</span><br><span class="line">                    inject: true,</span><br><span class="line">                    minify: &#123;</span><br><span class="line">                        html5: true,</span><br><span class="line">                        collapseWhitespace: true,</span><br><span class="line">                        preserveLineBreaks: false,</span><br><span class="line">                        minifyCSS: true,</span><br><span class="line">                        minifyJS: true,</span><br><span class="line">                        removeComments: false</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;)</span><br><span class="line">            );</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">    return &#123;</span><br><span class="line">        entry,</span><br><span class="line">        htmlWebpackPlugins</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">const &#123;entry,htmlWebpackPlugins&#125; = setMPA()</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>sourceMap</p>
<ul>
<li>开发环境使用，生产环境只需要传到监控平台</li>
<li>关键字<ul>
<li>eval 使用eval包裹模块代码，最后面制定对应的源文件，不生成单独的map文件</li>
<li>cheap 不包含列信息</li>
<li>source-map 生成.map文件</li>
<li>inline 将.map作为DataURI嵌入，不单独生成.map</li>
<li>module 包含loader的source-map,可对依赖分析</li>
</ul>
</li>
<li>类型<ul>
<li>生产环境使用source-map，map文件上传到监控平台</li>
<li>开发环境使用eval-source-map，加速打包</li>
</ul>
</li>
</ul>
</li>
<li><p>提取公共资源</p>
<ul>
<li>基础库(vue/react/react-dom)分离到cdn，可使用html-webpack-externals-plugin</li>
<li>也可以用webpack4内置的splitChunksPlugin代替CommonsChunkPlugin</li>
<li>chunks说明<ul>
<li>async 默认选项，表示异步引入的库进行分离</li>
<li>initial 同步引入的库进行分离</li>
<li>all 推荐使用，所有引入的库都进行分离</li>
</ul>
</li>
<li>chunks分离后需要把分离出的name添加到htmlWP中的chunks<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">optimization:&#123;</span><br><span class="line">       splitChunks:&#123;</span><br><span class="line">           minSize: 0,</span><br><span class="line">           maxSize:1000,</span><br><span class="line">           minChunks: 2,</span><br><span class="line">           cacheGroups:&#123;</span><br><span class="line">               vendors:&#123;</span><br><span class="line">                   test:/(react|react-dom)/,</span><br><span class="line">                   name:&quot;vendors&quot;,</span><br><span class="line">                   chunks:&quot;all&quot;</span><br><span class="line">               &#125;,</span><br><span class="line">               commons:&#123;</span><br><span class="line">                 name:&quot;commons&quot;,</span><br><span class="line">                 chunks:&quot;all&quot;,</span><br><span class="line">                 minChunks:2</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>treeShaking</p>
<ul>
<li>把模块中没被引用的方法在uglify阶段去除掉</li>
<li>使用<ul>
<li>必须是ES6的语法，不能用在CommonJS，ES6可以静态分析</li>
<li>在.babelrc里设置module:false把模块的静态分析交给webpack处理</li>
<li>对class类的treeShaking需要在.babelrc里配置loose:true</li>
<li>mode为production情况下默认开启了此功能</li>
<li>要求导出的函数不能有副作用，否则也会失效,即包的package.json.sideEffects:false声明</li>
</ul>
</li>
<li>原理<ul>
<li>DCE dead code elimination 无用代码擦除<ul>
<li>代码不可到达</li>
<li>代码执行的结果不会被用到</li>
<li>只写不读的代码</li>
</ul>
</li>
<li>ES6模块特点<ul>
<li>import只能出现在代码顶层</li>
<li>import的模块名只能是字符串常量</li>
<li>import的binding是immutable的</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p>ScopeHoisting</p>
<ul>
<li>问题<ul>
<li>构建后的模块代码都是通过闭包实现IIFE</li>
<li>大量的闭包导致代码体积增大，运行时内存开销增大</li>
</ul>
</li>
<li>分析<ul>
<li>把所有的模块都包裹一层函数形成IIFE</li>
<li>把import转换成_webpack_require,export转换成_webpack_exports</li>
<li>把所有模块都缓存到modules数组</li>
<li>通过WEBPACK_REQUIRE_METHOD(0) 启动程序</li>
</ul>
</li>
<li>scopeHoisting将模块代码按照引用顺序放在一个函数作用域，适当的做重命名防止变量冲突，达到减少函数声明和内存开销</li>
<li>使用时mode设置为production默认开启</li>
<li>手动开启使用 new webpack.optimize.ModuleConcatenationPlugin()</li>
</ul>
</li>
<li><p>动态import</p>
<ul>
<li>把相同的代码抽离到一个共享模块，在通过懒加载动态import使初始下载的代码更小</li>
<li>懒加载<ul>
<li>CommonJS使用方式require.ensure()</li>
<li>ES6使用方式 动态import目前还没有原生支持，需要babel插件<ul>
<li>npm i @babel/plugin-syntax-dynamic-import</li>
<li>.babelrc中plugins:[‘@babel/plugin-syntax-dynamic-import’]</li>
<li>代码中需要的地方用import(‘./dynamic.js’).then()</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p>ESLint</p>
<ul>
<li>制定规范<ul>
<li>基于eslint:recommmend配置进行改进，不重复造轮子</li>
<li>能够帮助发现错误的规则全部开启</li>
<li>保持风格统一，不要限制开发体验</li>
</ul>
</li>
<li>落地<ul>
<li>和CICD集成 如gitlab的pipline</li>
<li>和webpack集成</li>
</ul>
</li>
<li>本地开发增加precommit钩子(本地可以–no-verify绕过，所以CICD必须要有)<ul>
<li>npm i -D husky</li>
<li>“precommit”: “lint-staged”</li>
<li>“lint-staged”: {“linters”:”*.{js,scss}”:[“eslint –fix”, “git add”]}</li>
</ul>
</li>
<li>webpack集成ESLint<ul>
<li>.js文件先用eslint-loader再使用babel-loader</li>
<li>npm i -D eslint eslint-loader babel-eslint eslint-plugin-import …</li>
<li>.eslintrc.js<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">module.exports = &#123;</span><br><span class="line">    parser:&quot;babel-eslint&quot;,</span><br><span class="line">    extends:[&apos;&apos;],</span><br><span class="line">    env:&#123;</span><br><span class="line">        browser:true,</span><br><span class="line">        node:true</span><br><span class="line">    &#125;,</span><br><span class="line">    rules:&#123;</span><br><span class="line">        indent:[2,2]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
</li>
<li><p>打包库和组件</p>
<ul>
<li>需求<ul>
<li>打包压缩版和非压缩版</li>
<li>支持AMD/CJS/ESM模块引入和script直接引入，统称UMD</li>
</ul>
</li>
<li>实现<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">const TerserPlugin = require(&apos;terser-webpack-plugin&apos;)</span><br><span class="line">module.exports = &#123;</span><br><span class="line">  mode:&apos;none&apos;,</span><br><span class="line">  entry:&#123;</span><br><span class="line">    &apos;name&apos;:&apos;./src/index.js&apos;,</span><br><span class="line">    &apos;name.min&apos;:&apos;./src/index.js&apos;</span><br><span class="line">  &#125;,</span><br><span class="line">  output:&#123;</span><br><span class="line">    filename:&apos;[name].js&apos;,</span><br><span class="line">    library:&apos;libName&apos;, // 库的全局变量</span><br><span class="line">    libraryExport:&apos;default&apos;,</span><br><span class="line">    libraryTarget:&apos;umd&apos; // 库的引入方式</span><br><span class="line">  &#125;,</span><br><span class="line">  optimization:&#123;</span><br><span class="line">    minimize:true,</span><br><span class="line">    minimizer:[</span><br><span class="line">      new TerserPlugin(&#123;</span><br><span class="line">        include:/\.min\.js$/, //只对.min压缩</span><br><span class="line">      &#125;)</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// package.json</span><br><span class="line">&quot;main&quot;: &quot;index.js&quot;,</span><br><span class="line">&quot;scripts&quot;: &#123;</span><br><span class="line">  &quot;build&quot;: &quot;webpack&quot;,</span><br><span class="line">  &quot;prepublish&quot;: &quot;webpack&quot;</span><br><span class="line">&#125;,</span><br><span class="line"></span><br><span class="line">// index.js</span><br><span class="line">if(process.env.NODE_ENV === &apos;production&apos;)&#123;</span><br><span class="line">  module.exports = require(&apos;./dist/name.min.js&apos;)</span><br><span class="line">&#125;else&#123;</span><br><span class="line">  module.exports = require(&apos;./dist/name.js&apos;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>SSR</p>
<ul>
<li>server side render</li>
<li>优势<ul>
<li>减少网络请求</li>
<li>减少白屏时间</li>
<li>对SEO友好</li>
</ul>
</li>
<li>实现思路<ul>
<li>服务端使用server的renderToString将组件渲染成字符串，路由返回对应的字符串模板</li>
<li>客户端进行环境判断请求对应的文件</li>
</ul>
</li>
<li>问题<ul>
<li>nodejs中没有浏览器的window需要hack：if(typeof window === ‘undefined’){ global.window = {} }</li>
<li>不兼容的组件需要根据打包环境进行适配</li>
<li>http请求需要改写成axios</li>
<li>css样式不显示可以采用浏览器端模板占位符替换的方式’<!--HTML_PLACEHOLDER-->‘</li>
<li>首屏业务数据也可用模板占位符替换的方式<!--INITIAL_DATA_PLACEHOLDER--></li>
</ul>
</li>
</ul>
</li>
<li><p>优化构建日志</p>
<ul>
<li>webpack.config.js中stats字段控制统计信息<ul>
<li>errors-only</li>
<li>minimal</li>
<li>none | false</li>
<li>normal | true</li>
<li>verbose </li>
</ul>
</li>
<li>friendly-errors-webpack-plugin<ul>
<li>stats: ‘errors-only’</li>
<li>new FriendlyErrorsWebpackPlugin()</li>
<li>日志提示<ul>
<li>success</li>
<li>warning</li>
<li>error</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p>构建异常和中断</p>
<ul>
<li>如果没有错误则process.exit(0)</li>
<li>如果有错误则process.exit(非0)，回调函数err.code则为非0数值</li>
<li>compiler每次构建结束后都会触发done这个hook</li>
<li>hook回调stats.compilation.errors错误对象</li>
</ul>
</li>
</ul>
<h1 id="进阶篇"><a href="#进阶篇" class="headerlink" title="进阶篇"></a>进阶篇</h1><h2 id="可维护的配置"><a href="#可维护的配置" class="headerlink" title="可维护的配置"></a>可维护的配置</h2><ul>
<li><p>抽离成npm包的意义</p>
<ul>
<li>通用性<ul>
<li>开发者无需关注构建配置</li>
<li>统一团队构建脚本</li>
</ul>
</li>
<li>可维护性<ul>
<li>构建配置合理拆分</li>
<li>README/CHANGELOG</li>
</ul>
</li>
<li>质量<ul>
<li>冒烟测试/单元测试/测试覆盖率</li>
<li>CI</li>
</ul>
</li>
</ul>
</li>
<li><p>构建配置管理的可选方案</p>
<ul>
<li>通过多个配置文件管理对应环境 webpack –config参数控制</li>
<li>构建配置设计成一个库 如neutrino webpack-blocks</li>
<li>设计成一个工具 如create-react-app nwb</li>
<li>配置放在一个文件，通过–env控制</li>
</ul>
</li>
<li><p>构建配置包设计</p>
<ul>
<li>通过多个配置文件管理对应环境<ul>
<li>webpack.base.js<ul>
<li>资源解析(es6/react/css/less/图片/字体)</li>
<li>样式增强(css前缀自动补齐/px2rem)</li>
<li>目录清理</li>
<li>多页面打包</li>
<li>构建过程日志优化</li>
<li>构建错误捕获和处理</li>
<li>css提取成一个单独的文件</li>
</ul>
</li>
<li>webpack.dev.js<ul>
<li>hmr</li>
<li>sourcemap</li>
</ul>
</li>
<li>webpack.prod.js<ul>
<li>代码压缩</li>
<li>文件指纹</li>
<li>treeShaking</li>
<li>scopeHoisting</li>
<li>速度优化 基础包放cdn</li>
<li>体积优化 代码分割动态import</li>
</ul>
</li>
<li>webpack.ssr.js<ul>
<li>output.libraryTarget</li>
<li>css解析</li>
</ul>
</li>
</ul>
</li>
<li>npm包<ul>
<li>规范(git commit/READMEESLINT/SemVer)</li>
<li>质量(冒烟测试/单元测试/测试覆盖率/CI)</li>
</ul>
</li>
<li>配置组合<ul>
<li>webpack-merge</li>
<li>module.exports=merge(baseConf,devConf)</li>
</ul>
</li>
<li>目录结构<ul>
<li>test/</li>
<li>lib/</li>
<li>README.md</li>
<li>CHANGELOG.md</li>
<li>.eslintrc.js</li>
<li>.gitignore</li>
<li>package.json</li>
<li>index.js</li>
</ul>
</li>
</ul>
</li>
<li><p>构建包使用ESLINT</p>
<ul>
<li>使用eslint-config-airbnb-base规则集</li>
<li>使用eslint –fix做自动修复</li>
<li>package.json “lint”:”eslint ./lib –fix”</li>
<li>.eslintrc.js<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">module.exports = &#123;</span><br><span class="line">  extends:[&apos;airbnb-base&apos;],</span><br><span class="line">  parser:&apos;babel-eslint&apos;,</span><br><span class="line">  env:&#123;</span><br><span class="line">    browser:true,</span><br><span class="line">    node:true</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>冒烟测试smoke testing</p>
<ul>
<li>指对提交测试的软件在进行详细测试前的预测试</li>
<li>主要目的是暴露基本功能失效的严重问题</li>
<li>执行<ul>
<li>构建是否成功 webpack(conf,(err,stats)=&gt;{})</li>
<li>是否生成对应文件 glob.sync([‘*.js’]).length</li>
</ul>
</li>
</ul>
</li>
<li><p>单元测试和测试覆盖率</p>
<ul>
<li>框架<ul>
<li>mocha(单纯的测试框架)+chai(断言库)</li>
<li>jasmine/jest 集成框架，开箱即用</li>
</ul>
</li>
<li>mocha接入<ul>
<li>npm i -D mocha chai</li>
<li>test.js中编写describe/it/expect</li>
<li>package.json中”test”:”mocha “</li>
<li>npm run test</li>
</ul>
</li>
<li>测试覆盖率<ul>
<li>npm i -D istanbul</li>
<li>package.json中”test”:”istanbul cover mocha”</li>
</ul>
</li>
</ul>
</li>
<li><p>CI</p>
<ul>
<li>作用<ul>
<li>快速发现错误</li>
<li>防止分支大幅偏离主干</li>
</ul>
</li>
<li>措施<ul>
<li>集成前必须跑通测试，否则不予集成</li>
</ul>
</li>
<li>排名<ul>
<li>travis-ci</li>
<li>circle-ci</li>
<li>jenkins-ci</li>
</ul>
</li>
</ul>
</li>
<li><p>发布npm包</p>
<ul>
<li>npm login</li>
<li>npm version patch|minor|major(自动git提交和tag)</li>
<li>npm publish</li>
</ul>
</li>
<li><p>git提交规范和changeLog生成</p>
<ul>
<li>提交规范优势<ul>
<li>加快review流程</li>
<li>根据提交生成changeLog</li>
<li>可追溯可回顾</li>
</ul>
</li>
<li>技术方案<ul>
<li>目地统一提交日志标准</li>
<li>使用angular的git commit规范<ul>
<li>信息分3部分，空行分割<ul>
<li>标题(首字母不大写，末尾不要标点)<ul>
<li>type(scope): subject</li>
</ul>
</li>
<li>主题内容</li>
<li>尾注</li>
</ul>
</li>
<li>提交类型type限制<ul>
<li>feat：新增feature</li>
<li>fix：修复bug</li>
<li>docs：仅仅修改了文档</li>
<li>style：仅仅修改文件样式，不改变逻辑</li>
<li>perf：优化相关，提升体验性能等</li>
<li>refactor：代码重构无新功能或bug修复</li>
<li>test：测试用例</li>
<li>chore：改变构建流程或增加依赖库工具</li>
<li>revert：回滚到上一版本</li>
</ul>
</li>
<li>scope(可根项目分成大类如docs/components)</li>
<li>主题内容可以详细列明每个修改点影响点</li>
<li>尾注可以增加链接或关闭issue等</li>
</ul>
</li>
<li>日志提交时友好的提示工具:commitize</li>
<li>不符合要求的拒绝提交:validate-commit-msg</li>
<li>统一changeLog文档信息生成:conventional-changelog-cli</li>
</ul>
</li>
<li>本地增加precommit钩子<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">npm i -D husky validate-commit-msg conventional-changelog-cli</span><br><span class="line"></span><br><span class="line">&quot;scripts&quot;:&#123;</span><br><span class="line">  &quot;commitmsg&quot;:&quot;validate-commit-msg&quot;,</span><br><span class="line">  &quot;changelog&quot;:&quot;conventional-changelog -p angular -i CHANGELOG.md -s -r 0&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>语义化版本号</p>
<ul>
<li>semantic versioning<ul>
<li>major 做了不兼容api的修改</li>
<li>minor 做了向下兼容的功能新增</li>
<li>patch 做了向下兼容的问题修正</li>
<li>major.minor.patch版本号严格递增</li>
</ul>
</li>
<li>优势<ul>
<li>避免出现循环依赖</li>
<li>减少依赖冲突</li>
</ul>
</li>
<li>发布重要版本时可以发先行版本<ul>
<li>alpha 内测版</li>
<li>beta 外部小范围测试版，可以加新功能</li>
<li>rc 公测版release candidate不会加新功能，主要用排错</li>
<li>major.minor.patch-alpha.2</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="构建速度和体积优化"><a href="#构建速度和体积优化" class="headerlink" title="构建速度和体积优化"></a>构建速度和体积优化</h2><ul>
<li><p>初级分析</p>
<ul>
<li>使用webpack内置的stats<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&quot;scripts&quot;:&#123;</span><br><span class="line">  &quot;build:stats&quot;:&quot;webpack --env production --json &gt; stats.json&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>速度分析</p>
<ul>
<li>使用speed-measure-webpack-plugin插件</li>
<li>可以看到每个loader和插件执行耗时和总耗时<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">npm i -D speed-measure-webpack-plugin</span><br><span class="line"></span><br><span class="line">const SMWP = require(&apos;speed-measure-webpack-plugin&apos;)</span><br><span class="line"></span><br><span class="line">const smp = new SMWP();</span><br><span class="line"></span><br><span class="line">module.exports = smp.wrap(WEBPACK_CONFIG)</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>体积分析</p>
<ul>
<li>使用webpack-bundle-analyzer插件</li>
<li>构建完毕自动在8888端口展示结果<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">npm i -D webpack-bundle-analyzer</span><br><span class="line"></span><br><span class="line">const &#123; BundleAnalyzerPlugin&#125; = require(&apos;webpack-bundle-analyzer&apos;);</span><br><span class="line"></span><br><span class="line">plugins:[</span><br><span class="line">  new webpack-bundle-analyzer()</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>速度提升</p>
<ul>
<li>使用高版本nodejs和webpack，从底层做了优化</li>
<li>多进程多实例构建 thread-loader </li>
<li>多进程多实例并行压缩terser-webpack-plugin<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">npm i -D thread-loader terser-webpack-plugin</span><br><span class="line"></span><br><span class="line">use:[</span><br><span class="line">  &#123;</span><br><span class="line">    loader:&quot;thread-loader&quot;,</span><br><span class="line">    options:&#123;</span><br><span class="line">      workers:3</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;babel-loader&quot;</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">optimization:&#123;</span><br><span class="line">  minimizer:[</span><br><span class="line">    new TerserWebpackPlugin(&#123;</span><br><span class="line">      parallel:true // 默认cpu核心2倍-1</span><br><span class="line">    &#125;)</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>进一步分包</p>
<ul>
<li>htmlWebpackExternalsPlugin将基础包分离到cdn引入的缺点是可能有很多基础包很多script请求</li>
<li>splitChunks缺点是每次都要分析依赖的基础包</li>
<li>DLLPlugin分包可以把框架基础包和业务基础包进行预编译，打包成一个文件，然后通过DLLReferencePlugin对manifest.json引用<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">// webpack.dll.js</span><br><span class="line">const path = require(&apos;path&apos;)</span><br><span class="line">const webpack = require(&apos;webpack&apos;)</span><br><span class="line">module.exports = &#123;</span><br><span class="line">  entry:&#123;</span><br><span class="line">    library:[</span><br><span class="line">      &apos;react&apos;,</span><br><span class="line">      &apos;react-dom&apos;</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  output:&#123;</span><br><span class="line">    filename:&quot;[name]_[chunkhash]_dll.js&quot;,</span><br><span class="line">    path:path.join(__dirname,&apos;dll&apos;),</span><br><span class="line">    library:&quot;[name]&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  plugins:[</span><br><span class="line">    new webpack.DllPlugin(&#123;</span><br><span class="line">      name:&quot;[name]_[hash]&quot;,</span><br><span class="line">      path:path.join(__dirname,&apos;dll/[name].json&apos;)</span><br><span class="line">    &#125;)</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// package.json</span><br><span class="line">&quot;scripts&quot;:&#123;</span><br><span class="line">  &quot;dll&quot;:&quot;webpack --config webpack.dll.js&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// webpack.prod.js</span><br><span class="line"></span><br><span class="line">new webpack.DllReferencePlugin(&#123;</span><br><span class="line">  manifest: require(&apos;./dll/library.json&apos;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>缓存</p>
<ul>
<li>提升二次构建速度</li>
<li>思路<ul>
<li>babel-loader开启缓存</li>
<li>terser-webpack-plugin开启缓存</li>
<li>hard-source-webpack-plugin开启缓存<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">// babel-loader</span><br><span class="line">&apos;babel-loader?cacheDirectory=true&apos;</span><br><span class="line"></span><br><span class="line">// terser-webpack-plugin</span><br><span class="line">optimization:&#123;</span><br><span class="line">  minimizer:[</span><br><span class="line">    new TerserWebpackPlugin(&#123;</span><br><span class="line">      parallel:true,</span><br><span class="line">      cache:true</span><br><span class="line">    &#125;)</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// hard-source-webpack-plugin</span><br><span class="line">let HSWP= require(&apos;hard-source-webpack-plugin&apos;)</span><br><span class="line"></span><br><span class="line">plugins:[</span><br><span class="line">  new HSWP()</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
</li>
<li><p>缩小构建目标</p>
<ul>
<li>尽可能少的构建模块 exclude:’node_modules’</li>
<li>减少文件搜索范围<ul>
<li>优化resolve.modules [path.resolve(__dirname,’node_modules’)]</li>
<li>优化resolve.mainFields [‘main’]</li>
<li>优化resolve.extensions [‘.js’,’.json’]</li>
<li>优化resolve.alias {react:path.resolve(__dirname,’node_modules/….js’)}</li>
</ul>
</li>
</ul>
</li>
<li><p>图片压缩</p>
<ul>
<li>基于nodejs的imagemin或tinypng的api，使用image-webpack-loader</li>
<li>imagemin优势<ul>
<li>很多可配置项目</li>
<li>可引入第三方优化插件</li>
<li>可处理多种图片格式<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  loader: &apos;image-webpack-loader&apos;,</span><br><span class="line">  options: &#123;</span><br><span class="line">    mozjpeg: &#123;</span><br><span class="line">      progressive: true,</span><br><span class="line">      quality: 65</span><br><span class="line">    &#125;,</span><br><span class="line">    // optipng.enabled: false will disable optipng</span><br><span class="line">    optipng: &#123;</span><br><span class="line">      enabled: false,</span><br><span class="line">    &#125;,</span><br><span class="line">    pngquant: &#123;</span><br><span class="line">      quality: &apos;65-90&apos;,</span><br><span class="line">      speed: 4</span><br><span class="line">    &#125;,</span><br><span class="line">    gifsicle: &#123;</span><br><span class="line">      interlaced: false,</span><br><span class="line">    &#125;,</span><br><span class="line">    // the webp option will enable WEBP</span><br><span class="line">    webp: &#123;</span><br><span class="line">      quality: 75</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
</li>
<li><p>treeShaking擦除无用css</p>
<ul>
<li>默认模块中只要有一个方法被引用整个文件会被打入bundle中，treeShaking是在uglify阶段擦除无用</li>
<li>webpack4中production默认开启treeShaking</li>
<li>前提必须是ESM语法，CJS不支持</li>
<li>手动开启需要在.babelrc中设置modules:false</li>
<li>删除无用css2种方案<ul>
<li>purifyCSS 遍历代码，识别已经用到的css</li>
<li>uncss 通过document.querySelector进行识别</li>
</ul>
</li>
<li>实践<ul>
<li>purgecss-webpack-plugin + mini-css-extract-plugin</li>
</ul>
</li>
</ul>
</li>
<li><p>动态polyfill</p>
<ul>
<li>减少构建体积</li>
<li>polyfill是根据UA下发需要的polyfill来按需加载</li>
<li>可以直接script[src=’’]来引用polyfill.io服务</li>
<li>也可以基于官方开源的方案自建polyfill的cdn服务</li>
<li>ua篡改也可以根据代码结果降级为获取全部polyfill</li>
</ul>
</li>
</ul>
<h1 id="原理篇"><a href="#原理篇" class="headerlink" title="原理篇"></a>原理篇</h1><h2 id="源码掌握原理"><a href="#源码掌握原理" class="headerlink" title="源码掌握原理"></a>源码掌握原理</h2><ul>
<li><p>webpack源码</p>
<ul>
<li>本质<ul>
<li>基于事件流的编程范例，运行一系列的插件</li>
<li>compiler = webpack(options)</li>
</ul>
</li>
<li>启动流程<ul>
<li>npm scripts</li>
<li>webpack cli</li>
<li>实际都是执行的node_modules/webpack/bin/webpack.js</li>
</ul>
</li>
<li>主要步骤<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">process.exitCode = 0;</span><br><span class="line">const runCommand = (cmd,args)=&gt;&#123;&#125;</span><br><span class="line">const installed = packageName=&gt;&#123;&#125;</span><br><span class="line">const CLIs = []</span><br><span class="line">const installedCLIs = CLIs.filter()</span><br><span class="line">if(installedCLIs.length ===0 )&#123;</span><br><span class="line"></span><br><span class="line">&#125;else if(installedCLIs.length ===1)&#123;</span><br><span class="line"></span><br><span class="line">&#125;else&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>webpack-cli源码</p>
<ul>
<li>主要流程<ul>
<li>引入yargs，对命令行进行定制</li>
<li>分析命令行参数，对参数进行转换，组成编译配置项</li>
<li>引入webpack，根据配置项进行编译</li>
</ul>
</li>
<li>不需编译的子命令<ul>
<li>init</li>
<li>migrate</li>
<li>add</li>
<li>remote</li>
<li>serve</li>
<li>info</li>
<li>generate-loader</li>
<li>generate-plugin</li>
</ul>
</li>
</ul>
</li>
<li><p>tapable</p>
<ul>
<li>类似nodejs的EventEmitter,主要控制钩子的发布和订阅</li>
<li>插件系统发布或订阅钩子函数进行处理</li>
<li>9大hook类<ul>
<li>SyncHook</li>
<li>SyncBailHook</li>
<li>SyncWaterfallHook</li>
<li>SyncLoopHook</li>
<li>AsyncParallelHook</li>
<li>AsyncParallelBailHook</li>
<li>AsyncSeriesHook</li>
<li>AsyncSeriesBailHook</li>
<li>AsyncSeriesWaterfallHook</li>
</ul>
</li>
<li>绑定和执行<ul>
<li>同步:tap和call</li>
<li>异步:tapAsync/tapPromise/tap和callAsync/<br>promise<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">const hook1 = new SyncHook([&quot;a1&quot;,&quot;a2&quot;,&quot;a3&quot;])</span><br><span class="line"></span><br><span class="line">hook1.tap(&quot;hook1&quot;,(a1,a2,a3)=&gt;&#123;&#125;)</span><br><span class="line">hook1.call(1,2,3)</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
</li>
<li><p>简易实现webpack</p>
<ul>
<li>babel语法转换 babylon</li>
<li>依赖分析 babel-traverse</li>
</ul>
</li>
</ul>
<h2 id="自定义loader"><a href="#自定义loader" class="headerlink" title="自定义loader"></a>自定义loader</h2><ul>
<li><p>loader链式调用和执行顺序</p>
<ul>
<li>loader只是一个导出为函数的js模块</li>
<li>module.exports = function(source){return s}</li>
<li>链式调用时从右到左从后到前依次串行执行</li>
<li>函数组合的2种方式<ul>
<li>unix的pipline从左到右</li>
<li>compose的方式从右到左compose=(f,g)=&gt;(…args)=&gt;f(g(…args)) webpack采用此方式</li>
</ul>
</li>
</ul>
</li>
<li><p>loader-runner</p>
<ul>
<li>可用webpack-cli的generate-loader命令</li>
<li>loader-runner可以在不安装webpack情况下运行loaders</li>
<li>webpack也使用loader-runner执行loader</li>
<li>开发中也可以用loader-runner进行loader的开发和调试</li>
</ul>
</li>
<li><p>pitchLoader</p>
<ul>
<li>可以跳过loader的处理</li>
<li>实现简单，可以更灵活的定义loader的执行</li>
</ul>
</li>
<li><p>实战</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">mkdir raw-loader &amp;&amp; cd raw-loader</span><br><span class="line">npm init -y </span><br><span class="line">npm i loader-runner</span><br><span class="line"></span><br><span class="line">/src/demo.txt</span><br><span class="line">demotxt</span><br><span class="line"></span><br><span class="line">/src/raw-loader.js</span><br><span class="line">module.exports=function(src)&#123;</span><br><span class="line">  const json = JSON.stringify(src)</span><br><span class="line">              .replace(/\u2028/g,&apos;\\u2028&apos;)</span><br><span class="line">              .replace(/\u2029/g,&apos;\\u2029&apos;)</span><br><span class="line"></span><br><span class="line">  // 正常返回 return `export default $&#123;json&#125;`; </span><br><span class="line">  // 抛错 throw new Error(&apos;myError&apos;);</span><br><span class="line">  // 也可通过this.callback(error,data1 [,data2...])</span><br><span class="line">  this.callback(null, json);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/run-loader.js</span><br><span class="line">const &#123;runLoaders &#125; = require(&apos;loader-runner&apos;);</span><br><span class="line">const fs = require(&apos;fs&apos;);</span><br><span class="line">const path = require(&apos;path&apos;)</span><br><span class="line">runLoaders(&#123;</span><br><span class="line">    resource:path.join(__dirname,&apos;./src/demo.txt&apos;),</span><br><span class="line">    loaders:[</span><br><span class="line">        path.join(__dirname,&apos;./src/raw-loader.js&apos;)</span><br><span class="line">    ],</span><br><span class="line">    context:&#123;</span><br><span class="line">        minimize:true</span><br><span class="line">    &#125;,</span><br><span class="line">    readResource:fs.readFile.bind(fs)</span><br><span class="line">&#125;,function(err,res)&#123;</span><br><span class="line">    console.log(err,res)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">node run-loader.js</span><br></pre></td></tr></table></figure>
</li>
<li><p>高级用法</p>
<ul>
<li><p>loader-utils的getOptions获取loader参数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">const loaderUtils = require(&apos;loader-utils&apos;);</span><br><span class="line">module.exports = function(source)&#123;</span><br><span class="line">  const &#123;name&#125; = loaderUtils.getOptions(this);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>loader的异步处理</p>
<ul>
<li>通过this.async()返回的一个函数进行异步处理</li>
<li>第一个参数是error，第二个参数是处理结果<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">module.exports = function(source)&#123;</span><br><span class="line">  const callback = this.async();</span><br><span class="line"></span><br><span class="line">  fs.readFile(path,&apos;utf-8&apos;,(err,data)=&gt;&#123;</span><br><span class="line">    callback(err,data)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>loader的缓存</p>
<ul>
<li>webpack中默认开启缓存</li>
<li>可使用this.cacheable(false)关掉缓存</li>
<li>缓存的条件是相同的输入有相同的输出</li>
<li>有依赖的loader无法使用缓存</li>
</ul>
</li>
<li><p>loader的文件输出</p>
<ul>
<li>this.emitFile(outputPath,content)</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="自定义plugin"><a href="#自定义plugin" class="headerlink" title="自定义plugin"></a>自定义plugin</h2><ul>
<li><p>插件</p>
<ul>
<li>没有loader那样的独立运行环境，只能在webpack内运行</li>
<li>插件需要导出一个类，类需要实现apply方法</li>
<li>apply方法接收到一个compiler对象参数</li>
<li>插件内通过compiler的hooks和compilation的hooks做逻辑处理</li>
</ul>
</li>
<li><p>搭建插件运行环境</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">const path = require(&apos;path&apos;);</span><br><span class="line">const DemoPlugin = require(&apos;./plugins/demo.js&apos;);</span><br><span class="line">const options = &#123;&#125;</span><br><span class="line"></span><br><span class="line">module.exports = &#123;</span><br><span class="line">  entry:&#123;</span><br><span class="line">    lib: path.join(__dirname,&apos;src/lib.js&apos;)</span><br><span class="line">  &#125;,</span><br><span class="line">  output:&#123;</span><br><span class="line">    path:path.join(__dirname,&apos;dist&apos;),</span><br><span class="line">    filename:&apos;[name].js&apos;</span><br><span class="line">  &#125;,</span><br><span class="line">  plugins:[</span><br><span class="line">    new DemoPlugin(options)</span><br><span class="line">  ]</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// plugins/demo.js</span><br><span class="line">module.exports = class DemoPlugin &#123;</span><br><span class="line">  constructor(options)&#123;</span><br><span class="line">    this.options = options</span><br><span class="line">  &#125;</span><br><span class="line">  apply(compiler)&#123;</span><br><span class="line">    console.log(this.options);</span><br><span class="line">    compiler.hooks.done.tap(&apos;demo&apos;,()=&gt;&#123;&#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>错误处理</p>
<ul>
<li>接收参数时可以直接throw new Error()</li>
<li>hooks处理阶段通过compilation.warnings或errors.push(‘msg’)</li>
</ul>
</li>
<li><p>文件输出</p>
<ul>
<li>通过compilation.assets配合webpack-sources包<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">const JSZip = require(&apos;jszip&apos;)</span><br><span class="line">const RawSource = require(&apos;webpack-sources&apos;).RawSource</span><br><span class="line">const path = require(&apos;path&apos;)</span><br><span class="line">const zip = new JSZip()</span><br><span class="line">module.exports = class DemoPlugin &#123;</span><br><span class="line">  constructor (options) &#123;</span><br><span class="line">    this.options = options</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  apply (compiler) &#123;</span><br><span class="line">    compiler.hooks.emit.tapAsync(&apos;zipPlugin&apos;, (compilation, cb) =&gt; &#123;</span><br><span class="line">      const folder = zip.folder(this.options.name)</span><br><span class="line">      for (const filename in compilation.assets) &#123;</span><br><span class="line">        const source = compilation.assets[filename].source()</span><br><span class="line">        folder.file(filename, source)</span><br><span class="line">      &#125;</span><br><span class="line">      zip.generateAsync(&#123;</span><br><span class="line">        type: &apos;nodebuffer&apos;</span><br><span class="line">      &#125;).then((content) =&gt; &#123;</span><br><span class="line">        console.log(compilation.options)</span><br><span class="line">        const outputPath = path.join(compilation.options.output.path, this.options.name + &apos;.zip&apos;)</span><br><span class="line">        const relativePath = path.relative(compilation.options.output.path, outputPath)</span><br><span class="line">        compilation.assets[relativePath] = new RawSource(content)</span><br><span class="line">        cb()</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
</li>
</ul>

            </div>
          

    
      <footer class="post-footer">
		
		<div class="post-tags">
		  
			<a href="/tags/webpack/">webpack</a>
		  
		</div>
		

        
        
  <nav class="post-nav">
    
      <a class="prev" href="/2019/08/17/cli/">
        <i class="iconfont icon-left"></i>
        <span class="prev-text nav-default">cli</span>
        <span class="prev-text nav-mobile">Prev</span>
      </a>
    
    
      <a class="next" href="/2019/08/15/vscode/">
        <span class="next-text nav-default">vscode</span>
        <span class="prev-text nav-mobile">Next</span>
        <i class="iconfont icon-right"></i>
      </a>
    
  </nav>

        
  <div class="comments" id="comments">
    
  </div>


      </footer>
    
  </article>

    </div>

      </div>

      <footer id="colophon"><span class="copyright-year">
    
        &copy;
    
    2020
    <span class="footer-author">prief.</span>
    <span class="power-by">
        Powered by <a class="hexo-link" href="https://hexo.io/">Hexo</a> and <a class="theme-link" href="https://github.com/frostfan/hexo-theme-polarbear">Polar Bear</a>
    </span>
</span>

      </footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div>
    


    




  
    <script type="text/javascript" src="/lib/jquery/jquery-3.1.1.min.js"></script>
  

  

    <script type="text/javascript" src="/js/src/theme.js?v=1.1"></script>
<script type="text/javascript" src="/js/src/bootstrap.js?v=1.1"></script>

  </body>
</html>
