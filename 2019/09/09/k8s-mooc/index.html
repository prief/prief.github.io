<!DOCTYPE HTML>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  
  <title>k8s-mooc | prief | about share and go on</title>

  
  <meta name="author" content="prief">
  

  
  <meta name="description" content="k8s快速入门核心概念
kubernetes 舵手

image

container

pod

包含1个或多个container
container之间共享网络，ip


replicaset

deployment

service

通过labelSelector选择后端服务
通过clust">
  

  
  
  <meta name="keywords" content>
  

  <meta id="viewport" name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  <meta property="og:title" content="k8s-mooc">

  <meta property="og:site_name" content="prief">

  
  <meta property="og:image" content="/favicon.ico">
  

  <link href="/favicon.ico" rel="icon">
  <link rel="alternate" href="/atom.xml" title="prief" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
</head>


<body>
<div class="blog">
  <div class="content">

    <header>
  <div class="site-branding">
    <h1 class="site-title">
      <a href="/">prief</a>
    </h1>
    <p class="site-description">about share and go on</p>
  </div>
  <nav class="site-navigation">
    <ul>
      
        <li><a href="/">Home</a></li>
      
        <li><a href="/tags">Tags</a></li>
      
    </ul>
  </nav>
</header>

    <main class="site-main posts-loop">
    <article>

  
    
    <h3 class="article-title"><span>k8s-mooc</span></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2019/09/09/k8s-mooc/" rel="bookmark">
        <time class="entry-date published" datetime="2019-09-09T14:37:42.000Z">
          2019-09-09
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <h1 id="k8s快速入门"><a href="#k8s快速入门" class="headerlink" title="k8s快速入门"></a>k8s快速入门</h1><h2 id="核心概念"><a href="#核心概念" class="headerlink" title="核心概念"></a>核心概念</h2><ul>
<li><p>kubernetes 舵手</p>
</li>
<li><p>image</p>
</li>
<li><p>container</p>
</li>
<li><p>pod</p>
<ul>
<li>包含1个或多个container</li>
<li>container之间共享网络，ip</li>
</ul>
</li>
<li><p>replicaset</p>
</li>
<li><p>deployment</p>
</li>
<li><p>service</p>
<ul>
<li>通过labelSelector选择后端服务</li>
<li>通过clusterIp暴露服务</li>
</ul>
</li>
<li><p><a href="https://k8s.imroc.io/" target="_blank" rel="noopener">https://k8s.imroc.io/</a></p>
<h2 id="架构设计"><a href="#架构设计" class="headerlink" title="架构设计"></a>架构设计</h2></li>
<li><p>master</p>
<ul>
<li>etcd</li>
<li>apiServer</li>
<li>scheduler</li>
<li>controllerManager</li>
</ul>
</li>
<li><p>worker</p>
<ul>
<li>kubelet</li>
<li>kube-proxy</li>
<li>docker<h2 id="认证授权"><a href="#认证授权" class="headerlink" title="认证授权"></a>认证授权</h2></li>
</ul>
</li>
<li><p>https</p>
<ul>
<li>ssl/tls</li>
<li>CA(浏览器的公共CA和自有CA)</li>
</ul>
</li>
<li><p>k8s认证</p>
<ul>
<li>集群外访问apiServer<ul>
<li>客户端证书认证(kubectl,tls双向认证)</li>
<li>BearerToken认证(apiServer内置了可信任的token)</li>
</ul>
</li>
<li>集群内pod访问apiServer<ul>
<li>serviceAccount<ul>
<li>三部分(namespace,token,ca)</li>
<li>上面的信息通过目录挂载到pod中，应用通过指定目录使用</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p>授权</p>
<ul>
<li>ABAC</li>
<li>webHook</li>
<li>RBAC(最新的主流方案，roleBasedAccessControl)<ul>
<li>User<ul>
<li>user</li>
<li>serviceAccount</li>
</ul>
</li>
<li>Role<ul>
<li>namespace</li>
<li>name</li>
<li>resource</li>
<li>verbs</li>
</ul>
</li>
<li>Authority<ul>
<li>resource</li>
<li>verbs</li>
</ul>
</li>
<li>RBAC<ul>
<li>Role/RoleBinding</li>
<li>ClusterRole/ClusterRoleBinding</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p>准入控制</p>
<ul>
<li>AdmisionControl，类似java中的filter</li>
<li>AlwaysAdmit</li>
<li>AlwaysDeny</li>
<li>ServiceAccount</li>
<li>DenyEscalatingExec<h2 id="集群搭建方案对比"><a href="#集群搭建方案对比" class="headerlink" title="集群搭建方案对比"></a>集群搭建方案对比</h2></li>
</ul>
</li>
<li><p>kubeadm</p>
<ul>
<li>优雅，几乎所有组件都在pod中</li>
<li>简单</li>
<li>支持高可用</li>
<li>升级方便</li>
</ul>
</li>
<li><p>二进制</p>
<ul>
<li>容易维护</li>
<li>灵活</li>
<li>支持高可用</li>
<li>升级方便</li>
<li>证书、配置等需要一步步操作<h1 id="kubeadm方式搭建"><a href="#kubeadm方式搭建" class="headerlink" title="kubeadm方式搭建"></a>kubeadm方式搭建</h1><h2 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h2></li>
</ul>
</li>
<li><p>统一主机名</p>
<ul>
<li>hostname</li>
<li>hostnamectl set-hostname name</li>
<li>vi /etc/hosts</li>
</ul>
</li>
<li><p>安装依赖包</p>
<ul>
<li>wget -O /etc/yum.repos.d/CentOS-Base.repo <a href="http://mirrors.aliyun.com/repo/Centos-7.repo" target="_blank" rel="noopener">http://mirrors.aliyun.com/repo/Centos-7.repo</a></li>
<li>yum install -y epel-release &amp;&amp; yum clean all &amp;&amp; yum makecache</li>
<li>yum update -y</li>
<li>yum install -y conntrack ipvsadm ipset jq sysstat curl iptables libseccomp ntpdate</li>
<li>ntpdate ip</li>
</ul>
</li>
<li><p>主机配置</p>
<ul>
<li>关闭防火墙 systemctl stop firewalld &amp;&amp; systemctl disable firewalld</li>
<li>关闭swap  swapoff -a &amp;&amp; sed -i ‘/swap/s/^(.*)$/# \1/g’ /etc/fstab</li>
<li>重置iptables iptables -F &amp;&amp; iptables -X &amp;&amp; iptables -F -t nat &amp;&amp; iptables -X -t nat &amp;&amp; iptables -P FORWARD ACCEPT</li>
<li>关闭selinux setenforce 0 &amp;&amp; sed -i ‘s/^SELINUX=.*$/SELINUX=disabled/‘ /etc/selinux/config</li>
<li>关闭dnsmasq systemctl stop dnsmasq &amp;&amp; systemctl disable dnsmasq</li>
<li>配置k8s系统文件 vim /etc/sysctl.d/kubernetes.conf &amp;&amp; sysctl -p /etc/sysctl.d/kubernetes.conf<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/sysctl.d/kubernetes.conf &lt;&lt;EOF</span><br><span class="line">net.bridge.bridge-nf-call-iptables=1</span><br><span class="line">net.bridge.bridge-nf-call-ip6tables=1</span><br><span class="line">net.ipv4.ip_forward=1</span><br><span class="line">vm.swappiness=0</span><br><span class="line">vm.overcommit_memory=1</span><br><span class="line">vm.panic_on_oom=0</span><br><span class="line">fs.inotify.max_user_watches=89100</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>安装docker</p>
<ul>
<li>mkdir -p /opt/kubernetes/docker &amp;&amp; cd /opt/kubernetes/docker</li>
<li>wget <a href="http://yum.dockerproject.org/repo/main/centos/7/Packages/docker-engine-selinux-17.03.1.ce-1.el7.centos.noarch.rpm" target="_blank" rel="noopener">http://yum.dockerproject.org/repo/main/centos/7/Packages/docker-engine-selinux-17.03.1.ce-1.el7.centos.noarch.rpm</a></li>
<li>wget <a href="http://yum.dockerproject.org/repo/main/centos/7/Packages/docker-engine-debuginfo-17.03.1.ce-1.el7.centos.x86_64.rpm" target="_blank" rel="noopener">http://yum.dockerproject.org/repo/main/centos/7/Packages/docker-engine-debuginfo-17.03.1.ce-1.el7.centos.x86_64.rpm</a></li>
<li>wget <a href="http://yum.dockerproject.org/repo/main/centos/7/Packages/docker-engine-17.03.1.ce-1.el7.centos.x86_64.rpm" target="_blank" rel="noopener">http://yum.dockerproject.org/repo/main/centos/7/Packages/docker-engine-17.03.1.ce-1.el7.centos.x86_64.rpm</a></li>
<li>yum remove -y docker* container-selinux</li>
<li>yum localinstall -y *.rpm</li>
<li>systemctl enable docker</li>
<li>df -h # 查看空间较大的分区并在分区下创建dockerdata目录准备存放docker数据</li>
<li>#设置docker数据目录并启动docker服务 systemctl start docker<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;EOF &gt; /etc/docker/daemon.json</span><br><span class="line">&#123;</span><br><span class="line">    &quot;graph&quot;: &quot;/var/lib/docker&quot;,</span><br><span class="line">    &quot;registry-mirrors&quot;: [&quot;https://4vo01fev.mirror.aliyuncs.com&quot;],</span><br><span class="line">    &quot;exec-opts&quot;: [&quot;native.cgroupdriver=systemd&quot;],</span><br><span class="line">    &quot;log-driver&quot;: &quot;json-file&quot;,</span><br><span class="line">    &quot;log-opts&quot;: &#123;</span><br><span class="line">        &quot;max-size&quot;: &quot;100m&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;storage-driver&quot;: &quot;overlay2&quot;,</span><br><span class="line">    &quot;storage-opts&quot;: [</span><br><span class="line">        &quot;overlay2.override_kernel_check=true&quot;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cat &lt;&lt;EOF &gt; /etc/systemd/system/docker.service.d/http-proxy.conf</span><br><span class="line">[Service]</span><br><span class="line">Environment=&quot;HTTP_PROXY=&quot; &quot;HTTPS_PROXY=&quot;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>安装必要工具</p>
<ul>
<li>kubeadm/kubelet/kubectl</li>
<li>配置yum源</li>
<li>yum install -y kubelet kubeadm kubectl –disableexcludes=kubernetes</li>
<li>systemctl enable kubelet &amp;&amp; systemctl start kubelet<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">cat &lt;&lt; EOF &gt; /etc/yum.repos.d/kubernetes.repo</span><br><span class="line">[kubernetes]</span><br><span class="line">name=Kubernetes</span><br><span class="line">baseurl=http://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=0</span><br><span class="line">repo_gpgcheck=0</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-apiserver:v1.17.0 </span><br><span class="line">docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-controller-manager:v1.17.0</span><br><span class="line">docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-scheduler:v1.17.0</span><br><span class="line">docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy:v1.17.0</span><br><span class="line">docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1</span><br><span class="line">docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/etcd:3.4.3-0</span><br><span class="line">docker pull coredns/coredns:1.6.5</span><br><span class="line"></span><br><span class="line">docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/kube-apiserver:v1.17.0 k8s.gcr.io/kube-apiserver:v1.17.0</span><br><span class="line">docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/kube-controller-manager:v1.17.0 k8s.gcr.io/kube-controller-manager:v1.17.0</span><br><span class="line">docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/kube-scheduler:v1.17.0 k8s.gcr.io/kube-scheduler:v1.17.0</span><br><span class="line">docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy:v1.17.0 k8s.gcr.io/kube-proxy:v1.17.0</span><br><span class="line">docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1 k8s.gcr.io/pause:3.1</span><br><span class="line">docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/etcd:3.4.3-0 k8s.gcr.io/etcd:3.4.3-0</span><br><span class="line">docker tag coredns/coredns:1.6.5 k8s.gcr.io/coredns:1.6.5</span><br><span class="line"></span><br><span class="line">docker rmi registry.cn-hangzhou.aliyuncs.com/google_containers/kube-apiserver:v1.17.0 </span><br><span class="line">docker rmi registry.cn-hangzhou.aliyuncs.com/google_containers/kube-controller-manager:v1.17.0</span><br><span class="line">docker rmi registry.cn-hangzhou.aliyuncs.com/google_containers/kube-scheduler:v1.17.0</span><br><span class="line">docker rmi registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy:v1.17.0</span><br><span class="line">docker rmi registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1</span><br><span class="line">docker rmi registry.cn-hangzhou.aliyuncs.com/google_containers/etcd:3.4.3-0</span><br><span class="line">docker rmi coredns/coredns:1.6.5</span><br></pre></td></tr></table></figure>

</li>
</ul>
</li>
</ul>
<h2 id="高可用部署"><a href="#高可用部署" class="headerlink" title="高可用部署"></a>高可用部署</h2><ul>
<li><p>实现apiServer的高可用与负载均衡，也可只用keepalived</p>
<ul>
<li>yum install -y socat keepalived haproxy ipvsadm</li>
<li>systemctl enable haproxy &amp;&amp; systemctl enable keepalived</li>
<li>systemctl start haproxy &amp;&amp; systemctl start keepalived</li>
<li>journalctl -f -u keepalived </li>
<li>ip a # 查看虚拟ip<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"># /etc/keepalived/keepalived.conf</span><br><span class="line">global_defs &#123;</span><br><span class="line">   router_id master01|master02|master03</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_script check &#123;</span><br><span class="line">    script /etc/keepalived/check_haproxy.sh｜check_apiserver.sh </span><br><span class="line">    interval 3</span><br><span class="line">    # weight -2 如果脚本非零退出，则权重-2，可动态配置权重,与check_apiserver.sh 搭配</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state MASTER|BACKUP|BACKUP</span><br><span class="line">    interface ens160|ens160|ens160</span><br><span class="line">    virtual_router_id 80</span><br><span class="line">    priority 100|90|80</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 1111</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        10.18.3.200</span><br><span class="line">    &#125;</span><br><span class="line">    track_script &#123;   </span><br><span class="line">        check</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#/etc/keepalived/check_haproxy.sh </span><br><span class="line">#!/bin/bash</span><br><span class="line">NUM=`ps -C haproxy --no-header |wc -l`</span><br><span class="line">if [ $NUM -eq 0 ];then</span><br><span class="line">    systemctl stop keepalived</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">#/etc/keepalived/check_apiserver.sh </span><br><span class="line">#!/bin/bash</span><br><span class="line">errorExit()&#123;</span><br><span class="line">    echo &quot;*** $*&quot; 1&gt;&amp;2</span><br><span class="line">    exit 1</span><br><span class="line">&#125;</span><br><span class="line">curl --silent --max-time 2 --insecure https://localhost:6443/ -o /dev/null || errorExit &quot;Error https://localhost:6443&quot;</span><br><span class="line">if ip addr | grep -q 10.18.3.200; then</span><br><span class="line">    curl --silent --max-time 2 --insecure https://10.18.3.200:6443 -o /dev/null || errorExit &quot;Error https://10.18.3.200:6443&quot;</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">#/etc/haproxy/haproxy.cfg</span><br><span class="line">global</span><br><span class="line">    log         127.0.0.1 local3</span><br><span class="line">    chroot      /var/lib/haproxy</span><br><span class="line">    pidfile     /var/run/haproxy.pid</span><br><span class="line">    maxconn     32768</span><br><span class="line">    user        haproxy</span><br><span class="line">    group       haproxy</span><br><span class="line">    daemon</span><br><span class="line">    nbproc      1</span><br><span class="line">    stats socket /var/lib/haproxy/stats</span><br><span class="line"></span><br><span class="line">defaults</span><br><span class="line">    mode                    tcp</span><br><span class="line">    log                     global</span><br><span class="line">    option                  tcplog</span><br><span class="line">    option                  dontlognull</span><br><span class="line">    option                  redispatch</span><br><span class="line">    retries                 3</span><br><span class="line">    timeout queue           1m</span><br><span class="line">    timeout connect         10s</span><br><span class="line">    timeout client          1m</span><br><span class="line">    timeout server          1m</span><br><span class="line">    timeout check           10s</span><br><span class="line"></span><br><span class="line">listen stats</span><br><span class="line">    mode   http</span><br><span class="line">    bind :8888</span><br><span class="line">    stats   enable</span><br><span class="line">    stats   uri     /admin</span><br><span class="line">    stats   auth    admin:admin</span><br><span class="line">    stats   admin   if TRUE</span><br><span class="line"></span><br><span class="line">frontend  k8s_https *:8443</span><br><span class="line">    mode      tcp</span><br><span class="line">    maxconn      2000</span><br><span class="line">    default_backend     https_sri</span><br><span class="line"></span><br><span class="line">backend https_sri</span><br><span class="line">    balance      roundrobin</span><br><span class="line">    server master1-api 10.18.3.178:6443  check inter 10000 fall 2 rise 2 weight 1</span><br><span class="line">    server master2-api 10.18.3.179:6443  check inter 10000 fall 2 rise 2 weight 1</span><br><span class="line">    server master3-api 10.18.3.180:6443  check inter 10000 fall 2 rise 2 weight 1</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>部署master01</p>
<ul>
<li>kubeadm config print init-defaults &gt; ~/kubeadm_master01.yaml #默认配置文件</li>
<li>kubeadm config images list –config  ~/kubeadm_master01.yaml #查看所需镜像</li>
<li>kubeadm config images pull –config  ~/kubeadm_master01.yaml #拉取所需镜像，也可手动拉取</li>
<li>kubeadm init –control-plane-endpoint “LOAD_BALANCER_DNS:LOAD_BALANCER_PORT” –pod-network-cidr 10.96.0.0/16 –upload-certs</li>
<li>mkdir -p $HOME/.kube</li>
<li>sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</li>
<li>sudo chown $(id -u):$(id -g) $HOME/.kube/config</li>
<li>kubectl get pods –all-namespaces #测试</li>
</ul>
</li>
<li><p>部署master02|master03</p>
<ul>
<li>kubeadm join 10.18.3.200:8443 –token XXX –discovery-token-ca-cert-hash XXX –control-plane –certificate-key XXX</li>
<li>mkdir -p $HOME/.kube</li>
<li>sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</li>
<li>sudo chown $(id -u):$(id -g) $HOME/.kube/config</li>
<li>kubectl get pods –all-namespaces #测试</li>
</ul>
</li>
<li><p>部署worker</p>
<ul>
<li>kubeadm join 10.18.3.200:8443 –token XXX –discovery-token-ca-cert-hash XXX</li>
</ul>
</li>
<li><p>部署网络插件</p>
<ul>
<li>#任意主节点下载配置文件并更改cidr</li>
<li>kubectl apply -f calico.yaml</li>
<li>kubectl get pods –all-namespaces #测试</li>
</ul>
</li>
<li><p>检测</p>
<ul>
<li>kubectl get nodes</li>
<li>kubectl cluster-info</li>
<li>kubectl get cs</li>
<li>kubectl exec -n kube-system etcd-m1 – etcdctl –cacert=”/etc/kubernetes/pki/etcd/ca.crt” –cert=”/etc/kubernetes/pki/etcd/peer.crt” –key=”/etc/kubernetes/pki/etcd/peer.key” –endpoints=<a href="https://10.18.3.178:2379" target="_blank" rel="noopener">https://10.18.3.178:2379</a> member list #查看etcd集群</li>
<li>journalctl -f #查看日志<h2 id="可用性测试"><a href="#可用性测试" class="headerlink" title="可用性测试"></a>可用性测试</h2></li>
</ul>
</li>
<li><p>kubectl apply -f nginx-ds.yaml  </p>
</li>
<li><p>ping podIp</p>
</li>
<li><p>curl svcIp:svcPort</p>
</li>
<li><p>curl nodeIp:nodePort</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-ds-svc</span><br><span class="line">  labels:</span><br><span class="line">    app: nginx-ds-svc</span><br><span class="line">spec:</span><br><span class="line">  type: NodePort</span><br><span class="line">  selector:</span><br><span class="line">    app: nginx-ds</span><br><span class="line">  ports:</span><br><span class="line">  - name: http</span><br><span class="line">    port: 80</span><br><span class="line">    targetPort: 80</span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: DaemonSet</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-ds</span><br><span class="line">  labels:</span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: nginx-ds</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx-ds</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: my-nginx</span><br><span class="line">        image: nginx:1.7.9</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 80</span><br></pre></td></tr></table></figure>

<ul>
<li>kubectl apply -f pod-nginx.yaml</li>
<li>kubectl exec -it nginx bash</li>
<li>cat /etc/resolve.conf #查看DNS</li>
<li>ping svc-name #如果不通可以按如下修改proxy模式为ipvs</li>
<li>kubectl logs kube-proxy-hash -n kube-system #查看proxy模式</li>
<li>kubectl edit cm kube-proxy -n kube-system #默认kube-proxy模式为iptables，可修改mode为ipvs，同时需要ipvs模块配置</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx</span><br><span class="line">  labels:</span><br><span class="line">        app: nginx-ds</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: my-nginx</span><br><span class="line">    image: nginx:1.7.9</span><br><span class="line">    ports:</span><br><span class="line">    - containerPort: 80</span><br><span class="line"></span><br><span class="line"># ipvs模块配置</span><br><span class="line">cat &gt; /etc/sysconfig/modules/ipvs.modules &lt;&lt;EOF</span><br><span class="line">#!/bin/bash </span><br><span class="line">modprobe -- ip_vs </span><br><span class="line">modprobe -- ip_vs_rr </span><br><span class="line">modprobe -- ip_vs_wrr </span><br><span class="line">modprobe -- ip_vs_sh </span><br><span class="line">modprobe -- nf_conntrack_ipv4 </span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">#配置开机自加载并执行生效</span><br><span class="line">chmod 755 /etc/sysconfig/modules/ipvs.modules &amp;&amp; bash /etc/sysconfig/modules/ipvs.modules</span><br><span class="line"></span><br><span class="line">#查看是否加载</span><br><span class="line">lsmod | grep -e ip_vs -e nf_conntrack_ipv4</span><br><span class="line"></span><br><span class="line">#重启kube-proxy</span><br><span class="line">kubectl get pod -n kube-system | grep kube-proxy |awk &apos;&#123;system(&quot;kubectl delete pod &quot;$1&quot; -n kube-system&quot;)&#125;&apos;</span><br></pre></td></tr></table></figure>

<h2 id="dashboard"><a href="#dashboard" class="headerlink" title="dashboard"></a>dashboard</h2><ul>
<li>kubectl apply -f dashboard.yaml</li>
<li>bash dashboardToken.sh # 默认只支持token登陆<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># dashboardToken.sh</span><br><span class="line">#!/bin/bash</span><br><span class="line">kubectl describe secret -n kubernetes-dashboard $(kubectl get secret -n kubernetes-dashboard | grep dashboard-token | awk &apos;&#123;print $1&#125;&apos;) | grep -E &apos;^token&apos; | awk &apos;&#123;print $2&#125;&apos;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h1 id="二进制方式搭建"><a href="#二进制方式搭建" class="headerlink" title="二进制方式搭建"></a>二进制方式搭建</h1><h2 id="环境准备-1"><a href="#环境准备-1" class="headerlink" title="环境准备"></a>环境准备</h2><ul>
<li><p>统一主机名</p>
<ul>
<li>hostname</li>
<li>hostnamectl set-hostname name</li>
<li>vi /etc/hosts</li>
</ul>
</li>
<li><p>rhel更换yum</p>
<ul>
<li>rpm -qa | grep yum | xargs rpm -e –nodeps</li>
<li>mkdir yumrpm &amp;&amp; cd yumrpm</li>
<li>wget <a href="https://mirrors.aliyun.com/centos/7/os/x86_64/Packages/yum-3.4.3-163.el7.centos.noarch.rpm" target="_blank" rel="noopener">https://mirrors.aliyun.com/centos/7/os/x86_64/Packages/yum-3.4.3-163.el7.centos.noarch.rpm</a></li>
<li>wget <a href="https://mirrors.aliyun.com/centos/7/os/x86_64/Packages/yum-metadata-parser-1.1.4-10.el7.x86_64.rpm" target="_blank" rel="noopener">https://mirrors.aliyun.com/centos/7/os/x86_64/Packages/yum-metadata-parser-1.1.4-10.el7.x86_64.rpm</a></li>
<li>wget <a href="https://mirrors.aliyun.com/centos/7/os/x86_64/Packages/yum-utils-1.1.31-52.el7.noarch.rpm" target="_blank" rel="noopener">https://mirrors.aliyun.com/centos/7/os/x86_64/Packages/yum-utils-1.1.31-52.el7.noarch.rpm</a></li>
<li>wget <a href="https://mirrors.aliyun.com/centos/7/os/x86_64/Packages/yum-updateonboot-1.1.31-52.el7.noarch.rpm" target="_blank" rel="noopener">https://mirrors.aliyun.com/centos/7/os/x86_64/Packages/yum-updateonboot-1.1.31-52.el7.noarch.rpm</a></li>
<li>wget <a href="https://mirrors.aliyun.com/centos/7/os/x86_64/Packages/yum-plugin-fastestmirror-1.1.31-52.el7.noarch.rpm" target="_blank" rel="noopener">https://mirrors.aliyun.com/centos/7/os/x86_64/Packages/yum-plugin-fastestmirror-1.1.31-52.el7.noarch.rpm</a></li>
<li>rpm -ivh yum*</li>
</ul>
</li>
<li><p>安装依赖包</p>
<ul>
<li>wget -O /etc/yum.repos.d/CentOS-Base.repo <a href="http://mirrors.aliyun.com/repo/Centos-7.repo" target="_blank" rel="noopener">http://mirrors.aliyun.com/repo/Centos-7.repo</a></li>
<li>yum install -y epel-release &amp;&amp; yum clean all &amp;&amp; yum makecache</li>
<li>yum update -y</li>
<li>yum install -y conntrack ipvsadm ipset jq sysstat curl iptables libseccomp ntpdate</li>
<li>ntpdate ip</li>
</ul>
</li>
<li><p>主机配置</p>
<ul>
<li>关闭防火墙 systemctl stop firewalld &amp;&amp; systemctl disable firewalld</li>
<li>关闭swap  swapoff -a &amp;&amp; sed -i ‘/swap/s/^(.*)$/# \1/g’ /etc/fstab</li>
<li>重置iptables iptables -F &amp;&amp; iptables -X &amp;&amp; iptables -F -t nat &amp;&amp; iptables -X -t nat &amp;&amp; iptables -P FORWARD ACCEPT</li>
<li>关闭selinux setenforce 0 &amp;&amp; sed -i ‘s/^SELINUX=.*$/SELINUX=disabled/‘ /etc/selinux/config</li>
<li>关闭dnsmasq systemctl stop dnsmasq &amp;&amp; systemctl disable dnsmasq</li>
<li>配置k8s系统文件 vim /etc/sysctl.d/kubernetes.conf &amp;&amp; sysctl -p /etc/sysctl.d/kubernetes.conf<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/sysctl.d/kubernetes.conf &lt;&lt;EOF</span><br><span class="line">net.bridge.bridge-nf-call-iptables=1</span><br><span class="line">net.bridge.bridge-nf-call-ip6tables=1</span><br><span class="line">net.ipv4.ip_forward=1</span><br><span class="line">vm.swappiness=0</span><br><span class="line">vm.overcommit_memory=1</span><br><span class="line">vm.panic_on_oom=0</span><br><span class="line">fs.inotify.max_user_watches=89100</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>安装docker</p>
<ul>
<li>mkdir -p /opt/kubernetes/docker &amp;&amp; cd /opt/kubernetes/docker</li>
<li>wget <a href="http://yum.dockerproject.org/repo/main/centos/7/Packages/docker-engine-selinux-17.03.1.ce-1.el7.centos.noarch.rpm" target="_blank" rel="noopener">http://yum.dockerproject.org/repo/main/centos/7/Packages/docker-engine-selinux-17.03.1.ce-1.el7.centos.noarch.rpm</a></li>
<li>wget <a href="http://yum.dockerproject.org/repo/main/centos/7/Packages/docker-engine-debuginfo-17.03.1.ce-1.el7.centos.x86_64.rpm" target="_blank" rel="noopener">http://yum.dockerproject.org/repo/main/centos/7/Packages/docker-engine-debuginfo-17.03.1.ce-1.el7.centos.x86_64.rpm</a></li>
<li>wget <a href="http://yum.dockerproject.org/repo/main/centos/7/Packages/docker-engine-17.03.1.ce-1.el7.centos.x86_64.rpm" target="_blank" rel="noopener">http://yum.dockerproject.org/repo/main/centos/7/Packages/docker-engine-17.03.1.ce-1.el7.centos.x86_64.rpm</a></li>
<li>yum remove -y docker* container-selinux</li>
<li>yum localinstall -y *.rpm</li>
<li>systemctl enable docker</li>
<li>df -h # 查看空间较大的分区并在分区下创建dockerdata目录准备存放docker数据</li>
<li>#设置docker数据目录并启动docker服务 systemctl start docker<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;EOF &gt; /etc/docker/daemon.json</span><br><span class="line">&#123;</span><br><span class="line">    &quot;graph&quot;: &quot;/var/lib/docker&quot;,</span><br><span class="line">    &quot;registry-mirrors&quot;: [&quot;https://4vo01fev.mirror.aliyuncs.com&quot;],</span><br><span class="line">    &quot;exec-opts&quot;: [&quot;native.cgroupdriver=systemd&quot;],</span><br><span class="line">    &quot;log-driver&quot;: &quot;json-file&quot;,</span><br><span class="line">    &quot;log-opts&quot;: &#123;</span><br><span class="line">        &quot;max-size&quot;: &quot;100m&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;storage-driver&quot;: &quot;overlay2&quot;,</span><br><span class="line">    &quot;storage-opts&quot;: [</span><br><span class="line">        &quot;overlay2.override_kernel_check=true&quot;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cat &lt;&lt;EOF &gt; /etc/systemd/system/docker.service.d/http-proxy.conf</span><br><span class="line">[Service]</span><br><span class="line">Environment=&quot;HTTP_PROXY=&quot; &quot;HTTPS_PROXY=&quot;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>配置发布机免密登陆</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen -t rsa</span><br><span class="line">ssh-copy-id .ssh/id_rsa.pub user@ip</span><br></pre></td></tr></table></figure>
</li>
<li><p>准备二进制文件</p>
<ul>
<li>master<ul>
<li>etcd</li>
<li>etcdctl</li>
<li>kube-apiserver</li>
<li>kube-controller-manager</li>
<li>kube-scheduler</li>
<li>kubeadm</li>
<li>kubectl</li>
</ul>
</li>
<li>worker<ul>
<li>kubelet</li>
<li>kube-proxy</li>
</ul>
</li>
</ul>
</li>
<li><p>分发到各节点并配置PATH</p>
<ul>
<li>scp </li>
<li>echo “PATH=$PATH:/opt/k8s/bin” &gt;&gt; ~/.bashrc</li>
</ul>
</li>
<li><p>配置各服务参数</p>
</li>
</ul>
<h2 id="高可用部署-1"><a href="#高可用部署-1" class="headerlink" title="高可用部署"></a>高可用部署</h2><ul>
<li><p>CA证书</p>
<ul>
<li>安装工具，cfssl非常好用的CA工具，用来生成证书和密钥文件</li>
<li>生成根证书，后续所有的证书都由根证书签名<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"># getCfssl.sh</span><br><span class="line">#!/bin/bash</span><br><span class="line">mkdir -p ~/cfssl/bin</span><br><span class="line">wget https://pkg.cfssl.org/R1.2/cfssl_linux-amd64 -O ~/cfssl/bin/cfssl</span><br><span class="line">wget https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64 -O ~/cfssl/bin/cfssljson</span><br><span class="line">chmod +x ~/cfssl/bin/cfssl ~/cfssl/bin/cfssljson</span><br><span class="line">echo &quot;PATH=$PATH:~/cfssl/bin/&quot; &gt;&gt; ~/.bashrc</span><br><span class="line">source ~/.bashrc</span><br><span class="line">cfssl version</span><br><span class="line"></span><br><span class="line"># genCA.sh</span><br><span class="line">#!/bin/bash</span><br><span class="line">mkdir -p ~/cfssl/my/ &amp;&amp; cd ~/cfssl/my/</span><br><span class="line"># 生成证书ca.pem和私钥ca-key.pem</span><br><span class="line"># csr.json可参考官网</span><br><span class="line">cfssl genkey -initca csr.json | cfssljson -bare ca</span><br><span class="line"># 把根证书拷贝到主节点</span><br><span class="line">ssh root@MASTER_IP &quot;mkdir -p /etc/kubernetes/pki/&quot;</span><br><span class="line">scp ca*.pem root@MASTER_IP:/etc/kubernetes/pki/</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>etcd集群(3台master)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">wget &apos;https://github.com/etcd-io/etcd/releases/download/v3.3.18/etcd-v3.3.18-linux-amd64.tar.gz&apos;</span><br><span class="line"></span><br><span class="line"># 生成etcd的证书和私钥</span><br><span class="line">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes etcd-csr.json | cfssljson -bare etcd</span><br><span class="line"></span><br><span class="line"># 分发到每个etcd节点</span><br><span class="line">scp etcd*.pem root@MASTER_IP:/etc/kubernetes/pki/</span><br><span class="line"></span><br><span class="line"># 配置service 文件</span><br><span class="line">scp etcd.service MASTERIP:/etc/systemd/system/</span><br><span class="line"></span><br><span class="line"># 启动服务</span><br><span class="line">systemctl daemon-reload &amp;&amp; systemctl enable etcd &amp;&amp; systemctl restart etcd</span><br><span class="line"></span><br><span class="line"># 查看日志</span><br><span class="line">journalctl -f -u etcd</span><br><span class="line"></span><br><span class="line"># 查看端口</span><br><span class="line">netstat -tunlp ｜ grep 23(79|80)</span><br></pre></td></tr></table></figure>
</li>
<li><p>apiserver集群(3台master)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"># 生成证书和私钥</span><br><span class="line">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kubernetes-csr.json | cfssljson -bare kubernetes</span><br><span class="line"></span><br><span class="line"># 分发到每个etcd节点</span><br><span class="line">scp kubernetes*.pem root@MASTER_IP:/etc/kubernetes/pki/</span><br><span class="line"></span><br><span class="line"># 配置service 文件</span><br><span class="line">scp kube-apiserver.service MASTERIP:/etc/systemd/system/</span><br><span class="line"></span><br><span class="line"># 启动服务</span><br><span class="line">systemctl daemon-reload &amp;&amp; systemctl enable kube-apiserver &amp;&amp; systemctl restart kube-apiserver</span><br><span class="line"></span><br><span class="line"># 查看日志</span><br><span class="line">journalctl -f -u kube-apiserver</span><br><span class="line"></span><br><span class="line"># 查看端口</span><br><span class="line">netstat -tunlp ｜ grep 6443</span><br></pre></td></tr></table></figure>
</li>
<li><p>部署keepalived(apiserver高可用)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"># 一般部署一主一备2个节点即可</span><br><span class="line">yum install -y keepalived</span><br><span class="line"></span><br><span class="line"># 创建配置文件 /etc/keepalived/keepalived.conf</span><br><span class="line">global_defs &#123;</span><br><span class="line">   router_id master01|master02</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_script check &#123;</span><br><span class="line">    script /etc/keepalived/check_apiserver.sh </span><br><span class="line">    interval 3</span><br><span class="line">    weight -2 如果脚本非零退出，则权重-2，与check_apiserver.sh 搭配</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state MASTER|BACKUP</span><br><span class="line">    interface ens160|ens160</span><br><span class="line">    virtual_router_id 80</span><br><span class="line">    priority 100|90</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 1111</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        VIP</span><br><span class="line">    &#125;</span><br><span class="line">    track_script &#123;   </span><br><span class="line">        check</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 创建监控脚本 /etc/keepalived/check_apiserver.sh</span><br><span class="line">#!/bin/bash</span><br><span class="line">errorExit()&#123;</span><br><span class="line">    echo &quot;*** $*&quot; 1&gt;&amp;2</span><br><span class="line">    exit 1</span><br><span class="line">&#125;</span><br><span class="line">curl --silent --max-time 2 --insecure https://localhost:6443/ -o /dev/null || errorExit &quot;Error https://localhost:6443&quot;</span><br><span class="line">if ip addr | grep -q VIP; then</span><br><span class="line">    curl --silent --max-time 2 --insecure https://VIP:6443 -o /dev/null || errorExit &quot;Error https://VIP:6443&quot;</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"># 启动服务</span><br><span class="line">systemctl daemon-reload &amp;&amp; systemctl enable keepalived &amp;&amp; systemctl restart keepalived</span><br><span class="line"></span><br><span class="line"># 查看日志</span><br><span class="line">journalctl -f -u keepalived</span><br><span class="line"></span><br><span class="line"># 访问服务</span><br><span class="line">curl --insecure https://VIP:6443/</span><br></pre></td></tr></table></figure>
</li>
<li><p>kubectl</p>
<ul>
<li>是k8s集群的命令行管理工具</li>
<li>默认从 ~/.kube/config文件读取apiserver的地址、证书、token等信息<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"># 创建admin证书和私钥</span><br><span class="line">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes admin-csr.json | cfssljson -bare admin</span><br><span class="line"></span><br><span class="line"># 创建kubeconfig文件</span><br><span class="line"># 设置集群参数</span><br><span class="line">kubectl config set-cluster kubernetes</span><br><span class="line"># 设置客户端认证参数</span><br><span class="line">kubectl config set-credentials admin</span><br><span class="line"># 设置上下文参数</span><br><span class="line">kubectl config set-context kubernetes</span><br><span class="line"># 设置默认上下文</span><br><span class="line">kubectl config use-context kubernetes</span><br><span class="line"># 分发到目标节点</span><br><span class="line">scp kube.config root@MASTERIP:~/.kube/config</span><br><span class="line"></span><br><span class="line"># 授予k8s证书访问kubeletAPI的权限</span><br><span class="line">kubectl create clusterrolebinding kube-apiserver:kubelet-apis --clusterrole=system:kubelet-api-admin --user kubernetes</span><br><span class="line"></span><br><span class="line"># 测试</span><br><span class="line">kubectl cluster-info</span><br><span class="line">kubectl get all --all-namespaces</span><br><span class="line">kubectl get cs|componentstatuses</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>controller-manager</p>
<ul>
<li>启动后通过竞选产生一个leader，其他节点阻塞</li>
<li>当leader不可用后剩余节点再竞选，保证高可用<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"># 创建证书和私钥</span><br><span class="line">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes cm-csr.json | cfssljson -bare controller-manager</span><br><span class="line"></span><br><span class="line"># 分发到目标节点</span><br><span class="line">scp controller-manager*.pem root@MASTERIP:/etc/kubernetes/pki/</span><br><span class="line"></span><br><span class="line"># 创建kubeconfig文件</span><br><span class="line"># 设置集群参数</span><br><span class="line">kubectl config set-cluster kubernetes</span><br><span class="line"># 设置客户端认证参数</span><br><span class="line">kubectl config set-credentials system:kube-controller-manager</span><br><span class="line"># 设置上下文参数</span><br><span class="line">kubectl config set-context system:kube-controller-manager</span><br><span class="line"># 设置默认上下文</span><br><span class="line">kubectl config use-context system:kube-controller-manager</span><br><span class="line"># 分发到目标节点</span><br><span class="line">scp controller-manager.kubeconfig root@MASTERIP:/etc/kubernetes/</span><br><span class="line"></span><br><span class="line"># 创建service文件</span><br><span class="line"># vi /etc/systemd/system/kube-controller-manager.service</span><br><span class="line"></span><br><span class="line"># 启动服务</span><br><span class="line">systemctl daemon-reload &amp;&amp; systemctl enable kube-controller-manager &amp;&amp; systemctl restart kube-controller-manager</span><br><span class="line"></span><br><span class="line"># 查看日志</span><br><span class="line">journalctl -f -u kube-controller-manager</span><br><span class="line"></span><br><span class="line"># 查看leader</span><br><span class="line">kubectl get endpoints kube-controller-manager -n kube-system -o yaml</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>scheduler</p>
<ul>
<li>启动后通过竞选产生一个leader，其他节点阻塞</li>
<li>当leader不可用后剩余节点再竞选，保证高可用<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"># 创建证书和私钥</span><br><span class="line">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes scheduler-csr.json | cfssljson -bare kube-scheduler</span><br><span class="line"></span><br><span class="line"># 分发到目标节点</span><br><span class="line">scp kube-scheduler*.pem root@MASTERIP:/etc/kubernetes/pki/</span><br><span class="line"></span><br><span class="line"># 创建kubeconfig文件</span><br><span class="line"># 设置集群参数</span><br><span class="line">kubectl config set-cluster kubernetes</span><br><span class="line"># 设置客户端认证参数</span><br><span class="line">kubectl config set-credentials system:kube-scheduler</span><br><span class="line"># 设置上下文参数</span><br><span class="line">kubectl config set-context system:kube-scheduler</span><br><span class="line"># 设置默认上下文</span><br><span class="line">kubectl config use-context system:kube-scheduler</span><br><span class="line"># 分发到目标节点</span><br><span class="line">scp kube-scheduler.kubeconfig root@MASTERIP:/etc/kubernetes/</span><br><span class="line"></span><br><span class="line"># 创建service文件</span><br><span class="line"># vi /etc/systemd/system/kube-scheduler.service</span><br><span class="line"></span><br><span class="line"># 启动服务</span><br><span class="line">systemctl daemon-reload &amp;&amp; systemctl enable kube-scheduler &amp;&amp; systemctl restart kube-scheduler</span><br><span class="line"></span><br><span class="line"># 查看日志</span><br><span class="line">journalctl -f -u kube-scheduler</span><br><span class="line"></span><br><span class="line"># 查看leader</span><br><span class="line">kubectl get endpoints kube-scheduler -n kube-system -o yaml</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>kubelet(worker节点)</p>
<ul>
<li>下载所需镜像<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"># 创建bootstrap配置文件</span><br><span class="line"># 创建token</span><br><span class="line">export BOOTSTRAP_TOKEN=$(kubeadm token create ) </span><br><span class="line"># 设置集群参数</span><br><span class="line">kubectl config set-cluster kubernetes</span><br><span class="line"># 设置客户端认证参数</span><br><span class="line">kubectl config set-credentials kubelet-bootstrap</span><br><span class="line"># 设置上下文参数</span><br><span class="line">kubectl config set-context default </span><br><span class="line"># 设置默认上下文</span><br><span class="line">kubectl config use-context default </span><br><span class="line"># 分发到目标节点</span><br><span class="line">scp kubelet-bootstrap.kubeconfig root@WORKER:/etc/kubernetes/kubelet-bootstrap.kubeconfig</span><br><span class="line"># 分发CA到worker节点</span><br><span class="line">scp ca.pem root@WORKER:/etc/kubernetes/pki/</span><br><span class="line"></span><br><span class="line"># 分发kubelet配置文件</span><br><span class="line">scp kubelet.config.json root@WORKER:/etc/kubernetes/</span><br><span class="line"></span><br><span class="line"># 设置kubelet服务文件</span><br><span class="line">vi /etc/systemd/system/kubelet.service</span><br><span class="line"></span><br><span class="line"># bootstrap授权</span><br><span class="line">kubectl create clusterrolebinding kubelet-bootstrap --clusterrole=system:node-bootstrapper --group=system:bootstrappers</span><br><span class="line"></span><br><span class="line"># 启动服务</span><br><span class="line">systemctl daemon-reload &amp;&amp; systemctl enable kubelet &amp;&amp; systemctl restart kubelet</span><br><span class="line"></span><br><span class="line"># master上通过请求</span><br><span class="line">kubectl get csr</span><br><span class="line">kubectl certificate approve &lt;name&gt;</span><br><span class="line"></span><br><span class="line"># worer节点日志</span><br><span class="line">journalctl -f</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>kube-proxy（所有节点）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"># 创建证书和私钥</span><br><span class="line">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kube-proxy-csr.json | cfssljson -bare kube-proxy </span><br><span class="line"></span><br><span class="line"># 创建kubeconfig文件</span><br><span class="line"># 设置集群参数</span><br><span class="line">kubectl config set-cluster kubernetes</span><br><span class="line"># 设置客户端认证参数</span><br><span class="line">kubectl config set-credentials kube-proxy</span><br><span class="line"># 设置上下文参数</span><br><span class="line">kubectl config set-context default</span><br><span class="line"># 设置默认上下文</span><br><span class="line">kubectl config use-context default</span><br><span class="line"># 分发到目标节点</span><br><span class="line">scp kube-proxy.kubeconfig root@NODEIP:/etc/kubernetes/</span><br><span class="line"></span><br><span class="line"># 创建service文件</span><br><span class="line"># vi /etc/systemd/system/kube-proxy.service</span><br><span class="line"></span><br><span class="line"># 启动服务</span><br><span class="line">systemctl daemon-reload &amp;&amp; systemctl enable kube-proxy &amp;&amp; systemctl restart kube-proxy</span><br><span class="line"></span><br><span class="line"># 查看日志</span><br><span class="line">journalctl -f -u kube-proxy</span><br></pre></td></tr></table></figure>
</li>
<li><p>部署插件</p>
<ul>
<li>calico</li>
<li>coredns</li>
</ul>
</li>
</ul>
<h2 id="可用性测试-1"><a href="#可用性测试-1" class="headerlink" title="可用性测试"></a>可用性测试</h2><ul>
<li>kubectl apply -f nginx-ds.yaml</li>
<li>ping podIp</li>
<li>curl svcIp:svcPort</li>
<li>curl nodeIp:nodePort</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-ds-svc</span><br><span class="line">  labels:</span><br><span class="line">    app: nginx-ds-svc</span><br><span class="line">spec:</span><br><span class="line">  type: NodePort</span><br><span class="line">  selector:</span><br><span class="line">    app: nginx-ds</span><br><span class="line">  ports:</span><br><span class="line">  - name: http</span><br><span class="line">    port: 80</span><br><span class="line">    targetPort: 80</span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: DaemonSet</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-ds</span><br><span class="line">  labels:</span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: nginx-ds</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx-ds</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: my-nginx</span><br><span class="line">        image: nginx:1.7.9</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 80</span><br></pre></td></tr></table></figure>

<ul>
<li>kubectl apply -f pod-nginx.yaml</li>
<li>kubectl exec -it nginx bash</li>
<li>cat /etc/resolve.conf #查看DNS</li>
<li>ping svc-name #如果不通可以按如下修改proxy模式为ipvs</li>
<li>kubectl logs kube-proxy-hash -n kube-system #查看proxy模式</li>
<li>kubectl edit cm kube-proxy -n kube-system #默认kube-proxy模式为iptables，可修改mode为ipvs，同时需要ipvs模块配置</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx</span><br><span class="line">  labels:</span><br><span class="line">        app: nginx-ds</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: my-nginx</span><br><span class="line">    image: nginx:1.7.9</span><br><span class="line">    ports:</span><br><span class="line">    - containerPort: 80</span><br><span class="line"></span><br><span class="line"># ipvs模块配置</span><br><span class="line">cat &gt; /etc/sysconfig/modules/ipvs.modules &lt;&lt;EOF</span><br><span class="line">#!/bin/bash </span><br><span class="line">modprobe -- ip_vs </span><br><span class="line">modprobe -- ip_vs_rr </span><br><span class="line">modprobe -- ip_vs_wrr </span><br><span class="line">modprobe -- ip_vs_sh </span><br><span class="line">modprobe -- nf_conntrack_ipv4 </span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">#配置开机自加载并执行生效</span><br><span class="line">chmod 755 /etc/sysconfig/modules/ipvs.modules &amp;&amp; bash /etc/sysconfig/modules/ipvs.modules</span><br><span class="line"></span><br><span class="line">#查看是否加载</span><br><span class="line">lsmod | grep -e ip_vs -e nf_conntrack_ipv4</span><br><span class="line"></span><br><span class="line">#重启kube-proxy</span><br><span class="line">kubectl get pod -n kube-system | grep kube-proxy |awk &apos;&#123;system(&quot;kubectl delete pod &quot;$1&quot; -n kube-system&quot;)&#125;&apos;</span><br></pre></td></tr></table></figure>

<h2 id="dashboard-1"><a href="#dashboard-1" class="headerlink" title="dashboard"></a>dashboard</h2><ul>
<li>kubectl apply -f dashboard.yaml</li>
<li>bash dashboardToken.sh # 默认只支持token登陆<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># dashboardToken.sh</span><br><span class="line">#!/bin/bash</span><br><span class="line">kubectl describe secret -n kubernetes-dashboard $(kubectl get secret -n kubernetes-dashboard | grep dashboard-token | awk &apos;&#123;print $1&#125;&apos;) | grep -E &apos;^token&apos; | awk &apos;&#123;print $2&#125;&apos;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h1 id="业务迁移到k8s"><a href="#业务迁移到k8s" class="headerlink" title="业务迁移到k8s"></a>业务迁移到k8s</h1><h2 id="harbor"><a href="#harbor" class="headerlink" title="harbor"></a>harbor</h2><ul>
<li><p>采用比较简单的高可用方案</p>
<ul>
<li>nginx做负载均衡</li>
<li>harbor原生安装方式部署2个节点提供服务</li>
</ul>
</li>
<li><p>部署</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"># 服务节点</span><br><span class="line">wget &apos;https://github.com/goharbor/harbor/releases/download/v1.9.4/harbor-offline-installer-v1.9.4.tgz&apos;</span><br><span class="line">tar xzvf harbor-offline-installer-v1.9.4.tgz</span><br><span class="line">cd harbor</span><br><span class="line"># 修改hostname为当前ip</span><br><span class="line">vi harbor.cfg</span><br><span class="line"># 查看镜像等文件目录是否在主机最大空间目录下</span><br><span class="line">vi docker-compose.yml </span><br><span class="line">sh install.sh</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># nginx</span><br><span class="line">vi nginx.conf</span><br><span class="line">user nginx;</span><br><span class="line">worker_processes 1;</span><br><span class="line">error_log /var/log/nginx/error.log warn;</span><br><span class="line">pid /var/run/nginx.pid;</span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">  worker_connections 1024;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">stream &#123;</span><br><span class="line">  upstream hub &#123;</span><br><span class="line">    server 10.18.3.181:80;</span><br><span class="line">  &#125;</span><br><span class="line">  server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    proxy_pass hub;</span><br><span class="line">	  proxy_timeout 300s;</span><br><span class="line">	  proxy_connect_timeout 5s;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"># restart.sh</span><br><span class="line">#!/bin/bash</span><br><span class="line">docker stop harbornginx &amp;&amp; docker rm harbornginx</span><br><span class="line">docker run -itd --net=host --name harbornginx -v /root/harbor/nginx.conf:/etc/nginx/nginx.conf nginx</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用harbor</p>
<ul>
<li>本地配置host文件，域名指向ip</li>
<li>登陆harbor并新建kubernetes项目</li>
<li>docker tag nginx:latest 域名/项目名/镜像名:TAG</li>
<li>docker push 域名/项目名/镜像名:TAG</li>
<li>报错https则在/etc/docker/daemon.json中添加insecure-registries:[“域名”]并重启docker</li>
<li>配置harbor的同步规则，使2个仓库进行实时同步</li>
</ul>
</li>
</ul>
<h2 id="服务发现"><a href="#服务发现" class="headerlink" title="服务发现"></a>服务发现</h2><ul>
<li>集群内相互访问<ul>
<li>ClusterIPService通过DNS把name解析成CluseterIP访问集群pod</li>
<li>客户端通过headlessService拿到集群endpoints然后客户端自己实现</li>
</ul>
</li>
<li>集群内访问集群外<ul>
<li>直接配置ip+port</li>
<li>空的service + 同名的endpoint自动绑定，endpoint里配置外部服务</li>
</ul>
</li>
<li>集群外访问集群内<ul>
<li>NodePortService</li>
<li>HostPortService(HostNetwork)</li>
<li>Ingress<ul>
<li>Ingress(host+path到service的配置信息)</li>
<li>IngressController(Ingress-nginx)<h2 id="部署ingress-nginx"><a href="#部署ingress-nginx" class="headerlink" title="部署ingress-nginx"></a>部署ingress-nginx</h2></li>
</ul>
</li>
</ul>
</li>
<li>wget <a href="https://raw.githubusercontent.com/kubernetes/ingress-nginx/nginx-0.27.0/deploy/static/mandatory.yaml" target="_blank" rel="noopener">https://raw.githubusercontent.com/kubernetes/ingress-nginx/nginx-0.27.0/deploy/static/mandatory.yaml</a></li>
<li>kubectl apply -f ingress-nginx-mandatory.yaml</li>
<li>kubectl get all -n ingress-nginx</li>
<li>wget <a href="https://raw.githubusercontent.com/kubernetes/ingress-nginx/nginx-0.27.0/deploy/static/provider/baremetal/service-nodeport.yaml" target="_blank" rel="noopener">https://raw.githubusercontent.com/kubernetes/ingress-nginx/nginx-0.27.0/deploy/static/provider/baremetal/service-nodeport.yaml</a></li>
<li>kubectl apply -f service-nodeport.yaml #暴露NodePort的80/443</li>
<li>kubectl label node m1 app=ingress #通过label限制HostPort</li>
<li>vi ingress-nginx-mandatory.yaml #暴露HostPort，deployment的spec.hostNetwork=true,spec.nodeSelector={app:ingress}</li>
<li>kubectl get all -n ingress-nginx</li>
<li>kubectl apply -f ingress-demo.yaml #测试<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: tomcat-demo</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: tomcat-demo</span><br><span class="line">  replicas: 1</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: tomcat-demo</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: tomcat-demo</span><br><span class="line">        image: tomcat:8.0.51-alpine</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 8080</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: tomcat-demo</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    app: tomcat-demo</span><br><span class="line">  ports:</span><br><span class="line">  - port: 80</span><br><span class="line">    protocol: TCP</span><br><span class="line">    targetPort: 8080</span><br><span class="line">    </span><br><span class="line">---</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: tomcat-demo</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: tomcat.test.com</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /</span><br><span class="line">        backend:</span><br><span class="line">          serviceName: tomcat-demo</span><br><span class="line">          servicePort: 80</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="定时任务迁移"><a href="#定时任务迁移" class="headerlink" title="定时任务迁移"></a>定时任务迁移</h2><h2 id="springboot迁移"><a href="#springboot迁移" class="headerlink" title="springboot迁移"></a>springboot迁移</h2><h2 id="dubbo迁移"><a href="#dubbo迁移" class="headerlink" title="dubbo迁移"></a>dubbo迁移</h2><h2 id="传统web迁移"><a href="#传统web迁移" class="headerlink" title="传统web迁移"></a>传统web迁移</h2><h1 id="cicd"><a href="#cicd" class="headerlink" title="cicd"></a>cicd</h1><h2 id="git"><a href="#git" class="headerlink" title="git"></a>git</h2><h2 id="maven"><a href="#maven" class="headerlink" title="maven"></a>maven</h2><h2 id="docker-build"><a href="#docker-build" class="headerlink" title="docker build"></a>docker build</h2><h2 id="harbor-1"><a href="#harbor-1" class="headerlink" title="harbor"></a>harbor</h2><h2 id="服务发布"><a href="#服务发布" class="headerlink" title="服务发布"></a>服务发布</h2><h2 id="健康检查"><a href="#健康检查" class="headerlink" title="健康检查"></a>健康检查</h2><h1 id="重要资源对象"><a href="#重要资源对象" class="headerlink" title="重要资源对象"></a>重要资源对象</h1><h2 id="namespace"><a href="#namespace" class="headerlink" title="namespace"></a>namespace</h2><h2 id="resources"><a href="#resources" class="headerlink" title="resources"></a>resources</h2><h2 id="label"><a href="#label" class="headerlink" title="label"></a>label</h2><h1 id="调度与编排"><a href="#调度与编排" class="headerlink" title="调度与编排"></a>调度与编排</h1><h2 id="健康检查-1"><a href="#健康检查-1" class="headerlink" title="健康检查"></a>健康检查</h2><h2 id="scheduler"><a href="#scheduler" class="headerlink" title="scheduler"></a>scheduler</h2><h2 id="部署策略"><a href="#部署策略" class="headerlink" title="部署策略"></a>部署策略</h2><h2 id="pod"><a href="#pod" class="headerlink" title="pod"></a>pod</h2><h1 id="落地实践"><a href="#落地实践" class="headerlink" title="落地实践"></a>落地实践</h1><h2 id="ingress"><a href="#ingress" class="headerlink" title="ingress"></a>ingress</h2><h2 id="共享存储pv-pvc-sc"><a href="#共享存储pv-pvc-sc" class="headerlink" title="共享存储pv/pvc/sc"></a>共享存储pv/pvc/sc</h2><h2 id="statefulset"><a href="#statefulset" class="headerlink" title="statefulset"></a>statefulset</h2><h2 id="k8sApi"><a href="#k8sApi" class="headerlink" title="k8sApi"></a>k8sApi</h2><h1 id="日志和监控"><a href="#日志和监控" class="headerlink" title="日志和监控"></a>日志和监控</h1><h2 id="日志方案"><a href="#日志方案" class="headerlink" title="日志方案"></a>日志方案</h2><h2 id="监控入门"><a href="#监控入门" class="headerlink" title="监控入门"></a>监控入门</h2><h2 id="部署实战"><a href="#部署实战" class="headerlink" title="部署实战"></a>部署实战</h2><h2 id="监控落地"><a href="#监控落地" class="headerlink" title="监控落地"></a>监控落地</h2><h1 id="istio"><a href="#istio" class="headerlink" title="istio"></a>istio</h1><h2 id="架构原理"><a href="#架构原理" class="headerlink" title="架构原理"></a>架构原理</h2><h2 id="核心组件"><a href="#核心组件" class="headerlink" title="核心组件"></a>核心组件</h2><h2 id="智能路由"><a href="#智能路由" class="headerlink" title="智能路由"></a>智能路由</h2><h2 id="指标收集和查询"><a href="#指标收集和查询" class="headerlink" title="指标收集和查询"></a>指标收集和查询</h2><h2 id="分布式追踪"><a href="#分布式追踪" class="headerlink" title="分布式追踪"></a>分布式追踪</h2><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2>
      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    

    </div>

    
  </div>
</article>


    </main>

    <footer class="site-footer">
  <p class="site-info">
    Proudly powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and
    Theme by <a href="https://github.com/CodeDaraW/Hacker" target="_blank">Hacker</a>
    </br>
    
    &copy; 2020 prief
    
  </p>
</footer>
    
  </div>
</div>
</body>
</html>