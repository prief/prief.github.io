<!DOCTYPE HTML>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  
  <title>prief | about share and go on</title>

  
  <meta name="author" content="prief">
  

  

  

  <meta id="viewport" name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  

  <meta property="og:site_name" content="prief">

  
  <meta property="og:image" content="/favicon.ico">
  

  <link href="/favicon.ico" rel="icon">
  <link rel="alternate" href="/atom.xml" title="prief" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
</head>


<body>
<div class="blog">
  <div class="content">

    <header>
  <div class="site-branding">
    <h1 class="site-title">
      <a href="/">prief</a>
    </h1>
    <p class="site-description">about share and go on</p>
  </div>
  <nav class="site-navigation">
    <ul>
      
        <li><a href="/">Home</a></li>
      
        <li><a href="/tags">Tags</a></li>
      
    </ul>
  </nav>
</header>

    <main class="site-main posts-loop">
    
  <article>

  
    
    <h3 class="article-title"><a href="/2020/02/28/fe/"><span>fe</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2020/02/28/fe/" rel="bookmark">
        <time class="entry-date published" datetime="2020-02-28T05:18:52.000Z">
          2020-02-28
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <h3 id="fe"><a href="#fe" class="headerlink" title="fe"></a>fe</h3><h4 id="js"><a href="#js" class="headerlink" title="js"></a>js</h4><ul>
<li>原始类型<ul>
<li>Boolean</li>
<li>String</li>
<li>Number</li>
<li>Undefined</li>
<li>Null</li>
<li>Symbol</li>
</ul>
</li>
<li>类型判断<ul>
<li>typeof<ul>
<li>undefined</li>
<li>boolean</li>
<li>string</li>
<li>number</li>
<li>function</li>
<li>object</li>
</ul>
</li>
<li>instanceof<ul>
<li>数组</li>
<li>自定义类</li>
</ul>
</li>
</ul>
</li>
<li>类型传递<ul>
<li>值类型按值传递<ul>
<li>Boolean</li>
<li>String</li>
<li>Number</li>
<li>Undefined</li>
<li>Null</li>
</ul>
</li>
<li>引用类型按共享传递<ul>
<li>Object</li>
<li>Function</li>
<li>Array</li>
<li>Date</li>
</ul>
</li>
</ul>
</li>
<li>原型和原型链<ul>
<li>引用类型都有对象的特性，可自由扩展属性</li>
<li>引用类型都有一个<strong>proto</strong>属性指向原型对象</li>
<li>所有的函数都有prototype属性指向原型对象</li>
<li>引用类型的<strong>proto</strong>指向它构造函数的prototype</li>
<li>当试图得到一个对象的某个属性时如果本身没有则去<strong>proto</strong>上寻找形成原型链</li>
</ul>
</li>
<li>作用域和作用域链<ul>
<li>全局作用域</li>
<li>函数作用域</li>
<li>ES6后增加块级作用域</li>
<li>当前作用域中没有的变量称为自由变量，自由变量向父级作用域寻值，形成作用域链</li>
</ul>
</li>
</ul>
<h4 id="css"><a href="#css" class="headerlink" title="css"></a>css</h4><ul>
<li>选择器权重和优先级<ul>
<li>!important</li>
<li>内联样式</li>
<li>ID选择器</li>
<li>类、伪类、属性选择器</li>
<li>元素选择器</li>
</ul>
</li>
<li>盒子模型<ul>
<li>margin</li>
<li>border</li>
<li>padding</li>
<li>content</li>
<li>分类<ul>
<li>border-box</li>
<li>content-box</li>
</ul>
</li>
</ul>
</li>
<li>position<ul>
<li>static</li>
<li>relative</li>
<li>absolute</li>
<li>fixed</li>
</ul>
</li>
<li>flex<ul>
<li>container<ul>
<li>flex-direction</li>
<li>justify-content</li>
<li>align-items</li>
</ul>
</li>
<li>item</li>
</ul>
</li>
<li>重绘和回流<ul>
<li>重绘<ul>
<li>简单的进行样式的变化，如颜色、背景等，不影响几何信息</li>
<li>开销小</li>
</ul>
</li>
<li>回流（重排）<ul>
<li>DOM中的尺寸大小几何信息，位置信息发生变化导致重新渲染</li>
<li>开销大</li>
<li>getComputedStyle/currentStyle获取即时属性值的操作也会触发回流</li>
</ul>
</li>
<li>避免<ul>
<li>缓存DOM对象</li>
<li>避免逐条修改样式，使用类名合并</li>
<li>将DOM离线后操作不会有性能问题，操作完毕后上线display:none/block;</li>
<li>现代浏览器会维护一个flush队列，在不得已的时候会执行队列</li>
</ul>
</li>
</ul>
</li>
<li>1px线实现方式<ul>
<li>渐变</li>
<li>缩放</li>
<li>图片(base64/svg)</li>
</ul>
</li>
<li>图片保真<ul>
<li>统一使用最高倍图，但浪费带宽</li>
<li>srcset属性</li>
</ul>
</li>
<li>字体适配<ul>
<li>默认最小限制<ul>
<li>PC上是12px</li>
<li>手机上是8px</li>
</ul>
</li>
<li>不建议使用奇数数值，容易在低端手机上出现锯齿</li>
<li>尽量使用默认系统字体</li>
<li>font-family取值<ul>
<li>具体字体名称</li>
<li>通用类别<ul>
<li>serif 衬线字体族</li>
<li>sans-serif 非衬线字体族</li>
<li>monospace 等宽字体</li>
<li>cursive 草书字体</li>
<li>fantasy 艺术字体</li>
<li>systme-ui 系统默认字体</li>
<li>emoji 兼容表情符号</li>
<li>math 数学表达式</li>
<li>fangsong 仿宋</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="算法"><a href="#算法" class="headerlink" title="算法"></a>算法</h4><ul>
<li>程序<ul>
<li>数据</li>
<li>算法</li>
</ul>
</li>
<li>数据结构<ul>
<li>简单数据结构<ul>
<li>有序数据结构：栈、队列、链表，省空间，存储空间小</li>
<li>无序数据结构：字典、集合、散列集，省时间，读取时间快</li>
</ul>
</li>
<li>高级数据结构<ul>
<li>树、堆</li>
<li>图</li>
</ul>
</li>
</ul>
</li>
<li>常见算法<ul>
<li>递归</li>
<li>排序</li>
<li>枚举</li>
</ul>
</li>
<li>算法复杂度<ul>
<li>时间复杂度（好估算、好评估）<ul>
<li>常数阶O(1) #每行一次性的语句就是常数阶</li>
<li>线性阶O(n)</li>
<li>平方阶O(n^2)</li>
<li>立方阶O(n^3)</li>
<li>k次方阶O(n^k)</li>
<li>指数阶O(2^n)</li>
<li>对数阶O(logN)</li>
<li>线性对数阶O(nlogN)</li>
</ul>
</li>
<li>空间复杂度</li>
<li>分析技巧<ul>
<li>几重循环，一般就是1层循环就是O(n)，两重循环就是O(n^2)</li>
<li>如果有二分，则为O(logN)</li>
<li>每行一次性的语句则为1</li>
<li>所有行的复杂度相加后除去常数即得复杂度</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="浏览器相关"><a href="#浏览器相关" class="headerlink" title="浏览器相关"></a>浏览器相关</h4><ul>
<li>加载过程<ul>
<li>DNS解析</li>
<li>TCP连接</li>
<li>HTTP请求</li>
<li>HTTP响应</li>
<li>客户端渲染<ul>
<li>根据html生成DOM</li>
<li>根据css生成CSSOM</li>
<li>DOM和CSSOM整合生成RenderTree</li>
<li>布局合成 、绘制渲染</li>
<li>遇到script会阻塞渲染，因为js执行和浏览器渲染共用一个线程</li>
</ul>
</li>
</ul>
</li>
<li>性能优化<ul>
<li>减少页面体积，提升网络加载<ul>
<li>静态资源压缩、合并</li>
<li>静态资源缓存</li>
<li>使用CDN</li>
</ul>
</li>
<li>优化页面渲染<ul>
<li>css放前、js放后</li>
<li>懒加载</li>
<li>减少DOM操作</li>
<li>事件节流</li>
<li>SSR</li>
</ul>
</li>
</ul>
</li>
<li>web安全<ul>
<li>SQL注入</li>
<li>XSS</li>
<li>CSRF</li>
</ul>
</li>
</ul>
<h4 id="性能优化"><a href="#性能优化" class="headerlink" title="性能优化"></a>性能优化</h4><ul>
<li><p>DNS解析</p>
<ul>
<li>浏览器DNS缓存</li>
<li>DNS prefetch</li>
</ul>
</li>
<li><p>TCP连接</p>
<ul>
<li>长连接</li>
<li>预连接</li>
<li>接入SPDY协议</li>
</ul>
</li>
<li><p>HTTP请求</p>
<ul>
<li>减少次数（loader中的exclude、三方库DllPlugin/DllReferencePlugin）</li>
<li>减少体积（webpack-bundle-analyzer、代码压缩混淆、gzip、tree-shaking、按需加载）</li>
<li>CDN<ul>
<li>content delivery network</li>
<li>2大功能<ul>
<li>缓存</li>
<li>回源</li>
</ul>
</li>
<li>CDN域名和业务服务域名一定要分开，避免cookie无用传输</li>
</ul>
</li>
<li>Gzip<ul>
<li>gzip的内核就是Deflate</li>
<li>通常能减小70%的体积</li>
<li>原理就是把内容中重复的字符串临时替换，使整个文件变小，所以重复率越高，收益越好</li>
<li>nginx等代理文件中可以配置index.js/index.js.gz 以减少cpu临时压缩的消耗</li>
</ul>
</li>
<li>图片优化<ul>
<li>JPEG/JPG 有损压缩、体积小、色彩丰富，常用轮播图，不支持透明</li>
<li>PNG 无损压缩、质量高、支持透明，常用单色小图logo，体积大<ul>
<li>PNG-8  二进制的位数8，最多支持256种颜色</li>
<li>PNG-24 二进制的位数24，最多支持1600万种颜色</li>
</ul>
</li>
<li>SVG<ul>
<li>文本文件</li>
<li>体积小、不失真、可压缩</li>
<li>对图像的处理不是基于像素，而是基于对图像的描述</li>
<li>可以放到HTML的DOM中，也可以单独保存.svg文件</li>
<li>渲染成本比较高，性能要求比较高</li>
</ul>
</li>
<li>Base64<ul>
<li>文本文件</li>
<li>依赖编码，小图标解决方案</li>
<li>编码后，体积会增大1/3</li>
</ul>
</li>
<li>WebP<ul>
<li>年轻的全能选手</li>
<li>支持有损和无损压缩</li>
<li>支持透明、支持动态图、支持丰富的色彩、体积比较小</li>
<li>兼容性比较差，编码时比jpg需要更多计算资源</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p>渲染</p>
<ul>
<li>SSR<ul>
<li>SEO</li>
<li>首屏白屏</li>
</ul>
</li>
<li>CSS</li>
<li>JSji</li>
<li>DOM</li>
<li>懒加载</li>
<li>事件节流和防抖</li>
<li>回流和重绘</li>
</ul>
</li>
<li><p>浏览器引擎</p>
<ul>
<li>渲染引擎（内核）<ul>
<li>功能部件<ul>
<li>html解释器，将html输出DOM</li>
<li>css解释器，将css输出CSSOM</li>
<li>布局绘制，合成renderTree</li>
<li>网络</li>
<li>存储</li>
<li>图形、图片解码器</li>
<li>音视频</li>
</ul>
</li>
<li>常见分类<ul>
<li>Trident（IE）</li>
<li>Gecko（Firefox）</li>
<li>Blink（Chrome、Opera）是webkit的一个分支</li>
<li>Webkit（Safari）</li>
</ul>
</li>
<li>优化<ul>
<li>css<ul>
<li>css解释器对每条规则都按从右到左的顺序去匹配，因此要减少选择器嵌套</li>
<li>避免使用通配符，只对需要用到的元素进行选择</li>
<li>css是阻塞渲染的资源，需要尽早加载，尽早渲染，把css往前放</li>
</ul>
</li>
<li>js<ul>
<li>默认的js也会阻塞DOM和CSSOM，因为可能会操作DOM</li>
<li>async模式加载js不会阻塞浏览器，异步加载js，加载完毕后立即执行</li>
<li>defer模式加载js不会阻塞浏览器，异步加载js，加载完毕后延迟到DOMContentLoaded后执行</li>
</ul>
</li>
<li>DOM<ul>
<li>对DOM的修改引发了DOM几何尺寸的变化，浏览器都要重新计算几何属性，再将结果绘制出来，即回流重排</li>
<li>对DOM的修改没有引发几何尺寸的变化，不需要重新计算几何属性，跳过重排直接执行重绘</li>
<li>减少DOM的访问和操作</li>
<li>必要的DOM操作可以使用DocumentFragment，不会有性能问题</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>js引擎<ul>
<li>异步队列<ul>
<li>micro-task<ul>
<li>process.nextTick</li>
<li>promise</li>
<li>MutationObserver</li>
</ul>
</li>
<li>macro-task<ul>
<li>setTimeout</li>
<li>setInteral</li>
<li>setImmediate</li>
<li>IO操作</li>
</ul>
</li>
</ul>
</li>
<li>执行过程<ul>
<li>将一个macro-task执行并出队</li>
<li>将一对micro-task执行并出对</li>
<li>执行渲染，更新界面</li>
<li>处理worker相关的任务</li>
<li>循环，当我们需要在异步任务中实现DOM修改时，把它包装成micro-task是明智的选择</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p>浏览器缓存</p>
<ul>
<li><p>MemoryCache</p>
<ul>
<li>本着节约内存的原则，一般较小的资源有几率入内存</li>
</ul>
</li>
<li><p>ServiceWorkerCache 离线缓存</p>
<ul>
<li>脱离主线程之外的独立线程</li>
<li>不能操作DOM，只能做些js的计算，数据的请求</li>
<li>serviceWorker生命周期<ul>
<li>install</li>
<li>active</li>
<li>working</li>
</ul>
</li>
</ul>
</li>
<li><p>HTTPCache</p>
<ul>
<li>强缓存（200）<ul>
<li>expires（http1.0,依赖本地时间）</li>
<li>cache-control(http1.1,完全替代expires，优先级高)<ul>
<li>max-age=31536000(有效时间长度，单位秒)</li>
<li>s-maxage优先级高于max-age，只在代理服务器上有效</li>
<li>public可以被客户端和代理服务器缓存，private只能被客户端缓存，默认private</li>
<li>no-cache 忽略所有客户端缓存，与服务器协商缓存</li>
<li>no-store 忽略所有缓存，包括协商缓存，直接请求资源</li>
</ul>
</li>
</ul>
</li>
<li>协商缓存（304）<ul>
<li>Last-Modified/If-Modified-Since（时间戳）<ul>
<li>只是更新了文件的元信息，比如touch了文件一下，也会造成更新</li>
<li>时间粒度只能到秒，如果1秒内完成了内容的变更，却不会更新</li>
</ul>
</li>
<li>ETag/If-None-Match<ul>
<li>解决上述2个问题</li>
<li>基于文件内容为资源编码的唯一字符串标示</li>
<li>因为ETag的生成要耗费服务器资源，所以是上面的补充，不能完全替代，优先级高于上面<img src="/2020/02/28/fe/http协商缓存响应头设置流程.png" title="http协商缓存响应头设置流程">
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p>PushCache </p>
<ul>
<li>http2的特性</li>
<li>是缓存的最后一道防线，在上面3种缓存都未命中的情况下才会询问PushCache</li>
<li>不同的页面共享了一个http2连接，就共享同一个PushCache</li>
<li>会话级的缓存，session关闭，缓存失效</li>
</ul>
</li>
</ul>
</li>
<li><p>本地存储</p>
<ul>
<li>cookie<ul>
<li>状态维持，解决http无状态的问题</li>
<li>体积限制，最大4k</li>
<li>流量消耗</li>
</ul>
</li>
<li>storage<ul>
<li>localStorage 永久有效</li>
<li>sessionStorage 会话级有效</li>
</ul>
</li>
<li>IndexedDB<ul>
<li>非关系型数据库<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">var db;</span><br><span class="line">// 参数1位数据库名，参数2为版本号</span><br><span class="line">const request = window.indexedDB.open(&quot;name&quot;, 1)</span><br><span class="line">// 使用IndexedDB失败时的监听函数</span><br><span class="line">request.onerror = function(event) &#123;</span><br><span class="line">  console.log(&apos;无法使用IndexedDB&apos;)</span><br><span class="line">&#125;</span><br><span class="line">// 成功</span><br><span class="line">request.onsuccess  = function(event)&#123;</span><br><span class="line">  // 此处就可以获取到db实例</span><br><span class="line">  db = event.target.result</span><br><span class="line">  console.log(&quot;你打开了IndexedDB&quot;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// onupgradeneeded事件会在初始化数据库/版本发生更新时被调用，我们在它的监听函数中创建object store</span><br><span class="line">request.onupgradeneeded = function(event)&#123;</span><br><span class="line">  let objectStore</span><br><span class="line">  // 如果同名表未被创建过，则新建test表</span><br><span class="line">  if (!db.objectStoreNames.contains(&apos;test&apos;)) &#123;</span><br><span class="line">    objectStore = db.createObjectStore(&apos;test&apos;, &#123; keyPath: &apos;id&apos; &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line">  // 创建事务，指定表格名称和读写权限</span><br><span class="line">  const transaction = db.transaction([&quot;test&quot;],&quot;readwrite&quot;)</span><br><span class="line">  // 拿到Object Store对象</span><br><span class="line">  const objectStore = transaction.objectStore(&quot;test&quot;)</span><br><span class="line">  // 向表格写入数据</span><br><span class="line">  objectStore.add(&#123;id: 1, name: &apos;test1&apos;&#125;)</span><br><span class="line"></span><br><span class="line">  // 操作成功时的监听函数</span><br><span class="line">  transaction.oncomplete = function(event) &#123;</span><br><span class="line">    console.log(&quot;操作成功&quot;)</span><br><span class="line">  &#125;</span><br><span class="line">  // 操作失败时的监听函数</span><br><span class="line">  transaction.onerror = function(event) &#123;</span><br><span class="line">    console.log(&quot;这里有一个Error&quot;)</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
</li>
</ul>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">// lazyload</span><br><span class="line">// 获取所有的图片标签</span><br><span class="line">const imgs = document.getElementsByTagName(&apos;img&apos;)</span><br><span class="line">// 获取可视区域的高度</span><br><span class="line">const viewHeight = window.innerHeight || document.documentElement.clientHeight</span><br><span class="line">// num用于统计当前显示到了哪一张图片，避免每次都从第一张图片开始检查是否露出</span><br><span class="line">let num = 0</span><br><span class="line">function lazyload()&#123;</span><br><span class="line">    for(let i=num; i&lt;imgs.length; i++) &#123;</span><br><span class="line">        // 用可视区域高度减去元素顶部距离可视区域顶部的高度</span><br><span class="line">        let distance = viewHeight - imgs[i].getBoundingClientRect().top</span><br><span class="line">        // 如果可视区域高度大于等于元素顶部距离可视区域顶部的高度，说明元素露出</span><br><span class="line">        if(distance &gt;= 0 )&#123;</span><br><span class="line">            // 给元素写入真实的src，展示图片</span><br><span class="line">            imgs[i].src = imgs[i].getAttribute(&apos;data-src&apos;)</span><br><span class="line">            // 前i张图片已经加载完毕，下次从第i+1张开始检查是否露出</span><br><span class="line">            num = i + 1</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">// 监听Scroll事件</span><br><span class="line">window.addEventListener(&apos;scroll&apos;, lazyload, false);</span><br><span class="line"></span><br><span class="line">// fn是我们需要包装的事件回调, delay是时间间隔的阈值</span><br><span class="line">function throttle(fn, delay) &#123;</span><br><span class="line">  // last为上一次触发回调的时间, timer是定时器</span><br><span class="line">  let last = 0, timer = null</span><br><span class="line">  // 将throttle处理结果当作函数返回</span><br><span class="line">  </span><br><span class="line">  return function () &#123; </span><br><span class="line">    // 保留调用时的this上下文</span><br><span class="line">    let context = this</span><br><span class="line">    // 保留调用时传入的参数</span><br><span class="line">    let args = arguments</span><br><span class="line">    // 记录本次触发回调的时间</span><br><span class="line">    let now = +new Date()</span><br><span class="line">    </span><br><span class="line">    // 判断上次触发的时间和本次触发的时间差是否小于时间间隔的阈值</span><br><span class="line">    if (now - last &lt; delay) &#123;</span><br><span class="line">    // 如果时间间隔小于我们设定的时间间隔阈值，则为本次触发操作设立一个新的定时器</span><br><span class="line">       clearTimeout(timer)</span><br><span class="line">       timer = setTimeout(function () &#123;</span><br><span class="line">          last = now</span><br><span class="line">          fn.apply(context, args)</span><br><span class="line">        &#125;, delay)</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        // 如果时间间隔超出了我们设定的时间间隔阈值，那就不等了，无论如何要反馈给用户一次响应</span><br><span class="line">        last = now</span><br><span class="line">        fn.apply(context, args)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 用新的throttle包装scroll的回调</span><br><span class="line">const better_scroll = throttle(() =&gt; console.log(&apos;触发了滚动事件&apos;), 1000)</span><br><span class="line">document.addEventListener(&apos;scroll&apos;, better_scroll)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// throttle</span><br><span class="line">// fn是我们需要包装的事件回调, interval是时间间隔的阈值</span><br><span class="line">function throttle(fn, interval) &#123;</span><br><span class="line">  // last为上一次触发回调的时间</span><br><span class="line">  let last = 0</span><br><span class="line">  </span><br><span class="line">  // 将throttle处理结果当作函数返回</span><br><span class="line">  return function () &#123;</span><br><span class="line">      // 保留调用时的this上下文</span><br><span class="line">      let context = this</span><br><span class="line">      // 保留调用时传入的参数</span><br><span class="line">      let args = arguments</span><br><span class="line">      // 记录本次触发回调的时间</span><br><span class="line">      let now = +new Date()</span><br><span class="line">      </span><br><span class="line">      // 判断上次触发的时间和本次触发的时间差是否小于时间间隔的阈值</span><br><span class="line">      if (now - last &gt;= interval) &#123;</span><br><span class="line">      // 如果时间间隔大于我们设定的时间间隔阈值，则执行回调</span><br><span class="line">          last = now;</span><br><span class="line">          fn.apply(context, args);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">// 用throttle来包装scroll的回调</span><br><span class="line">const better_scroll = throttle(() =&gt; console.log(&apos;触发了滚动事件&apos;), 1000)</span><br><span class="line">document.addEventListener(&apos;scroll&apos;, better_scroll)</span><br><span class="line"></span><br><span class="line">// fn是我们需要包装的事件回调, delay是每次推迟执行的等待时间</span><br><span class="line">function debounce(fn, delay) &#123;</span><br><span class="line">  // 定时器</span><br><span class="line">  let timer = null</span><br><span class="line">  </span><br><span class="line">  // 将debounce处理结果当作函数返回</span><br><span class="line">  return function () &#123;</span><br><span class="line">    // 保留调用时的this上下文</span><br><span class="line">    let context = this</span><br><span class="line">    // 保留调用时传入的参数</span><br><span class="line">    let args = arguments</span><br><span class="line"></span><br><span class="line">    // 每次事件被触发时，都去清除之前的旧定时器</span><br><span class="line">    if(timer) &#123;</span><br><span class="line">        clearTimeout(timer)</span><br><span class="line">    &#125;</span><br><span class="line">    // 设立新定时器</span><br><span class="line">    timer = setTimeout(function () &#123;</span><br><span class="line">      fn.apply(context, args)</span><br><span class="line">    &#125;, delay)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 用debounce来包装scroll的回调</span><br><span class="line">const better_scroll = debounce(() =&gt; console.log(&apos;触发了滚动事件&apos;), 1000)</span><br><span class="line">document.addEventListener(&apos;scroll&apos;, better_scroll)</span><br></pre></td></tr></table></figure>

<ul>
<li>性能监测<ul>
<li>可视化工具<ul>
<li>Performance</li>
<li>LightHouse</li>
</ul>
</li>
<li>性能api<ul>
<li>performance</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="技能分层"><a href="#技能分层" class="headerlink" title="技能分层"></a>技能分层</h4><ul>
<li><p>基础页面开发（pc网页）</p>
<ul>
<li>设计稿审查<ul>
<li>确定设计稿的开发友好性（是否有还原成本高和无法实现的地方）</li>
<li>特殊元素是否有合理的边界处理（如文案超出外层容器怎么办）</li>
<li>确定页面的框架结构（layout）</li>
<li>识别可复用的组件（跨页面可复用/当前页面可复用）</li>
</ul>
</li>
<li>编写页面骨骼框架<ul>
<li>盒模型统一 box-sizing:border-box;</li>
<li>布局<ul>
<li>普通文档流</li>
<li>浮动布局</li>
<li>绝对布局</li>
<li>弹性布局</li>
<li>网格布局</li>
</ul>
</li>
</ul>
</li>
<li>填充网页内容</li>
<li>润色<ul>
<li>BEM <ul>
<li>基于组件的css命名规范</li>
<li>block模块，模块名字的单词之间用-连接</li>
<li>element元素，模块中的子元素，用__连接模块名</li>
<li>modifier修饰符，元素的其他形态，用–连接</li>
<li>B-B__E–M</li>
</ul>
</li>
</ul>
</li>
<li>兼容性测试<ul>
<li>html兼容性</li>
<li>css兼容性</li>
<li>js兼容性</li>
</ul>
</li>
</ul>
</li>
<li><p>响应式页面开发（移动端网页） </p>
<ul>
<li>目标<ul>
<li>为不同的浏览器窗口使用不同的样式代码</li>
<li>页面元素的尺寸能够依据浏览器窗口变化而平滑变化</li>
</ul>
</li>
<li>步骤<ul>
<li>添加vierport的meta标签</li>
<li>使用mediaQuery <ul>
<li>@media(min|max-width|height orientation)</li>
<li>两种方式<ul>
<li>style代码里@media (){}</li>
<li><link media="(min-width: 769px)" href="min-769.css"></li>
</ul>
</li>
<li>样式断点，参考bulma框架<ul>
<li>mobile</li>
<li>tablet 769</li>
<li>desktop 1024</li>
<li>widescreen 1216</li>
<li>fullhd 1408</li>
</ul>
</li>
</ul>
</li>
<li>使用viewport单位和rem 解决元素的尺寸能响应变化<ul>
<li>使用vw作为唯一单位<ul>
<li>sass函数将设计稿尺寸的像素单位转换为vw单位</li>
<li>所有尺寸全部转换为vw包括文字</li>
<li>1px使用transform的scale实现<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">// iPhone 6尺寸作为设计稿基准</span><br><span class="line">$vw_base: 375; </span><br><span class="line">@function vw($px) &#123;</span><br><span class="line">    @return ($px / $vm_base) * 100vw;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p>滑屏应用开发（活动营销页面）</p>
</li>
<li><p>动效开发（活动营销页面）</p>
</li>
</ul>
<h4 id="软技能"><a href="#软技能" class="headerlink" title="软技能"></a>软技能</h4><ul>
<li>健身</li>
<li>理财</li>
<li>韧性</li>
<li>责任心</li>
<li>持续学习能力</li>
<li>团队合作能力</li>
<li>交流沟通能力</li>
</ul>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    

    </div>

    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2020/02/22/web-sec/"><span>web-sec</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2020/02/22/web-sec/" rel="bookmark">
        <time class="entry-date published" datetime="2020-02-22T04:36:13.000Z">
          2020-02-22
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <h2 id="基础"><a href="#基础" class="headerlink" title="基础"></a>基础</h2><h3 id="安全问题"><a href="#安全问题" class="headerlink" title="安全问题"></a>安全问题</h3><ul>
<li>服务端<ul>
<li>SQL注入</li>
<li>命令注入</li>
<li>文件上传</li>
<li>暴力破解</li>
</ul>
</li>
<li>客户端<ul>
<li>XSS</li>
<li>CSRF</li>
<li>点击劫持</li>
<li>URL跳转</li>
<li>钓鱼 仿冒官网进行信息获取</li>
<li>暗链 植入灰黑产业的链接，用户不可见，但可以提高排名</li>
<li>webshell 通过网页部署后门程序，执行非法命令</li>
</ul>
</li>
</ul>
<h3 id="web基础"><a href="#web基础" class="headerlink" title="web基础"></a>web基础</h3><ul>
<li>URL规范<ul>
<li>schema://</li>
<li>username:password@</li>
<li>hostname:port/</li>
<li>path?</li>
<li>querystring#</li>
<li>anchor</li>
</ul>
</li>
<li>HTTP报文<ul>
<li>头行</li>
<li>头部</li>
<li>空行</li>
<li>主体</li>
</ul>
</li>
<li>SQL<ul>
<li>order by FIELD/index ASC/DESC，默认升序</li>
<li>select * from t1 union select * from t2 默认合并重复</li>
<li>select * from t1 union all select * from t2 不合并重复</li>
<li>注释 <ul>
<li><h1 id="内容"><a href="#内容" class="headerlink" title="内容"></a>内容</h1></li>
<li>– 内容 </li>
<li>/* 内容 */</li>
</ul>
</li>
<li>内置命令<ul>
<li>source file #导入sql文件</li>
<li>select current_user #显示当前用户</li>
<li>select load_file(PATH) #显示文件内容</li>
</ul>
</li>
</ul>
</li>
<li>PHP<ul>
<li>脚本范围 <?php 内容 ?></li>
<li>注释<ul>
<li>// 内容</li>
<li><h1 id="内容-1"><a href="#内容-1" class="headerlink" title="内容"></a>内容</h1></li>
<li>/* 内容 */</li>
</ul>
</li>
<li>echo 可以用，一次可以输入多个变量</li>
<li>print 一次只能输出一个变量，有返回值</li>
<li>$var表示变量，区分大小写</li>
<li>引入外部php文件<ul>
<li>include 当脚本错误时，只是警告，继续执行</li>
<li>require 当脚本错误时，停止脚本执行</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="安全漏洞"><a href="#安全漏洞" class="headerlink" title="安全漏洞"></a>安全漏洞</h2><h3 id="XSS"><a href="#XSS" class="headerlink" title="XSS"></a>XSS</h3><ul>
<li>cross site scripting 跨站脚本攻击</li>
<li>分类<br>XSS类型 ｜ 存储型 ｜ 反射型 ｜ DOM型</li>
<li>– ｜ — ｜ — ｜—<br>触发过程 ｜ 黑客构造XSS后用户访问XSS页面 ｜ 用户访问XSS页面 ｜ 用户访问XSS页面<br>数据存储 ｜ 数据库 ｜ URL ｜ URL的hash中<br>谁来输出 ｜ 后端WEB程序 ｜ 后端WEB程序 ｜ 前端JS<br>输出位置 ｜ HTTP响应 ｜ HTTP响应 ｜ 动态构造的DOM</li>
</ul>
<h3 id="CSRF"><a href="#CSRF" class="headerlink" title="CSRF"></a>CSRF</h3><ul>
<li>cross site request forgery 跨站请求伪造</li>
<li>在用户登陆的情况下以不知情的方式执行非法操作</li>
</ul>
<h3 id="点击劫持"><a href="#点击劫持" class="headerlink" title="点击劫持"></a>点击劫持</h3><ul>
<li>通过覆盖不可见的iframe引导用户点击操作的恶意行为</li>
<li>也称UI覆盖攻击</li>
</ul>
<h3 id="URL跳转漏洞"><a href="#URL跳转漏洞" class="headerlink" title="URL跳转漏洞"></a>URL跳转漏洞</h3><ul>
<li>借助未验证的URL跳转，把非法的URL嫁接到安全的URL后引导用户到非法网站</li>
<li>如img.alipay.com/sys/html/wait.html?goto=恶意网址</li>
<li>现在的短网址更隐蔽</li>
<li>方式<ul>
<li>header头的location</li>
<li>meta标签的refresh,url</li>
<li>js的location.href </li>
</ul>
</li>
</ul>
<h3 id="SQL注入"><a href="#SQL注入" class="headerlink" title="SQL注入"></a>SQL注入</h3><ul>
<li>SQL injection</li>
<li>万能密码<ul>
<li>利用’ –进行字符串的闭合和注释进行攻击</li>
<li>本质就是SQL注入的利用方式</li>
</ul>
</li>
<li>原理<ul>
<li>数据当作了代码来执行</li>
<li>本质就是数据和代码未分离</li>
</ul>
</li>
</ul>
<h3 id="命令注入"><a href="#命令注入" class="headerlink" title="命令注入"></a>命令注入</h3><ul>
<li>必要条件<ul>
<li>调用可执行系统命令的函数(system/eval…)</li>
<li>函数或函数的参数可控</li>
<li>拼接命令注入</li>
</ul>
</li>
</ul>
<h3 id="文件操作漏洞"><a href="#文件操作漏洞" class="headerlink" title="文件操作漏洞"></a>文件操作漏洞</h3><ul>
<li>上传漏洞<ul>
<li>正常的有上传头像、附件的上传功能</li>
<li>上传webShell</li>
<li>上传木马</li>
</ul>
</li>
<li>下载漏洞<ul>
<li>下载系统任意文件</li>
<li>下载程序代码</li>
</ul>
</li>
</ul>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    

    </div>

    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2020/02/17/vue/"><span>vue</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2020/02/17/vue/" rel="bookmark">
        <time class="entry-date published" datetime="2020-02-17T04:10:54.000Z">
          2020-02-17
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <h2 id="cli"><a href="#cli" class="headerlink" title="cli"></a>cli</h2><ul>
<li>features<ul>
<li>babel</li>
<li>ts</li>
<li>pwa</li>
<li>router</li>
<li>vuex</li>
<li>cssPreProcessor</li>
<li>linter/formatter</li>
<li>unitTesting</li>
<li>e2eTesting</li>
</ul>
</li>
<li>dir<ul>
<li>node_modules</li>
<li>public<ul>
<li>favicon.ico</li>
<li>index.html</li>
</ul>
</li>
<li>src<ul>
<li>assets</li>
<li>components</li>
<li>router</li>
<li>store</li>
<li>views</li>
<li>main.js</li>
<li>App.vue</li>
</ul>
</li>
<li>tests<ul>
<li>unit</li>
<li>e2e</li>
</ul>
</li>
<li>.gitignore</li>
<li>.postcssrc.js</li>
<li>.eslintrc.js</li>
<li>.browserslistrc        </li>
<li>babel.config.js</li>
<li>package.json</li>
<li>package-lock.json</li>
<li>README.md</li>
</ul>
</li>
<li>ext<ul>
<li>npm/yarm</li>
<li>webpack</li>
<li>环境配置</li>
<li>接口配置</li>
<li>单页应用</li>
<li>多页应用</li>
<li>实用工具</li>
<li>开发技巧</li>
</ul>
</li>
</ul>
<h2 id="browserlist"><a href="#browserlist" class="headerlink" title="browserlist"></a>browserlist</h2><ul>
<li>目标浏览器列表，给所有插件共享如autoprefixer等 </li>
<li>可以写单独的.browserslistrc文件也可写在package.json.browserslist中</li>
<li>最终的数据来源于CanIUse</li>
<li>可以在项目中运行npx browserslist进行查看</li>
</ul>
<h2 id="env环境"><a href="#env环境" class="headerlink" title="env环境"></a>env环境</h2><ul>
<li>环境<ul>
<li>公共配置</li>
<li>开发环境配置</li>
<li>测试环境配置</li>
<li>生产环境配置</li>
</ul>
</li>
<li>推荐使用js文件进行config配置，可以支持动态参数/变量等</li>
</ul>
<h2 id="单页应用配置"><a href="#单页应用配置" class="headerlink" title="单页应用配置"></a>单页应用配置</h2><ul>
<li>路由配置<ul>
<li>如果路由存在二级目录，需要添加base属性值否则默认/</li>
<li>默认路由模式为hash，可修改history</li>
<li>路由组件可以进行懒加载 component:()=&gt;import(/* webpackChunkName: “name” */ “path2vue”)</li>
</ul>
</li>
<li>vuex配置<ul>
<li>通过 actions 异步提交 mutations 去 修改 state 的值并通过 getter 获取</li>
<li>大型项目目录<ul>
<li>index.js #组装模块并导出store<ul>
<li>state</li>
<li>mutations</li>
<li>actions</li>
<li>getters</li>
<li>modules</li>
</ul>
</li>
<li>actions.js #根级别的action</li>
<li>mutations.js #跟级别的mutation</li>
<li>modules<ul>
<li>moduleA.js A模块<ul>
<li>state</li>
<li>mutations</li>
<li>actions</li>
<li>getters</li>
</ul>
</li>
<li>moduleB.js B模块</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>接口配置<ul>
<li>目录<ul>
<li>src<ul>
<li>services<ul>
<li>index.js #接口封装</li>
<li>moduleA.js #模块A接口</li>
<li>moduleB.js #模块B接口</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>devServer配置proxy<ul>
<li>moduleX.js中一般不配置host</li>
<li>devServer.proxy.PATTERN.target代理目标地址</li>
</ul>
</li>
</ul>
</li>
<li>公共设施配置<ul>
<li>封装公共的方法等</li>
<li>目录<ul>
<li>src<ul>
<li>common<ul>
<li>index.js #公共配置入口，统一向外暴露</li>
<li>validate.js #表单验证</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>多页应用配置<ul>
<li>entries</li>
<li>htmlWebpackPlugin</li>
<li>上面2个分开的配置也可以统一使用pages配置</li>
<li>多页间路由跳转必须使用location的原生方法，可以封装到Vue原型链上</li>
<li>多页间路由跳转需要注意historyApi前后端配置</li>
<li>模版配置时需要注意inject的值防止重复注入</li>
<li>模块配置可以通过htmlWebpackPlugin.options添加自定义配置</li>
</ul>
</li>
<li>webpack配置<ul>
<li>alias解决复杂路径问题，css/html中需要~</li>
<li>CompressionWebpackPlugin进行压缩如gzip</li>
</ul>
</li>
</ul>
<h2 id="编码"><a href="#编码" class="headerlink" title="编码"></a>编码</h2><ul>
<li><p>基础</p>
<ul>
<li>过多的if/switch判断可以用对象代替</li>
<li>路由跳转使用name而不是path，方便维护</li>
<li>key值推荐使用数组中不会变化且唯一的值</li>
<li>使用computed代替watch</li>
<li>统一管理缓存变量，增加types.js把字符串变量化</li>
<li>避免for/in遍历数组，防止数组原型被修改</li>
</ul>
</li>
<li><p>api</p>
<ul>
<li>Vue.config.performance=true;开启性能监控，配合VuePerformanceDevtool插件分析</li>
<li>捕获异常<ul>
<li>try/catch</li>
<li>window.onerror</li>
<li>Vue.config.errorHandler=(err,vm,info)=&gt;{}</li>
<li>watch:{obj:{handler(){},deep:b,immediate:b}}</li>
</ul>
</li>
</ul>
</li>
<li><p>可复用</p>
<ul>
<li>步骤<ul>
<li>出现重复代码</li>
<li>封装成一个变量</li>
<li>封装函数</li>
<li>封装组件</li>
<li>封装插件</li>
</ul>
</li>
<li>组件<ul>
<li>封装<ul>
<li>全部封装</li>
<li>插槽封装</li>
</ul>
</li>
<li>分类<ul>
<li>容器组件，主要处理组件逻辑</li>
<li>展示组件，主要处理组件样式</li>
</ul>
</li>
</ul>
</li>
<li>插件<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">/* toast.js */</span><br><span class="line">import ToastComponent from &apos;./toast.vue&apos; // 引入组件</span><br><span class="line"></span><br><span class="line">let $vm</span><br><span class="line"></span><br><span class="line">export default &#123;    </span><br><span class="line">    install(Vue, options) &#123;</span><br><span class="line">        </span><br><span class="line">        // 判断实例是否存在</span><br><span class="line">        if (!$vm) &#123;            </span><br><span class="line">            const ToastPlugin = Vue.extend(ToastComponent); // 创建一个“扩展实例构造器”</span><br><span class="line">            </span><br><span class="line">            // 创建 $vm 实例</span><br><span class="line">            $vm = new ToastPlugin(&#123;                </span><br><span class="line">                el: document.createElement(&apos;div&apos;)  // 声明挂载元素          </span><br><span class="line">            &#125;);            </span><br><span class="line">            </span><br><span class="line">            document.body.appendChild($vm.$el); // 把 toast 组件的 DOM 添加到 body 里</span><br><span class="line">        &#125; </span><br><span class="line">        </span><br><span class="line">        // 给 toast 设置自定义文案和时间</span><br><span class="line">        let toast = (text, duration) =&gt; &#123;</span><br><span class="line">            $vm.text = text;</span><br><span class="line">            $vm.duration = duration;</span><br><span class="line">            </span><br><span class="line">            // 在指定 duration 之后让 toast 消失</span><br><span class="line">            setTimeout(() =&gt; &#123;</span><br><span class="line">                $vm.isShow = false;  </span><br><span class="line">            &#125;, $vm.duration);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // 判断 Vue.$toast 是否存在</span><br><span class="line">        if (!Vue.$toast) &#123;            </span><br><span class="line">            Vue.$toast = toast;        </span><br><span class="line">        &#125;        </span><br><span class="line">        </span><br><span class="line">        Vue.prototype.$toast = Vue.$toast; // 全局添加 $toast 事件</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 入口文件注册</span><br><span class="line">import Toast from &apos;@/widgets/toast/toast.js&apos;</span><br><span class="line"></span><br><span class="line">Vue.use(Toast); // 注册 Toast</span><br><span class="line"></span><br><span class="line"># 使用</span><br><span class="line">this.$toast(&apos;Hello World&apos;, 2000);</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>开发工具</p>
<ul>
<li>vueDevtool</li>
<li>vuePerformanceDevtool</li>
<li>pageSpeedInsights</li>
<li>JSONViewer</li>
<li>webpack-bundle-analyser</li>
<li>safari调试ios页面</li>
<li>chrome://inspect调试安卓页面</li>
</ul>
</li>
</ul>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    

    </div>

    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2020/02/12/ldap/"><span>ldap</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2020/02/12/ldap/" rel="bookmark">
        <time class="entry-date published" datetime="2020-02-12T04:12:40.000Z">
          2020-02-12
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <h2 id="ldap"><a href="#ldap" class="headerlink" title="ldap"></a>ldap</h2><ul>
<li>lightweight directory access protocol</li>
<li>运行在TCP/IP上的目录访问协议，本质上是一个为只读访问而优化的非关系数据库</li>
<li>ldap中的信息按照目录信息数组织结构</li>
<li>树中的一个节点称之为条目Entry，包含了节点的属性和属性值</li>
<li>ldap服务的实现<ul>
<li>windows的AD</li>
<li>openldap</li>
</ul>
</li>
</ul>
<h2 id="术语"><a href="#术语" class="headerlink" title="术语"></a>术语</h2><ul>
<li>Entry/Object 条目或对象，ldap中的每个单元都认为是条目</li>
<li>DN 条目名称</li>
<li>OU 组织名称</li>
<li>DC 域组件，一般多个，如dc=baidu,dc=com</li>
<li>CN 通用名称，如人名或对象名</li>
</ul>
<h2 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># 安装OpenLDAP</span><br><span class="line">mkdir -p ~/openldap/&#123;config,database&#125;</span><br><span class="line">docker pull osixia/openldap:1.2.2</span><br><span class="line">docker run -d --name ldap-service --hostname ldap-service -p 389:389 -p 689:689 -v ~/openldap/database:/var/lib/ldap -v ~/openldap/config:/etc/ldap/slapd.d --env LDAP_ORGANISATION=&quot;test.com&quot; --env LDAP_DOMAIN=&quot;test.com&quot; --env LDAP_ADMIN_PASSWORD=&quot;password&quot; --env LDAP_TLS=false --detach osixia/openldap:1.2.2</span><br><span class="line"></span><br><span class="line"># 图形管理工具</span><br><span class="line">docker pull osixia/phpldapadmin:0.7.2</span><br><span class="line">docker run --name phpldapadmin-service -p 6443:443 -p 6680:80 --hostname phpldapadmin-service --link ldap-service:test.com --env PHPLDAPADMIN_LDAP_HOSTS=test.com --env PHPLDAPADMIN_HTTPS=false --detach osixia/phpldapadmin:0.7.2</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 访问 http://localhost:6680</span><br><span class="line"># 账号 cn=admin,dc=test,dc=com</span><br><span class="line"># 密码 password</span><br></pre></td></tr></table></figure>

<h2 id="操作"><a href="#操作" class="headerlink" title="操作"></a>操作</h2><ul>
<li>增加用户组</li>
<li>增加用户</li>
<li>更新用户属性</li>
<li>对接gitlab/jira系统</li>
</ul>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    

    </div>

    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2019/12/08/refe/"><span>refe</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2019/12/08/refe/" rel="bookmark">
        <time class="entry-date published" datetime="2019-12-08T01:52:17.000Z">
          2019-12-08
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <h2 id="开篇"><a href="#开篇" class="headerlink" title="开篇"></a>开篇</h2><ul>
<li>学习<ul>
<li>0基础的可以学习《js高级程序设计》《精通css》，MDN网站等</li>
<li>进阶学习方法<ul>
<li>建立知识架构<ul>
<li>逻辑性和完备性</li>
<li>任何语言都是用规定的文法表达特定的语义最终操作运行时的过程</li>
</ul>
</li>
<li>追本溯源</li>
</ul>
</li>
</ul>
</li>
<li>js知识架构<ul>
<li>文法<ul>
<li>词法</li>
<li>语法</li>
</ul>
</li>
<li>语义</li>
<li>运行时（程序=数据结构+算法）<ul>
<li>数据结构<ul>
<li>类型(7种基本类型和7种语言类型)</li>
<li>实例(内置对象等)</li>
</ul>
</li>
<li>算法（执行过程）<ul>
<li>程序与模块</li>
<li>事件循环</li>
<li>微任务</li>
<li>函数/语句的执行</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>html/css知识架构<ul>
<li>html<ul>
<li>元素(功能)<ul>
<li>文档元信息(meta/link/style/base)</li>
<li>语义相关内容(section/nav)</li>
<li>链接(文档内/外链接)</li>
<li>替换型元素(img/audio/video)</li>
<li>表单(input/button)</li>
<li>表格(table/thead)</li>
<li>总集</li>
</ul>
</li>
<li>语言<ul>
<li>实体</li>
<li>命名空间</li>
<li>补充标准ARIA</li>
</ul>
</li>
<li>补充标准</li>
</ul>
</li>
<li>css<ul>
<li>语言<ul>
<li>@rule</li>
<li>选择器</li>
<li>单位</li>
</ul>
</li>
<li>功能<ul>
<li>布局(正常流/弹性布局)</li>
<li>绘制(颜色和形状/文字等)</li>
<li>交互(动画和其他交互)</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>浏览器实现原理和api<ul>
<li>实现原理<ul>
<li>解析</li>
<li>构建DOM</li>
<li>计算CSS</li>
<li>渲染、合成和绘制</li>
</ul>
</li>
<li>api<ul>
<li>DOM</li>
<li>CSSOM</li>
<li>事件</li>
<li>api总集和</li>
</ul>
</li>
</ul>
</li>
<li>前端工程实践<ul>
<li>性能</li>
<li>工具链</li>
<li>持续集成</li>
<li>搭建系统</li>
<li>架构和基础库<h2 id="js"><a href="#js" class="headerlink" title="js"></a>js</h2><h3 id="类型"><a href="#类型" class="headerlink" title="类型"></a>类型</h3></li>
</ul>
</li>
<li>7种语言类型<ul>
<li>Undefined<ul>
<li>undefined</li>
</ul>
</li>
<li>Null<ul>
<li>null</li>
</ul>
</li>
<li>String<ul>
<li>最大长度2^53-1，是指字符串的UTF16编码长度</li>
<li>通常使用utf8和utf16</li>
<li>unicode码点通常U+?表示，0-65536码点称为基本字符区域BMP</li>
</ul>
</li>
<li>Number<ul>
<li>有精度限制，符合双精度浮点数规则</li>
<li>NaN占用了一个数字</li>
<li>Infinity无穷大</li>
<li>-Infinity负无穷大</li>
<li>区分是+0还是-0的方式就是检测1/x是Infinity还是-Infinity</li>
<li>比较浮点数可以通过两个数的差的绝对值是否小于最小精度值</li>
<li>Math.abs(0.1 + 0.2 - 0.3) &lt;= Number.EPSILON</li>
</ul>
</li>
<li>Boolean<ul>
<li>true</li>
<li>false</li>
</ul>
</li>
<li>Object<ul>
<li>.运算符提供了装箱操作，在基础类型上构造临时对象</li>
</ul>
</li>
<li>Symbol<ul>
<li>一切非字符串的对象key的集合，ES6中整个对象系统被Symbol重塑</li>
<li>Symbol可以有字符串类型的描述，但即使描述相同Symbol也不相等</li>
<li>var mySymbol = Symbol(‘label’), 使用new调用会报错</li>
</ul>
</li>
</ul>
</li>
<li>类型转换<ul>
<li>StringToNumber<ul>
<li>支持二进制/八进制/十进制/十六进制</li>
<li>支持正负号和科学计数法</li>
<li>parseInt建议传入第二个进制参数，parseFloat只支持十进制</li>
</ul>
</li>
<li>装箱转换<ul>
<li>基本类型转换成对应的对象</li>
<li>Object()显示装箱，函数的call方法可以强迫产生装箱</li>
<li>装箱机制会频繁产生临时对象，性能要求高时应避免装箱操作</li>
<li>var symbolObject = (function(){return this;}).call(Symbol(“a”))</li>
<li>typeof symbolObject 为 object</li>
<li>symbolObject.constructor 为 Symbol</li>
<li>symbolObject instanceof Symbol也为true</li>
</ul>
</li>
<li>拆箱转换<ul>
<li>ToPrimitive()是对象类型到基本类型的转换</li>
<li>根据运算上下文尝试调用valueOf()和toString()进行拆箱</li>
<li>如果都不存在，或返回的不是基本类型则会产生类型错误TypeError</li>
<li>ES6可以显示指定o[Symbol.toPrimitive]=()=&gt;{return ‘’}</li>
<li>ES6显示指定后toString()和valueOf()都不会被调用了</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="html-css"><a href="#html-css" class="headerlink" title="html/css"></a>html/css</h2><h2 id="浏览器"><a href="#浏览器" class="headerlink" title="浏览器"></a>浏览器</h2><h2 id="综合应用"><a href="#综合应用" class="headerlink" title="综合应用"></a>综合应用</h2>
      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    

    </div>

    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2019/11/16/pm/"><span>pm</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2019/11/16/pm/" rel="bookmark">
        <time class="entry-date published" datetime="2019-11-16T07:43:34.000Z">
          2019-11-16
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <h2 id="常识篇"><a href="#常识篇" class="headerlink" title="常识篇"></a>常识篇</h2><h3 id="转型三大误区"><a href="#转型三大误区" class="headerlink" title="转型三大误区"></a>转型三大误区</h3><ul>
<li>凡事事必躬亲<ul>
<li>成功施加影响三个层次<ul>
<li>让人知道要做 Awareness</li>
<li>有动力做 Desire</li>
<li>有能力做 Ability(短期借调/内部转岗/外部引入)</li>
</ul>
</li>
<li>为什么要做/为什么现在做/获取认同和激发动力/选择授权对象</li>
</ul>
</li>
<li>追在屁股后面监工<ul>
<li>明确目标</li>
<li>建立机制</li>
<li>形成秩序(流程和规则)</li>
</ul>
</li>
<li>拿着锤子看哪里都是钉子<ul>
<li>从项目和团队真实痛点出发</li>
</ul>
</li>
</ul>
<h3 id="十大领域五大过程组"><a href="#十大领域五大过程组" class="headerlink" title="十大领域五大过程组"></a>十大领域五大过程组</h3><ul>
<li>国际三大项目管理研究体系<ul>
<li>PMI 美国项目管理协会</li>
<li>IPMA 欧洲的国际项目管理协会</li>
<li>PRINCE2 英国</li>
</ul>
</li>
<li>项目<ul>
<li>项目是为创造独特的产品、服务或成果而进行的临时性工作</li>
<li>项目管理是将各种知识、技能、工具、技术应用于项目活动，满足项目的要求，是变理想为现实，化抽象为具体的一门科学和艺术</li>
<li>PMI把项目管理分为<ul>
<li>十大知识领域</li>
<li>五大过程组49个子过程</li>
</ul>
</li>
</ul>
</li>
<li>十大知识领域<ul>
<li>整合管理 1个整体领域</li>
<li>范围管理 4个核心领域</li>
<li>进度管理 4个核心领域</li>
<li>成本管理 4个核心领域</li>
<li>质量管理 4个核心领域</li>
<li>资源管理 5个辅助领域</li>
<li>沟通管理 5个辅助领域</li>
<li>干系人管理 5个辅助领域</li>
<li>风险管理 5个辅助领域</li>
<li>采购管理 5个辅助领域<img src="/2019/11/16/pm/10大领域管理.png" title="10大领域管理"></li>
</ul>
</li>
<li>五大过程组(PDCA戴明环Plan/Do/Check/Act)
<ul>
<li>启动过程组(千里之行始于足下)<ul>
<li>识别干系人</li>
<li>制定项目章程</li>
</ul>
</li>
<li>规划过程组(运筹帷幄决胜千里) </li>
<li>执行过程组(言出必行行之必果)</li>
<li>监控过程组(审时度势沉着应变)</li>
<li>收尾过程组(慎终如始则无败事)</li>
</ul>
</li>
<li>网易项目管理<img src="/2019/11/16/pm/网易项目管理纲领.png" title="网易项目管理纲领"> 
 

</li>
</ul>
<h2 id="硬技能篇"><a href="#硬技能篇" class="headerlink" title="硬技能篇"></a>硬技能篇</h2><h3 id="启动：识别项目四类干系人"><a href="#启动：识别项目四类干系人" class="headerlink" title="启动：识别项目四类干系人"></a>启动：识别项目四类干系人</h3><ul>
<li>干系人识别 
 </li>
<li>高利益高权利<ul>
<li>代表就是项目发起人sponsor </li>
</ul>
</li>
<li>低利益高权力<ul>
<li>代表是职能经理 </li>
</ul>
</li>
<li>高利益低权利<ul>
<li>代表项目组成员 </li>
</ul>
</li>
<li>低利益低权利<ul>
<li>代表外围支持人员</li>
</ul>
</li>
</ul>
<h3 id="规划：排除计划中的“延期地雷”"><a href="#规划：排除计划中的“延期地雷”" class="headerlink" title="规划：排除计划中的“延期地雷”"></a>规划：排除计划中的“延期地雷”</h3><ul>
<li>计划是市场需求或发起人的期望和团队生产力之间的平衡结果</li>
<li>计划是用来对焦的，做计划就是集体对焦的过程</li>
<li>雷区<ul>
<li>不够具体<ul>
<li>做计划的第一个标准动作WBS(work breakdown structure)工作分解</li>
<li>WBS就是把项目工作按阶段可交付成果分解成较小的易于管理的组成部分</li>
<li>明确分成多少阶段多少块内容，涉及哪些角色和环节，将工作项拆解到3个工作日内，具体到人</li>
</ul>
</li>
<li>不够全面<ul>
<li>做计划的第二个标准动作识别依赖并画出关键路径，从目标的角度进行统筹思考</li>
</ul>
</li>
<li>不够准确<ul>
<li>做计划第三个标准动作定义完成标准</li>
<li>完成标准就是某时间点需要完成的事项列表或是达到某些指标</li>
</ul>
</li>
<li>没有共识<ul>
<li>做计划的第四个标准动作达成共识并公开透明</li>
<li>召开全员规划会，对齐信息达成共识，发邮件给干系人正式告知</li>
</ul>
</li>
<li>不够即时<ul>
<li>做计划的第五个标准动作及时调整变更</li>
<li>公开告知所有项目组成员</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="执行：打造品质要从头开始闭环"><a href="#执行：打造品质要从头开始闭环" class="headerlink" title="执行：打造品质要从头开始闭环"></a>执行：打造品质要从头开始闭环</h3><ul>
<li>闭环验证方法<ul>
<li>方案评审(OARP决策机制)<ul>
<li>Owner 负责人，负责给出方案，组织各方讨论并推进做出决策</li>
<li>Approver 批准者</li>
<li>Reviewer 审核者</li>
<li>Participant 参与者 
 </li>
</ul>
</li>
<li>BugBash(bug大扫除)<ul>
<li>时间：在阶段性活动后，需要1-2个小时</li>
<li>地点：集合到一起，活动更有氛围</li>
<li>参与者：研发、测试、产品、设计、运营等</li>
<li>现场安排：反馈问题可视化，现场氛围营造</li>
<li>活动结束：公示结果，现场奖励，明确改进计划并周知</li>
</ul>
</li>
<li>冒烟用例评审<ul>
<li>冒烟测试用例是开发和测试之间最基础的合约，是测试的准入标准</li>
<li>可通过记录冒烟测试通过率来共同提高质量</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="监控：进展巧汇报，用数据说话"><a href="#监控：进展巧汇报，用数据说话" class="headerlink" title="监控：进展巧汇报，用数据说话"></a>监控：进展巧汇报，用数据说话</h3><ul>
<li><p>紧急汇报：直面问题有章法</p>
<ul>
<li>紧急报告基本元素 <ul>
<li>事件描述</li>
<li>影响后果</li>
<li>跟进分析</li>
<li>响应措施(包含负责人及时间表)</li>
<li>所需支持</li>
</ul>
</li>
</ul>
</li>
<li><p>常规汇报：项目周报三个问题</p>
<ul>
<li>项目整体进展状态？</li>
<li>风险是否可控？</li>
<li>目标达成有没有问题  
</li>
</ul>
</li>
<li><p>数据汇报：善用透明的力量</p>
<ul>
<li>数据指标</li>
<li>jira图表<ul>
<li>发布倒计时</li>
<li>工作量燃尽图</li>
<li>剩余工作量</li>
<li>工作状态分布</li>
</ul>
</li>
<li>数据透明给团队，利用团队的力量</li>
</ul>
</li>
</ul>
<h3 id="收尾：项目复盘，持续改进"><a href="#收尾：项目复盘，持续改进" class="headerlink" title="收尾：项目复盘，持续改进"></a>收尾：项目复盘，持续改进</h3><ul>
<li>设定开放的基调，认清目的，避免追责</li>
<li>会前准备，梳理整个版本的历程</li>
<li>复盘流程<ul>
<li>现场回顾总结(目标/进度/变更/质量等)</li>
<li>每个人总结做的好/不好的3个点</li>
<li>白板前review</li>
<li>集体投票</li>
<li>总结并讨论改进方案  </li>
</ul>
</li>
<li>打造团队持续改进能力<ul>
<li></li>
</ul>
</li>
</ul>
<h2 id="软实力篇"><a href="#软实力篇" class="headerlink" title="软实力篇"></a>软实力篇</h2>
      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    

    </div>

    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2019/10/01/flutter/"><span>flutter</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2019/10/01/flutter/" rel="bookmark">
        <time class="entry-date published" datetime="2019-10-01T08:24:22.000Z">
          2019-10-01
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <h1 id="flutter开发起步"><a href="#flutter开发起步" class="headerlink" title="flutter开发起步"></a>flutter开发起步</h1><h2 id="核心"><a href="#核心" class="headerlink" title="核心"></a>核心</h2><ul>
<li>底层渲染逻辑skia<ul>
<li>利用自己的渲染引擎skia，不依赖OS的组件</li>
<li>保证了高度一致性</li>
</ul>
</li>
<li>上层开发语言dart<ul>
<li>Dart同时支持JIT/AOT</li>
<li>开发期调试效率高，发布期执行性能好<h2 id="特性"><a href="#特性" class="headerlink" title="特性"></a>特性</h2></li>
</ul>
</li>
<li>跨平台</li>
<li>高保真(自己的渲染引擎skia完成了渲染的闭环，不用js扩展调用原生)</li>
<li>高性能</li>
</ul>
<h2 id="分层架构"><a href="#分层架构" class="headerlink" title="分层架构"></a>分层架构</h2><ul>
<li>embedder<ul>
<li>操作系统适配层</li>
<li>实现了渲染设置，线程设置，平台插件适配等</li>
</ul>
</li>
<li>engine<ul>
<li>skia和text提供了调用底层渲染和排版的能力</li>
<li>dart提供了运行时调用dart和渲染引擎的能力</li>
</ul>
</li>
<li>framework<ul>
<li>dart实现的UI SDK包含动画、图形绘制、手势识别等<img src="/2019/10/01/flutter/flutterArch.png" title="flutter">

</li>
</ul>
</li>
</ul>
<h2 id="工作流程"><a href="#工作流程" class="headerlink" title="工作流程"></a>工作流程</h2><ul>
<li>Widget以树的形式组织成控件树</li>
<li>flutter通过每个控件创建不同类型的渲染对象组成渲染对象树</li>
<li>渲染对象树通过4个阶段完成展示<ul>
<li>布局 采用深度优先机制遍历渲染对象树，决定对象的位置和尺寸(支持布局边界和父约束)</li>
<li>绘制 按位置和尺寸绘制到不同的图层，采用深度优先机制遍历(支持重绘边界)</li>
<li>合成 将所有图层根据位置，尺寸，层级，大小，透明度等规则计算出最终显示效果简化渲染树</li>
<li>渲染 几何图层数据交给skia引擎加工成二维图像数据最终给GPU进行渲染<img src="/2019/10/01/flutter/flutter.jpg" title="flutter技术点">

</li>
</ul>
</li>
</ul>
<h2 id="跨平台方案"><a href="#跨平台方案" class="headerlink" title="跨平台方案"></a>跨平台方案</h2><ul>
<li><p>三个时代</p>
<ul>
<li>web容器时代(cordova,ionic,微信小程序都使用webview+jsBridge)</li>
<li>泛web容器时代(reactNative,weex,快应用都把渲染交给原生)</li>
<li>自绘引擎时代(flutter,客户端只提供一块画布即可)<img src="/2019/10/01/flutter/hybrid.png" title="技术选型对比">
</li>
</ul>
</li>
<li><p>图像显示基本原理</p>
<ul>
<li>CPU负责图像数据的计算</li>
<li>GPU负责图像数据的渲染，渲染后放入帧缓冲区，视频控制器根据垂直同步信号VSync以60t/s刷新给显示器</li>
<li>显示器负责图像显示</li>
</ul>
</li>
<li><p>skia</p>
<ul>
<li>c++开发的高性能2D图像绘制引擎</li>
</ul>
</li>
</ul>
<h2 id="开发环境"><a href="#开发环境" class="headerlink" title="开发环境"></a>开发环境</h2><ul>
<li>android<ul>
<li>AS</li>
<li>AVD(Nexus6P)</li>
</ul>
</li>
<li>ios<ul>
<li>Xcode</li>
<li>open -a Simulator</li>
</ul>
</li>
<li>flutter<ul>
<li>export PUB_HOSTED_URL=<a href="https://pub.flutter-io.cn" target="_blank" rel="noopener">https://pub.flutter-io.cn</a></li>
<li>export FLUTTER_STORAGE_BASE_URL=<a href="https://storage.flutter-io.cn" target="_blank" rel="noopener">https://storage.flutter-io.cn</a></li>
<li>export FLUTTER_HOME=/Users/dh/dev/flutter</li>
<li>export PATH=$PATH:$FLUTTER_HOME/bin</li>
<li>flutter emulators [–launch apple_ios_simulator]</li>
<li>flutter doctor</li>
</ul>
</li>
<li>doctor问题解决方案<ul>
<li>ios<ul>
<li>gem sources –add <a href="https://gems.ruby-china.com/" target="_blank" rel="noopener">https://gems.ruby-china.com/</a> –remove <a href="https://rubygems.org/" target="_blank" rel="noopener">https://rubygems.org/</a></li>
<li>gem sources -l</li>
<li>gem update –system</li>
<li>sudo gem install cocoapods</li>
<li>pod setup</li>
<li>brew update</li>
<li>brew install –HEAD usbmuxd #usb通信抽象为tcp通信，与设备进行多路socket守护进程</li>
<li>brew link usbmuxd</li>
<li>brew install –HEAD libimobiledevice # 与设备进行通信的跨平台协议库</li>
<li>brew install ideviceinstaller # 在ios设备上管理app的工具</li>
<li>signing</li>
</ul>
</li>
<li>android<ul>
<li>flutter doctor –android-licenses</li>
<li>flutter plugin</li>
</ul>
</li>
<li>vscode<ul>
<li>flutter extension</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="工程结构"><a href="#工程结构" class="headerlink" title="工程结构"></a>工程结构</h2><ul>
<li>android 安卓子工程</li>
<li>build 构建产物</li>
<li>ios ios子工程</li>
<li>lib/main.dart flutter工程入口文件</li>
<li>test 测试目录</li>
<li>flutter_app_demo.iml 工程配置文件</li>
<li>pubspec.lock 记录当前项目实际依赖信息的文件</li>
<li>pubspec.yaml 管理第三方库和资源的配置文件</li>
</ul>
<h1 id="Dart基础"><a href="#Dart基础" class="headerlink" title="Dart基础"></a>Dart基础</h1><h2 id="特性-1"><a href="#特性-1" class="headerlink" title="特性"></a>特性</h2><ul>
<li>同时支持JIT/AOT编译模式<ul>
<li>JIT just in time即时编译，适合开发环境</li>
<li>AOT ahead of time运行前编译，适合生产环境</li>
</ul>
</li>
<li>内存分配和垃圾回收机制<ul>
<li>内存线性增长，创建对象时只在堆上移动指针</li>
<li>并发是通过Isolate实现，使dart实现了无锁的内存分配</li>
<li>避免了抢占式调度和共享内存</li>
<li>垃圾回收采用多生代算法，只操作少量的活跃对象，忽略死亡对象</li>
</ul>
</li>
<li>单线程模型<ul>
<li>dart中没有线程，只有Isolate隔离区，isolate不共享内存</li>
<li>通过事件循环在事件队列上传递消息</li>
</ul>
</li>
<li>无需单独的声明式布局语言</li>
</ul>
<h2 id="语言基础"><a href="#语言基础" class="headerlink" title="语言基础"></a>语言基础</h2><ul>
<li>dart概述<ul>
<li>是类型安全的语言，不会隐式转换类型</li>
<li>所有的类型都是对象类型，都继承自顶层的Object</li>
</ul>
</li>
<li>main()作为程序的入口 </li>
<li>变量与类型<ul>
<li>var声明变量表示变量类型自动推断</li>
<li>未初始化的变量的值都是null</li>
</ul>
</li>
<li>基本类型<ul>
<li>String<ul>
<li>UTF-16的字符串组成</li>
<li>支持单引号、双引号</li>
<li>支持${expression}或$var</li>
<li>三个单引号或双引号来表示多行字符串</li>
</ul>
</li>
<li>num<ul>
<li>64位int，代表整数类型</li>
<li>64位double，代表浮点类型</li>
</ul>
</li>
<li>bool<ul>
<li>true</li>
<li>false</li>
</ul>
</li>
<li>List<ul>
<li>类型约束List<int>/ list = <int>[]</int></int></li>
<li>类型判断 list is List<int></int></li>
</ul>
</li>
<li>Map<ul>
<li>类型约束Map&lt;String,String&gt;/ map = &lt;String,String&gt;{}</li>
<li>类型判断 map is Map&lt;String,String&gt;</li>
</ul>
</li>
</ul>
</li>
<li>常量<ul>
<li>const 表示在编译期间即能确定的值</li>
<li>final 表示在运行时确定的值，一旦确定后就不可改变</li>
</ul>
</li>
<li>函数<ul>
<li>类型Function</li>
<li>支持箭头函数</li>
<li>函数的重载即提供同名但参数不同的函数，dart认为会导致混乱所以不支持</li>
<li>但dart支持更高效的可选命名参数{}和可选参数[],也支持参数默认值</li>
</ul>
</li>
<li>类<ul>
<li>实例变量/方法</li>
<li>类变量/方法 static关键字</li>
<li>变量/方法名称前面加上_即可作为private使用，否则就是public，_是库访问级别</li>
<li>构造函数语法糖就是类中调用同类名相同的方法</li>
<li>命名构造函数即类可以有多个构造函数</li>
<li>实例化时可以省略new关键字</li>
<li>dart支持初始化列表，即支持多个构造函数，构造函数可以重定向:到另一个构造函数</li>
</ul>
</li>
<li>复用<ul>
<li>继承父类 extends</li>
<li>接口实现 implements</li>
<li>混入 with 解决dart缺少对多重继承的支持问题还能避免多重继承导致的菱形歧义</li>
</ul>
</li>
<li>运算符(用于简化处理变量实例缺失即null的情况)<ul>
<li>?. p?.printInfo()表示p为null时跳过，不为null时再调用，避免抛错</li>
<li>??= a??=value 如果a为null则赋值value，否则跳过</li>
<li>?? a ?? b 如果a不为null则返回a，否则返回b</li>
<li>dart提供了类似C++的运算符覆写机制，使用户可以自定义运算符，使用operator关键字和运算符一起使用来表示类成员运算符函数</li>
</ul>
</li>
</ul>
<h1 id="flutter基础"><a href="#flutter基础" class="headerlink" title="flutter基础"></a>flutter基础</h1><h2 id="widget"><a href="#widget" class="headerlink" title="widget"></a>widget</h2><ul>
<li>描述<ul>
<li>是flutter功能的抽象描述</li>
<li>是视图的配置信息</li>
<li>是数据的映射</li>
<li>一切皆widget(view/viewController/Activity/Application/Layout等)</li>
<li>由父到子、自顶向下方式构建，父widget控制子widget的样式</li>
<li>widget是不可变的，更新则意味着销毁和重建</li>
</ul>
</li>
<li>分类<ul>
<li>statelessWidget Model在build后不变，父widget通过初始化参数完全控制UI</li>
<li>statefulWidget build后还要关心和响应数据变化来进行重绘，setState就会触发</li>
</ul>
</li>
<li>渲染过程<ul>
<li>widget树 对视图的一种结构化描述数据，widget是不可变的需要很多的重建</li>
<li>element树 是widget的一个实例化对象，element.renderObject承载了视图构建的上下文数据，element是可变的，把真正需要修改的部分同步到renderObject中</li>
<li>renderObject树 主要负责视图渲染的对象<ul>
<li>布局 在renderObject中完成，采用深度优先机制遍历，确定位置和尺寸</li>
<li>绘制 在renderObject中完成，采用深度优先机制遍历，确定图层</li>
<li>合成 交给skia引擎</li>
<li>渲染 交给skia引擎，在VSync信号同步时直接从渲染树合成Bitmap，交给GPU</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="生命周期"><a href="#生命周期" class="headerlink" title="生命周期"></a>生命周期</h2><ul>
<li>app的生命周期<ul>
<li>WidgetsBindingObserver类实现钩子，此类中有很多函数</li>
<li>didChangeAppLifecycleState<ul>
<li>resumed 可见的，可以响应用户交互</li>
<li>inactive 非活动状态，不能响应用户交互(上下两个状态切换时的中间状态)</li>
<li>paused 不可见并不能响应用户交互但后台继续活动</li>
</ul>
</li>
<li>addPostFrameCallback<ul>
<li>单次frame绘制回调，只会回调1次</li>
</ul>
</li>
<li>addPersistentFrameCallback<ul>
<li>实时frame绘制回调，每次frame绘制完成后都回调</li>
<li>适合做FPS监测</li>
</ul>
</li>
</ul>
</li>
<li>视图的生命周期，通过state体现<ul>
<li>创建<ul>
<li>构造方法，调用createState创建state，构造方法决定了最初呈现效果在state生命周期只会被调用1次</li>
<li>initState，在state生命周期只会被调用1次</li>
<li>didChangeDependencies</li>
<li>build，构建视图返回一个widget</li>
</ul>
</li>
<li>更新<ul>
<li>setState</li>
<li>didChangeDependencies</li>
<li>didUpdateWidget</li>
</ul>
</li>
<li>销毁<ul>
<li>deactivate</li>
<li>dispose<img src="/2019/10/01/flutter/lifecycle1.png" title="生命周期1">
<img src="/2019/10/01/flutter/lifecycle2.png" title="生命周期2">

</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="常用widget"><a href="#常用widget" class="headerlink" title="常用widget"></a>常用widget</h2><ul>
<li>Text<ul>
<li>Text</li>
<li>Text.rich</li>
</ul>
</li>
<li>TextSpan</li>
<li>Image<ul>
<li>Image.asset(“images/logo.png”)加载本地资源图片</li>
<li>Image.file(new File(“/path/to/file”))本地图片</li>
<li>Image.network(“<a href="http://xxx/xx.xx&quot;)加载网络图片" target="_blank" rel="noopener">http://xxx/xx.xx&quot;)加载网络图片</a></li>
</ul>
</li>
<li>FadeInImage 提供了图片占位，加载动画效果</li>
<li>CachedNetworkImage 还可以把图片缓存到fs中，更强大</li>
<li>FloatingActionButton 圆形按钮</li>
<li>FlatButton 扁平化的按钮，默认背景透明，有交互效果</li>
<li>RaisedButton 凸起的按钮，默认带有灰色背景，有交互效果</li>
<li>ListView<ul>
<li>ListView 适用于少量子元素，需要提前创建子widget，性能较差</li>
<li>ListView.builder 适用于子widget比较多的情况懒加载widget</li>
<li>ListView.separated 可设置分割线样式</li>
</ul>
</li>
<li>CustomScrollView<ul>
<li>处理多个需要自定义滚动效果的widget</li>
<li>彼此独立的可滚动的widget统称为sliver</li>
</ul>
</li>
<li>ScrollController 滚动信息的监听</li>
<li>ScrollNotification 获取滚动事件的通知，将ListView纳入子widget</li>
<li>布局类widget<ul>
<li>单子widget<ul>
<li>Container</li>
<li>Padding</li>
<li>Center</li>
</ul>
</li>
<li>多子widget<ul>
<li>Row</li>
<li>Column</li>
<li>Expanded 处理容器的剩余空间</li>
</ul>
</li>
<li>层叠widget<ul>
<li>Stack 提供了层叠布局的容器</li>
<li>Positioned 提供了设置子widget位置的能力</li>
</ul>
</li>
</ul>
</li>
<li>自定义widget<ul>
<li>组合</li>
<li>自绘<ul>
<li>CustomPaint是用以承接自绘控件的容器，并不负责真正的绘制</li>
<li>绘制使用画布Canvas和画笔Paint及绘制逻辑CustomPainter控制</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="主题定制"><a href="#主题定制" class="headerlink" title="主题定制"></a>主题定制</h2><ul>
<li>主题一般包括颜色、图片、字体、字号等资源和配置</li>
<li>实现<ul>
<li>ios中通常将配置信息预写到plist中通过单例来控制</li>
<li>android中通常将配置信息写到style属性值的xml中，通过activity的setTheme切换</li>
<li>前端通过切换css即可实现</li>
</ul>
</li>
<li>Theme(data:ThemeData(),child:MyWidget())</li>
<li>Theme(data:Theme.of(context).copyWith(),child:MyWidget())</li>
<li>flutter使用ThemeData统一管理<ul>
<li>app全局范围 MaterialApp.theme</li>
<li>widget局部范围 Theme.data<ul>
<li>不想继承任何全局配置可直接新建一个ThemeData实例</li>
<li>想继承可使用Theme.of(context).copyWith()</li>
</ul>
</li>
<li>Theme.of(context)向上查找widget树，返回最近的Theme</li>
<li>defaultTargetPlatform 可判断当前运行的平台</li>
</ul>
</li>
</ul>
<h2 id="依赖管理"><a href="#依赖管理" class="headerlink" title="依赖管理"></a>依赖管理</h2><ul>
<li>原生<ul>
<li>ios使用Images.xcassets管理图片，其他资源直接拖进项目即可</li>
<li>android使用drawable+分辨率命名的文件夹管理图片，res/layout放布局，res/values放资源描述文件，assets放原始文件</li>
</ul>
</li>
<li>flutter<ul>
<li>assets可管理任意类型的资源</li>
<li>pubspec.yaml中配置指向对应目录即可<ul>
<li>可以单独指向某个文件</li>
<li>也可以指向一个目录，目录制定并不会递归，所以需显示递归指定子目录</li>
</ul>
</li>
<li>资源引用<ul>
<li>Image.asset()引用图片<ul>
<li>遵循基于像素密度的管理方式1.0x、2.0x、3.0x</li>
<li>flutter根据设备分辨率加载比例最接近的图片资源实现自动降级</li>
<li>资源目录应该将1.0x、2.0x、3.0x图片资源分开管理</li>
<li>assets/bg.jpg</li>
<li>assets/2.0x/bg.jpg</li>
<li>assets/3.0x/bg.jpg</li>
<li>pubspec.yaml中仅声明1.0x资源即可 flutter.assets: assets/bg.jpg</li>
</ul>
</li>
<li>rootBundle.loadString()加载字符串文件资源</li>
<li>rootBundle.load()加载二进制文件资源</li>
<li>fonts:[{family: name,fonts:[{asset:assets/fonts/name.ttf},{asset:assets/fonts/name-Italic.ttf,style:italic},{asset:assets/fonts/name-Bold.ttf,weight:700}]}]</li>
</ul>
</li>
</ul>
</li>
<li>flutter框架前的原生配置<ul>
<li>更换app图标<ul>
<li>ios ios/Runner/Assets.xcassets/AppIcon.appiconset</li>
<li>android android/app/src/main/res/mipmap</li>
</ul>
</li>
<li>更换app启动图<ul>
<li>ios ios/Runner/Assets.xcassets/LaunchImage.imageset</li>
<li>android android/app/src/main/res/drawable/launch_background.xml</li>
</ul>
</li>
</ul>
</li>
<li>第三方组件库<ul>
<li>pubspec.yaml<ul>
<li>类似于ios中的Podfile/android中的build.gradle/前端的package.json</li>
<li>pub<ul>
<li>dart的包管理工具，类似于ios中的cocoaPods/android中的maven/前端npm</li>
<li>dart的包实际上就是一个包含了pubspec.yaml的目录</li>
</ul>
</li>
</ul>
</li>
<li>推荐包使用区间进行版本的管理，dart/flutter的sdk运行环境使用固定版本号</li>
<li>包依赖可以直接获取pub资源，也可以使用本地路径或git地址</li>
<li>所有依赖确定并下载完毕后会生成.packages文件记录包映射信息，此文件需要忽略</li>
<li>最后pub会生成pubspec.lock文件记录包的来源和版本号，此文件需要git</li>
</ul>
</li>
</ul>
<h2 id="用户交互事件"><a href="#用户交互事件" class="headerlink" title="用户交互事件"></a>用户交互事件</h2><ul>
<li>原始的指针事件(PointerEvent)<ul>
<li>原生常见的触摸事件</li>
<li>事件会从最内层冒泡到根节点，无法取消冒泡或停止分发，只能hitTestBehavior</li>
<li>ListenerWidget可以监听子widget的原始指针事件</li>
</ul>
</li>
<li>手势识别(GestureDetector)<ul>
<li>多个原始指针事件的组合操作，是指针事件的语义化封装</li>
<li>GestureDetector可以处理各种高级触摸行为，可监听多个手势但最终只有一个生效</li>
<li>不同手势通过flutter内部的arena进行PK，最终决定是什么手势</li>
<li>父组件也需要处理子组件手势时需要RawGestureDetector和GestureFactory自定义</li>
</ul>
</li>
</ul>
<h2 id="组件通信"><a href="#组件通信" class="headerlink" title="组件通信"></a>组件通信</h2><ul>
<li>组件通信标准方式是通过属性传值</li>
<li>跨组件通信三种方案<ul>
<li>InheritedWidget</li>
<li>Notification</li>
<li>EventBus</li>
</ul>
</li>
<li>InheritedWidget<ul>
<li>从上到下传递</li>
<li>Theme是典型案例，父子建立观察者关系，上层属性修改后，子也会更新，默认只读</li>
</ul>
</li>
<li>Notification<ul>
<li>从下到上传递</li>
<li>NotificationListener进行监听</li>
</ul>
</li>
<li>EventBus<ul>
<li>上面两种依赖父子widget关系树</li>
<li>eventBus遵循了发布/订阅模式</li>
<li>全局作用，但容易引起冲突，组件移除要清理事件</li>
</ul>
</li>
</ul>
<h2 id="路由与导航"><a href="#路由与导航" class="headerlink" title="路由与导航"></a>路由与导航</h2><ul>
<li>Route <ul>
<li>是页面的抽象，主要负责接收参数，创建页面，响应navigator的打开和关闭</li>
</ul>
</li>
<li>Navigator<ul>
<li>维护一个路由栈管理Route，可打开/关闭/替换</li>
</ul>
</li>
<li>路由管理<ul>
<li>基本路由<ul>
<li>无需提前注册，页面切换时需要自己构造页面实例</li>
<li>Navigator.push(context,MaterialPageRouter(builder:()=&gt;{}))</li>
</ul>
</li>
<li>命名路由<ul>
<li>需要提前注册，页面切换时根据注册的标示符打开</li>
<li>Navigator.pushNamed(context,”name”)</li>
<li>Navigator.of(context).pushNamed(“name”,arguments:”args”);</li>
</ul>
</li>
</ul>
</li>
<li>其他<ul>
<li>默认路由 UnknownRoute</li>
<li>路由页面打开参数<ul>
<li>RouteSettings </li>
<li>args = ModalRoute.of(context).settings.arguments as String;</li>
</ul>
</li>
<li>路由页面返回参数<ul>
<li>push页面时要设置目标页面关闭时的监听函数以获取返回参数Navigator.pushNamed(context,”name”).then(args =&gt; print args);</li>
<li>目标页面关闭路由时要传递相关返回参数 Navigator.pop(context,”args”);</li>
</ul>
</li>
</ul>
</li>
</ul>
<h1 id="flutter进阶"><a href="#flutter进阶" class="headerlink" title="flutter进阶"></a>flutter进阶</h1><h2 id="动画"><a href="#动画" class="headerlink" title="动画"></a>动画</h2><ul>
<li>Animation<ul>
<li>flutter动画库的核心类</li>
<li>flutter的动画状态和渲染是分离的</li>
<li>fultter动画的生成器</li>
</ul>
</li>
<li>AnimationController<ul>
<li>flutter动画的控制器</li>
<li>管理Animation，可设置动画的时长、启动动画、暂停、反转等</li>
<li>controller.forward()启动动画</li>
<li>controller.repeat()重复动画</li>
<li>controller.dispose()释放资源</li>
</ul>
</li>
<li>Listener<ul>
<li>flutter动画的监听器</li>
<li>是Animation的回调函数，可监听动画的进度变化</li>
<li>监听变化后重新触发刷新实现动画</li>
<li>实践中尽量避免直接使用提高性能</li>
</ul>
</li>
<li>AnimatedWidget<ul>
<li>将Animation状态与其子widget视觉样式绑定，省去了状态监听和刷新UI</li>
<li>使用时要继承此widget并接收Animation对象作为初始化参数,build方法中读值初始化</li>
</ul>
</li>
<li>AnimatedBuilder<ul>
<li>自动监听Animation对象变化根据需要刷新UI</li>
<li>尺寸变化由builder(context,child)函数管理</li>
<li>此类实现了动画与渲染的职责分离</li>
</ul>
</li>
<li>跨页面共享的动画<ul>
<li>共享元素变换 SharedElementTransition</li>
<li>Hero(tag:”name”,child:Widget)</li>
</ul>
</li>
</ul>
<h2 id="单线程模型"><a href="#单线程模型" class="headerlink" title="单线程模型"></a>单线程模型</h2><ul>
<li>EventLoop机制<ul>
<li>MicrotaskQueue微任务队列<ul>
<li>表示短时间就会完成的异步任务</li>
<li>微任务在事件循环中的优先级最高，只要有任务就一直霸占着事件循环</li>
<li>scheduleMicroTask()</li>
<li>一般不需要此队列</li>
</ul>
</li>
<li>EventQueue事件队列<ul>
<li>优先级比较低，比较常用</li>
<li>dart为EventQueue任务提供了Future封装</li>
<li>Future提供了链式调用能力，可在异步完成后依次执行</li>
<li>then与Future函数体共用一个事件循环</li>
<li>Future执行完毕了又给引用添加了一个then方法或Future函数体为null时会把then方法体放入微任务队列，尽快执行<img src="/2019/10/01/flutter/eventLoop.png" title="事件循环">
<img src="/2019/10/01/flutter/eventLoop.gif" title="事件循环"></li>
</ul>
</li>
</ul>
</li>
<li>异步处理<ul>
<li>async/await</li>
</ul>
</li>
<li>并发编程<ul>
<li>dart是基于单线程模型，但也提供了基于Isolate的多线程机制提高多核cpu利用率</li>
<li>Isolate都有自己的EventLoop和Queue，资源隔离做的很好</li>
<li>Isolate之间不共享任何资源，只能依靠消息机制SendPort通信，避免了资源抢占需要加锁的问题</li>
<li>Isolate.spawn(fnName,args)</li>
<li>主/并发Isolate之间通信靠ReceivePort.listen()和sendPort.send()</li>
<li>为了方便使用抽象了支持并发计算的compute函数</li>
</ul>
</li>
</ul>
<h2 id="网络编程"><a href="#网络编程" class="headerlink" title="网络编程"></a>网络编程</h2><ul>
<li>网络请求流程<ul>
<li>构造client，设置通用请求行为（超时）</li>
<li>构造URI，设置请求header/body</li>
<li>发起请求，等待响应</li>
<li>解析响应的内容</li>
</ul>
</li>
<li>flutter实现方式<ul>
<li>dart:io里的HttpClient</li>
<li>dart原生的http请求库</li>
<li>第三方库dio(支持拦截器/请求合并等高级能力)</li>
</ul>
</li>
<li>JSON解析<ul>
<li>flutter不支持运行时反射，所以不能自动解析JSON只能手动解析</li>
<li>dart:convert库中内置的JSON解码器把JSON字符串解析成对象</li>
<li>字符串传给JSON.decode()返回一个Map再传给自定义解析类</li>
<li>如果JSON数据格式比较复杂或量比较大推荐使用compute函数将解析放到新Isolate完成</li>
</ul>
</li>
</ul>
<h2 id="持久化存储"><a href="#持久化存储" class="headerlink" title="持久化存储"></a>持久化存储</h2><ul>
<li>文件<ul>
<li>目录<ul>
<li>临时目录Temporary(ios的NSTemporaryDirectory和andriod的getCacheDir)</li>
<li>文档目录Documents(ios的NSDocumentDirectory和andriod的AppData目录)</li>
</ul>
</li>
<li>编码<ul>
<li>非常耗时需要在异步环境中编码</li>
<li>防止异常需要try/catch</li>
</ul>
</li>
</ul>
</li>
<li>SharedPreferences<ul>
<li>以原生方式为简单的键值对数据提供存储（string/int/double/bool）</li>
<li>ios中使用NSUserDefaults</li>
<li>android中使用SharedPreferences</li>
</ul>
</li>
<li>数据库sqlite<ul>
<li>设定数据库存储地址时使用join方法自动处理路径分隔符</li>
<li>创建数据库时传入的version与onCreate方法的回调中的version一致</li>
<li>在app版本升级过程中需要对数据库存储字段改动需要onUpgrade方法处理</li>
<li>数据库只会创建1次即onCreate在app卸载前只会执行1次</li>
</ul>
</li>
</ul>
<h2 id="dart层兼容原生"><a href="#dart层兼容原生" class="headerlink" title="dart层兼容原生"></a>dart层兼容原生</h2><ul>
<li>方法通道MethodChannel 解决原生能力复用问题<ul>
<li>基于方法通道(MethodChannel)机制可以把原生代码接口形式暴露给Dart</li>
<li>构造方法通道时需要指定一个唯一的字符串标识符，然后在这个通道上发起方法调用</li>
<li>const mc = MethodChannel(‘com.ceair/utils’);</li>
<li>try { await mc.invokeMethod(‘methodName’) } catch(e){}</li>
<li>方法通道调用过程中涉及的跨平台数据格式flutter会使用StandardMessageCodec进行序列化</li>
<li>方法通道是非线程安全的，所以原生和flutter都需要在主线程操作否则可能会有奇怪的bug</li>
</ul>
</li>
<li>平台视图PlatformView 解决原生视图复用问题<ul>
<li>允许flutter里嵌入原生的视图并加入flutter渲染树中实现混合视图</li>
<li>flutter通过原生视图的封装类(UIKitView和AndroidView)传入视图标识符发起请求</li>
<li>原生代码交给PlatformViewFactory实现</li>
<li>原生代码把视图标识符和工厂进行关联注册让flutter可直接找到工厂</li>
</ul>
</li>
</ul>
<h2 id="原生工程混编flutter"><a href="#原生工程混编flutter" class="headerlink" title="原生工程混编flutter"></a>原生工程混编flutter</h2><ul>
<li>混编原理 <ul>
<li>android原生提供一个FLutterView</li>
<li>ios原生提供一个FlutterViewController</li>
</ul>
</li>
<li>混编方式<ul>
<li>原生工程作为flutter工程的子工程，flutter统一管理（开发效率低）</li>
<li>flutter工程作为原生工程共用的子模块，原生工程不变的三端分离模式（推荐使用）<ul>
<li>抽离flutter工程，将不同平台的构建产物依照标准组件化形式管理</li>
<li>android项目把flutter模块打包成aar，通过build.gradle进行依赖管理</li>
<li>ios项目把flutter模块打包成pod，通过Podfle进行依赖管理</li>
</ul>
</li>
</ul>
</li>
<li>flutter模块<ul>
<li>flutter create -t module flutter_library</li>
</ul>
</li>
<li>android模块集成<ul>
<li>依赖1 flutter库和引擎 Flutter.jar</li>
<li>依赖2 flutter工程产物 isolate_snapshot_instr/vm_snapshot_data/FLutter_assets…</li>
<li>集成1 flutter build apk –[debug|release]</li>
<li>集成2 把上一步的产物flutter-debug.aar放到安卓工程app/libs目录下</li>
<li>集成3 build.gradle中添加对aar的依赖后sync一下</li>
<li>集成4 MainActivity.java中进行调用</li>
</ul>
</li>
<li>ios模块集成<ul>
<li>依赖1 flutter库和引擎 Flutter.framework</li>
<li>依赖2 flutter工程产物 App.framework</li>
<li>集成1 flutter build ios –[debug|release]</li>
<li>集成2 把上一步的产物拷贝到原生项目根目录下的FlutterEngine目录并创建FlutterEngine.podspec</li>
<li>集成3 pod lib lint</li>
<li>集成4 Podfile中集成后需要pod install</li>
<li>集成5 AppDelegate.m中进行调用</li>
</ul>
</li>
</ul>
<h2 id="混合导航栈"><a href="#混合导航栈" class="headerlink" title="混合导航栈"></a>混合导航栈</h2><ul>
<li>原生采用单容器单页面机制(一个ViewController/Activity对应一个页面)</li>
<li>Flutter采用单容器多页面机制(一个ViewController/Activity对应多个flutter页面)</li>
<li>原生跳转到flutter<ul>
<li>ios初始化flutter容器(FlutterViewController)并设置初始路由页面即可</li>
<li>android需要把View包装到Activity的contentView中并设置初始化路由</li>
</ul>
</li>
<li>flutter跳转到原生<ul>
<li>flutter打开新的原生页面(通过方法通道进行实现)</li>
<li>flutter回退到旧的原生页面(需要关闭flutter容器也是通过方法通道进行实现)</li>
</ul>
</li>
<li>性能问题<ul>
<li>由于flutter容器初始化成本比较高，每启动一个实例都要创建一个新的engine和Isolate</li>
<li>尽量避免flutter跳到原生后又跳到flutter，尽量在flutter完成业务的闭环</li>
<li>业界解决方案<ul>
<li>今日头条修改flutterEngine源码，使多engine在底层共享Isolate</li>
<li>闲鱼的共享FlutterView，通过hack方法由原生层驱动flutter层渲染内容</li>
<li>上面2种解决方案都有自己的不足，所以尽量减少此应用场景<img src="/2019/10/01/flutter/hybridNav.png" title="混合导航栈">

</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="状态管理"><a href="#状态管理" class="headerlink" title="状态管理"></a>状态管理</h2><ul>
<li>Provider<ul>
<li>官方推荐框架，是InheritWidget的语法糖</li>
<li>提供了依赖注入的功能，允许widget树灵活处理数据</li>
<li>可读写的ChangeNotifierProvider/MultiProvider和只读的Provider</li>
<li>Provider.of()可获取资源，但页面其他Widget也会刷新</li>
<li>ConsumerN可通过Builder(context,model,child)只更新依赖的widget提高性能</li>
</ul>
</li>
<li>使用<ul>
<li>pubspec.yaml中添加Provider依赖</li>
<li>封装: 定义需要共享的数据模型，通过混入ChangeNotifier管理听众，模型中调用notifyListeners()通知听众刷新</li>
<li>注入: 把模型放到widget的父级或更高ChangeNotifierProvider.value(value:SharedModel(),child:Widget())</li>
<li>读写: Provider.of()/ConsumerN()</li>
</ul>
</li>
</ul>
<h2 id="原生推送"><a href="#原生推送" class="headerlink" title="原生推送"></a>原生推送</h2><ul>
<li>ios<ul>
<li>使用APNS苹果推送通知服务</li>
<li>为了保证api统一，ios上也使用封装了APNs的第三方服务</li>
</ul>
</li>
<li>android<ul>
<li>类似Firebase云消息传递机制FCM(FirebaseCloudMessage)实现推送托管</li>
<li>大陆通常使用三方推送(极光/友盟)适配</li>
<li>第三方服务不能享受系统底层的优化，使用自建的长链接通道</li>
<li>但也是共享所有接入第三方推送的app的推送通道，只要有一个存活就可推送</li>
</ul>
</li>
<li>推送流程<ul>
<li>业务服务器调用APNS/FCM</li>
<li>消息到达用户终端设备</li>
<li>设备解析后把消息转给所属应用</li>
</ul>
</li>
<li>极光接入流程<ul>
<li>初始化SDK setup(调用原生接口)</li>
<li>获取地址id registrationID(调用原生接口)</li>
<li>注册消息通知 setOpenNotificationHandler(原生回调dart)</li>
<li>单例模式实现整个应用共享</li>
<li>android<ul>
<li>JCommonService是一个后台Service，极光共享长链接通道核心</li>
<li>JPushMessageReceiver是一个BroadcastReceiver可获取推送消息</li>
<li>AndroidManifest.xml中声明上面2个的注册</li>
<li>收到消息回调后首先启动MainActivity，等待Flutter初始化完成后再回调flutter推送消息</li>
</ul>
</li>
<li>ios<ul>
<li>podspec文件引入极光SDKjpush</li>
<li>用户点击了推送消息，防止是从后台唤醒，要确保flutter初始化好后再回调flutter推送消息</li>
</ul>
</li>
<li>提供应用推送证书，关联极光应用配置<ul>
<li>android注册appkey后根据包名进行注册并在build.gradle中绑定manifestPlaceholders</li>
<li>ios首先要申请推送证书(.p12证书或APNsAuthKey)并在平台配置绑定后工程开启push</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="国际化"><a href="#国际化" class="headerlink" title="国际化"></a>国际化</h2><ul>
<li>本质是语言和地区的差异性配置</li>
<li>资源<ul>
<li>字符串文本</li>
<li>货币单位</li>
<li>时间格式</li>
<li>背景图资源</li>
</ul>
</li>
<li>步骤<ul>
<li>实现LocalizationsDelegate，将所有需要转换的资源声明为其属性</li>
<li>手动翻译适配</li>
<li>app初始化时，将代理类设置为应用程序的翻译回调</li>
<li>官方的方案可以先放弃，借鉴Flutter i18n插件</li>
</ul>
</li>
<li>Flutteri18n<ul>
<li>as中安装此插件</li>
<li>pubspec.yaml中声明flutter_localizations sdk: flutter依赖</li>
<li>res/values/strings_en.arb文件是JSON格式的配置，存放标识符和翻译的键值对</li>
<li>修改上面的arb文件会自动生成lib/generated/i18n.dart(支持静态映射和动态传参)</li>
<li>初始化时2个重要参数localizationsDelegates翻译回调和supportedLocales所支持的语言配置</li>
<li>配置翻译回调时需要GlobalMaterialLocalizations.delegate与GlobalWidgetsLocalizations.delegate是官方widgets本身的翻译回调</li>
<li>S.of(context)直接获取arb文件中翻译的文案</li>
<li>翻译的代码只能在获取到context的前提下才能生效即MaterialApp的子widget，通过MaterialApp的onGenerateTitle回调设置title的国际化</li>
<li>ios程序有一套自建的语言环境管理机制，默认是英文，为了支持国际化需要额外配置Localization</li>
<li>原生工程配置<ul>
<li>在flutter框架启动前的配置需要在原生中配置</li>
<li>android中应用名称在AndroidManifest.xml中application的android:label属性</li>
<li>并且要在android/app/src/main/res中为要支持的语言创建values目录和strings.xml</li>
<li>ios工程中的应用名称是在Info.plist文件中，需要一个字符串资源引用的文件InfoPlist.strings并在Localizations中添加多语言</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="适配屏幕分辨率"><a href="#适配屏幕分辨率" class="headerlink" title="适配屏幕分辨率"></a>适配屏幕分辨率</h2><ul>
<li>适配屏幕旋转<ul>
<li>竖屏模式/横屏模式2套布局方案</li>
<li>OrientationBuilder的builder函数可以回调屏幕状态orientation</li>
<li>MediaQuery.of(context).orientation可以在OrientationBuilder外获取状态</li>
<li>SystemChrome.setPreferredOrientations([DeviceOrientation.portraitUp]);关闭横屏</li>
</ul>
</li>
<li>适配分辨率<ul>
<li>将屏幕空间划分为多个窗格即用原生类似的Fragment/ChildViewController概念抽象独立区块视觉功能</li>
<li>多窗格布局可以在平板电脑和横屏模式上，实现更好的视觉平衡效果</li>
<li>页面的实现和区块的实现是相互独立的，所以可以实现区块的复用</li>
<li>MediaQuery.of(context).size.width可获取屏幕宽度</li>
</ul>
</li>
</ul>
<h2 id="编译模式"><a href="#编译模式" class="headerlink" title="编译模式"></a>编译模式</h2><ul>
<li>运行模式<ul>
<li>Debug JIT</li>
<li>Release AOT</li>
<li>Profile Release+Profile(Observatory) flutter run –profile</li>
</ul>
</li>
<li>编译模式<ul>
<li>JIT <ul>
<li>JustInTime运行时编译</li>
<li>动态编译/将dart代码编译成中间代码scriptSnapshot最终生成DartKernel(可动态更新)需要在设备上用DartVM解释执行实现widget重建</li>
<li>可以模拟器和真机运行</li>
<li>打开assert断言/debug调试/observatory调试/hotReload热重载</li>
<li>没有优化应用启动速度/代码执行速度/二进制包大小/部署</li>
<li>flutter run –debug</li>
</ul>
</li>
<li>AOT<ul>
<li>AheadOfTime运行前编译</li>
<li>静态编译/生成设备可执行的二进制码</li>
<li>只能真机运行</li>
<li>关闭assert断言/debug调试/observatory调试/hotReload热重载</li>
<li>优化应用启动速度/代码执行速度/二进制包大小/部署</li>
<li>flutter run –release</li>
</ul>
</li>
</ul>
</li>
<li>运行时识别编译模式<ul>
<li>区别<ul>
<li>debug模式下打印详细日志，调用开发接口</li>
<li>release模式下记录精简日志，调用生产接口</li>
</ul>
</li>
<li>识别<ul>
<li>通过断言识别 assert((){ // DoSth4Debug; return true;}()) release下此代码被删除</li>
<li>通过DartVM提供的编译常数识别 if(kReleaseMode){}else{/ DoSth4Debug;} 代码总会被打包</li>
</ul>
</li>
</ul>
</li>
<li>分离配置环境<ul>
<li>抽象配置并用InheritedWidget封装</li>
<li>配置多入口(main_dev.dart/main.dart)</li>
<li>读取配置(运行时通过InheritedWidget将配置部分应用到子widget)</li>
<li>编译打包(通过不同选项构建不同的安装包flutter run -t|–target main[_dev].dart)</li>
</ul>
</li>
<li>原生配置差异<ul>
<li>android: build flavor</li>
<li>ios: 多个build target</li>
</ul>
</li>
</ul>
<h2 id="hotReload"><a href="#hotReload" class="headerlink" title="hotReload"></a>hotReload</h2><img src="/2019/10/01/flutter/hotReload.png" title="热重载流程">
<ul>
<li>热重载流程<ul>
<li>扫描工程改动</li>
<li>增量编译</li>
<li>推送更新</li>
<li>代码合并</li>
<li>Widget重建</li>
</ul>
</li>
<li>不支持热重载场景(此场景可以用hotRestart)<ul>
<li>代码编译错误</li>
<li>widget状态无法兼容</li>
<li>全局变量和静态属性的更改</li>
<li>main()里的更改</li>
<li>initState()里的更改</li>
<li>枚举和泛类型的更改</li>
</ul>
</li>
</ul>
<h2 id="工具链优化"><a href="#工具链优化" class="headerlink" title="工具链优化"></a>工具链优化</h2><ul>
<li>输出日志<ul>
<li>print() 涉及IO操作，耗费系统资源</li>
<li>debugPrint() 可以定制打印能力如debugPrint = (String msg,{int wrapWidth}{})</li>
</ul>
</li>
<li>断点调试<ul>
<li>标记断点</li>
<li>调试应用</li>
<li>查看信息</li>
</ul>
</li>
<li>布局调试<ul>
<li>DebugPainting<ul>
<li>布局边界展示辅助线</li>
<li>debugPaintSizeEnabled=true</li>
</ul>
</li>
<li>FlutterInspector 查看具体信息</li>
</ul>
</li>
</ul>
<h2 id="性能优化"><a href="#性能优化" class="headerlink" title="性能优化"></a>性能优化</h2><ul>
<li>性能问题<ul>
<li>GPU线程问题<ul>
<li>涉及widget裁剪/蒙层等多视图叠加渲染可main中使用checkerboardOffscreenLayers=true检查</li>
<li>缺少缓存导致静态图像反复绘制可main中使用checkerboardRasterCacheImages=true检查，有问题可使用RepaintBoundary缓存</li>
</ul>
</li>
<li>UI线程问题(cpu)<ul>
<li>OpenDevTools</li>
<li>Performance性能工具<ul>
<li>可记录cpu帧图(火焰图)展示cpu调用栈表示cpu繁忙程度</li>
<li>y轴表示调用栈，每一层都是一个函数，调用栈越深火焰越高，底部就是正在执行的函数，上方是父函数</li>
<li>x轴表示单位时间，在x轴越长表示执行时间越长，平顶表示函数可能存在性能问题</li>
</ul>
</li>
<li>有问题可以使用Isolate或compute()将耗时的操作移到主Isolate外完成</li>
</ul>
</li>
</ul>
</li>
<li>性能图层<ul>
<li>PerformanceOverlay</li>
<li>为采集真实的环境需要使用Profile分析模式</li>
<li>模拟器使用x86指令集/真机使用ARM指令集</li>
<li>flutter run –profile</li>
<li>性能图层展示了最近300帧的表现</li>
<li>为了保证60Hz的刷新频率，每一帧都要小于16ms(1/60)</li>
</ul>
</li>
<li>经验<ul>
<li>控制build方法耗时，将widget拆小越小越可复用</li>
<li>不要使用widget半透明效果，而使用图片代替</li>
<li>列表采用懒加载</li>
</ul>
</li>
</ul>
<h2 id="自动化测试"><a href="#自动化测试" class="headerlink" title="自动化测试"></a>自动化测试</h2><ul>
<li>单元测试<ul>
<li>对软件中最小可测试单元(语句/函数/方法/类)进行验证</li>
<li>pubspec.yaml中需要依赖test包 dev_dependencies: test:</li>
<li>测试用例<ul>
<li>定义 test()/group()测试用例封装类</li>
<li>执行</li>
<li>验证 expect()将执行结果与预期进行比较</li>
</ul>
</li>
<li>模拟mock<ul>
<li>pubspec.yaml中依赖mockito</li>
<li>Mock类可模拟任何外部依赖</li>
<li>when().thenAnswer()当符合条件时进行注入</li>
</ul>
</li>
</ul>
</li>
<li>UI测试<ul>
<li>pubspec.yaml中使用flutter_test包提供核心框架</li>
<li>testWidgets(‘name’,(tester) async{})测试用例封装类</li>
<li>await tester.pumpWidget(MyApp())触发MyApp渲染</li>
<li>find.text(str)查找字符串文本为str的widget</li>
<li>find.byIcon(Icons.add)查找到按钮控件</li>
<li>await tester.tap()点击</li>
<li>await tester.pump()强制渲染刷新</li>
</ul>
</li>
</ul>
<h1 id="综合应用"><a href="#综合应用" class="headerlink" title="综合应用"></a>综合应用</h1><h2 id="生产异常捕获和信息采集"><a href="#生产异常捕获和信息采集" class="headerlink" title="生产异常捕获和信息采集"></a>生产异常捕获和信息采集</h2><ul>
<li><p>flutter异常</p>
<ul>
<li>try/catch捕获异常</li>
<li>dart程序不强制要求必须处理异常(dart用事件循环机制来运行任务，各任务状态独立)</li>
</ul>
</li>
<li><p>dart异常</p>
<ul>
<li><p>App异常</p>
<ul>
<li>同步异常 通过try/catch捕获</li>
<li>异步异常 通过Future的catchError语句捕获</li>
<li>集中管理 通过Zone.runZoned Zone表示代码执行的范围相当于沙盒,onError回调捕获错误，统一处理异常可以把main()的runApp()放到Zone中<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">runZoned&lt;Future&lt;Null&gt;&gt;(() async &#123;</span><br><span class="line">  runApp(MyApp());</span><br><span class="line">&#125;, onError: (error, stackTrace) async &#123;</span><br><span class="line"> //Do sth for error</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>Framework异常</p>
<ul>
<li>触发了底层的try/catch，有异常就会渲染ErrorWidget</li>
<li>为了提高用户体验需要重写ErrorWidget.builder()自定义错误页面<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">ErrorWidget.builder = (FlutterErrorDetails flutterErrorDetails)&#123;</span><br><span class="line">  return Scaffold(</span><br><span class="line">    body: Center(</span><br><span class="line">      child: Text(&quot;Custom Error Widget&quot;),</span><br><span class="line">    )</span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>FlutterError</p>
<ul>
<li>为了集中处理框架异常</li>
<li>FlutterError.onError在接收到框架异常时执行相应的回调</li>
<li>可以把flutter框架的异常统一转发到当前Zone里统一处理，这样就可以捕获应用所有异常<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">FlutterError.onError = (FlutterErrorDetails details) async &#123;</span><br><span class="line">  //转发至Zone中</span><br><span class="line">  Zone.current.handleUncaughtError(details.exception, details.stack);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">runZoned&lt;Future&lt;Null&gt;&gt;(() async &#123;</span><br><span class="line">  runApp(MyApp());</span><br><span class="line">&#125;, onError: (error, stackTrace) async &#123;</span><br><span class="line"> //Do sth for error</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
</li>
<li><p>异常上报</p>
<ul>
<li>三方服务厂商<ul>
<li>友盟</li>
<li>bugly(社区比较活跃)</li>
<li>sentry(开源)</li>
</ul>
</li>
<li>bugly接入<ul>
<li>dart接口封装(实现单例的FlutterCrashPlugin的setup/postException的方法通道)</li>
<li>ios<ul>
<li>flutter_crash_plugin.podspec引入BuglySDK</li>
<li>实现原生接口FlutterCrashPlugin</li>
</ul>
</li>
<li>android<ul>
<li>build.gradle引入BuglySDK(crashreport和nativecrashreport)</li>
<li>实现原生接口FlutterCrashPlugin</li>
<li>AndroidManifest.xml中配置网络/日志读取等的权限注册</li>
</ul>
</li>
<li>关联应用配置<ul>
<li>ios只需要调用dart的setup就可以</li>
<li>android需要build.gradle中增加NDK架构支持和AndroidP的network_security_config.xml允许http传输数据并在AndroidManifest.xml中新增同名的网络安全配置</li>
</ul>
</li>
<li>接入插件<ul>
<li>pubspec.yaml中添加dependencies</li>
<li>main()里拦截到应用所有的错误后调用上报接口</li>
</ul>
</li>
</ul>
</li>
<li>底层异常<ul>
<li>flutter只能拦截dart层的异常</li>
<li>engine层大部分代码都是C++写的，一旦有异常需要借助原生系统的Crash监听机制</li>
<li>bugly也可以自动收集原生代码的crash，开发者可以把flutterEngine层的符号表下载下来，使用安卓的ndk-stack或ios的symbolicatecrash或atos命令对对crash堆栈进行解析得出引擎层崩溃的代码</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="线上质量"><a href="#线上质量" class="headerlink" title="线上质量"></a>线上质量</h2><ul>
<li><p>页面异常率</p>
<ul>
<li>异常发生次数/页面pv数<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">// 异常发生次数</span><br><span class="line">int exceptionCount = 0; </span><br><span class="line">Future&lt;Null&gt; _reportError(dynamic error, dynamic stackTrace) async &#123;</span><br><span class="line">  exceptionCount++; //累加异常次数</span><br><span class="line">  FlutterCrashPlugin.postException(error, stackTrace);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Future&lt;Null&gt; main() async &#123;</span><br><span class="line">  FlutterError.onError = (FlutterErrorDetails details) async &#123;</span><br><span class="line">    //将异常转发至Zone</span><br><span class="line">    Zone.current.handleUncaughtError(details.exception, details.stack);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  runZoned&lt;Future&lt;Null&gt;&gt;(() async &#123;</span><br><span class="line">    runApp(MyApp());</span><br><span class="line">  &#125;, onError: (error, stackTrace) async &#123;</span><br><span class="line">    //拦截异常</span><br><span class="line">    await _reportError(error, stackTrace);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 页面打开次数</span><br><span class="line">int totalPV = 0;</span><br><span class="line">//导航监听器</span><br><span class="line">class MyObserver extends NavigatorObserver&#123;</span><br><span class="line">  @override</span><br><span class="line">  void didPush(Route route, Route previousRoute) &#123;</span><br><span class="line">    super.didPush(route, previousRoute);</span><br><span class="line">    totalPV++;//累加PV</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class MyApp extends StatelessWidget &#123;</span><br><span class="line">  @override</span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    return  MaterialApp(</span><br><span class="line">    //设置路由监听</span><br><span class="line">       navigatorObservers: [</span><br><span class="line">         MyObserver(),</span><br><span class="line">       ],</span><br><span class="line">       home: HomePage(),</span><br><span class="line">    ); </span><br><span class="line">  &#125;   </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// 页面异常率计算</span><br><span class="line"></span><br><span class="line">double pageException() &#123;</span><br><span class="line">  if(totalPV == 0) return 0;</span><br><span class="line">  return exceptionCount/totalPV;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>页面帧率</p>
<ul>
<li>FPS(60Hz，因为VSync信号周期就是每秒60次)</li>
<li>window.onReportTimings()回调最近绘制帧所耗费的时间</li>
<li>FPS = 60 * 实际渲染的帧数 / 本来应该渲染的帧数<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">import &apos;dart:ui&apos;;</span><br><span class="line"></span><br><span class="line">var orginalCallback;</span><br><span class="line"></span><br><span class="line">void main() &#123;</span><br><span class="line">  runApp(MyApp());</span><br><span class="line">  //设置帧回调函数并保存原始帧回调函数</span><br><span class="line">  orginalCallback = window.onReportTimings;</span><br><span class="line">  window.onReportTimings = onReportTimings;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//仅缓存最近25帧绘制耗时</span><br><span class="line">const maxframes = 25;</span><br><span class="line">final lastFrames = List&lt;FrameTiming&gt;();</span><br><span class="line">//基准VSync信号周期</span><br><span class="line">const frameInterval = const Duration(microseconds: Duration.microsecondsPerSecond ~/ 60);</span><br><span class="line"></span><br><span class="line">void onReportTimings(List&lt;FrameTiming&gt; timings) &#123;</span><br><span class="line">  lastFrames.addAll(timings);</span><br><span class="line">  //仅保留25帧</span><br><span class="line">  if(lastFrames.length &gt; maxframes) &#123;</span><br><span class="line">    lastFrames.removeRange(0, lastFrames.length - maxframes);</span><br><span class="line">  &#125;</span><br><span class="line">  //如果有原始帧回调函数，则执行</span><br><span class="line">  if (orginalCallback != null) &#123;</span><br><span class="line">    orginalCallback(timings);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">double get fps &#123;</span><br><span class="line">  int sum = 0;</span><br><span class="line">  for (FrameTiming timing in lastFrames) &#123;</span><br><span class="line">    //计算渲染耗时</span><br><span class="line">    int duration = timing.timestampInMicroseconds(FramePhase.rasterFinish) - timing.timestampInMicroseconds(FramePhase.buildStart);</span><br><span class="line">    //判断耗时是否在Vsync信号周期内</span><br><span class="line">    if(duration &lt; frameInterval.inMicroseconds) &#123;</span><br><span class="line">      sum += 1;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      //有丢帧，向上取整</span><br><span class="line">      int count = (duration/frameInterval.inMicroseconds).ceil();</span><br><span class="line">      sum += count;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  return lastFrames.length/sum * 60;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>页面加载时长</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">class MyHomePage extends StatefulWidget &#123;</span><br><span class="line">  int startTime;</span><br><span class="line">  int endTime;</span><br><span class="line">  MyHomePage(&#123;Key key&#125;) : super(key: key) &#123;</span><br><span class="line">    //页面初始化时记录启动时间</span><br><span class="line">    startTime = DateTime.now().millisecondsSinceEpoch;</span><br><span class="line">  &#125;</span><br><span class="line">  @override</span><br><span class="line">  _MyHomePageState createState() =&gt; _MyHomePageState();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class _MyHomePageState extends State&lt;MyHomePage&gt; &#123;</span><br><span class="line">  @override</span><br><span class="line">  void initState() &#123;</span><br><span class="line">    super.initState();</span><br><span class="line">    //通过帧绘制回调获取渲染完成时间</span><br><span class="line">    WidgetsBinding.instance.addPostFrameCallback((_) &#123;</span><br><span class="line">      widget.endTime = DateTime.now().millisecondsSinceEpoch;</span><br><span class="line">      int timeSpend = widget.endTime - widget.startTime;</span><br><span class="line">      print(&quot;Page render time:$&#123;timeSpend&#125; ms&quot;);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="工程架构"><a href="#工程架构" class="headerlink" title="工程架构"></a>工程架构</h2><ul>
<li>组件化<ul>
<li>独立的功能进行拆分</li>
<li>可以是一个包/页面/UI控件/常用函数</li>
<li>基本原则<ul>
<li>单一性原则，清晰自己的边界专注做自己单一的事</li>
<li>抽象化原则，抽象接口设计，变化因子尽量自己维护</li>
<li>稳定性原则，外部依赖尽量稳定，如果不稳定考虑下一条原则</li>
<li>自完备性原则，尽量自给自足减少外部依赖，除非上一条满足</li>
</ul>
</li>
<li>实施步骤<ul>
<li>剥离并实现基础功能<ul>
<li>网络请求</li>
<li>组件中间件</li>
<li>第三方库封装(尽量不直接依赖外部代码)</li>
<li>UI组件</li>
</ul>
</li>
<li>抽象并划分业务模块<ul>
<li>粒度可先粗后细</li>
<li>后续分步迭代</li>
</ul>
</li>
<li>最小化服务能力</li>
</ul>
</li>
</ul>
</li>
<li>平台化<ul>
<li>组件化的升级，在组件化的基础上增加了统一分层和依赖治理的概念</li>
<li>组件化关注组件的独立性，平台化关注组件之间的关系合理性(尽量符合单向依赖原则)</li>
<li>如果下层确实要依赖上层可以增加中间层(EventBus/Provider/Router)</li>
</ul>
</li>
</ul>
<h2 id="构建打包发布环境"><a href="#构建打包发布环境" class="headerlink" title="构建打包发布环境"></a>构建打包发布环境</h2><ul>
<li>travisCI</li>
<li>ios逆向之重签名<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"># 列出所有开发者证书文件</span><br><span class="line">security find-identity -p codesigning -v</span><br><span class="line"></span><br><span class="line"># 找一个开发环境配置文件生成entitlements.plist</span><br><span class="line">security cms -D -i XX.mobileprovision  &gt; profile.plist</span><br><span class="line">/usr/libexec/PlistBuddy -x -c &apos;Print :Entitlements&apos; profile.plist &gt; entitlements.plist</span><br><span class="line">cat entitlements.plist</span><br><span class="line"></span><br><span class="line"># 把准备好的开发环境配置文件复制到XX.app文件夹下</span><br><span class="line">cp XX.mobileprovision Payload/XX.app/embedded.mobileprovision</span><br><span class="line"></span><br><span class="line"># 修改包Info.plist中的Bundle Identifier与配置文件中的Bundle Identifier保持一致</span><br><span class="line">/usr/libexec/PlistBuddy -c &quot;Set :CFBundleIdentifier com.XX.XX&quot; Payload/XX.app/Info.plist</span><br><span class="line"></span><br><span class="line"># 移除之前的签名文件夹</span><br><span class="line">rm -rf Payload/XX.app/_CodeSignature</span><br><span class="line"></span><br><span class="line"># 重签名framework</span><br><span class="line">/usr/bin/codesign --force --sign 84A4B9F1F902462CC33D01E9FF72C1BA04A97653 --entitlements entitlements.plist /Payload/XX.app/Frameworks/JSONModel.framework</span><br><span class="line"></span><br><span class="line"># 重签名app执行文件</span><br><span class="line">/usr/bin/codesign --force --sign 84A4B9F1F902462CC33D01E9FF72C1BA04A97653 --entitlements entitlements.plist Payload/XX.app/XX</span><br><span class="line"></span><br><span class="line"># 查看app签名信息</span><br><span class="line">codesign -vv -d Payload/XX.app</span><br><span class="line"></span><br><span class="line"># 安装调试</span><br><span class="line">ios-deploy -d -b Payload/XX.app</span><br><span class="line"></span><br><span class="line"># 打包</span><br><span class="line">zip -qry ppdest.ipa Payload</span><br><span class="line">rm -rf Payload/</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="构建混合开发框架"><a href="#构建混合开发框架" class="headerlink" title="构建混合开发框架"></a>构建混合开发框架</h2><ul>
<li><p>混合开发</p>
<ul>
<li>原生负责提供容器和基础能力支撑</li>
<li>flutter负责业务和大部分渲染工作</li>
</ul>
</li>
<li><p>混合开发工程架构</p>
<ul>
<li>依赖分层管理<ul>
<li>原生对flutter的依赖抽象为依赖flutter模块封装的原生组件</li>
<li>flutter对原生的依赖抽象为依赖插件封装的原生行为</li>
</ul>
</li>
<li>flutter模块定义为原生工程的独立业务层，以原生基础业务层向flutter模块提供业务通用能力，原生基础能力层向flutter模块提供基础功能支撑 <img src="/2019/10/01/flutter/projectArch.png" title="混合开发工程架构"></li>
</ul>
</li>
<li><p>混合开发工作模式</p>
<img src="/2019/10/01/flutter/workflow.png" title="混合开发工作流">
<img src="/2019/10/01/flutter/cmd.png" title="flutter命令行">
</li>
<li><p>原生插件依赖管理</p>
<ul>
<li>ios的AFNetworking</li>
<li>android的OkHttp</li>
</ul>
</li>
<li><p>flutter模块工程依赖管理</p>
<ul>
<li>使用flutter插件(pubspec.yaml)</li>
<li>模块工程的ios构建产物封装以提供原生ios工程依赖管理</li>
<li>模块工程的android构建产物封装以提供原生android工程依赖管理</li>
<li>flutter模块工程把所有原生的依赖都交给了原生工程管理所以其构建产物并不会携带原生插件的封装实现，我们需要遍历模块工程所使用的原生依赖组件，并为他们逐一生成插件代码对应的原生组件封装</li>
</ul>
</li>
</ul>
<h2 id="实践"><a href="#实践" class="headerlink" title="实践"></a>实践</h2><ul>
<li>TabBar<ul>
<li>TabBar 默认会在 widget 树中向上寻找离它最近的一个 DefaultTabController节点作为自己的 TabController</li>
<li>如果手动创建 TabController，那么必须将它作为参数传给 TabBar</li>
</ul>
</li>
<li>FocusScope.of(context).requestFocus(myFocusNode)</li>
<li>flutter drive –target=test_driver/app.dart</li>
</ul>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    

    </div>

    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2019/09/09/k8s-mooc/"><span>k8s-mooc</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2019/09/09/k8s-mooc/" rel="bookmark">
        <time class="entry-date published" datetime="2019-09-09T14:37:42.000Z">
          2019-09-09
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <h1 id="k8s快速入门"><a href="#k8s快速入门" class="headerlink" title="k8s快速入门"></a>k8s快速入门</h1><h2 id="核心概念"><a href="#核心概念" class="headerlink" title="核心概念"></a>核心概念</h2><ul>
<li><p>kubernetes 舵手</p>
</li>
<li><p>image</p>
</li>
<li><p>container</p>
</li>
<li><p>pod</p>
<ul>
<li>包含1个或多个container</li>
<li>container之间共享网络，ip</li>
</ul>
</li>
<li><p>replicaset</p>
</li>
<li><p>deployment</p>
</li>
<li><p>service</p>
<ul>
<li>通过labelSelector选择后端服务</li>
<li>通过clusterIp暴露服务</li>
</ul>
</li>
<li><p><a href="https://k8s.imroc.io/" target="_blank" rel="noopener">https://k8s.imroc.io/</a></p>
<h2 id="架构设计"><a href="#架构设计" class="headerlink" title="架构设计"></a>架构设计</h2></li>
<li><p>master</p>
<ul>
<li>etcd</li>
<li>apiServer</li>
<li>scheduler</li>
<li>controllerManager</li>
</ul>
</li>
<li><p>worker</p>
<ul>
<li>kubelet</li>
<li>kube-proxy</li>
<li>docker<h2 id="认证授权"><a href="#认证授权" class="headerlink" title="认证授权"></a>认证授权</h2></li>
</ul>
</li>
<li><p>https</p>
<ul>
<li>ssl/tls</li>
<li>CA(浏览器的公共CA和自有CA)</li>
</ul>
</li>
<li><p>k8s认证</p>
<ul>
<li>集群外访问apiServer<ul>
<li>客户端证书认证(kubectl,tls双向认证)</li>
<li>BearerToken认证(apiServer内置了可信任的token)</li>
</ul>
</li>
<li>集群内pod访问apiServer<ul>
<li>serviceAccount<ul>
<li>三部分(namespace,token,ca)</li>
<li>上面的信息通过目录挂载到pod中，应用通过指定目录使用</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p>授权</p>
<ul>
<li>ABAC</li>
<li>webHook</li>
<li>RBAC(最新的主流方案，roleBasedAccessControl)<ul>
<li>User<ul>
<li>user</li>
<li>serviceAccount</li>
</ul>
</li>
<li>Role<ul>
<li>namespace</li>
<li>name</li>
<li>resource</li>
<li>verbs</li>
</ul>
</li>
<li>Authority<ul>
<li>resource</li>
<li>verbs</li>
</ul>
</li>
<li>RBAC<ul>
<li>Role/RoleBinding</li>
<li>ClusterRole/ClusterRoleBinding</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p>准入控制</p>
<ul>
<li>AdmisionControl，类似java中的filter</li>
<li>AlwaysAdmit</li>
<li>AlwaysDeny</li>
<li>ServiceAccount</li>
<li>DenyEscalatingExec<h2 id="集群搭建方案对比"><a href="#集群搭建方案对比" class="headerlink" title="集群搭建方案对比"></a>集群搭建方案对比</h2></li>
</ul>
</li>
<li><p>kubeadm</p>
<ul>
<li>优雅，几乎所有组件都在pod中</li>
<li>简单</li>
<li>支持高可用</li>
<li>升级方便</li>
</ul>
</li>
<li><p>二进制</p>
<ul>
<li>容易维护</li>
<li>灵活</li>
<li>支持高可用</li>
<li>升级方便</li>
<li>证书、配置等需要一步步操作<h1 id="kubeadm方式搭建"><a href="#kubeadm方式搭建" class="headerlink" title="kubeadm方式搭建"></a>kubeadm方式搭建</h1><h2 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h2></li>
</ul>
</li>
<li><p>统一主机名</p>
<ul>
<li>hostname</li>
<li>hostnamectl set-hostname name</li>
<li>vi /etc/hosts</li>
</ul>
</li>
<li><p>安装依赖包</p>
<ul>
<li>wget -O /etc/yum.repos.d/CentOS-Base.repo <a href="http://mirrors.aliyun.com/repo/Centos-7.repo" target="_blank" rel="noopener">http://mirrors.aliyun.com/repo/Centos-7.repo</a></li>
<li>yum install -y epel-release &amp;&amp; yum clean all &amp;&amp; yum makecache</li>
<li>yum update -y</li>
<li>yum install -y conntrack ipvsadm ipset jq sysstat curl iptables libseccomp ntpdate</li>
<li>ntpdate ip</li>
</ul>
</li>
<li><p>主机配置</p>
<ul>
<li>关闭防火墙 systemctl stop firewalld &amp;&amp; systemctl disable firewalld</li>
<li>关闭swap  swapoff -a &amp;&amp; sed -i ‘/swap/s/^(.*)$/# \1/g’ /etc/fstab</li>
<li>重置iptables iptables -F &amp;&amp; iptables -X &amp;&amp; iptables -F -t nat &amp;&amp; iptables -X -t nat &amp;&amp; iptables -P FORWARD ACCEPT</li>
<li>关闭selinux setenforce 0 &amp;&amp; sed -i ‘s/^SELINUX=.*$/SELINUX=disabled/‘ /etc/selinux/config</li>
<li>关闭dnsmasq systemctl stop dnsmasq &amp;&amp; systemctl disable dnsmasq</li>
<li>配置k8s系统文件 vim /etc/sysctl.d/kubernetes.conf &amp;&amp; sysctl -p /etc/sysctl.d/kubernetes.conf<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/sysctl.d/kubernetes.conf &lt;&lt;EOF</span><br><span class="line">net.bridge.bridge-nf-call-iptables=1</span><br><span class="line">net.bridge.bridge-nf-call-ip6tables=1</span><br><span class="line">net.ipv4.ip_forward=1</span><br><span class="line">vm.swappiness=0</span><br><span class="line">vm.overcommit_memory=1</span><br><span class="line">vm.panic_on_oom=0</span><br><span class="line">fs.inotify.max_user_watches=89100</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>安装docker</p>
<ul>
<li>mkdir -p /opt/kubernetes/docker &amp;&amp; cd /opt/kubernetes/docker</li>
<li>wget <a href="http://yum.dockerproject.org/repo/main/centos/7/Packages/docker-engine-selinux-17.03.1.ce-1.el7.centos.noarch.rpm" target="_blank" rel="noopener">http://yum.dockerproject.org/repo/main/centos/7/Packages/docker-engine-selinux-17.03.1.ce-1.el7.centos.noarch.rpm</a></li>
<li>wget <a href="http://yum.dockerproject.org/repo/main/centos/7/Packages/docker-engine-debuginfo-17.03.1.ce-1.el7.centos.x86_64.rpm" target="_blank" rel="noopener">http://yum.dockerproject.org/repo/main/centos/7/Packages/docker-engine-debuginfo-17.03.1.ce-1.el7.centos.x86_64.rpm</a></li>
<li>wget <a href="http://yum.dockerproject.org/repo/main/centos/7/Packages/docker-engine-17.03.1.ce-1.el7.centos.x86_64.rpm" target="_blank" rel="noopener">http://yum.dockerproject.org/repo/main/centos/7/Packages/docker-engine-17.03.1.ce-1.el7.centos.x86_64.rpm</a></li>
<li>yum remove -y docker* container-selinux</li>
<li>yum localinstall -y *.rpm</li>
<li>systemctl enable docker</li>
<li>df -h # 查看空间较大的分区并在分区下创建dockerdata目录准备存放docker数据</li>
<li>#设置docker数据目录并启动docker服务 systemctl start docker<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;EOF &gt; /etc/docker/daemon.json</span><br><span class="line">&#123;</span><br><span class="line">    &quot;graph&quot;: &quot;/var/lib/docker&quot;,</span><br><span class="line">    &quot;registry-mirrors&quot;: [&quot;https://4vo01fev.mirror.aliyuncs.com&quot;],</span><br><span class="line">    &quot;exec-opts&quot;: [&quot;native.cgroupdriver=systemd&quot;],</span><br><span class="line">    &quot;log-driver&quot;: &quot;json-file&quot;,</span><br><span class="line">    &quot;log-opts&quot;: &#123;</span><br><span class="line">        &quot;max-size&quot;: &quot;100m&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;storage-driver&quot;: &quot;overlay2&quot;,</span><br><span class="line">    &quot;storage-opts&quot;: [</span><br><span class="line">        &quot;overlay2.override_kernel_check=true&quot;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cat &lt;&lt;EOF &gt; /etc/systemd/system/docker.service.d/http-proxy.conf</span><br><span class="line">[Service]</span><br><span class="line">Environment=&quot;HTTP_PROXY=&quot; &quot;HTTPS_PROXY=&quot;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>安装必要工具</p>
<ul>
<li>kubeadm/kubelet/kubectl</li>
<li>配置yum源</li>
<li>yum install -y kubelet kubeadm kubectl –disableexcludes=kubernetes</li>
<li>systemctl enable kubelet &amp;&amp; systemctl start kubelet<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">cat &lt;&lt; EOF &gt; /etc/yum.repos.d/kubernetes.repo</span><br><span class="line">[kubernetes]</span><br><span class="line">name=Kubernetes</span><br><span class="line">baseurl=http://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=0</span><br><span class="line">repo_gpgcheck=0</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-apiserver:v1.17.0 </span><br><span class="line">docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-controller-manager:v1.17.0</span><br><span class="line">docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-scheduler:v1.17.0</span><br><span class="line">docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy:v1.17.0</span><br><span class="line">docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1</span><br><span class="line">docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/etcd:3.4.3-0</span><br><span class="line">docker pull coredns/coredns:1.6.5</span><br><span class="line"></span><br><span class="line">docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/kube-apiserver:v1.17.0 k8s.gcr.io/kube-apiserver:v1.17.0</span><br><span class="line">docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/kube-controller-manager:v1.17.0 k8s.gcr.io/kube-controller-manager:v1.17.0</span><br><span class="line">docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/kube-scheduler:v1.17.0 k8s.gcr.io/kube-scheduler:v1.17.0</span><br><span class="line">docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy:v1.17.0 k8s.gcr.io/kube-proxy:v1.17.0</span><br><span class="line">docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1 k8s.gcr.io/pause:3.1</span><br><span class="line">docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/etcd:3.4.3-0 k8s.gcr.io/etcd:3.4.3-0</span><br><span class="line">docker tag coredns/coredns:1.6.5 k8s.gcr.io/coredns:1.6.5</span><br><span class="line"></span><br><span class="line">docker rmi registry.cn-hangzhou.aliyuncs.com/google_containers/kube-apiserver:v1.17.0 </span><br><span class="line">docker rmi registry.cn-hangzhou.aliyuncs.com/google_containers/kube-controller-manager:v1.17.0</span><br><span class="line">docker rmi registry.cn-hangzhou.aliyuncs.com/google_containers/kube-scheduler:v1.17.0</span><br><span class="line">docker rmi registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy:v1.17.0</span><br><span class="line">docker rmi registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1</span><br><span class="line">docker rmi registry.cn-hangzhou.aliyuncs.com/google_containers/etcd:3.4.3-0</span><br><span class="line">docker rmi coredns/coredns:1.6.5</span><br></pre></td></tr></table></figure>

</li>
</ul>
</li>
</ul>
<h2 id="高可用部署"><a href="#高可用部署" class="headerlink" title="高可用部署"></a>高可用部署</h2><ul>
<li><p>实现apiServer的高可用与负载均衡，也可只用keepalived</p>
<ul>
<li>yum install -y socat keepalived haproxy ipvsadm</li>
<li>systemctl enable haproxy &amp;&amp; systemctl enable keepalived</li>
<li>systemctl start haproxy &amp;&amp; systemctl start keepalived</li>
<li>journalctl -f -u keepalived </li>
<li>ip a # 查看虚拟ip<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"># /etc/keepalived/keepalived.conf</span><br><span class="line">global_defs &#123;</span><br><span class="line">   router_id master01|master02|master03</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_script check &#123;</span><br><span class="line">    script /etc/keepalived/check_haproxy.sh｜check_apiserver.sh </span><br><span class="line">    interval 3</span><br><span class="line">    # weight -2 如果脚本非零退出，则权重-2，可动态配置权重,与check_apiserver.sh 搭配</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state MASTER|BACKUP|BACKUP</span><br><span class="line">    interface ens160|ens160|ens160</span><br><span class="line">    virtual_router_id 80</span><br><span class="line">    priority 100|90|80</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 1111</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        10.18.3.200</span><br><span class="line">    &#125;</span><br><span class="line">    track_script &#123;   </span><br><span class="line">        check</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#/etc/keepalived/check_haproxy.sh </span><br><span class="line">#!/bin/bash</span><br><span class="line">NUM=`ps -C haproxy --no-header |wc -l`</span><br><span class="line">if [ $NUM -eq 0 ];then</span><br><span class="line">    systemctl stop keepalived</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">#/etc/keepalived/check_apiserver.sh </span><br><span class="line">#!/bin/bash</span><br><span class="line">errorExit()&#123;</span><br><span class="line">    echo &quot;*** $*&quot; 1&gt;&amp;2</span><br><span class="line">    exit 1</span><br><span class="line">&#125;</span><br><span class="line">curl --silent --max-time 2 --insecure https://localhost:6443/ -o /dev/null || errorExit &quot;Error https://localhost:6443&quot;</span><br><span class="line">if ip addr | grep -q 10.18.3.200; then</span><br><span class="line">    curl --silent --max-time 2 --insecure https://10.18.3.200:6443 -o /dev/null || errorExit &quot;Error https://10.18.3.200:6443&quot;</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">#/etc/haproxy/haproxy.cfg</span><br><span class="line">global</span><br><span class="line">    log         127.0.0.1 local3</span><br><span class="line">    chroot      /var/lib/haproxy</span><br><span class="line">    pidfile     /var/run/haproxy.pid</span><br><span class="line">    maxconn     32768</span><br><span class="line">    user        haproxy</span><br><span class="line">    group       haproxy</span><br><span class="line">    daemon</span><br><span class="line">    nbproc      1</span><br><span class="line">    stats socket /var/lib/haproxy/stats</span><br><span class="line"></span><br><span class="line">defaults</span><br><span class="line">    mode                    tcp</span><br><span class="line">    log                     global</span><br><span class="line">    option                  tcplog</span><br><span class="line">    option                  dontlognull</span><br><span class="line">    option                  redispatch</span><br><span class="line">    retries                 3</span><br><span class="line">    timeout queue           1m</span><br><span class="line">    timeout connect         10s</span><br><span class="line">    timeout client          1m</span><br><span class="line">    timeout server          1m</span><br><span class="line">    timeout check           10s</span><br><span class="line"></span><br><span class="line">listen stats</span><br><span class="line">    mode   http</span><br><span class="line">    bind :8888</span><br><span class="line">    stats   enable</span><br><span class="line">    stats   uri     /admin</span><br><span class="line">    stats   auth    admin:admin</span><br><span class="line">    stats   admin   if TRUE</span><br><span class="line"></span><br><span class="line">frontend  k8s_https *:8443</span><br><span class="line">    mode      tcp</span><br><span class="line">    maxconn      2000</span><br><span class="line">    default_backend     https_sri</span><br><span class="line"></span><br><span class="line">backend https_sri</span><br><span class="line">    balance      roundrobin</span><br><span class="line">    server master1-api 10.18.3.178:6443  check inter 10000 fall 2 rise 2 weight 1</span><br><span class="line">    server master2-api 10.18.3.179:6443  check inter 10000 fall 2 rise 2 weight 1</span><br><span class="line">    server master3-api 10.18.3.180:6443  check inter 10000 fall 2 rise 2 weight 1</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>部署master01</p>
<ul>
<li>kubeadm config print init-defaults &gt; ~/kubeadm_master01.yaml #默认配置文件</li>
<li>kubeadm config images list –config  ~/kubeadm_master01.yaml #查看所需镜像</li>
<li>kubeadm config images pull –config  ~/kubeadm_master01.yaml #拉取所需镜像，也可手动拉取</li>
<li>kubeadm init –control-plane-endpoint “LOAD_BALANCER_DNS:LOAD_BALANCER_PORT” –pod-network-cidr 10.96.0.0/16 –upload-certs</li>
<li>mkdir -p $HOME/.kube</li>
<li>sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</li>
<li>sudo chown $(id -u):$(id -g) $HOME/.kube/config</li>
<li>kubectl get pods –all-namespaces #测试</li>
</ul>
</li>
<li><p>部署master02|master03</p>
<ul>
<li>kubeadm join 10.18.3.200:8443 –token XXX –discovery-token-ca-cert-hash XXX –control-plane –certificate-key XXX</li>
<li>mkdir -p $HOME/.kube</li>
<li>sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</li>
<li>sudo chown $(id -u):$(id -g) $HOME/.kube/config</li>
<li>kubectl get pods –all-namespaces #测试</li>
</ul>
</li>
<li><p>部署worker</p>
<ul>
<li>kubeadm join 10.18.3.200:8443 –token XXX –discovery-token-ca-cert-hash XXX</li>
</ul>
</li>
<li><p>部署网络插件</p>
<ul>
<li>#任意主节点下载配置文件并更改cidr</li>
<li>kubectl apply -f calico.yaml</li>
<li>kubectl get pods –all-namespaces #测试</li>
</ul>
</li>
<li><p>检测</p>
<ul>
<li>kubectl get nodes</li>
<li>kubectl cluster-info</li>
<li>kubectl get cs</li>
<li>kubectl exec -n kube-system etcd-m1 – etcdctl –cacert=”/etc/kubernetes/pki/etcd/ca.crt” –cert=”/etc/kubernetes/pki/etcd/peer.crt” –key=”/etc/kubernetes/pki/etcd/peer.key” –endpoints=<a href="https://10.18.3.178:2379" target="_blank" rel="noopener">https://10.18.3.178:2379</a> member list #查看etcd集群</li>
<li>journalctl -f #查看日志<h2 id="可用性测试"><a href="#可用性测试" class="headerlink" title="可用性测试"></a>可用性测试</h2></li>
</ul>
</li>
<li><p>kubectl apply -f nginx-ds.yaml  </p>
</li>
<li><p>ping podIp</p>
</li>
<li><p>curl svcIp:svcPort</p>
</li>
<li><p>curl nodeIp:nodePort</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-ds-svc</span><br><span class="line">  labels:</span><br><span class="line">    app: nginx-ds-svc</span><br><span class="line">spec:</span><br><span class="line">  type: NodePort</span><br><span class="line">  selector:</span><br><span class="line">    app: nginx-ds</span><br><span class="line">  ports:</span><br><span class="line">  - name: http</span><br><span class="line">    port: 80</span><br><span class="line">    targetPort: 80</span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: DaemonSet</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-ds</span><br><span class="line">  labels:</span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: nginx-ds</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx-ds</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: my-nginx</span><br><span class="line">        image: nginx:1.7.9</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 80</span><br></pre></td></tr></table></figure>

<ul>
<li>kubectl apply -f pod-nginx.yaml</li>
<li>kubectl exec -it nginx bash</li>
<li>cat /etc/resolve.conf #查看DNS</li>
<li>ping svc-name #如果不通可以按如下修改proxy模式为ipvs</li>
<li>kubectl logs kube-proxy-hash -n kube-system #查看proxy模式</li>
<li>kubectl edit cm kube-proxy -n kube-system #默认kube-proxy模式为iptables，可修改mode为ipvs，同时需要ipvs模块配置</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx</span><br><span class="line">  labels:</span><br><span class="line">        app: nginx-ds</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: my-nginx</span><br><span class="line">    image: nginx:1.7.9</span><br><span class="line">    ports:</span><br><span class="line">    - containerPort: 80</span><br><span class="line"></span><br><span class="line"># ipvs模块配置</span><br><span class="line">cat &gt; /etc/sysconfig/modules/ipvs.modules &lt;&lt;EOF</span><br><span class="line">#!/bin/bash </span><br><span class="line">modprobe -- ip_vs </span><br><span class="line">modprobe -- ip_vs_rr </span><br><span class="line">modprobe -- ip_vs_wrr </span><br><span class="line">modprobe -- ip_vs_sh </span><br><span class="line">modprobe -- nf_conntrack_ipv4 </span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">#配置开机自加载并执行生效</span><br><span class="line">chmod 755 /etc/sysconfig/modules/ipvs.modules &amp;&amp; bash /etc/sysconfig/modules/ipvs.modules</span><br><span class="line"></span><br><span class="line">#查看是否加载</span><br><span class="line">lsmod | grep -e ip_vs -e nf_conntrack_ipv4</span><br><span class="line"></span><br><span class="line">#重启kube-proxy</span><br><span class="line">kubectl get pod -n kube-system | grep kube-proxy |awk &apos;&#123;system(&quot;kubectl delete pod &quot;$1&quot; -n kube-system&quot;)&#125;&apos;</span><br></pre></td></tr></table></figure>

<h2 id="dashboard"><a href="#dashboard" class="headerlink" title="dashboard"></a>dashboard</h2><ul>
<li>kubectl apply -f dashboard.yaml</li>
<li>bash dashboardToken.sh # 默认只支持token登陆<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># dashboardToken.sh</span><br><span class="line">#!/bin/bash</span><br><span class="line">kubectl describe secret -n kubernetes-dashboard $(kubectl get secret -n kubernetes-dashboard | grep dashboard-token | awk &apos;&#123;print $1&#125;&apos;) | grep -E &apos;^token&apos; | awk &apos;&#123;print $2&#125;&apos;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h1 id="二进制方式搭建"><a href="#二进制方式搭建" class="headerlink" title="二进制方式搭建"></a>二进制方式搭建</h1><h2 id="环境准备-1"><a href="#环境准备-1" class="headerlink" title="环境准备"></a>环境准备</h2><ul>
<li><p>统一主机名</p>
<ul>
<li>hostname</li>
<li>hostnamectl set-hostname name</li>
<li>vi /etc/hosts</li>
</ul>
</li>
<li><p>rhel更换yum</p>
<ul>
<li>rpm -qa | grep yum | xargs rpm -e –nodeps</li>
<li>mkdir yumrpm &amp;&amp; cd yumrpm</li>
<li>wget <a href="https://mirrors.aliyun.com/centos/7/os/x86_64/Packages/yum-3.4.3-163.el7.centos.noarch.rpm" target="_blank" rel="noopener">https://mirrors.aliyun.com/centos/7/os/x86_64/Packages/yum-3.4.3-163.el7.centos.noarch.rpm</a></li>
<li>wget <a href="https://mirrors.aliyun.com/centos/7/os/x86_64/Packages/yum-metadata-parser-1.1.4-10.el7.x86_64.rpm" target="_blank" rel="noopener">https://mirrors.aliyun.com/centos/7/os/x86_64/Packages/yum-metadata-parser-1.1.4-10.el7.x86_64.rpm</a></li>
<li>wget <a href="https://mirrors.aliyun.com/centos/7/os/x86_64/Packages/yum-utils-1.1.31-52.el7.noarch.rpm" target="_blank" rel="noopener">https://mirrors.aliyun.com/centos/7/os/x86_64/Packages/yum-utils-1.1.31-52.el7.noarch.rpm</a></li>
<li>wget <a href="https://mirrors.aliyun.com/centos/7/os/x86_64/Packages/yum-updateonboot-1.1.31-52.el7.noarch.rpm" target="_blank" rel="noopener">https://mirrors.aliyun.com/centos/7/os/x86_64/Packages/yum-updateonboot-1.1.31-52.el7.noarch.rpm</a></li>
<li>wget <a href="https://mirrors.aliyun.com/centos/7/os/x86_64/Packages/yum-plugin-fastestmirror-1.1.31-52.el7.noarch.rpm" target="_blank" rel="noopener">https://mirrors.aliyun.com/centos/7/os/x86_64/Packages/yum-plugin-fastestmirror-1.1.31-52.el7.noarch.rpm</a></li>
<li>rpm -ivh yum*</li>
</ul>
</li>
<li><p>安装依赖包</p>
<ul>
<li>wget -O /etc/yum.repos.d/CentOS-Base.repo <a href="http://mirrors.aliyun.com/repo/Centos-7.repo" target="_blank" rel="noopener">http://mirrors.aliyun.com/repo/Centos-7.repo</a></li>
<li>yum install -y epel-release &amp;&amp; yum clean all &amp;&amp; yum makecache</li>
<li>yum update -y</li>
<li>yum install -y conntrack ipvsadm ipset jq sysstat curl iptables libseccomp ntpdate</li>
<li>ntpdate ip</li>
</ul>
</li>
<li><p>主机配置</p>
<ul>
<li>关闭防火墙 systemctl stop firewalld &amp;&amp; systemctl disable firewalld</li>
<li>关闭swap  swapoff -a &amp;&amp; sed -i ‘/swap/s/^(.*)$/# \1/g’ /etc/fstab</li>
<li>重置iptables iptables -F &amp;&amp; iptables -X &amp;&amp; iptables -F -t nat &amp;&amp; iptables -X -t nat &amp;&amp; iptables -P FORWARD ACCEPT</li>
<li>关闭selinux setenforce 0 &amp;&amp; sed -i ‘s/^SELINUX=.*$/SELINUX=disabled/‘ /etc/selinux/config</li>
<li>关闭dnsmasq systemctl stop dnsmasq &amp;&amp; systemctl disable dnsmasq</li>
<li>配置k8s系统文件 vim /etc/sysctl.d/kubernetes.conf &amp;&amp; sysctl -p /etc/sysctl.d/kubernetes.conf<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/sysctl.d/kubernetes.conf &lt;&lt;EOF</span><br><span class="line">net.bridge.bridge-nf-call-iptables=1</span><br><span class="line">net.bridge.bridge-nf-call-ip6tables=1</span><br><span class="line">net.ipv4.ip_forward=1</span><br><span class="line">vm.swappiness=0</span><br><span class="line">vm.overcommit_memory=1</span><br><span class="line">vm.panic_on_oom=0</span><br><span class="line">fs.inotify.max_user_watches=89100</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>安装docker</p>
<ul>
<li>mkdir -p /opt/kubernetes/docker &amp;&amp; cd /opt/kubernetes/docker</li>
<li>wget <a href="http://yum.dockerproject.org/repo/main/centos/7/Packages/docker-engine-selinux-17.03.1.ce-1.el7.centos.noarch.rpm" target="_blank" rel="noopener">http://yum.dockerproject.org/repo/main/centos/7/Packages/docker-engine-selinux-17.03.1.ce-1.el7.centos.noarch.rpm</a></li>
<li>wget <a href="http://yum.dockerproject.org/repo/main/centos/7/Packages/docker-engine-debuginfo-17.03.1.ce-1.el7.centos.x86_64.rpm" target="_blank" rel="noopener">http://yum.dockerproject.org/repo/main/centos/7/Packages/docker-engine-debuginfo-17.03.1.ce-1.el7.centos.x86_64.rpm</a></li>
<li>wget <a href="http://yum.dockerproject.org/repo/main/centos/7/Packages/docker-engine-17.03.1.ce-1.el7.centos.x86_64.rpm" target="_blank" rel="noopener">http://yum.dockerproject.org/repo/main/centos/7/Packages/docker-engine-17.03.1.ce-1.el7.centos.x86_64.rpm</a></li>
<li>yum remove -y docker* container-selinux</li>
<li>yum localinstall -y *.rpm</li>
<li>systemctl enable docker</li>
<li>df -h # 查看空间较大的分区并在分区下创建dockerdata目录准备存放docker数据</li>
<li>#设置docker数据目录并启动docker服务 systemctl start docker<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;EOF &gt; /etc/docker/daemon.json</span><br><span class="line">&#123;</span><br><span class="line">    &quot;graph&quot;: &quot;/var/lib/docker&quot;,</span><br><span class="line">    &quot;registry-mirrors&quot;: [&quot;https://4vo01fev.mirror.aliyuncs.com&quot;],</span><br><span class="line">    &quot;exec-opts&quot;: [&quot;native.cgroupdriver=systemd&quot;],</span><br><span class="line">    &quot;log-driver&quot;: &quot;json-file&quot;,</span><br><span class="line">    &quot;log-opts&quot;: &#123;</span><br><span class="line">        &quot;max-size&quot;: &quot;100m&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;storage-driver&quot;: &quot;overlay2&quot;,</span><br><span class="line">    &quot;storage-opts&quot;: [</span><br><span class="line">        &quot;overlay2.override_kernel_check=true&quot;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cat &lt;&lt;EOF &gt; /etc/systemd/system/docker.service.d/http-proxy.conf</span><br><span class="line">[Service]</span><br><span class="line">Environment=&quot;HTTP_PROXY=&quot; &quot;HTTPS_PROXY=&quot;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>配置发布机免密登陆</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen -t rsa</span><br><span class="line">ssh-copy-id .ssh/id_rsa.pub user@ip</span><br></pre></td></tr></table></figure>
</li>
<li><p>准备二进制文件</p>
<ul>
<li>master<ul>
<li>etcd</li>
<li>etcdctl</li>
<li>kube-apiserver</li>
<li>kube-controller-manager</li>
<li>kube-scheduler</li>
<li>kubeadm</li>
<li>kubectl</li>
</ul>
</li>
<li>worker<ul>
<li>kubelet</li>
<li>kube-proxy</li>
</ul>
</li>
</ul>
</li>
<li><p>分发到各节点并配置PATH</p>
<ul>
<li>scp </li>
<li>echo “PATH=$PATH:/opt/k8s/bin” &gt;&gt; ~/.bashrc</li>
</ul>
</li>
<li><p>配置各服务参数</p>
</li>
</ul>
<h2 id="高可用部署-1"><a href="#高可用部署-1" class="headerlink" title="高可用部署"></a>高可用部署</h2><ul>
<li><p>CA证书</p>
<ul>
<li>安装工具，cfssl非常好用的CA工具，用来生成证书和密钥文件</li>
<li>生成根证书，后续所有的证书都由根证书签名<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"># getCfssl.sh</span><br><span class="line">#!/bin/bash</span><br><span class="line">mkdir -p ~/cfssl/bin</span><br><span class="line">wget https://pkg.cfssl.org/R1.2/cfssl_linux-amd64 -O ~/cfssl/bin/cfssl</span><br><span class="line">wget https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64 -O ~/cfssl/bin/cfssljson</span><br><span class="line">chmod +x ~/cfssl/bin/cfssl ~/cfssl/bin/cfssljson</span><br><span class="line">echo &quot;PATH=$PATH:~/cfssl/bin/&quot; &gt;&gt; ~/.bashrc</span><br><span class="line">source ~/.bashrc</span><br><span class="line">cfssl version</span><br><span class="line"></span><br><span class="line"># genCA.sh</span><br><span class="line">#!/bin/bash</span><br><span class="line">mkdir -p ~/cfssl/my/ &amp;&amp; cd ~/cfssl/my/</span><br><span class="line"># 生成证书ca.pem和私钥ca-key.pem</span><br><span class="line"># csr.json可参考官网</span><br><span class="line">cfssl genkey -initca csr.json | cfssljson -bare ca</span><br><span class="line"># 把根证书拷贝到主节点</span><br><span class="line">ssh root@MASTER_IP &quot;mkdir -p /etc/kubernetes/pki/&quot;</span><br><span class="line">scp ca*.pem root@MASTER_IP:/etc/kubernetes/pki/</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>etcd集群(3台master)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">wget &apos;https://github.com/etcd-io/etcd/releases/download/v3.3.18/etcd-v3.3.18-linux-amd64.tar.gz&apos;</span><br><span class="line"></span><br><span class="line"># 生成etcd的证书和私钥</span><br><span class="line">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes etcd-csr.json | cfssljson -bare etcd</span><br><span class="line"></span><br><span class="line"># 分发到每个etcd节点</span><br><span class="line">scp etcd*.pem root@MASTER_IP:/etc/kubernetes/pki/</span><br><span class="line"></span><br><span class="line"># 配置service 文件</span><br><span class="line">scp etcd.service MASTERIP:/etc/systemd/system/</span><br><span class="line"></span><br><span class="line"># 启动服务</span><br><span class="line">systemctl daemon-reload &amp;&amp; systemctl enable etcd &amp;&amp; systemctl restart etcd</span><br><span class="line"></span><br><span class="line"># 查看日志</span><br><span class="line">journalctl -f -u etcd</span><br><span class="line"></span><br><span class="line"># 查看端口</span><br><span class="line">netstat -tunlp ｜ grep 23(79|80)</span><br></pre></td></tr></table></figure>
</li>
<li><p>apiserver集群(3台master)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"># 生成证书和私钥</span><br><span class="line">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kubernetes-csr.json | cfssljson -bare kubernetes</span><br><span class="line"></span><br><span class="line"># 分发到每个etcd节点</span><br><span class="line">scp kubernetes*.pem root@MASTER_IP:/etc/kubernetes/pki/</span><br><span class="line"></span><br><span class="line"># 配置service 文件</span><br><span class="line">scp kube-apiserver.service MASTERIP:/etc/systemd/system/</span><br><span class="line"></span><br><span class="line"># 启动服务</span><br><span class="line">systemctl daemon-reload &amp;&amp; systemctl enable kube-apiserver &amp;&amp; systemctl restart kube-apiserver</span><br><span class="line"></span><br><span class="line"># 查看日志</span><br><span class="line">journalctl -f -u kube-apiserver</span><br><span class="line"></span><br><span class="line"># 查看端口</span><br><span class="line">netstat -tunlp ｜ grep 6443</span><br></pre></td></tr></table></figure>
</li>
<li><p>部署keepalived(apiserver高可用)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"># 一般部署一主一备2个节点即可</span><br><span class="line">yum install -y keepalived</span><br><span class="line"></span><br><span class="line"># 创建配置文件 /etc/keepalived/keepalived.conf</span><br><span class="line">global_defs &#123;</span><br><span class="line">   router_id master01|master02</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_script check &#123;</span><br><span class="line">    script /etc/keepalived/check_apiserver.sh </span><br><span class="line">    interval 3</span><br><span class="line">    weight -2 如果脚本非零退出，则权重-2，与check_apiserver.sh 搭配</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state MASTER|BACKUP</span><br><span class="line">    interface ens160|ens160</span><br><span class="line">    virtual_router_id 80</span><br><span class="line">    priority 100|90</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 1111</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        VIP</span><br><span class="line">    &#125;</span><br><span class="line">    track_script &#123;   </span><br><span class="line">        check</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 创建监控脚本 /etc/keepalived/check_apiserver.sh</span><br><span class="line">#!/bin/bash</span><br><span class="line">errorExit()&#123;</span><br><span class="line">    echo &quot;*** $*&quot; 1&gt;&amp;2</span><br><span class="line">    exit 1</span><br><span class="line">&#125;</span><br><span class="line">curl --silent --max-time 2 --insecure https://localhost:6443/ -o /dev/null || errorExit &quot;Error https://localhost:6443&quot;</span><br><span class="line">if ip addr | grep -q VIP; then</span><br><span class="line">    curl --silent --max-time 2 --insecure https://VIP:6443 -o /dev/null || errorExit &quot;Error https://VIP:6443&quot;</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"># 启动服务</span><br><span class="line">systemctl daemon-reload &amp;&amp; systemctl enable keepalived &amp;&amp; systemctl restart keepalived</span><br><span class="line"></span><br><span class="line"># 查看日志</span><br><span class="line">journalctl -f -u keepalived</span><br><span class="line"></span><br><span class="line"># 访问服务</span><br><span class="line">curl --insecure https://VIP:6443/</span><br></pre></td></tr></table></figure>
</li>
<li><p>kubectl</p>
<ul>
<li>是k8s集群的命令行管理工具</li>
<li>默认从 ~/.kube/config文件读取apiserver的地址、证书、token等信息<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"># 创建admin证书和私钥</span><br><span class="line">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes admin-csr.json | cfssljson -bare admin</span><br><span class="line"></span><br><span class="line"># 创建kubeconfig文件</span><br><span class="line"># 设置集群参数</span><br><span class="line">kubectl config set-cluster kubernetes</span><br><span class="line"># 设置客户端认证参数</span><br><span class="line">kubectl config set-credentials admin</span><br><span class="line"># 设置上下文参数</span><br><span class="line">kubectl config set-context kubernetes</span><br><span class="line"># 设置默认上下文</span><br><span class="line">kubectl config use-context kubernetes</span><br><span class="line"># 分发到目标节点</span><br><span class="line">scp kube.config root@MASTERIP:~/.kube/config</span><br><span class="line"></span><br><span class="line"># 授予k8s证书访问kubeletAPI的权限</span><br><span class="line">kubectl create clusterrolebinding kube-apiserver:kubelet-apis --clusterrole=system:kubelet-api-admin --user kubernetes</span><br><span class="line"></span><br><span class="line"># 测试</span><br><span class="line">kubectl cluster-info</span><br><span class="line">kubectl get all --all-namespaces</span><br><span class="line">kubectl get cs|componentstatuses</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>controller-manager</p>
<ul>
<li>启动后通过竞选产生一个leader，其他节点阻塞</li>
<li>当leader不可用后剩余节点再竞选，保证高可用<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"># 创建证书和私钥</span><br><span class="line">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes cm-csr.json | cfssljson -bare controller-manager</span><br><span class="line"></span><br><span class="line"># 分发到目标节点</span><br><span class="line">scp controller-manager*.pem root@MASTERIP:/etc/kubernetes/pki/</span><br><span class="line"></span><br><span class="line"># 创建kubeconfig文件</span><br><span class="line"># 设置集群参数</span><br><span class="line">kubectl config set-cluster kubernetes</span><br><span class="line"># 设置客户端认证参数</span><br><span class="line">kubectl config set-credentials system:kube-controller-manager</span><br><span class="line"># 设置上下文参数</span><br><span class="line">kubectl config set-context system:kube-controller-manager</span><br><span class="line"># 设置默认上下文</span><br><span class="line">kubectl config use-context system:kube-controller-manager</span><br><span class="line"># 分发到目标节点</span><br><span class="line">scp controller-manager.kubeconfig root@MASTERIP:/etc/kubernetes/</span><br><span class="line"></span><br><span class="line"># 创建service文件</span><br><span class="line"># vi /etc/systemd/system/kube-controller-manager.service</span><br><span class="line"></span><br><span class="line"># 启动服务</span><br><span class="line">systemctl daemon-reload &amp;&amp; systemctl enable kube-controller-manager &amp;&amp; systemctl restart kube-controller-manager</span><br><span class="line"></span><br><span class="line"># 查看日志</span><br><span class="line">journalctl -f -u kube-controller-manager</span><br><span class="line"></span><br><span class="line"># 查看leader</span><br><span class="line">kubectl get endpoints kube-controller-manager -n kube-system -o yaml</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>scheduler</p>
<ul>
<li>启动后通过竞选产生一个leader，其他节点阻塞</li>
<li>当leader不可用后剩余节点再竞选，保证高可用<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"># 创建证书和私钥</span><br><span class="line">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes scheduler-csr.json | cfssljson -bare kube-scheduler</span><br><span class="line"></span><br><span class="line"># 分发到目标节点</span><br><span class="line">scp kube-scheduler*.pem root@MASTERIP:/etc/kubernetes/pki/</span><br><span class="line"></span><br><span class="line"># 创建kubeconfig文件</span><br><span class="line"># 设置集群参数</span><br><span class="line">kubectl config set-cluster kubernetes</span><br><span class="line"># 设置客户端认证参数</span><br><span class="line">kubectl config set-credentials system:kube-scheduler</span><br><span class="line"># 设置上下文参数</span><br><span class="line">kubectl config set-context system:kube-scheduler</span><br><span class="line"># 设置默认上下文</span><br><span class="line">kubectl config use-context system:kube-scheduler</span><br><span class="line"># 分发到目标节点</span><br><span class="line">scp kube-scheduler.kubeconfig root@MASTERIP:/etc/kubernetes/</span><br><span class="line"></span><br><span class="line"># 创建service文件</span><br><span class="line"># vi /etc/systemd/system/kube-scheduler.service</span><br><span class="line"></span><br><span class="line"># 启动服务</span><br><span class="line">systemctl daemon-reload &amp;&amp; systemctl enable kube-scheduler &amp;&amp; systemctl restart kube-scheduler</span><br><span class="line"></span><br><span class="line"># 查看日志</span><br><span class="line">journalctl -f -u kube-scheduler</span><br><span class="line"></span><br><span class="line"># 查看leader</span><br><span class="line">kubectl get endpoints kube-scheduler -n kube-system -o yaml</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>kubelet(worker节点)</p>
<ul>
<li>下载所需镜像<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"># 创建bootstrap配置文件</span><br><span class="line"># 创建token</span><br><span class="line">export BOOTSTRAP_TOKEN=$(kubeadm token create ) </span><br><span class="line"># 设置集群参数</span><br><span class="line">kubectl config set-cluster kubernetes</span><br><span class="line"># 设置客户端认证参数</span><br><span class="line">kubectl config set-credentials kubelet-bootstrap</span><br><span class="line"># 设置上下文参数</span><br><span class="line">kubectl config set-context default </span><br><span class="line"># 设置默认上下文</span><br><span class="line">kubectl config use-context default </span><br><span class="line"># 分发到目标节点</span><br><span class="line">scp kubelet-bootstrap.kubeconfig root@WORKER:/etc/kubernetes/kubelet-bootstrap.kubeconfig</span><br><span class="line"># 分发CA到worker节点</span><br><span class="line">scp ca.pem root@WORKER:/etc/kubernetes/pki/</span><br><span class="line"></span><br><span class="line"># 分发kubelet配置文件</span><br><span class="line">scp kubelet.config.json root@WORKER:/etc/kubernetes/</span><br><span class="line"></span><br><span class="line"># 设置kubelet服务文件</span><br><span class="line">vi /etc/systemd/system/kubelet.service</span><br><span class="line"></span><br><span class="line"># bootstrap授权</span><br><span class="line">kubectl create clusterrolebinding kubelet-bootstrap --clusterrole=system:node-bootstrapper --group=system:bootstrappers</span><br><span class="line"></span><br><span class="line"># 启动服务</span><br><span class="line">systemctl daemon-reload &amp;&amp; systemctl enable kubelet &amp;&amp; systemctl restart kubelet</span><br><span class="line"></span><br><span class="line"># master上通过请求</span><br><span class="line">kubectl get csr</span><br><span class="line">kubectl certificate approve &lt;name&gt;</span><br><span class="line"></span><br><span class="line"># worer节点日志</span><br><span class="line">journalctl -f</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>kube-proxy（所有节点）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"># 创建证书和私钥</span><br><span class="line">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kube-proxy-csr.json | cfssljson -bare kube-proxy </span><br><span class="line"></span><br><span class="line"># 创建kubeconfig文件</span><br><span class="line"># 设置集群参数</span><br><span class="line">kubectl config set-cluster kubernetes</span><br><span class="line"># 设置客户端认证参数</span><br><span class="line">kubectl config set-credentials kube-proxy</span><br><span class="line"># 设置上下文参数</span><br><span class="line">kubectl config set-context default</span><br><span class="line"># 设置默认上下文</span><br><span class="line">kubectl config use-context default</span><br><span class="line"># 分发到目标节点</span><br><span class="line">scp kube-proxy.kubeconfig root@NODEIP:/etc/kubernetes/</span><br><span class="line"></span><br><span class="line"># 创建service文件</span><br><span class="line"># vi /etc/systemd/system/kube-proxy.service</span><br><span class="line"></span><br><span class="line"># 启动服务</span><br><span class="line">systemctl daemon-reload &amp;&amp; systemctl enable kube-proxy &amp;&amp; systemctl restart kube-proxy</span><br><span class="line"></span><br><span class="line"># 查看日志</span><br><span class="line">journalctl -f -u kube-proxy</span><br></pre></td></tr></table></figure>
</li>
<li><p>部署插件</p>
<ul>
<li>calico</li>
<li>coredns</li>
</ul>
</li>
</ul>
<h2 id="可用性测试-1"><a href="#可用性测试-1" class="headerlink" title="可用性测试"></a>可用性测试</h2><ul>
<li>kubectl apply -f nginx-ds.yaml</li>
<li>ping podIp</li>
<li>curl svcIp:svcPort</li>
<li>curl nodeIp:nodePort</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-ds-svc</span><br><span class="line">  labels:</span><br><span class="line">    app: nginx-ds-svc</span><br><span class="line">spec:</span><br><span class="line">  type: NodePort</span><br><span class="line">  selector:</span><br><span class="line">    app: nginx-ds</span><br><span class="line">  ports:</span><br><span class="line">  - name: http</span><br><span class="line">    port: 80</span><br><span class="line">    targetPort: 80</span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: DaemonSet</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-ds</span><br><span class="line">  labels:</span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: nginx-ds</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx-ds</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: my-nginx</span><br><span class="line">        image: nginx:1.7.9</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 80</span><br></pre></td></tr></table></figure>

<ul>
<li>kubectl apply -f pod-nginx.yaml</li>
<li>kubectl exec -it nginx bash</li>
<li>cat /etc/resolve.conf #查看DNS</li>
<li>ping svc-name #如果不通可以按如下修改proxy模式为ipvs</li>
<li>kubectl logs kube-proxy-hash -n kube-system #查看proxy模式</li>
<li>kubectl edit cm kube-proxy -n kube-system #默认kube-proxy模式为iptables，可修改mode为ipvs，同时需要ipvs模块配置</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx</span><br><span class="line">  labels:</span><br><span class="line">        app: nginx-ds</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: my-nginx</span><br><span class="line">    image: nginx:1.7.9</span><br><span class="line">    ports:</span><br><span class="line">    - containerPort: 80</span><br><span class="line"></span><br><span class="line"># ipvs模块配置</span><br><span class="line">cat &gt; /etc/sysconfig/modules/ipvs.modules &lt;&lt;EOF</span><br><span class="line">#!/bin/bash </span><br><span class="line">modprobe -- ip_vs </span><br><span class="line">modprobe -- ip_vs_rr </span><br><span class="line">modprobe -- ip_vs_wrr </span><br><span class="line">modprobe -- ip_vs_sh </span><br><span class="line">modprobe -- nf_conntrack_ipv4 </span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">#配置开机自加载并执行生效</span><br><span class="line">chmod 755 /etc/sysconfig/modules/ipvs.modules &amp;&amp; bash /etc/sysconfig/modules/ipvs.modules</span><br><span class="line"></span><br><span class="line">#查看是否加载</span><br><span class="line">lsmod | grep -e ip_vs -e nf_conntrack_ipv4</span><br><span class="line"></span><br><span class="line">#重启kube-proxy</span><br><span class="line">kubectl get pod -n kube-system | grep kube-proxy |awk &apos;&#123;system(&quot;kubectl delete pod &quot;$1&quot; -n kube-system&quot;)&#125;&apos;</span><br></pre></td></tr></table></figure>

<h2 id="dashboard-1"><a href="#dashboard-1" class="headerlink" title="dashboard"></a>dashboard</h2><ul>
<li>kubectl apply -f dashboard.yaml</li>
<li>bash dashboardToken.sh # 默认只支持token登陆<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># dashboardToken.sh</span><br><span class="line">#!/bin/bash</span><br><span class="line">kubectl describe secret -n kubernetes-dashboard $(kubectl get secret -n kubernetes-dashboard | grep dashboard-token | awk &apos;&#123;print $1&#125;&apos;) | grep -E &apos;^token&apos; | awk &apos;&#123;print $2&#125;&apos;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h1 id="业务迁移到k8s"><a href="#业务迁移到k8s" class="headerlink" title="业务迁移到k8s"></a>业务迁移到k8s</h1><h2 id="harbor"><a href="#harbor" class="headerlink" title="harbor"></a>harbor</h2><ul>
<li><p>采用比较简单的高可用方案</p>
<ul>
<li>nginx做负载均衡</li>
<li>harbor原生安装方式部署2个节点提供服务</li>
</ul>
</li>
<li><p>部署</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"># 服务节点</span><br><span class="line">wget &apos;https://github.com/goharbor/harbor/releases/download/v1.9.4/harbor-offline-installer-v1.9.4.tgz&apos;</span><br><span class="line">tar xzvf harbor-offline-installer-v1.9.4.tgz</span><br><span class="line">cd harbor</span><br><span class="line"># 修改hostname为当前ip</span><br><span class="line">vi harbor.cfg</span><br><span class="line"># 查看镜像等文件目录是否在主机最大空间目录下</span><br><span class="line">vi docker-compose.yml </span><br><span class="line">sh install.sh</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># nginx</span><br><span class="line">vi nginx.conf</span><br><span class="line">user nginx;</span><br><span class="line">worker_processes 1;</span><br><span class="line">error_log /var/log/nginx/error.log warn;</span><br><span class="line">pid /var/run/nginx.pid;</span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">  worker_connections 1024;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">stream &#123;</span><br><span class="line">  upstream hub &#123;</span><br><span class="line">    server 10.18.3.181:80;</span><br><span class="line">  &#125;</span><br><span class="line">  server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    proxy_pass hub;</span><br><span class="line">	  proxy_timeout 300s;</span><br><span class="line">	  proxy_connect_timeout 5s;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"># restart.sh</span><br><span class="line">#!/bin/bash</span><br><span class="line">docker stop harbornginx &amp;&amp; docker rm harbornginx</span><br><span class="line">docker run -itd --net=host --name harbornginx -v /root/harbor/nginx.conf:/etc/nginx/nginx.conf nginx</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用harbor</p>
<ul>
<li>本地配置host文件，域名指向ip</li>
<li>登陆harbor并新建kubernetes项目</li>
<li>docker tag nginx:latest 域名/项目名/镜像名:TAG</li>
<li>docker push 域名/项目名/镜像名:TAG</li>
<li>报错https则在/etc/docker/daemon.json中添加insecure-registries:[“域名”]并重启docker</li>
<li>配置harbor的同步规则，使2个仓库进行实时同步</li>
</ul>
</li>
</ul>
<h2 id="服务发现"><a href="#服务发现" class="headerlink" title="服务发现"></a>服务发现</h2><ul>
<li>集群内相互访问<ul>
<li>ClusterIPService通过DNS把name解析成CluseterIP访问集群pod</li>
<li>客户端通过headlessService拿到集群endpoints然后客户端自己实现</li>
</ul>
</li>
<li>集群内访问集群外<ul>
<li>直接配置ip+port</li>
<li>空的service + 同名的endpoint自动绑定，endpoint里配置外部服务</li>
</ul>
</li>
<li>集群外访问集群内<ul>
<li>NodePortService</li>
<li>HostPortService(HostNetwork)</li>
<li>Ingress<ul>
<li>Ingress(host+path到service的配置信息)</li>
<li>IngressController(Ingress-nginx)<h2 id="部署ingress-nginx"><a href="#部署ingress-nginx" class="headerlink" title="部署ingress-nginx"></a>部署ingress-nginx</h2></li>
</ul>
</li>
</ul>
</li>
<li>wget <a href="https://raw.githubusercontent.com/kubernetes/ingress-nginx/nginx-0.27.0/deploy/static/mandatory.yaml" target="_blank" rel="noopener">https://raw.githubusercontent.com/kubernetes/ingress-nginx/nginx-0.27.0/deploy/static/mandatory.yaml</a></li>
<li>kubectl apply -f ingress-nginx-mandatory.yaml</li>
<li>kubectl get all -n ingress-nginx</li>
<li>wget <a href="https://raw.githubusercontent.com/kubernetes/ingress-nginx/nginx-0.27.0/deploy/static/provider/baremetal/service-nodeport.yaml" target="_blank" rel="noopener">https://raw.githubusercontent.com/kubernetes/ingress-nginx/nginx-0.27.0/deploy/static/provider/baremetal/service-nodeport.yaml</a></li>
<li>kubectl apply -f service-nodeport.yaml #暴露NodePort的80/443</li>
<li>kubectl label node m1 app=ingress #通过label限制HostPort</li>
<li>vi ingress-nginx-mandatory.yaml #暴露HostPort，deployment的spec.hostNetwork=true,spec.nodeSelector={app:ingress}</li>
<li>kubectl get all -n ingress-nginx</li>
<li>kubectl apply -f ingress-demo.yaml #测试<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: tomcat-demo</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: tomcat-demo</span><br><span class="line">  replicas: 1</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: tomcat-demo</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: tomcat-demo</span><br><span class="line">        image: tomcat:8.0.51-alpine</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 8080</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: tomcat-demo</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    app: tomcat-demo</span><br><span class="line">  ports:</span><br><span class="line">  - port: 80</span><br><span class="line">    protocol: TCP</span><br><span class="line">    targetPort: 8080</span><br><span class="line">    </span><br><span class="line">---</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: tomcat-demo</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: tomcat.test.com</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /</span><br><span class="line">        backend:</span><br><span class="line">          serviceName: tomcat-demo</span><br><span class="line">          servicePort: 80</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="定时任务迁移"><a href="#定时任务迁移" class="headerlink" title="定时任务迁移"></a>定时任务迁移</h2><h2 id="springboot迁移"><a href="#springboot迁移" class="headerlink" title="springboot迁移"></a>springboot迁移</h2><h2 id="dubbo迁移"><a href="#dubbo迁移" class="headerlink" title="dubbo迁移"></a>dubbo迁移</h2><h2 id="传统web迁移"><a href="#传统web迁移" class="headerlink" title="传统web迁移"></a>传统web迁移</h2><h1 id="cicd"><a href="#cicd" class="headerlink" title="cicd"></a>cicd</h1><h2 id="git"><a href="#git" class="headerlink" title="git"></a>git</h2><h2 id="maven"><a href="#maven" class="headerlink" title="maven"></a>maven</h2><h2 id="docker-build"><a href="#docker-build" class="headerlink" title="docker build"></a>docker build</h2><h2 id="harbor-1"><a href="#harbor-1" class="headerlink" title="harbor"></a>harbor</h2><h2 id="服务发布"><a href="#服务发布" class="headerlink" title="服务发布"></a>服务发布</h2><h2 id="健康检查"><a href="#健康检查" class="headerlink" title="健康检查"></a>健康检查</h2><h1 id="重要资源对象"><a href="#重要资源对象" class="headerlink" title="重要资源对象"></a>重要资源对象</h1><h2 id="namespace"><a href="#namespace" class="headerlink" title="namespace"></a>namespace</h2><h2 id="resources"><a href="#resources" class="headerlink" title="resources"></a>resources</h2><h2 id="label"><a href="#label" class="headerlink" title="label"></a>label</h2><h1 id="调度与编排"><a href="#调度与编排" class="headerlink" title="调度与编排"></a>调度与编排</h1><h2 id="健康检查-1"><a href="#健康检查-1" class="headerlink" title="健康检查"></a>健康检查</h2><h2 id="scheduler"><a href="#scheduler" class="headerlink" title="scheduler"></a>scheduler</h2><h2 id="部署策略"><a href="#部署策略" class="headerlink" title="部署策略"></a>部署策略</h2><h2 id="pod"><a href="#pod" class="headerlink" title="pod"></a>pod</h2><h1 id="落地实践"><a href="#落地实践" class="headerlink" title="落地实践"></a>落地实践</h1><h2 id="ingress"><a href="#ingress" class="headerlink" title="ingress"></a>ingress</h2><h2 id="共享存储pv-pvc-sc"><a href="#共享存储pv-pvc-sc" class="headerlink" title="共享存储pv/pvc/sc"></a>共享存储pv/pvc/sc</h2><h2 id="statefulset"><a href="#statefulset" class="headerlink" title="statefulset"></a>statefulset</h2><h2 id="k8sApi"><a href="#k8sApi" class="headerlink" title="k8sApi"></a>k8sApi</h2><h1 id="日志和监控"><a href="#日志和监控" class="headerlink" title="日志和监控"></a>日志和监控</h1><h2 id="日志方案"><a href="#日志方案" class="headerlink" title="日志方案"></a>日志方案</h2><h2 id="监控入门"><a href="#监控入门" class="headerlink" title="监控入门"></a>监控入门</h2><h2 id="部署实战"><a href="#部署实战" class="headerlink" title="部署实战"></a>部署实战</h2><h2 id="监控落地"><a href="#监控落地" class="headerlink" title="监控落地"></a>监控落地</h2><h1 id="istio"><a href="#istio" class="headerlink" title="istio"></a>istio</h1><h2 id="架构原理"><a href="#架构原理" class="headerlink" title="架构原理"></a>架构原理</h2><h2 id="核心组件"><a href="#核心组件" class="headerlink" title="核心组件"></a>核心组件</h2><h2 id="智能路由"><a href="#智能路由" class="headerlink" title="智能路由"></a>智能路由</h2><h2 id="指标收集和查询"><a href="#指标收集和查询" class="headerlink" title="指标收集和查询"></a>指标收集和查询</h2><h2 id="分布式追踪"><a href="#分布式追踪" class="headerlink" title="分布式追踪"></a>分布式追踪</h2><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2>
      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    

    </div>

    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2019/08/17/cli/"><span>cli</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2019/08/17/cli/" rel="bookmark">
        <time class="entry-date published" datetime="2019-08-17T08:46:23.000Z">
          2019-08-17
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <h1 id="webpack"><a href="#webpack" class="headerlink" title="webpack"></a>webpack</h1><h2 id="loader"><a href="#loader" class="headerlink" title="loader"></a>loader</h2><ul>
<li>三种使用方式<ul>
<li>webpack.config.js</li>
<li>内联在import语句中</li>
<li>在cli命令中指定</li>
</ul>
</li>
<li>常用loader<ul>
<li>babel-loader</li>
<li>style-loader 在html中注入style标签</li>
<li>css-loader 解析@import url()等</li>
<li>postcss-loader</li>
<li>sass-loader</li>
<li>html-loader</li>
<li>vue-loader</li>
<li>file-loader</li>
<li>url-loader</li>
</ul>
</li>
</ul>
<h2 id="plugin"><a href="#plugin" class="headerlink" title="plugin"></a>plugin</h2><ul>
<li>常用plugin<ul>
<li>HtmlWebpackPlugin</li>
<li>CommonsChunkPlugin</li>
<li>DefinePlugin</li>
<li>DllPlugin</li>
<li>ExtractTextWebpackPlugin</li>
<li>HotModuleReplacementPlugin</li>
<li>UglifyjsWebpackPlugin</li>
<li>CopyWebpackPlugin</li>
</ul>
</li>
</ul>
<h1 id="工程化模版"><a href="#工程化模版" class="headerlink" title="工程化模版"></a>工程化模版</h1><h2 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h2><ul>
<li>mkdir template &amp;&amp; cd template &amp;&amp; npm init -y</li>
<li>npm i -D webpack webpack-cli vue-loader vue-template-compiler html-webpack-plugin css-loader style-loader sass-loader sass postcss-loader  postcss-preset-env url-loader file-loader @babel/core @babel/preset-env babel-loader webpack-dev-server connect-multiparty mockjs concurrently</li>
<li>npm i vue vue-router @babel/polyfill axios</li>
<li>浏览器支持列表<ul>
<li>package.json.browserslist</li>
<li>.browserlistrc</li>
<li>browserlist</li>
<li>环境变量BROWSERLIST </li>
</ul>
</li>
<li>.babelrc</li>
<li>postcss.config.js</li>
<li>webpack.config.js</li>
</ul>
<h2 id="模块化"><a href="#模块化" class="headerlink" title="模块化"></a>模块化</h2><ul>
<li>意义<ul>
<li>避免命名/变量冲突</li>
<li>更清晰的依赖关系</li>
<li>可维护</li>
<li>可复用</li>
<li>降低复杂度</li>
</ul>
</li>
<li>主流实现<ul>
<li>AMD<ul>
<li>异步加载，适合浏览器端</li>
<li>require</li>
<li>define([deps…],(deps…)=&gt;{return {}})</li>
</ul>
</li>
<li>CommonJS<ul>
<li>同步加载，适合服务端，因为大都在本地</li>
<li>require</li>
<li>module.exports | exports.</li>
</ul>
</li>
<li>ES6<ul>
<li>js语言层面支持的模块化，可做静态依赖分析，适合多端</li>
<li>import</li>
<li>export</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="本地开发环境"><a href="#本地开发环境" class="headerlink" title="本地开发环境"></a>本地开发环境</h2><ul>
<li><p>npm install –save-dev webpack-dev-server</p>
</li>
<li><p>“start”: “webpack-dev-server –open”</p>
</li>
<li><p>HMR</p>
<ul>
<li>hotModuleReplacement</li>
<li>能生效是因为模块实现了HMR接口<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">if (module.hot) &#123;</span><br><span class="line">  module.hot.accept(&quot;./print.js&quot;, function() &#123;</span><br><span class="line">    console.log(&quot;接收更新后的模块&quot;);</span><br><span class="line">    print();</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>sourceMap</p>
<ul>
<li>source-map 适合生产环境，映射关系完整但运行慢</li>
<li>eval-source-map 适合开发环境，只映射到行但运行快</li>
</ul>
</li>
</ul>
<h2 id="本地mock"><a href="#本地mock" class="headerlink" title="本地mock"></a>本地mock</h2><ul>
<li>服务 express</li>
<li>路由 url与数据的路由绑定</li>
<li>数据模拟 mockjs<ul>
<li>数据模版定义规范DTD(data template definition)<ul>
<li>属性名 与规则之间用|分割</li>
<li>生成规则 依赖属性值的类型，是可选的</li>
<li>属性值 可以有@占位符，指定了最终值的类型和初始值</li>
<li>例如：’name|rule’: value</li>
</ul>
</li>
<li>数据占位符定义规范DPD(data placeholder definition)</li>
<li>核心api<ul>
<li>mock 将模版输出为最终的数据</li>
<li>random 生成随机数据</li>
</ul>
</li>
</ul>
</li>
<li>concurrently<ul>
<li>同一终端同时运行多个npm命令，不管是否同一进程</li>
</ul>
</li>
</ul>
<h2 id="代码检查"><a href="#代码检查" class="headerlink" title="代码检查"></a>代码检查</h2><ul>
<li>eslint<ul>
<li>npm install -D eslint eslint-loader eslint-plugin-vue babel-eslint eslint-friendly-formatter</li>
<li>plugins指定需要的插件名称，可以忽略eslint-plugin-</li>
<li>默认使用espree解析器，因为有新的语言特性需要指定为babel-eslint</li>
<li>换解析器需要在parserOptions中，防止全局替换导致其他插件失败</li>
<li>es6模块的sourceType为module</li>
<li>禁用eslint规则<ul>
<li>文件开头/* eslint-disable */禁用整个文件的检查</li>
<li>行// eslint-disable-line 禁用行检查</li>
<li>行// eslint-disable-line no-console 禁用console规则</li>
</ul>
</li>
<li>自定义规则<ul>
<li>extends: eslint:recommended</li>
<li>rules:{ no-console: off, quotes:[“wanr”,”single”],indent:[“error”,2]}</li>
<li>数组值第一项表示级别，默认是error</li>
</ul>
</li>
</ul>
</li>
<li>stylelint<ul>
<li>npm install -D stylelint stylelint-webpack-plugin</li>
<li>.stylelintrc.js</li>
<li>禁用规则<ul>
<li>/* stylelint-disable unit-whitelist*/ 禁用unit规则校验</li>
<li>/* stylelint-disable */ 禁用所有规则校验</li>
</ul>
</li>
<li>自定义规则<ul>
<li>extends: “stylelint-config-standard”</li>
<li>rules: {“color-no-invalid-hex”: true}</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="雪碧图"><a href="#雪碧图" class="headerlink" title="雪碧图"></a>雪碧图</h2><ul>
<li>npm install -D webpack-spritesmith</li>
<li>resolve.modules如果是相对路径则按照规则一级一级向上查找，如果是绝对路径不会向上查找</li>
<li>使用<ul>
<li>@import “~sprite.scss”</li>
<li>.icon-picName{@include sprite($picName)}</li>
</ul>
</li>
<li>自定义生成2x样式表<ul>
<li>官网的templateFunction</li>
<li>customTemplates: {function_based_template: templateFunction},</li>
<li>target.css = [[],path.resolve(__dirname, “src/assets/generated/sprite.scss”)]</li>
<li>使用<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">@import &apos;~sprite2.scss&apos;;</span><br><span class="line">&lt;li class=&quot;ico ico-picName&quot;&gt;&lt;/li&gt; </span><br></pre></td></tr></table></figure>

</li>
</ul>
</li>
</ul>
<h2 id="按浏览器构建"><a href="#按浏览器构建" class="headerlink" title="按浏览器构建"></a>按浏览器构建</h2><ul>
<li>新版本浏览器<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;script type=&quot;module&quot;&gt;&lt;/script&gt; 可直接加载ES6</span><br><span class="line">&lt;link rel=&quot;modulepreload&quot;&gt;&lt;/link&gt; 预加载</span><br></pre></td></tr></table></figure></li>
<li>老版本浏览器<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;script nomodule&gt;加载旧版本js，新版本浏览器会忽略该引用</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="按环境构建"><a href="#按环境构建" class="headerlink" title="按环境构建"></a>按环境构建</h2><ul>
<li>development</li>
<li>test</li>
<li>production</li>
<li>插件<ul>
<li>npm install –save-dev extract-text-webpack-plugin</li>
<li>npm install –save-dev optimize-css-assets-webpack-plugin</li>
<li>npm install terser-webpack-plugin –save-dev</li>
<li>HashedModuleIdsPlugin 避免不必要的hash变化</li>
</ul>
</li>
</ul>
<h2 id="集成调试工具"><a href="#集成调试工具" class="headerlink" title="集成调试工具"></a>集成调试工具</h2><ul>
<li>weinre / spy-debugger</li>
<li>vconsole<ul>
<li>npm install vconsole</li>
<li>DebugPlugin.js里面去实现 debugtool插件</li>
<li>vconsole.js 里面去new Vconsole</li>
<li>可以单独发一个npm包 debugtool-webpack-plugin</li>
</ul>
</li>
</ul>
<h2 id="单元测试"><a href="#单元测试" class="headerlink" title="单元测试"></a>单元测试</h2><ul>
<li>chai作为断言库</li>
<li>Mocha编写测试用例、测试框架</li>
<li>Karma测试过程管理TestRunner及启动浏览器和生成测试报告</li>
<li>npm install –save-dev karma mocha karma-mocha karma-chrome-launcher karma-webpack karma-sourcemap-loader karma-spec-reporter chai @vue/test-utils karma-coverage babel-plugin-istanbul cross-env</li>
<li>覆盖率<ul>
<li>语句覆盖率</li>
<li>分支覆盖率</li>
<li>函数覆盖率</li>
<li>行覆盖率</li>
</ul>
</li>
</ul>
<h2 id="e2e测试"><a href="#e2e测试" class="headerlink" title="e2e测试"></a>e2e测试</h2><ul>
<li>npm install –save-dev nightwatch chromedriver</li>
<li>npm install –save-dev geckodriver # firefox</li>
<li>npm install –save-dev cross-spawn # 启动子进程</li>
<li>npm install –save-dev nightwatch-html-reporter</li>
<li>nightwatch接口<ul>
<li>断言相关<ul>
<li>expect.element()</li>
<li>.value</li>
<li>.text</li>
<li>.equal(val)/.contain(val)/.match(val)</li>
</ul>
</li>
<li>协议映射相关<ul>
<li>.click()</li>
<li>.url()</li>
<li>.setValue()</li>
<li>.pause()</li>
<li>.waitForElementVisible()</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="性能优化"><a href="#性能优化" class="headerlink" title="性能优化"></a>性能优化</h2><ul>
<li>缓存<ul>
<li>开启cache后，模块和生成的chunk如果内容不变则直接用cache，主要解决增量构建过程的性能</li>
<li>HardSourceWebpackPlugin，缓存编译过程中间结果 npm i -D hard-source-webpack-plugin</li>
</ul>
</li>
<li>多线程<ul>
<li>HappyPack</li>
<li>thread-loader #官方推荐</li>
</ul>
</li>
<li>预先编译<ul>
<li>DllPlugin 把基本不变的预先打包出单独dll文件</li>
<li>DllReferencePlugin 配置在文件中引用dll文件</li>
<li>运行一次npm run dll后不需在运行除非dll包有更新</li>
<li>npm i -D add-asset-html-webpack-plugin dll文件提前插入html</li>
<li>与splitChunks功能类似，可以去除splitChunks</li>
</ul>
</li>
</ul>
<h2 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h2><ul>
<li>ecs<ul>
<li>const { spawn } = require(“child_process”);</li>
<li>ssh免密登陆</li>
</ul>
</li>
<li>oss<ul>
<li>vinyl-fs</li>
<li>vinyl-ftp</li>
</ul>
</li>
</ul>
<h1 id="cli"><a href="#cli" class="headerlink" title="cli"></a>cli</h1><h2 id="聚合配置并模版化"><a href="#聚合配置并模版化" class="headerlink" title="聚合配置并模版化"></a>聚合配置并模版化</h2><ul>
<li>app.config.js 聚合用户自定义配置</li>
<li>相应的配置都要从app.config.js中获取</li>
</ul>
<h2 id="handlebars模版化"><a href="#handlebars模版化" class="headerlink" title="handlebars模版化"></a>handlebars模版化</h2><ul>
<li>template 存放模版</li>
<li>meta.js 配置入口<ul>
<li>helpers<ul>
<li>语法{{#helperName}}...{{/helperName}}</li>
<li>内置helper if,上面都语法可根据helperName的truthy进行判断</li>
<li>自定义registerHelper</li>
</ul>
</li>
<li>prompts</li>
<li>filters</li>
<li>completeMessage</li>
</ul>
</li>
</ul>
<h2 id="cli-1"><a href="#cli-1" class="headerlink" title="cli"></a>cli</h2><ul>
<li>工作流程<ul>
<li>运行命令 mc init weex pro</li>
<li>下载模版 </li>
<li>交互配置信息</li>
<li>渲染模版</li>
</ul>
</li>
<li>mc<ul>
<li>1个主命令</li>
<li>2个子命令<ul>
<li>mc init</li>
<li>mc help 默认子命令</li>
</ul>
</li>
</ul>
</li>
<li>主命令开发<ul>
<li>npm i commander</li>
<li>npm link #将包链接到全局</li>
</ul>
</li>
<li>子命令模块<ul>
<li>commander</li>
<li>chalk</li>
<li>inquirer</li>
<li>download-git-repo</li>
<li>rimraf</li>
<li>user-home</li>
<li>ora</li>
<li>metalsmith  <ul>
<li>文件处理工具,从哪里读，做什么处理，写到哪里去</li>
<li>use方法绑定插件</li>
<li>source设定源文件目录</li>
<li>destination指定文件写入的目录</li>
<li>clean(true|false)写入前是否删除原来已经存在的文件</li>
<li>build完成对文件的处理接收回调</li>
<li>metadata读取全局数据对象</li>
</ul>
</li>
<li>handlebars </li>
<li>async </li>
<li>consolidate<ul>
<li>各种模版引擎的整合库</li>
<li>还需要引用需要的模版引擎库</li>
</ul>
</li>
</ul>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">bin/mc</span><br><span class="line"></span><br><span class="line">#!/usr/bin/env node</span><br><span class="line">const program = require(&apos;commander&apos;);</span><br><span class="line">program</span><br><span class="line">  .version(require(&apos;../package&apos;).version)</span><br><span class="line">  .usage(&apos;&lt;command&gt; [options]&apos;)</span><br><span class="line">  .command(&apos;init&apos;, &apos;generate a new fe project&apos;);</span><br><span class="line">program.parse(process.argv);</span><br></pre></td></tr></table></figure>
      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    

    </div>

    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2019/08/17/webpack/"><span>webpack</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2019/08/17/webpack/" rel="bookmark">
        <time class="entry-date published" datetime="2019-08-17T08:29:05.000Z">
          2019-08-17
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <h1 id="基础篇"><a href="#基础篇" class="headerlink" title="基础篇"></a>基础篇</h1><h2 id="webpack及发展历史"><a href="#webpack及发展历史" class="headerlink" title="webpack及发展历史"></a>webpack及发展历史</h2><ul>
<li>目的<ul>
<li>css的预处理</li>
<li>ES6等的支持</li>
<li>图片压缩</li>
<li>发布产物的压缩混淆</li>
</ul>
</li>
<li>同类<ul>
<li>rollup</li>
<li>parcel</li>
</ul>
</li>
<li>安装准备<ul>
<li>brew install nvm , windows可以安装nvm-windows</li>
<li>nvm install v10.16.3</li>
<li>node -v</li>
<li>npm -v</li>
<li>mkdir webpack-demo &amp;&amp; cd webpack-demo</li>
<li>npm init -y</li>
<li>npm i -D webpack webpack-cli</li>
<li>./node_modules/.bin/webpack -v</li>
</ul>
</li>
</ul>
<h2 id="基础配置"><a href="#基础配置" class="headerlink" title="基础配置"></a>基础配置</h2><ul>
<li>基础<ul>
<li>mode</li>
<li>entry</li>
<li>output</li>
<li>module</li>
<li>plugins</li>
</ul>
</li>
<li>mode<ul>
<li>production 默认</li>
<li>development</li>
<li>none</li>
</ul>
</li>
<li>entry<ul>
<li>单入口 “path”</li>
<li>多入口 {name:path}</li>
</ul>
</li>
<li>output<ul>
<li>path 输出路径</li>
<li>filename 构建文件名称<ul>
<li>‘[name]’ 对应入口中的name</li>
<li>‘[hash]’ 对应文件的hash</li>
</ul>
</li>
</ul>
</li>
<li>loaders<ul>
<li>本质是一个函数，接收源文件作为参数输出转换后的结果</li>
<li>babel-loader<ul>
<li>解析ES6/7</li>
<li>需要安装@babel/core @babel/preset-env @babel/proposal-class-properties等</li>
<li>配置文件.babelrc中增加presets和plugins</li>
</ul>
</li>
<li>style-loader<ul>
<li>将css插入head的style标签</li>
</ul>
</li>
<li>css-loader<ul>
<li>解析.css文件转换成commonjs对象</li>
</ul>
</li>
<li>less-loader<ul>
<li>解析less代码成css，依赖less</li>
</ul>
</li>
<li>file-loader<ul>
<li>解析各种文件资源（图片/字体等）</li>
<li>如果希望能把小资源转成base64可以使用url-loader的limit</li>
<li>把二进制文件转成base64后文件大小会增加二进制文件的1/3左右</li>
</ul>
</li>
<li>raw-loader 将文件以字符串内容形式导入</li>
<li>thread-loader</li>
</ul>
</li>
<li>plugins<ul>
<li>本质是一个类，实现了apply方法</li>
<li>CommonsChunkPlugin chunk相同代码抽取成公共js</li>
<li>CleanWebpackPlugin 清理构建目录</li>
<li>CopyWebpackPlugin</li>
<li>ZipWebpackPlugin 将打包出的资源生成一个zip包</li>
<li>HtmlWebpackPlugin </li>
<li>ExtractTextWebpackPlugin</li>
<li>MiniCssExtractPlugin 需要配合.loader替换style-loader进行css文件提取</li>
<li>OptimizeCssAssetsWebpackPlugin</li>
<li>UglifyjsWebpackPlugin</li>
</ul>
</li>
</ul>
<h2 id="高级配置"><a href="#高级配置" class="headerlink" title="高级配置"></a>高级配置</h2><ul>
<li><p>构建监听</p>
<ul>
<li>webpack 命令行传 –watch</li>
<li>webpack.config.js中 watch:true</li>
<li>是通过轮询文件最后修改时间进行的，同时也有aggregateTimeout防止短时间多次修改，有poll指定每秒轮询多少次，ignore指定忽略，这些属性在watchOptions中</li>
</ul>
</li>
<li><p>WDS</p>
<ul>
<li>webpack-dev-server</li>
<li>WDS不输出文件都是存在内存中，所以不用手动刷新浏览器可实现HMR</li>
<li>dev: “webpack-dev-server –open”</li>
<li>webpack.config.js<ul>
<li>mode: ‘development’</li>
<li>plugins: [new webpack.HotModuleReplacementPlugin()]</li>
<li>devServer:{hot:true,contentBase:’./dist’}</li>
</ul>
</li>
<li>WDS灵活定制版WDM webapck-dev-middleware</li>
<li>HMR <ul>
<li>由compiler把源码编译成bundle和HMR的patch</li>
<li>bundle由本地的bundleServer返回给浏览器</li>
<li>HMR的patch由本地的HMRServer(WebSockt)返回浏览器的HMRRuntime</li>
<li>浏览器执行bundle和patch执行代码</li>
</ul>
</li>
</ul>
</li>
<li><p>文件指纹</p>
<ul>
<li>hash 和整个项目有关，只要项目内有变化hash就变，文件处理也可以用[hash:8]</li>
<li>chunkhash 不同的entry会生成不同的chunkhash，常用于js，常设置在output.filename中[chunkhash:8]</li>
<li>contenthash 文件内容不变contenthash不变，常用于css，常设置在MiniCssExtractPlugin的filename中[contenthash:8]</li>
</ul>
</li>
<li><p>代码压缩</p>
<ul>
<li>html 使用html-webpack-plugin的minify对象属性</li>
<li>css 使用optimize-css-assets-webpack-plugin和cssnano</li>
<li>js 内置了uglifyjs-webpack-plugin</li>
</ul>
</li>
<li><p>postcss</p>
<ul>
<li>autoprefixer<ul>
<li>o presto</li>
<li>ms trident</li>
<li>moz gecko</li>
<li>webkit webkit</li>
</ul>
</li>
<li>npm i -D postcss-loader autoprefixer</li>
</ul>
</li>
<li><p>屏幕分辨率</p>
<ul>
<li>rem: font-size of the root element，是相对单位</li>
<li>npm i -D px2rem-loader</li>
<li>options:{remUnit:75,remPrecision:8}</li>
<li>npm i lib-flexible lib-flexible在页面渲染时计算rem的值</li>
</ul>
</li>
<li><p>内联资源到html</p>
<ul>
<li>内联html/js<ul>
<li>raw-loader </li>
<li>html模版里写${ require(‘raw-loader!./meta.html’)} 直接内联html</li>
<li>script里写${ require(‘raw-loader!babel-loader!../node_modules/lib-flexible/flexible.js’) }内联js</li>
</ul>
</li>
<li>内联css<ul>
<li>style-loader options:{insertAt:’top’,singleton:true //所有style合并成1个 }</li>
<li>html-inline-css-webpack-plugin 将打包好的css内联</li>
</ul>
</li>
</ul>
</li>
<li><p>MPA</p>
<ul>
<li>手动的可增加1个entry，然后增加1个对应的htmlWP，不方便维护</li>
<li>通用的动态设置entry:glob.sync(path.join(__dirname,’./src/*/index.js’))和对应的htmlWP<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">const setMPA = () =&gt; &#123;</span><br><span class="line">    const entry = &#123;&#125;;</span><br><span class="line">    const htmlWebpackPlugins = [];</span><br><span class="line">    const entryFiles = glob.sync(path.join(__dirname, &apos;./src/*/index.js&apos;));</span><br><span class="line">    Object.keys(entryFiles)</span><br><span class="line">        .map((index) =&gt; &#123;</span><br><span class="line">            const entryFile = entryFiles[index];</span><br><span class="line">            const match = entryFile.match(/src\/(.*)\/index\.js/);</span><br><span class="line">            const pageName = match &amp;&amp; match[1];</span><br><span class="line"></span><br><span class="line">            entry[pageName] = entryFile;</span><br><span class="line">            htmlWebpackPlugins.push(</span><br><span class="line">                new HtmlWP(&#123;</span><br><span class="line">                    inlineSource: &apos;.css$&apos;,</span><br><span class="line">                    template: path.join(__dirname, `src/$&#123;pageName&#125;/index.html`),</span><br><span class="line">                    filename: `$&#123;pageName&#125;.html`,</span><br><span class="line">                    chunks: [&apos;vendors&apos;, pageName],</span><br><span class="line">                    inject: true,</span><br><span class="line">                    minify: &#123;</span><br><span class="line">                        html5: true,</span><br><span class="line">                        collapseWhitespace: true,</span><br><span class="line">                        preserveLineBreaks: false,</span><br><span class="line">                        minifyCSS: true,</span><br><span class="line">                        minifyJS: true,</span><br><span class="line">                        removeComments: false</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;)</span><br><span class="line">            );</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">    return &#123;</span><br><span class="line">        entry,</span><br><span class="line">        htmlWebpackPlugins</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">const &#123;entry,htmlWebpackPlugins&#125; = setMPA()</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>sourceMap</p>
<ul>
<li>开发环境使用，生产环境只需要传到监控平台</li>
<li>关键字<ul>
<li>eval 使用eval包裹模块代码，最后面制定对应的源文件，不生成单独的map文件</li>
<li>cheap 不包含列信息</li>
<li>source-map 生成.map文件</li>
<li>inline 将.map作为DataURI嵌入，不单独生成.map</li>
<li>module 包含loader的source-map,可对依赖分析</li>
</ul>
</li>
<li>类型<ul>
<li>生产环境使用source-map，map文件上传到监控平台</li>
<li>开发环境使用eval-source-map，加速打包</li>
</ul>
</li>
</ul>
</li>
<li><p>提取公共资源</p>
<ul>
<li>基础库(vue/react/react-dom)分离到cdn，可使用html-webpack-externals-plugin</li>
<li>也可以用webpack4内置的splitChunksPlugin代替CommonsChunkPlugin</li>
<li>chunks说明<ul>
<li>async 默认选项，表示异步引入的库进行分离</li>
<li>initial 同步引入的库进行分离</li>
<li>all 推荐使用，所有引入的库都进行分离</li>
</ul>
</li>
<li>chunks分离后需要把分离出的name添加到htmlWP中的chunks<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">optimization:&#123;</span><br><span class="line">       splitChunks:&#123;</span><br><span class="line">           minSize: 0,</span><br><span class="line">           maxSize:1000,</span><br><span class="line">           minChunks: 2,</span><br><span class="line">           cacheGroups:&#123;</span><br><span class="line">               vendors:&#123;</span><br><span class="line">                   test:/(react|react-dom)/,</span><br><span class="line">                   name:&quot;vendors&quot;,</span><br><span class="line">                   chunks:&quot;all&quot;</span><br><span class="line">               &#125;,</span><br><span class="line">               commons:&#123;</span><br><span class="line">                 name:&quot;commons&quot;,</span><br><span class="line">                 chunks:&quot;all&quot;,</span><br><span class="line">                 minChunks:2</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>treeShaking</p>
<ul>
<li>把模块中没被引用的方法在uglify阶段去除掉</li>
<li>使用<ul>
<li>必须是ES6的语法，不能用在CommonJS，ES6可以静态分析</li>
<li>在.babelrc里设置module:false即可</li>
<li>mode为production情况下默认开启了此功能</li>
<li>要求导出的函数不能有副作用，否则也会失效</li>
</ul>
</li>
<li>原理<ul>
<li>DCE dead code elimination 无用代码擦除<ul>
<li>代码不可到达</li>
<li>代码执行的结果不会被用到</li>
<li>只写不读的代码</li>
</ul>
</li>
<li>ES6模块特点<ul>
<li>import只能出现在代码顶层</li>
<li>import的模块名只能是字符串常量</li>
<li>import的binding是immutable的</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p>ScopeHoisting</p>
<ul>
<li>问题<ul>
<li>构建后的模块代码都是通过闭包实现IIFE</li>
<li>大量的闭包导致代码体积增大，运行时内存开销增大</li>
</ul>
</li>
<li>分析<ul>
<li>把所有的模块都包裹一层函数形成IIFE</li>
<li>把import转换成_webpack_require,export转换成_webpack_exports</li>
<li>把所有模块都缓存到modules数组</li>
<li>通过WEBPACK_REQUIRE_METHOD(0) 启动程序</li>
</ul>
</li>
<li>scopeHoisting将模块代码按照引用顺序放在一个函数作用域，适当的做重命名防止变量冲突，达到减少函数声明和内存开销</li>
<li>使用时mode设置为production默认开启</li>
<li>手动开启使用 new webpack.optimize.ModuleConcatenationPlugin()</li>
</ul>
</li>
<li><p>动态import</p>
<ul>
<li>把相同的代码抽离到一个共享模块，在通过懒加载动态import使初始下载的代码更小</li>
<li>懒加载<ul>
<li>CommonJS使用方式require.ensure()</li>
<li>ES6使用方式 动态import目前还没有原生支持，需要babel插件<ul>
<li>npm i @babel/plugin-syntax-dynamic-import</li>
<li>.babelrc中plugins:[‘@babel/plugin-syntax-dynamic-import’]</li>
<li>代码中需要的地方用import(‘./dynamic.js’).then()</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p>ESLint</p>
<ul>
<li>制定规范<ul>
<li>基于eslint:recommmend配置进行改进，不重复造轮子</li>
<li>能够帮助发现错误的规则全部开启</li>
<li>保持风格统一，不要限制开发体验</li>
</ul>
</li>
<li>落地<ul>
<li>和CICD集成 如gitlab的pipline</li>
<li>和webpack集成</li>
</ul>
</li>
<li>本地开发增加precommit钩子(本地可以–no-verify绕过，所以CICD必须要有)<ul>
<li>npm i -D husky</li>
<li>“precommit”: “lint-staged”</li>
<li>“lint-staged”: {“linters”:”*.{js,scss}”:[“eslint –fix”, “git add”]}</li>
</ul>
</li>
<li>webpack集成ESLint<ul>
<li>.js文件先用eslint-loader再使用babel-loader</li>
<li>npm i -D eslint eslint-loader babel-eslint eslint-plugin-import …</li>
<li>.eslintrc.js<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">module.exports = &#123;</span><br><span class="line">    parser:&quot;babel-eslint&quot;,</span><br><span class="line">    extends:[&apos;&apos;],</span><br><span class="line">    env:&#123;</span><br><span class="line">        browser:true,</span><br><span class="line">        node:true</span><br><span class="line">    &#125;,</span><br><span class="line">    rules:&#123;</span><br><span class="line">        indent:[2,2]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
</li>
<li><p>打包库和组件</p>
<ul>
<li>需求<ul>
<li>打包压缩版和非压缩版</li>
<li>支持AMD/CJS/ESM模块引入和script直接引入，统称UMD</li>
</ul>
</li>
<li>实现<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">const TerserPlugin = require(&apos;terser-webpack-plugin&apos;)</span><br><span class="line">module.exports = &#123;</span><br><span class="line">  mode:&apos;none&apos;,</span><br><span class="line">  entry:&#123;</span><br><span class="line">    &apos;name&apos;:&apos;./src/index.js&apos;,</span><br><span class="line">    &apos;name.min&apos;:&apos;./src/index.js&apos;</span><br><span class="line">  &#125;,</span><br><span class="line">  output:&#123;</span><br><span class="line">    filename:&apos;[name].js&apos;,</span><br><span class="line">    library:&apos;libName&apos;, // 库的全局变量</span><br><span class="line">    libraryExport:&apos;default&apos;,</span><br><span class="line">    libraryTarget:&apos;umd&apos; // 库的引入方式</span><br><span class="line">  &#125;,</span><br><span class="line">  optimization:&#123;</span><br><span class="line">    minimize:true,</span><br><span class="line">    minimizer:[</span><br><span class="line">      new TerserPlugin(&#123;</span><br><span class="line">        include:/\.min\.js$/, //只对.min压缩</span><br><span class="line">      &#125;)</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// package.json</span><br><span class="line">&quot;main&quot;: &quot;index.js&quot;,</span><br><span class="line">&quot;scripts&quot;: &#123;</span><br><span class="line">  &quot;build&quot;: &quot;webpack&quot;,</span><br><span class="line">  &quot;prepublish&quot;: &quot;webpack&quot;</span><br><span class="line">&#125;,</span><br><span class="line"></span><br><span class="line">// index.js</span><br><span class="line">if(process.env.NODE_ENV === &apos;production&apos;)&#123;</span><br><span class="line">  module.exports = require(&apos;./dist/name.min.js&apos;)</span><br><span class="line">&#125;else&#123;</span><br><span class="line">  module.exports = require(&apos;./dist/name.js&apos;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>SSR</p>
<ul>
<li>server side render</li>
<li>优势<ul>
<li>减少网络请求</li>
<li>减少白屏时间</li>
<li>对SEO友好</li>
</ul>
</li>
<li>实现思路<ul>
<li>服务端使用server的renderToString将组件渲染成字符串，路由返回对应的字符串模板</li>
<li>客户端进行环境判断请求对应的文件</li>
</ul>
</li>
<li>问题<ul>
<li>nodejs中没有浏览器的window需要hack：if(typeof window === ‘undefined’){ global.window = {} }</li>
<li>不兼容的组件需要根据打包环境进行适配</li>
<li>http请求需要改写成axios</li>
<li>css样式不显示可以采用浏览器端模板占位符替换的方式’<!--HTML_PLACEHOLDER-->‘</li>
<li>首屏业务数据也可用模板占位符替换的方式<!--INITIAL_DATA_PLACEHOLDER--></li>
</ul>
</li>
</ul>
</li>
<li><p>优化构建日志</p>
<ul>
<li>webpack.config.js中stats字段控制统计信息<ul>
<li>errors-only</li>
<li>minimal</li>
<li>none | false</li>
<li>normal | true</li>
<li>verbose </li>
</ul>
</li>
<li>friendly-errors-webpack-plugin<ul>
<li>stats: ‘errors-only’</li>
<li>new FriendlyErrorsWebpackPlugin()</li>
<li>日志提示<ul>
<li>success</li>
<li>warning</li>
<li>error</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p>构建异常和中断</p>
<ul>
<li>如果没有错误则process.exit(0)</li>
<li>如果有错误则process.exit(非0)，回调函数err.code则为非0数值</li>
<li>compiler每次构建结束后都会触发done这个hook</li>
<li>hook回调stats.compilation.errors错误对象</li>
</ul>
</li>
</ul>
<h1 id="进阶篇"><a href="#进阶篇" class="headerlink" title="进阶篇"></a>进阶篇</h1><h2 id="可维护的配置"><a href="#可维护的配置" class="headerlink" title="可维护的配置"></a>可维护的配置</h2><ul>
<li><p>抽离成npm包的意义</p>
<ul>
<li>通用性<ul>
<li>开发者无需关注构建配置</li>
<li>统一团队构建脚本</li>
</ul>
</li>
<li>可维护性<ul>
<li>构建配置合理拆分</li>
<li>README/CHANGELOG</li>
</ul>
</li>
<li>质量<ul>
<li>冒烟测试/单元测试/测试覆盖率</li>
<li>CI</li>
</ul>
</li>
</ul>
</li>
<li><p>构建配置管理的可选方案</p>
<ul>
<li>通过多个配置文件管理对应环境 webpack –config参数控制</li>
<li>构建配置设计成一个库 如neutrino webpack-blocks</li>
<li>设计成一个工具 如create-react-app nwb</li>
<li>配置放在一个文件，通过–env控制</li>
</ul>
</li>
<li><p>构建配置包设计</p>
<ul>
<li>通过多个配置文件管理对应环境<ul>
<li>webpack.base.js<ul>
<li>资源解析(es6/react/css/less/图片/字体)</li>
<li>样式增强(css前缀自动补齐/px2rem)</li>
<li>目录清理</li>
<li>多页面打包</li>
<li>构建过程日志优化</li>
<li>构建错误捕获和处理</li>
<li>css提取成一个单独的文件</li>
</ul>
</li>
<li>webpack.dev.js<ul>
<li>hmr</li>
<li>sourcemap</li>
</ul>
</li>
<li>webpack.prod.js<ul>
<li>代码压缩</li>
<li>文件指纹</li>
<li>treeShaking</li>
<li>scopeHoisting</li>
<li>速度优化 基础包放cdn</li>
<li>体积优化 代码分割动态import</li>
</ul>
</li>
<li>webpack.ssr.js<ul>
<li>output.libraryTarget</li>
<li>css解析</li>
</ul>
</li>
</ul>
</li>
<li>npm包<ul>
<li>规范(git commit/READMEESLINT/SemVer)</li>
<li>质量(冒烟测试/单元测试/测试覆盖率/CI)</li>
</ul>
</li>
<li>配置组合<ul>
<li>webpack-merge</li>
<li>module.exports=merge(baseConf,devConf)</li>
</ul>
</li>
<li>目录结构<ul>
<li>test/</li>
<li>lib/</li>
<li>README.md</li>
<li>CHANGELOG.md</li>
<li>.eslintrc.js</li>
<li>.gitignore</li>
<li>package.json</li>
<li>index.js</li>
</ul>
</li>
</ul>
</li>
<li><p>构建包使用ESLINT</p>
<ul>
<li>使用eslint-config-airbnb-base规则集</li>
<li>使用eslint –fix做自动修复</li>
<li>package.json “lint”:”eslint ./lib –fix”</li>
<li>.eslintrc.js<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">module.exports = &#123;</span><br><span class="line">  extends:[&apos;airbnb-base&apos;],</span><br><span class="line">  parser:&apos;babel-eslint&apos;,</span><br><span class="line">  env:&#123;</span><br><span class="line">    browser:true,</span><br><span class="line">    node:true</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>冒烟测试smoke testing</p>
<ul>
<li>指对提交测试的软件在进行详细测试前的预测试</li>
<li>主要目的是暴露基本功能失效的严重问题</li>
<li>执行<ul>
<li>构建是否成功 webpack(conf,(err,stats)=&gt;{})</li>
<li>是否生成对应文件 glob.sync([‘*.js’]).length</li>
</ul>
</li>
</ul>
</li>
<li><p>单元测试和测试覆盖率</p>
<ul>
<li>框架<ul>
<li>mocha(单纯的测试框架)+chai(断言库)</li>
<li>jasmine/jest 集成框架，开箱即用</li>
</ul>
</li>
<li>mocha接入<ul>
<li>npm i -D mocha chai</li>
<li>test.js中编写describe/it/expect</li>
<li>package.json中”test”:”mocha “</li>
<li>npm run test</li>
</ul>
</li>
<li>测试覆盖率<ul>
<li>npm i -D istanbul</li>
<li>package.json中”test”:”istanbul cover mocha”</li>
</ul>
</li>
</ul>
</li>
<li><p>CI</p>
<ul>
<li>作用<ul>
<li>快速发现错误</li>
<li>防止分支大幅偏离主干</li>
</ul>
</li>
<li>措施<ul>
<li>集成前必须跑通测试，否则不予集成</li>
</ul>
</li>
<li>排名<ul>
<li>travis-ci</li>
<li>circle-ci</li>
<li>jenkins-ci</li>
</ul>
</li>
</ul>
</li>
<li><p>发布npm包</p>
<ul>
<li>npm login</li>
<li>npm version patch|minor|major(自动git提交和tag)</li>
<li>npm publish</li>
</ul>
</li>
<li><p>git提交规范和changeLog生成</p>
<ul>
<li>提交规范优势<ul>
<li>加快review流程</li>
<li>根据提交生成changeLog</li>
<li>可追溯可回顾</li>
</ul>
</li>
<li>技术方案<ul>
<li>目地统一提交日志标准</li>
<li>使用angular的git commit规范<ul>
<li>信息分3部分，空行分割<ul>
<li>标题(首字母不大写，末尾不要标点)<ul>
<li>type(scope): subject</li>
</ul>
</li>
<li>主题内容</li>
<li>尾注</li>
</ul>
</li>
<li>提交类型type限制<ul>
<li>feat：新增feature</li>
<li>fix：修复bug</li>
<li>docs：仅仅修改了文档</li>
<li>style：仅仅修改文件样式，不改变逻辑</li>
<li>perf：优化相关，提升体验性能等</li>
<li>refactor：代码重构无新功能或bug修复</li>
<li>test：测试用例</li>
<li>chore：改变构建流程或增加依赖库工具</li>
<li>revert：回滚到上一版本</li>
</ul>
</li>
<li>scope(可根项目分成大类如docs/components)</li>
<li>主题内容可以详细列明每个修改点影响点</li>
<li>尾注可以增加链接或关闭issue等</li>
</ul>
</li>
<li>日志提交时友好的提示工具:commitize</li>
<li>不符合要求的拒绝提交:validate-commit-msg</li>
<li>统一changeLog文档信息生成:conventional-changelog-cli</li>
</ul>
</li>
<li>本地增加precommit钩子<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">npm i -D husky validate-commit-msg conventional-changelog-cli</span><br><span class="line"></span><br><span class="line">&quot;scripts&quot;:&#123;</span><br><span class="line">  &quot;commitmsg&quot;:&quot;validate-commit-msg&quot;,</span><br><span class="line">  &quot;changelog&quot;:&quot;conventional-changelog -p angular -i CHANGELOG.md -s -r 0&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>语义化版本号</p>
<ul>
<li>semantic versioning<ul>
<li>major 做了不兼容api的修改</li>
<li>minor 做了向下兼容的功能新增</li>
<li>patch 做了向下兼容的问题修正</li>
<li>major.minor.patch版本号严格递增</li>
</ul>
</li>
<li>优势<ul>
<li>避免出现循环依赖</li>
<li>减少依赖冲突</li>
</ul>
</li>
<li>发布重要版本时可以发先行版本<ul>
<li>alpha 内测版</li>
<li>beta 外部小范围测试版，可以加新功能</li>
<li>rc 公测版release candidate不会加新功能，主要用排错</li>
<li>major.minor.patch-alpha.2</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="构建速度和体积优化"><a href="#构建速度和体积优化" class="headerlink" title="构建速度和体积优化"></a>构建速度和体积优化</h2><ul>
<li><p>初级分析</p>
<ul>
<li>使用webpack内置的stats<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&quot;scripts&quot;:&#123;</span><br><span class="line">  &quot;build:stats&quot;:&quot;webpack --env production --json &gt; stats.json&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>速度分析</p>
<ul>
<li>使用speed-measure-webpack-plugin插件</li>
<li>可以看到每个loader和插件执行耗时和总耗时<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">npm i -D speed-measure-webpack-plugin</span><br><span class="line"></span><br><span class="line">const SMWP = require(&apos;speed-measure-webpack-plugin&apos;)</span><br><span class="line"></span><br><span class="line">const smp = new SMWP();</span><br><span class="line"></span><br><span class="line">module.exports = smp.wrap(WEBPACK_CONFIG)</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>体积分析</p>
<ul>
<li>使用webpack-bundle-analyzer插件</li>
<li>构建完毕自动在8888端口展示结果<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">npm i -D webpack-bundle-analyzer</span><br><span class="line"></span><br><span class="line">const &#123; BundleAnalyzerPlugin&#125; = require(&apos;webpack-bundle-analyzer&apos;);</span><br><span class="line"></span><br><span class="line">plugins:[</span><br><span class="line">  new webpack-bundle-analyzer()</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>速度提升</p>
<ul>
<li>使用高版本nodejs和webpack，从底层做了优化</li>
<li>多进程多实例构建 thread-loader </li>
<li>多进程多实例并行压缩terser-webpack-plugin<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">npm i -D thread-loader terser-webpack-plugin</span><br><span class="line"></span><br><span class="line">use:[</span><br><span class="line">  &#123;</span><br><span class="line">    loader:&quot;thread-loader&quot;,</span><br><span class="line">    options:&#123;</span><br><span class="line">      workers:3</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;babel-loader&quot;</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">optimization:&#123;</span><br><span class="line">  minimizer:[</span><br><span class="line">    new TerserWebpackPlugin(&#123;</span><br><span class="line">      parallel:true // 默认cpu核心2倍-1</span><br><span class="line">    &#125;)</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>进一步分包</p>
<ul>
<li>htmlWebpackExternalsPlugin将基础包分离到cdn引入的缺点是可能有很多基础包很多script请求</li>
<li>splitChunks缺点是每次都要分析依赖的基础包</li>
<li>DLLPlugin分包可以把框架基础包和业务基础包进行预编译，打包成一个文件，然后通过DLLReferencePlugin对manifest.json引用<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">// webpack.dll.js</span><br><span class="line">const path = require(&apos;path&apos;)</span><br><span class="line">const webpack = require(&apos;webpack&apos;)</span><br><span class="line">module.exports = &#123;</span><br><span class="line">  entry:&#123;</span><br><span class="line">    library:[</span><br><span class="line">      &apos;react&apos;,</span><br><span class="line">      &apos;react-dom&apos;</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  output:&#123;</span><br><span class="line">    filename:&quot;[name]_[chunkhash]_dll.js&quot;,</span><br><span class="line">    path:path.join(__dirname,&apos;dll&apos;),</span><br><span class="line">    library:&quot;[name]&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  plugins:[</span><br><span class="line">    new webpack.DllPlugin(&#123;</span><br><span class="line">      name:&quot;[name]_[hash]&quot;,</span><br><span class="line">      path:path.join(__dirname,&apos;dll/[name].json&apos;)</span><br><span class="line">    &#125;)</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// package.json</span><br><span class="line">&quot;scripts&quot;:&#123;</span><br><span class="line">  &quot;dll&quot;:&quot;webpack --config webpack.dll.js&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// webpack.prod.js</span><br><span class="line"></span><br><span class="line">new webpack.DllReferencePlugin(&#123;</span><br><span class="line">  manifest: require(&apos;./dll/library.json&apos;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>缓存</p>
<ul>
<li>提升二次构建速度</li>
<li>思路<ul>
<li>babel-loader开启缓存</li>
<li>terser-webpack-plugin开启缓存</li>
<li>hard-source-webpack-plugin开启缓存<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">// babel-loader</span><br><span class="line">&apos;babel-loader?cacheDirectory=true&apos;</span><br><span class="line"></span><br><span class="line">// terser-webpack-plugin</span><br><span class="line">optimization:&#123;</span><br><span class="line">  minimizer:[</span><br><span class="line">    new TerserWebpackPlugin(&#123;</span><br><span class="line">      parallel:true,</span><br><span class="line">      cache:true</span><br><span class="line">    &#125;)</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// hard-source-webpack-plugin</span><br><span class="line">let HSWP= require(&apos;hard-source-webpack-plugin&apos;)</span><br><span class="line"></span><br><span class="line">plugins:[</span><br><span class="line">  new HSWP()</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
</li>
<li><p>缩小构建目标</p>
<ul>
<li>尽可能少的构建模块 exclude:’node_modules’</li>
<li>减少文件搜索范围<ul>
<li>优化resolve.modules [path.resolve(__dirname,’node_modules’)]</li>
<li>优化resolve.mainFields [‘main’]</li>
<li>优化resolve.extensions [‘.js’,’.json’]</li>
<li>优化resolve.alias {react:path.resolve(__dirname,’node_modules/….js’)}</li>
</ul>
</li>
</ul>
</li>
<li><p>图片压缩</p>
<ul>
<li>基于nodejs的imagemin或tinypng的api，使用image-webpack-loader</li>
<li>imagemin优势<ul>
<li>很多可配置项目</li>
<li>可引入第三方优化插件</li>
<li>可处理多种图片格式<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  loader: &apos;image-webpack-loader&apos;,</span><br><span class="line">  options: &#123;</span><br><span class="line">    mozjpeg: &#123;</span><br><span class="line">      progressive: true,</span><br><span class="line">      quality: 65</span><br><span class="line">    &#125;,</span><br><span class="line">    // optipng.enabled: false will disable optipng</span><br><span class="line">    optipng: &#123;</span><br><span class="line">      enabled: false,</span><br><span class="line">    &#125;,</span><br><span class="line">    pngquant: &#123;</span><br><span class="line">      quality: &apos;65-90&apos;,</span><br><span class="line">      speed: 4</span><br><span class="line">    &#125;,</span><br><span class="line">    gifsicle: &#123;</span><br><span class="line">      interlaced: false,</span><br><span class="line">    &#125;,</span><br><span class="line">    // the webp option will enable WEBP</span><br><span class="line">    webp: &#123;</span><br><span class="line">      quality: 75</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
</li>
<li><p>treeShaking擦除无用css</p>
<ul>
<li>默认模块中只要有一个方法被引用整个文件会被打入bundle中，treeShaking是在uglify阶段擦除无用</li>
<li>webpack4中production默认开启treeShaking</li>
<li>前提必须是ESM语法，CJS不支持</li>
<li>手动开启需要在.babelrc中设置modules:false</li>
<li>删除无用css2种方案<ul>
<li>purifyCSS 遍历代码，识别已经用到的css</li>
<li>uncss 通过document.querySelector进行识别</li>
</ul>
</li>
<li>实践<ul>
<li>purgecss-webpack-plugin + mini-css-extract-plugin</li>
</ul>
</li>
</ul>
</li>
<li><p>动态polyfill</p>
<ul>
<li>减少构建体积</li>
<li>polyfill是根据UA下发需要的polyfill来按需加载</li>
<li>可以直接script[src=’’]来引用polyfill.io服务</li>
<li>也可以基于官方开源的方案自建polyfill的cdn服务</li>
<li>ua篡改也可以根据代码结果降级为获取全部polyfill</li>
</ul>
</li>
</ul>
<h1 id="原理篇"><a href="#原理篇" class="headerlink" title="原理篇"></a>原理篇</h1><h2 id="源码掌握原理"><a href="#源码掌握原理" class="headerlink" title="源码掌握原理"></a>源码掌握原理</h2><ul>
<li><p>webpack源码</p>
<ul>
<li>本质<ul>
<li>基于事件流的编程范例，运行一系列的插件</li>
<li>compiler = webpack(options)</li>
</ul>
</li>
<li>启动流程<ul>
<li>npm scripts</li>
<li>webpack cli</li>
<li>实际都是执行的node_modules/webpack/bin/webpack.js</li>
</ul>
</li>
<li>主要步骤<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">process.exitCode = 0;</span><br><span class="line">const runCommand = (cmd,args)=&gt;&#123;&#125;</span><br><span class="line">const installed = packageName=&gt;&#123;&#125;</span><br><span class="line">const CLIs = []</span><br><span class="line">const installedCLIs = CLIs.filter()</span><br><span class="line">if(installedCLIs.length ===0 )&#123;</span><br><span class="line"></span><br><span class="line">&#125;else if(installedCLIs.length ===1)&#123;</span><br><span class="line"></span><br><span class="line">&#125;else&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>webpack-cli源码</p>
<ul>
<li>主要流程<ul>
<li>引入yargs，对命令行进行定制</li>
<li>分析命令行参数，对参数进行转换，组成编译配置项</li>
<li>引入webpack，根据配置项进行编译</li>
</ul>
</li>
<li>不需编译的子命令<ul>
<li>init</li>
<li>migrate</li>
<li>add</li>
<li>remote</li>
<li>serve</li>
<li>info</li>
<li>generate-loader</li>
<li>generate-plugin</li>
</ul>
</li>
</ul>
</li>
<li><p>tapable</p>
<ul>
<li>类似nodejs的EventEmitter,主要控制钩子的发布和订阅</li>
<li>插件系统发布或订阅钩子函数进行处理</li>
<li>9大hook类<ul>
<li>SyncHook</li>
<li>SyncBailHook</li>
<li>SyncWaterfallHook</li>
<li>SyncLoopHook</li>
<li>AsyncParallelHook</li>
<li>AsyncParallelBailHook</li>
<li>AsyncSeriesHook</li>
<li>AsyncSeriesBailHook</li>
<li>AsyncSeriesWaterfallHook</li>
</ul>
</li>
<li>绑定和执行<ul>
<li>同步:tap和call</li>
<li>异步:tapAsync/tapPromise/tap和callAsync/<br>promise<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">const hook1 = new SyncHook([&quot;a1&quot;,&quot;a2&quot;,&quot;a3&quot;])</span><br><span class="line"></span><br><span class="line">hook1.tap(&quot;hook1&quot;,(a1,a2,a3)=&gt;&#123;&#125;)</span><br><span class="line">hook1.call(1,2,3)</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
</li>
<li><p>简易实现webpack</p>
<ul>
<li>babel语法转换 babylon</li>
<li>依赖分析 babel-traverse</li>
</ul>
</li>
</ul>
<h2 id="自定义loader"><a href="#自定义loader" class="headerlink" title="自定义loader"></a>自定义loader</h2><ul>
<li><p>loader链式调用和执行顺序</p>
<ul>
<li>loader只是一个导出为函数的js模块</li>
<li>module.exports = function(source){return s}</li>
<li>链式调用时从右到左从后到前依次串行执行</li>
<li>函数组合的2种方式<ul>
<li>unix的pipline从左到右</li>
<li>compose的方式从右到左compose=(f,g)=&gt;(…args)=&gt;f(g(…args)) webpack采用此方式</li>
</ul>
</li>
</ul>
</li>
<li><p>loader-runner</p>
<ul>
<li>可用webpack-cli的generate-loader命令</li>
<li>loader-runner可以在不安装webpack情况下运行loaders</li>
<li>webpack也使用loader-runner执行loader</li>
<li>开发中也可以用loader-runner进行loader的开发和调试</li>
</ul>
</li>
<li><p>实战</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">mkdir raw-loader &amp;&amp; cd raw-loader</span><br><span class="line">npm init -y </span><br><span class="line">npm i loader-runner</span><br><span class="line"></span><br><span class="line">/src/demo.txt</span><br><span class="line">demotxt</span><br><span class="line"></span><br><span class="line">/src/raw-loader.js</span><br><span class="line">module.exports=function(src)&#123;</span><br><span class="line">  const json = JSON.stringify(src)</span><br><span class="line">              .replace(/\u2028/g,&apos;\\u2028&apos;)</span><br><span class="line">              .replace(/\u2029/g,&apos;\\u2029&apos;)</span><br><span class="line"></span><br><span class="line">  // 正常返回 return `export default $&#123;json&#125;`; </span><br><span class="line">  // 抛错 throw new Error(&apos;myError&apos;);</span><br><span class="line">  // 也可通过this.callback(error,data1 [,data2...])</span><br><span class="line">  this.callback(null, json);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/run-loader.js</span><br><span class="line">const &#123;runLoaders &#125; = require(&apos;loader-runner&apos;);</span><br><span class="line">const fs = require(&apos;fs&apos;);</span><br><span class="line">const path = require(&apos;path&apos;)</span><br><span class="line">runLoaders(&#123;</span><br><span class="line">    resource:path.join(__dirname,&apos;./src/demo.txt&apos;),</span><br><span class="line">    loaders:[</span><br><span class="line">        path.join(__dirname,&apos;./src/raw-loader.js&apos;)</span><br><span class="line">    ],</span><br><span class="line">    context:&#123;</span><br><span class="line">        minimize:true</span><br><span class="line">    &#125;,</span><br><span class="line">    readResource:fs.readFile.bind(fs)</span><br><span class="line">&#125;,function(err,res)&#123;</span><br><span class="line">    console.log(err,res)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">node run-loader.js</span><br></pre></td></tr></table></figure>
</li>
<li><p>高级用法</p>
<ul>
<li><p>loader-utils的getOptions获取loader参数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">const loaderUtils = require(&apos;loader-utils&apos;);</span><br><span class="line">module.exports = function(source)&#123;</span><br><span class="line">  const &#123;name&#125; = loaderUtils.getOptions(this);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>loader的异步处理</p>
<ul>
<li>通过this.async()返回的一个函数进行异步处理</li>
<li>第一个参数是error，第二个参数是处理结果<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">module.exports = function(source)&#123;</span><br><span class="line">  const callback = this.async();</span><br><span class="line"></span><br><span class="line">  fs.readFile(path,&apos;utf-8&apos;,(err,data)=&gt;&#123;</span><br><span class="line">    callback(err,data)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>loader的缓存</p>
<ul>
<li>webpack中默认开启缓存</li>
<li>可使用this.cacheable(false)关掉缓存</li>
<li>缓存的条件是相同的输入有相同的输出</li>
<li>有依赖的loader无法使用缓存</li>
</ul>
</li>
<li><p>loader的文件输出</p>
<ul>
<li>this.emitFile(outputPath,content)</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="自定义plugin"><a href="#自定义plugin" class="headerlink" title="自定义plugin"></a>自定义plugin</h2><ul>
<li><p>插件</p>
<ul>
<li>没有loader那样的独立运行环境，只能在webpack内运行</li>
<li>插件需要导出一个类，类需要实现apply方法</li>
<li>apply方法接收到一个compiler对象参数</li>
<li>插件内通过compiler的hooks和compilation的hooks做逻辑处理</li>
</ul>
</li>
<li><p>搭建插件运行环境</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">const path = require(&apos;path&apos;);</span><br><span class="line">const DemoPlugin = require(&apos;./plugins/demo.js&apos;);</span><br><span class="line">const options = &#123;&#125;</span><br><span class="line"></span><br><span class="line">module.exports = &#123;</span><br><span class="line">  entry:&#123;</span><br><span class="line">    lib: path.join(__dirname,&apos;src/lib.js&apos;)</span><br><span class="line">  &#125;,</span><br><span class="line">  output:&#123;</span><br><span class="line">    path:path.join(__dirname,&apos;dist&apos;),</span><br><span class="line">    filename:&apos;[name].js&apos;</span><br><span class="line">  &#125;,</span><br><span class="line">  plugins:[</span><br><span class="line">    new DemoPlugin(options)</span><br><span class="line">  ]</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// plugins/demo.js</span><br><span class="line">module.exports = class DemoPlugin &#123;</span><br><span class="line">  constructor(options)&#123;</span><br><span class="line">    this.options = options</span><br><span class="line">  &#125;</span><br><span class="line">  apply(compiler)&#123;</span><br><span class="line">    console.log(this.options);</span><br><span class="line">    compiler.hooks.done.tap(&apos;demo&apos;,()=&gt;&#123;&#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>错误处理</p>
<ul>
<li>接收参数时可以直接throw new Error()</li>
<li>hooks处理阶段通过compilation.warnings或errors.push(‘msg’)</li>
</ul>
</li>
<li><p>文件输出</p>
<ul>
<li>通过compilation.assets配合webpack-sources包<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">const JSZip = require(&apos;jszip&apos;)</span><br><span class="line">const RawSource = require(&apos;webpack-sources&apos;).RawSource</span><br><span class="line">const path = require(&apos;path&apos;)</span><br><span class="line">const zip = new JSZip()</span><br><span class="line">module.exports = class DemoPlugin &#123;</span><br><span class="line">  constructor (options) &#123;</span><br><span class="line">    this.options = options</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  apply (compiler) &#123;</span><br><span class="line">    compiler.hooks.emit.tapAsync(&apos;zipPlugin&apos;, (compilation, cb) =&gt; &#123;</span><br><span class="line">      const folder = zip.folder(this.options.name)</span><br><span class="line">      for (const filename in compilation.assets) &#123;</span><br><span class="line">        const source = compilation.assets[filename].source()</span><br><span class="line">        folder.file(filename, source)</span><br><span class="line">      &#125;</span><br><span class="line">      zip.generateAsync(&#123;</span><br><span class="line">        type: &apos;nodebuffer&apos;</span><br><span class="line">      &#125;).then((content) =&gt; &#123;</span><br><span class="line">        console.log(compilation.options)</span><br><span class="line">        const outputPath = path.join(compilation.options.output.path, this.options.name + &apos;.zip&apos;)</span><br><span class="line">        const relativePath = path.relative(compilation.options.output.path, outputPath)</span><br><span class="line">        compilation.assets[relativePath] = new RawSource(content)</span><br><span class="line">        cb()</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
</li>
</ul>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/webpack/">webpack</a>
    </span>
    

    </div>

    
  </div>
</article>




<nav class="pagination">
  
  
  <a href="/page/2/" class="pagination-next">Next</a>
  
</nav>
    </main>

    <footer class="site-footer">
  <p class="site-info">
    Proudly powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and
    Theme by <a href="https://github.com/CodeDaraW/Hacker" target="_blank">Hacker</a>
    </br>
    
    &copy; 2020 prief
    
  </p>
</footer>
    
  </div>
</div>
</body>
</html>