<!DOCTYPE html>
<html lang="en">
  <head><meta name="generator" content="Hexo 3.9.0">
    
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,minimum-scale=1,maximum-scale=1">


<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">



  <meta name="description" content="k8s-mooc">








  <link rel="alternate" href="/atom.xml" title="prief">




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=1.1">



<link rel="canonical" href="https://prief.github.io/k8s-mooc/">


<meta name="description" content="k8s快速入门核心概念 kubernetes 舵手 image container pod 包含1个或多个container container之间共享网络，ip   replicaset deployment service 通过labelSelector选择后端服务 通过clusterIp暴露服务   https://k8s.imroc.io/  架构设计 master etcd apiSer">
<meta property="og:type" content="article">
<meta property="og:title" content="k8s-mooc">
<meta property="og:url" content="https://prief.github.io/k8s-mooc/index.html">
<meta property="og:site_name" content="prief">
<meta property="og:description" content="k8s快速入门核心概念 kubernetes 舵手 image container pod 包含1个或多个container container之间共享网络，ip   replicaset deployment service 通过labelSelector选择后端服务 通过clusterIp暴露服务   https://k8s.imroc.io/  架构设计 master etcd apiSer">
<meta property="og:locale" content="en">
<meta property="og:updated_time" content="2020-05-19T15:13:11.681Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="k8s-mooc">
<meta name="twitter:description" content="k8s快速入门核心概念 kubernetes 舵手 image container pod 包含1个或多个container container之间共享网络，ip   replicaset deployment service 通过labelSelector选择后端服务 通过clusterIp暴露服务   https://k8s.imroc.io/  架构设计 master etcd apiSer">


<link rel="stylesheet" type="text/css" href="/css/style.css?v=1.1">
<link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">





<script type="text/javascript">
  var themeConfig = {
    fancybox: {
      enable: false
    },
  };
</script>




  



    <title> k8s-mooc - prief </title>
  </head>

  <body>
    <div id="page">
      <header id="masthead"><div class="site-header-inner">
    <h1 class="site-title">
        <a href="/." class="logo">prief</a>
    </h1>

    <nav id="nav-top">
        
            <ul id="menu-top" class="nav-top-items">
                
                    <li class="menu-item">
                        <a href="/archives">
                            
                            
                                Archives
                            
                        </a>
                    </li>
                
                    <li class="menu-item">
                        <a href="/about">
                            
                            
                                About
                            
                        </a>
                    </li>
                
            </ul>
        
  </nav>
</div>

      </header>
      <div id="content">
        
    <div id="primary">
        
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          k8s-mooc
        
      </h1>

      <time class="post-time">
          Sep 09 2019
      </time>
    </header>



    
            <div class="post-content">
            <h3 id="k8s快速入门"><a href="#k8s快速入门" class="headerlink" title="k8s快速入门"></a>k8s快速入门</h3><h4 id="核心概念"><a href="#核心概念" class="headerlink" title="核心概念"></a>核心概念</h4><ul>
<li>kubernetes 舵手</li>
<li>image</li>
<li>container</li>
<li>pod<ul>
<li>包含1个或多个container</li>
<li>container之间共享网络，ip</li>
</ul>
</li>
<li>replicaset</li>
<li>deployment</li>
<li>service<ul>
<li>通过labelSelector选择后端服务</li>
<li>通过clusterIp暴露服务</li>
</ul>
</li>
<li><a href="https://k8s.imroc.io/" target="_blank" rel="noopener">https://k8s.imroc.io/</a></li>
</ul>
<h4 id="架构设计"><a href="#架构设计" class="headerlink" title="架构设计"></a>架构设计</h4><ul>
<li>master<ul>
<li>etcd</li>
<li>apiServer</li>
<li>scheduler</li>
<li>controllerManager</li>
</ul>
</li>
<li>worker<ul>
<li>kubelet</li>
<li>kube-proxy</li>
<li>docker</li>
</ul>
</li>
</ul>
<h4 id="认证授权"><a href="#认证授权" class="headerlink" title="认证授权"></a>认证授权</h4><ul>
<li>https<ul>
<li>ssl/tls</li>
<li>CA(浏览器的公共CA和自有CA)</li>
</ul>
</li>
<li>k8s认证<ul>
<li>集群外访问apiServer<ul>
<li>客户端证书认证(kubectl,tls双向认证)</li>
<li>BearerToken认证(apiServer内置了可信任的token)</li>
</ul>
</li>
<li>集群内pod访问apiServer<ul>
<li>serviceAccount<ul>
<li>三部分(namespace,token,ca)</li>
<li>上面的信息通过目录挂载到pod中，应用通过指定目录使用</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>授权<ul>
<li>ABAC</li>
<li>webHook</li>
<li>RBAC(最新的主流方案，roleBasedAccessControl)<ul>
<li>User<ul>
<li>user</li>
<li>serviceAccount</li>
</ul>
</li>
<li>Role<ul>
<li>namespace</li>
<li>name</li>
<li>resource</li>
<li>verbs</li>
</ul>
</li>
<li>Authority<ul>
<li>resource</li>
<li>verbs</li>
</ul>
</li>
<li>RBAC<ul>
<li>Role/RoleBinding</li>
<li>ClusterRole/ClusterRoleBinding</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>准入控制<ul>
<li>AdmisionControl，类似java中的filter</li>
<li>AlwaysAdmit</li>
<li>AlwaysDeny</li>
<li>ServiceAccount</li>
<li>DenyEscolatingExec</li>
</ul>
</li>
</ul>
<h4 id="集群搭建方案对比"><a href="#集群搭建方案对比" class="headerlink" title="集群搭建方案对比"></a>集群搭建方案对比</h4><ul>
<li>kubeadm<ul>
<li>优雅，几乎所有组件都在pod中</li>
<li>简单</li>
<li>支持高可用</li>
<li>升级方便</li>
</ul>
</li>
<li>二进制<ul>
<li>容易维护</li>
<li>灵活</li>
<li>支持高可用</li>
<li>升级方便</li>
<li>证书、配置等需要一步步操作</li>
</ul>
</li>
</ul>
<h3 id="kubeadm方式搭建"><a href="#kubeadm方式搭建" class="headerlink" title="kubeadm方式搭建"></a>kubeadm方式搭建</h3><h4 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h4><ul>
<li><p>统一主机名</p>
<ul>
<li>hostname</li>
<li>hostnamectl set-hostname name</li>
<li>vi /etc/hosts</li>
</ul>
</li>
<li><p>安装依赖包</p>
<ul>
<li>wget -O /etc/yum.repos.d/CentOS-Base.repo <a href="http://mirrors.aliyun.com/repo/Centos-7.repo" target="_blank" rel="noopener">http://mirrors.aliyun.com/repo/Centos-7.repo</a></li>
<li>rhel更换免费的yum源 </li>
<li>yum install -y epel-release &amp;&amp; yum clean all &amp;&amp; yum makecache &amp;&amp; yum update -y</li>
<li>yum install -y conntrack ipvsadm ipset jq sysstat curl iptables libseccomp ntpdate</li>
<li>ntpdate ip</li>
</ul>
</li>
<li><p>主机配置</p>
<ul>
<li>关闭防火墙 systemctl stop firewalld &amp;&amp; systemctl disable firewalld</li>
<li>关闭swap  swapoff -a &amp;&amp; sed -i &#39;/swap/s/^(.*)$/# \1/g&#39; /etc/fstab</li>
<li>重置iptables iptables -F &amp;&amp; iptables -X &amp;&amp; iptables -F -t nat &amp;&amp; iptables -X -t nat &amp;&amp; iptables -P FORWARD ACCEPT &amp;&amp; service iptables save</li>
<li>关闭selinux setenforce 0 &amp;&amp; sed -i ‘s/^SELINUX=.*$/SELINUX=disabled/‘ /etc/selinux/config</li>
<li>关闭dnsmasq systemctl stop dnsmasq &amp;&amp; systemctl disable dnsmasq</li>
<li>配置k8s系统文件 vim /etc/sysctl.d/kubernetes.conf &amp;&amp; sysctl -p /etc/sysctl.d/kubernetes.conf<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/sysctl.d/kubernetes.conf &lt;&lt;EOF</span><br><span class="line">net.bridge.bridge-nf-call-iptables=1</span><br><span class="line">net.bridge.bridge-nf-call-ip6tables=1</span><br><span class="line">net.ipv4.ip_forward=1</span><br><span class="line">vm.swappiness=0</span><br><span class="line">vm.overcommit_memory=1</span><br><span class="line">vm.panic_on_oom=0</span><br><span class="line">fs.inotify.max_user_watches=89100</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>安装docker</p>
<ul>
<li>mkdir -p /opt/kubernetes/docker &amp;&amp; cd /opt/kubernetes/docker</li>
<li>wget <a href="http://yum.dockerproject.org/repo/main/centos/7/Packages/docker-engine-selinux-17.03.1.ce-1.el7.centos.noarch.rpm" target="_blank" rel="noopener">http://yum.dockerproject.org/repo/main/centos/7/Packages/docker-engine-selinux-17.03.1.ce-1.el7.centos.noarch.rpm</a></li>
<li>wget <a href="http://yum.dockerproject.org/repo/main/centos/7/Packages/docker-engine-debuginfo-17.03.1.ce-1.el7.centos.x86_64.rpm" target="_blank" rel="noopener">http://yum.dockerproject.org/repo/main/centos/7/Packages/docker-engine-debuginfo-17.03.1.ce-1.el7.centos.x86_64.rpm</a></li>
<li>wget <a href="http://yum.dockerproject.org/repo/main/centos/7/Packages/docker-engine-17.03.1.ce-1.el7.centos.x86_64.rpm" target="_blank" rel="noopener">http://yum.dockerproject.org/repo/main/centos/7/Packages/docker-engine-17.03.1.ce-1.el7.centos.x86_64.rpm</a></li>
<li>yum remove -y docker* container-selinux</li>
<li>yum localinstall -y *.rpm</li>
<li>systemctl enable docker</li>
<li>df -h # 查看空间较大的分区并在分区下创建dockerdata目录准备存放docker数据</li>
<li>#设置docker数据目录并启动docker服务 systemctl start docker<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;EOF &gt; /etc/docker/daemon.json</span><br><span class="line">&#123;</span><br><span class="line">    &quot;graph&quot;: &quot;/var/lib/docker&quot;,</span><br><span class="line">    &quot;registry-mirrors&quot;: [&quot;https://4vo01fev.mirror.aliyuncs.com&quot;],</span><br><span class="line">    &quot;exec-opts&quot;: [&quot;native.cgroupdriver=systemd&quot;],</span><br><span class="line">    &quot;log-driver&quot;: &quot;json-file&quot;,</span><br><span class="line">    &quot;log-opts&quot;: &#123;</span><br><span class="line">        &quot;max-size&quot;: &quot;100m&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;storage-driver&quot;: &quot;overlay2&quot;,</span><br><span class="line">    &quot;storage-opts&quot;: [</span><br><span class="line">        &quot;overlay2.override_kernel_check=true&quot;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cat &lt;&lt;EOF &gt; /etc/systemd/system/docker.service.d/http-proxy.conf</span><br><span class="line">[Service]</span><br><span class="line">Environment=&quot;HTTP_PROXY=&quot; &quot;HTTPS_PROXY=&quot;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>安装必要工具</p>
<ul>
<li>kubeadm/kubelet/kubectl</li>
<li>配置yum源</li>
<li>yum install -y kubelet kubeadm kubectl –disableexcludes=kubernetes</li>
<li>systemctl enable kubelet &amp;&amp; systemctl start kubelet</li>
<li>source &lt;(kubectl completion bash)<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">cat &lt;&lt; EOF &gt; /etc/yum.repos.d/kubernetes.repo</span><br><span class="line">[kubernetes]</span><br><span class="line">name=Kubernetes</span><br><span class="line">baseurl=http://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=0</span><br><span class="line">repo_gpgcheck=0</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-apiserver:v1.17.0 </span><br><span class="line">docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-controller-manager:v1.17.0</span><br><span class="line">docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-scheduler:v1.17.0</span><br><span class="line">docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy:v1.17.0</span><br><span class="line">docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1</span><br><span class="line">docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/etcd:3.4.3-0</span><br><span class="line">docker pull coredns/coredns:1.6.5</span><br><span class="line"></span><br><span class="line">docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/kube-apiserver:v1.17.0 k8s.gcr.io/kube-apiserver:v1.17.0</span><br><span class="line">docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/kube-controller-manager:v1.17.0 k8s.gcr.io/kube-controller-manager:v1.17.0</span><br><span class="line">docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/kube-scheduler:v1.17.0 k8s.gcr.io/kube-scheduler:v1.17.0</span><br><span class="line">docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy:v1.17.0 k8s.gcr.io/kube-proxy:v1.17.0</span><br><span class="line">docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1 k8s.gcr.io/pause:3.1</span><br><span class="line">docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/etcd:3.4.3-0 k8s.gcr.io/etcd:3.4.3-0</span><br><span class="line">docker tag coredns/coredns:1.6.5 k8s.gcr.io/coredns:1.6.5</span><br><span class="line"></span><br><span class="line">docker rmi registry.cn-hangzhou.aliyuncs.com/google_containers/kube-apiserver:v1.17.0 </span><br><span class="line">docker rmi registry.cn-hangzhou.aliyuncs.com/google_containers/kube-controller-manager:v1.17.0</span><br><span class="line">docker rmi registry.cn-hangzhou.aliyuncs.com/google_containers/kube-scheduler:v1.17.0</span><br><span class="line">docker rmi registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy:v1.17.0</span><br><span class="line">docker rmi registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1</span><br><span class="line">docker rmi registry.cn-hangzhou.aliyuncs.com/google_containers/etcd:3.4.3-0</span><br><span class="line">docker rmi coredns/coredns:1.6.5</span><br></pre></td></tr></table></figure>

</li>
</ul>
</li>
</ul>
<h4 id="高可用部署"><a href="#高可用部署" class="headerlink" title="高可用部署"></a>高可用部署</h4><ul>
<li><p>实现apiServer的高可用与负载均衡，也可只用keepalived</p>
<ul>
<li>yum install -y socat keepalived haproxy ipvsadm</li>
<li>systemctl enable haproxy &amp;&amp; systemctl enable keepalived</li>
<li>systemctl start haproxy &amp;&amp; systemctl start keepalived</li>
<li>journalctl -f -u keepalived </li>
<li>ip a # 查看虚拟ip<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"># /etc/keepalived/keepalived.conf</span><br><span class="line">global_defs &#123;</span><br><span class="line">   router_id master01|master02|master03</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_script check &#123;</span><br><span class="line">    script /etc/keepalived/check_haproxy.sh｜check_apiserver.sh </span><br><span class="line">    interval 3</span><br><span class="line">    # weight -2 如果脚本非零退出，则权重-2，可动态配置权重,与check_apiserver.sh 搭配</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state MASTER|BACKUP|BACKUP</span><br><span class="line">    interface ens160|ens160|ens160</span><br><span class="line">    virtual_router_id 80</span><br><span class="line">    priority 100|90|80</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 1111</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        10.18.3.200</span><br><span class="line">    &#125;</span><br><span class="line">    track_script &#123;   </span><br><span class="line">        check</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#/etc/keepalived/check_haproxy.sh </span><br><span class="line">#!/bin/bash</span><br><span class="line">NUM=`ps -C haproxy --no-header |wc -l`</span><br><span class="line">if [ $NUM -eq 0 ];then</span><br><span class="line">    systemctl stop keepalived</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">#/etc/keepalived/check_apiserver.sh </span><br><span class="line">#!/bin/bash</span><br><span class="line">errorExit()&#123;</span><br><span class="line">    echo &quot;*** $*&quot; 1&gt;&amp;2</span><br><span class="line">    exit 1</span><br><span class="line">&#125;</span><br><span class="line">curl --silent --max-time 2 --insecure https://localhost:6443/ -o /dev/null || errorExit &quot;Error https://localhost:6443&quot;</span><br><span class="line">if ip addr | grep -q 10.18.3.200; then</span><br><span class="line">    curl --silent --max-time 2 --insecure https://10.18.3.200:6443 -o /dev/null || errorExit &quot;Error https://10.18.3.200:6443&quot;</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">#/etc/haproxy/haproxy.cfg</span><br><span class="line">global</span><br><span class="line">    log         127.0.0.1 local3</span><br><span class="line">    chroot      /var/lib/haproxy</span><br><span class="line">    pidfile     /var/run/haproxy.pid</span><br><span class="line">    maxconn     32768</span><br><span class="line">    user        haproxy</span><br><span class="line">    group       haproxy</span><br><span class="line">    daemon</span><br><span class="line">    nbproc      1</span><br><span class="line">    stats socket /var/lib/haproxy/stats</span><br><span class="line"></span><br><span class="line">defaults</span><br><span class="line">    mode                    tcp</span><br><span class="line">    log                     global</span><br><span class="line">    option                  tcplog</span><br><span class="line">    option                  dontlognull</span><br><span class="line">    option                  redispatch</span><br><span class="line">    retries                 3</span><br><span class="line">    timeout queue           1m</span><br><span class="line">    timeout connect         10s</span><br><span class="line">    timeout client          1m</span><br><span class="line">    timeout server          1m</span><br><span class="line">    timeout check           10s</span><br><span class="line"></span><br><span class="line">listen stats</span><br><span class="line">    mode   http</span><br><span class="line">    bind :8888</span><br><span class="line">    stats   enable</span><br><span class="line">    stats   uri     /admin</span><br><span class="line">    stats   auth    admin:admin</span><br><span class="line">    stats   admin   if TRUE</span><br><span class="line"></span><br><span class="line">frontend  k8s_https *:8443</span><br><span class="line">    mode      tcp</span><br><span class="line">    maxconn      2000</span><br><span class="line">    default_backend     https_sri</span><br><span class="line"></span><br><span class="line">backend https_sri</span><br><span class="line">    balance      roundrobin</span><br><span class="line">    server master1-api 10.18.3.178:6443  check inter 10000 fall 2 rise 2 weight 1</span><br><span class="line">    server master2-api 10.18.3.179:6443  check inter 10000 fall 2 rise 2 weight 1</span><br><span class="line">    server master3-api 10.18.3.180:6443  check inter 10000 fall 2 rise 2 weight 1</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>部署master01</p>
<ul>
<li>kubeadm config print init-defaults &gt; ~/kubeadm_master01.yaml #默认配置文件</li>
<li>kubeadm config images list –config  ~/kubeadm_master01.yaml #查看所需镜像</li>
<li>kubeadm config images pull –config  ~/kubeadm_master01.yaml #拉取所需镜像，也可手动拉取</li>
<li>kubeadm init –control-plane-endpoint “LOAD_BALANCER_DNS:LOAD_BALANCER_PORT” –pod-network-cidr 10.96.0.0/16 –upload-certs</li>
<li>mkdir -p $HOME/.kube</li>
<li>sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</li>
<li>sudo chown $(id -u):$(id -g) $HOME/.kube/config</li>
<li>kubectl get pods –all-namespaces #测试</li>
</ul>
</li>
<li><p>部署master02|master03</p>
<ul>
<li>kubeadm join 10.18.3.200:8443 –token XXX –discovery-token-ca-cert-hash XXX –control-plane –certificate-key XXX</li>
<li>mkdir -p $HOME/.kube</li>
<li>sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</li>
<li>sudo chown $(id -u):$(id -g) $HOME/.kube/config</li>
<li>kubectl get pods –all-namespaces #测试</li>
</ul>
</li>
<li><p>部署worker</p>
<ul>
<li>kubeadm join 10.18.3.200:8443 –token XXX –discovery-token-ca-cert-hash XXX</li>
<li>kubeadm token create –print-join-command  #重新生成token</li>
</ul>
</li>
<li><p>部署网络插件</p>
<ul>
<li>#任意主节点下载配置文件并更改cidr</li>
<li>kubectl apply -f calico.yaml</li>
<li>kubectl get pods –all-namespaces #测试</li>
</ul>
</li>
<li><p>检测</p>
<ul>
<li>kubectl get nodes</li>
<li>kubectl cluster-info</li>
<li>kubectl get cs</li>
<li>kubectl exec -n kube-system etcd-m1 – etcdctl –cacert=”/etc/kubernetes/pki/etcd/ca.crt” –cert=”/etc/kubernetes/pki/etcd/peer.crt” –key=”/etc/kubernetes/pki/etcd/peer.key” –endpoints=<a href="https://10.18.3.178:2379" target="_blank" rel="noopener">https://10.18.3.178:2379</a> member list #查看etcd集群</li>
<li>journalctl -f #查看日志</li>
</ul>
</li>
</ul>
<h4 id="可用性测试"><a href="#可用性测试" class="headerlink" title="可用性测试"></a>可用性测试</h4><ul>
<li>kubectl apply -f nginx-ds.yaml  </li>
<li>ping podIp</li>
<li>curl svcIp:svcPort</li>
<li>curl nodeIp:nodePort</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-ds-svc</span><br><span class="line">  labels:</span><br><span class="line">    app: nginx-ds-svc</span><br><span class="line">spec:</span><br><span class="line">  type: NodePort</span><br><span class="line">  selector:</span><br><span class="line">    app: nginx-ds</span><br><span class="line">  ports:</span><br><span class="line">  - name: http</span><br><span class="line">    port: 80</span><br><span class="line">    targetPort: 80</span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: DaemonSet</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-ds</span><br><span class="line">  labels:</span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: nginx-ds</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx-ds</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: my-nginx</span><br><span class="line">        image: nginx:1.7.9</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 80</span><br></pre></td></tr></table></figure>

<ul>
<li>kubectl apply -f pod-nginx.yaml</li>
<li>kubectl exec -it nginx bash</li>
<li>cat /etc/resolve.conf #查看DNS</li>
<li>ping svc-name #如果不通可以按如下修改proxy模式为ipvs</li>
<li>kubectl logs kube-proxy-hash -n kube-system #查看proxy模式</li>
<li>kubectl edit cm kube-proxy -n kube-system #默认kube-proxy模式为iptables，可修改mode为ipvs，同时需要ipvs模块配置</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx</span><br><span class="line">  labels:</span><br><span class="line">        app: nginx-ds</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: my-nginx</span><br><span class="line">    image: nginx:1.7.9</span><br><span class="line">    ports:</span><br><span class="line">    - containerPort: 80</span><br><span class="line"></span><br><span class="line"># ipvs模块配置</span><br><span class="line">cat &gt; /etc/sysconfig/modules/ipvs.modules &lt;&lt;EOF</span><br><span class="line">#!/bin/bash </span><br><span class="line">modprobe -- ip_vs </span><br><span class="line">modprobe -- ip_vs_rr </span><br><span class="line">modprobe -- ip_vs_wrr </span><br><span class="line">modprobe -- ip_vs_sh </span><br><span class="line">modprobe -- nf_conntrack_ipv4 </span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">#配置开机自加载并执行生效</span><br><span class="line">chmod 755 /etc/sysconfig/modules/ipvs.modules &amp;&amp; bash /etc/sysconfig/modules/ipvs.modules</span><br><span class="line"></span><br><span class="line">#查看是否加载</span><br><span class="line">lsmod | grep -e ip_vs -e nf_conntrack_ipv4</span><br><span class="line"></span><br><span class="line">#重启kube-proxy</span><br><span class="line">kubectl get pod -n kube-system | grep kube-proxy |awk &apos;&#123;system(&quot;kubectl delete pod &quot;$1&quot; -n kube-system&quot;)&#125;&apos;</span><br></pre></td></tr></table></figure>

<h4 id="dashboard"><a href="#dashboard" class="headerlink" title="dashboard"></a>dashboard</h4><ul>
<li>kubectl apply -f dashboard.yaml</li>
<li>bash dashboardToken.sh # 默认只支持token登陆<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># dashboardToken.sh</span><br><span class="line">#!/bin/bash</span><br><span class="line">kubectl describe secret -n kubernetes-dashboard $(kubectl get secret -n kubernetes-dashboard | grep dashboard-token | awk &apos;&#123;print $1&#125;&apos;) | grep -E &apos;^token&apos; | awk &apos;&#123;print $2&#125;&apos;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># gen-ingress-secret.sh</span><br><span class="line">openssl req -x509 -nodes -days 3650 -newkey rsa:2048 -keyout ingress.test.com.key -out ingress.test.com.pem -subj &quot;/CN=ingress.test.com&quot;</span><br><span class="line"></span><br><span class="line">kubectl create secret tls ingress-secret  --cert ingress.test.com.pem --key ingress.test.com.key</span><br><span class="line"></span><br><span class="line">kubectl  get secret -n kube-system | grep ingress</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h3 id="二进制方式搭建"><a href="#二进制方式搭建" class="headerlink" title="二进制方式搭建"></a>二进制方式搭建</h3><h4 id="环境准备-1"><a href="#环境准备-1" class="headerlink" title="环境准备"></a>环境准备</h4><ul>
<li><p>统一主机名</p>
<ul>
<li>hostname</li>
<li>hostnamectl set-hostname name</li>
<li>vi /etc/hosts</li>
</ul>
</li>
<li><p>rhel更换yum</p>
<ul>
<li>rpm -qa | grep yum | xargs rpm -e –nodeps</li>
<li>mkdir yumrpm &amp;&amp; cd yumrpm</li>
<li>wget <a href="https://mirrors.aliyun.com/centos/7/os/x86_64/Packages/yum-3.4.3-163.el7.centos.noarch.rpm" target="_blank" rel="noopener">https://mirrors.aliyun.com/centos/7/os/x86_64/Packages/yum-3.4.3-163.el7.centos.noarch.rpm</a></li>
<li>wget <a href="https://mirrors.aliyun.com/centos/7/os/x86_64/Packages/yum-metadata-parser-1.1.4-10.el7.x86_64.rpm" target="_blank" rel="noopener">https://mirrors.aliyun.com/centos/7/os/x86_64/Packages/yum-metadata-parser-1.1.4-10.el7.x86_64.rpm</a></li>
<li>wget <a href="https://mirrors.aliyun.com/centos/7/os/x86_64/Packages/yum-utils-1.1.31-52.el7.noarch.rpm" target="_blank" rel="noopener">https://mirrors.aliyun.com/centos/7/os/x86_64/Packages/yum-utils-1.1.31-52.el7.noarch.rpm</a></li>
<li>wget <a href="https://mirrors.aliyun.com/centos/7/os/x86_64/Packages/yum-updateonboot-1.1.31-52.el7.noarch.rpm" target="_blank" rel="noopener">https://mirrors.aliyun.com/centos/7/os/x86_64/Packages/yum-updateonboot-1.1.31-52.el7.noarch.rpm</a></li>
<li>wget <a href="https://mirrors.aliyun.com/centos/7/os/x86_64/Packages/yum-plugin-fastestmirror-1.1.31-52.el7.noarch.rpm" target="_blank" rel="noopener">https://mirrors.aliyun.com/centos/7/os/x86_64/Packages/yum-plugin-fastestmirror-1.1.31-52.el7.noarch.rpm</a></li>
<li>rpm -ivh yum*</li>
</ul>
</li>
<li><p>安装依赖包</p>
<ul>
<li>wget -O /etc/yum.repos.d/CentOS-Base.repo <a href="http://mirrors.aliyun.com/repo/Centos-7.repo" target="_blank" rel="noopener">http://mirrors.aliyun.com/repo/Centos-7.repo</a></li>
<li>yum install -y epel-release &amp;&amp; yum clean all &amp;&amp; yum makecache</li>
<li>yum update -y</li>
<li>yum install -y conntrack ipvsadm ipset jq sysstat curl iptables libseccomp ntpdate</li>
<li>ntpdate ip</li>
</ul>
</li>
<li><p>主机配置</p>
<ul>
<li>关闭防火墙 systemctl stop firewalld &amp;&amp; systemctl disable firewalld</li>
<li>关闭swap  swapoff -a &amp;&amp; sed -i ‘/swap/s/^(.*)$/# \1/g’ /etc/fstab</li>
<li>重置iptables iptables -F &amp;&amp; iptables -X &amp;&amp; iptables -F -t nat &amp;&amp; iptables -X -t nat &amp;&amp; iptables -P FORWARD ACCEPT</li>
<li>关闭selinux setenforce 0 &amp;&amp; sed -i ‘s/^SELINUX=.*$/SELINUX=disabled/‘ /etc/selinux/config</li>
<li>关闭dnsmasq systemctl stop dnsmasq &amp;&amp; systemctl disable dnsmasq</li>
<li>配置k8s系统文件 vim /etc/sysctl.d/kubernetes.conf &amp;&amp; sysctl -p /etc/sysctl.d/kubernetes.conf<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/sysctl.d/kubernetes.conf &lt;&lt;EOF</span><br><span class="line">net.bridge.bridge-nf-call-iptables=1</span><br><span class="line">net.bridge.bridge-nf-call-ip6tables=1</span><br><span class="line">net.ipv4.ip_forward=1</span><br><span class="line">vm.swappiness=0</span><br><span class="line">vm.overcommit_memory=1</span><br><span class="line">vm.panic_on_oom=0</span><br><span class="line">fs.inotify.max_user_watches=89100</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>安装docker</p>
<ul>
<li>mkdir -p /opt/kubernetes/docker &amp;&amp; cd /opt/kubernetes/docker</li>
<li>wget <a href="http://yum.dockerproject.org/repo/main/centos/7/Packages/docker-engine-selinux-17.03.1.ce-1.el7.centos.noarch.rpm" target="_blank" rel="noopener">http://yum.dockerproject.org/repo/main/centos/7/Packages/docker-engine-selinux-17.03.1.ce-1.el7.centos.noarch.rpm</a></li>
<li>wget <a href="http://yum.dockerproject.org/repo/main/centos/7/Packages/docker-engine-debuginfo-17.03.1.ce-1.el7.centos.x86_64.rpm" target="_blank" rel="noopener">http://yum.dockerproject.org/repo/main/centos/7/Packages/docker-engine-debuginfo-17.03.1.ce-1.el7.centos.x86_64.rpm</a></li>
<li>wget <a href="http://yum.dockerproject.org/repo/main/centos/7/Packages/docker-engine-17.03.1.ce-1.el7.centos.x86_64.rpm" target="_blank" rel="noopener">http://yum.dockerproject.org/repo/main/centos/7/Packages/docker-engine-17.03.1.ce-1.el7.centos.x86_64.rpm</a></li>
<li>yum remove -y docker* container-selinux</li>
<li>yum localinstall -y *.rpm</li>
<li>systemctl enable docker</li>
<li>df -h # 查看空间较大的分区并在分区下创建dockerdata目录准备存放docker数据</li>
<li>#设置docker数据目录并启动docker服务 systemctl start docker<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;EOF &gt; /etc/docker/daemon.json</span><br><span class="line">&#123;</span><br><span class="line">    &quot;graph&quot;: &quot;/var/lib/docker&quot;,</span><br><span class="line">    &quot;registry-mirrors&quot;: [&quot;https://4vo01fev.mirror.aliyuncs.com&quot;],</span><br><span class="line">    &quot;exec-opts&quot;: [&quot;native.cgroupdriver=systemd&quot;],</span><br><span class="line">    &quot;log-driver&quot;: &quot;json-file&quot;,</span><br><span class="line">    &quot;log-opts&quot;: &#123;</span><br><span class="line">        &quot;max-size&quot;: &quot;100m&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;storage-driver&quot;: &quot;overlay2&quot;,</span><br><span class="line">    &quot;storage-opts&quot;: [</span><br><span class="line">        &quot;overlay2.override_kernel_check=true&quot;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cat &lt;&lt;EOF &gt; /etc/systemd/system/docker.service.d/http-proxy.conf</span><br><span class="line">[Service]</span><br><span class="line">Environment=&quot;HTTP_PROXY=&quot; &quot;HTTPS_PROXY=&quot;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>配置发布机免密登陆</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen -t rsa</span><br><span class="line">ssh-copy-id .ssh/id_rsa.pub user@ip</span><br></pre></td></tr></table></figure>
</li>
<li><p>准备二进制文件</p>
<ul>
<li>master<ul>
<li>etcd</li>
<li>etcdctl</li>
<li>kube-apiserver</li>
<li>kube-controller-manager</li>
<li>kube-scheduler</li>
<li>kubeadm</li>
<li>kubectl</li>
</ul>
</li>
<li>worker<ul>
<li>kubelet</li>
<li>kube-proxy</li>
</ul>
</li>
</ul>
</li>
<li><p>分发到各节点并配置PATH</p>
<ul>
<li>scp </li>
<li>echo “PATH=$PATH:/opt/k8s/bin” &gt;&gt; ~/.bashrc</li>
</ul>
</li>
<li><p>配置各服务参数</p>
</li>
</ul>
<h4 id="高可用部署-1"><a href="#高可用部署-1" class="headerlink" title="高可用部署"></a>高可用部署</h4><ul>
<li><p>CA证书</p>
<ul>
<li>安装工具，cfssl非常好用的CA工具，用来生成证书和密钥文件</li>
<li>生成根证书，后续所有的证书都由根证书签名<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"># getCfssl.sh</span><br><span class="line">#!/bin/bash</span><br><span class="line">mkdir -p ~/cfssl/bin</span><br><span class="line">wget https://pkg.cfssl.org/R1.2/cfssl_linux-amd64 -O ~/cfssl/bin/cfssl</span><br><span class="line">wget https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64 -O ~/cfssl/bin/cfssljson</span><br><span class="line">chmod +x ~/cfssl/bin/cfssl ~/cfssl/bin/cfssljson</span><br><span class="line">echo &quot;PATH=$PATH:~/cfssl/bin/&quot; &gt;&gt; ~/.bashrc</span><br><span class="line">source ~/.bashrc</span><br><span class="line">cfssl version</span><br><span class="line"></span><br><span class="line"># genCA.sh</span><br><span class="line">#!/bin/bash</span><br><span class="line">mkdir -p ~/cfssl/my/ &amp;&amp; cd ~/cfssl/my/</span><br><span class="line"># 生成证书ca.pem和私钥ca-key.pem</span><br><span class="line"># csr.json可参考官网</span><br><span class="line">cfssl genkey -initca csr.json | cfssljson -bare ca</span><br><span class="line"># 把根证书拷贝到主节点</span><br><span class="line">ssh root@MASTER_IP &quot;mkdir -p /etc/kubernetes/pki/&quot;</span><br><span class="line">scp ca*.pem root@MASTER_IP:/etc/kubernetes/pki/</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>etcd集群(3台master)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">wget &apos;https://github.com/etcd-io/etcd/releases/download/v3.3.18/etcd-v3.3.18-linux-amd64.tar.gz&apos;</span><br><span class="line"></span><br><span class="line"># 生成etcd的证书和私钥</span><br><span class="line">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes etcd-csr.json | cfssljson -bare etcd</span><br><span class="line"></span><br><span class="line"># 分发到每个etcd节点</span><br><span class="line">scp etcd*.pem root@MASTER_IP:/etc/kubernetes/pki/</span><br><span class="line"></span><br><span class="line"># 配置service 文件</span><br><span class="line">scp etcd.service MASTERIP:/etc/systemd/system/</span><br><span class="line"></span><br><span class="line"># 启动服务</span><br><span class="line">systemctl daemon-reload &amp;&amp; systemctl enable etcd &amp;&amp; systemctl restart etcd</span><br><span class="line"></span><br><span class="line"># 查看日志</span><br><span class="line">journalctl -f -u etcd</span><br><span class="line"></span><br><span class="line"># 查看端口</span><br><span class="line">netstat -tunlp ｜ grep 23(79|80)</span><br></pre></td></tr></table></figure>
</li>
<li><p>apiserver集群(3台master)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"># 生成证书和私钥</span><br><span class="line">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kubernetes-csr.json | cfssljson -bare kubernetes</span><br><span class="line"></span><br><span class="line"># 分发到每个etcd节点</span><br><span class="line">scp kubernetes*.pem root@MASTER_IP:/etc/kubernetes/pki/</span><br><span class="line"></span><br><span class="line"># 配置service 文件</span><br><span class="line">scp kube-apiserver.service MASTERIP:/etc/systemd/system/</span><br><span class="line"></span><br><span class="line"># 启动服务</span><br><span class="line">systemctl daemon-reload &amp;&amp; systemctl enable kube-apiserver &amp;&amp; systemctl restart kube-apiserver</span><br><span class="line"></span><br><span class="line"># 查看日志</span><br><span class="line">journalctl -f -u kube-apiserver</span><br><span class="line"></span><br><span class="line"># 查看端口</span><br><span class="line">netstat -tunlp ｜ grep 6443</span><br></pre></td></tr></table></figure>
</li>
<li><p>部署keepalived(apiserver高可用)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"># 一般部署一主一备2个节点即可</span><br><span class="line">yum install -y keepalived</span><br><span class="line"></span><br><span class="line"># 创建配置文件 /etc/keepalived/keepalived.conf</span><br><span class="line">global_defs &#123;</span><br><span class="line">   router_id master01|master02</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_script check &#123;</span><br><span class="line">    script /etc/keepalived/check_apiserver.sh </span><br><span class="line">    interval 3</span><br><span class="line">    weight -2 如果脚本非零退出，则权重-2，与check_apiserver.sh 搭配</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state MASTER|BACKUP</span><br><span class="line">    interface ens160|ens160</span><br><span class="line">    virtual_router_id 80</span><br><span class="line">    priority 100|90</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 1111</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        VIP</span><br><span class="line">    &#125;</span><br><span class="line">    track_script &#123;   </span><br><span class="line">        check</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 创建监控脚本 /etc/keepalived/check_apiserver.sh</span><br><span class="line">#!/bin/bash</span><br><span class="line">errorExit()&#123;</span><br><span class="line">    echo &quot;*** $*&quot; 1&gt;&amp;2</span><br><span class="line">    exit 1</span><br><span class="line">&#125;</span><br><span class="line">curl --silent --max-time 2 --insecure https://localhost:6443/ -o /dev/null || errorExit &quot;Error https://localhost:6443&quot;</span><br><span class="line">if ip addr | grep -q VIP; then</span><br><span class="line">    curl --silent --max-time 2 --insecure https://VIP:6443 -o /dev/null || errorExit &quot;Error https://VIP:6443&quot;</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"># 启动服务</span><br><span class="line">systemctl daemon-reload &amp;&amp; systemctl enable keepalived &amp;&amp; systemctl restart keepalived</span><br><span class="line"></span><br><span class="line"># 查看日志</span><br><span class="line">journalctl -f -u keepalived</span><br><span class="line"></span><br><span class="line"># 访问服务</span><br><span class="line">curl --insecure https://VIP:6443/</span><br></pre></td></tr></table></figure>
</li>
<li><p>kubectl</p>
<ul>
<li>是k8s集群的命令行管理工具</li>
<li>默认从 ~/.kube/config文件读取apiserver的地址、证书、token等信息<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"># 创建admin证书和私钥</span><br><span class="line">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes admin-csr.json | cfssljson -bare admin</span><br><span class="line"></span><br><span class="line"># 创建kubeconfig文件</span><br><span class="line"># 设置集群参数</span><br><span class="line">kubectl config set-cluster kubernetes</span><br><span class="line"># 设置客户端认证参数</span><br><span class="line">kubectl config set-credentials admin</span><br><span class="line"># 设置上下文参数</span><br><span class="line">kubectl config set-context kubernetes</span><br><span class="line"># 设置默认上下文</span><br><span class="line">kubectl config use-context kubernetes</span><br><span class="line"># 分发到目标节点</span><br><span class="line">scp kube.config root@MASTERIP:~/.kube/config</span><br><span class="line"></span><br><span class="line"># 授予k8s证书访问kubeletAPI的权限</span><br><span class="line">kubectl create clusterrolebinding kube-apiserver:kubelet-apis --clusterrole=system:kubelet-api-admin --user kubernetes</span><br><span class="line"></span><br><span class="line"># 测试</span><br><span class="line">kubectl cluster-info</span><br><span class="line">kubectl get all --all-namespaces</span><br><span class="line">kubectl get cs|componentstatuses</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>controller-manager</p>
<ul>
<li>启动后通过竞选产生一个leader，其他节点阻塞</li>
<li>当leader不可用后剩余节点再竞选，保证高可用<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"># 创建证书和私钥</span><br><span class="line">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes cm-csr.json | cfssljson -bare controller-manager</span><br><span class="line"></span><br><span class="line"># 分发到目标节点</span><br><span class="line">scp controller-manager*.pem root@MASTERIP:/etc/kubernetes/pki/</span><br><span class="line"></span><br><span class="line"># 创建kubeconfig文件</span><br><span class="line"># 设置集群参数</span><br><span class="line">kubectl config set-cluster kubernetes</span><br><span class="line"># 设置客户端认证参数</span><br><span class="line">kubectl config set-credentials system:kube-controller-manager</span><br><span class="line"># 设置上下文参数</span><br><span class="line">kubectl config set-context system:kube-controller-manager</span><br><span class="line"># 设置默认上下文</span><br><span class="line">kubectl config use-context system:kube-controller-manager</span><br><span class="line"># 分发到目标节点</span><br><span class="line">scp controller-manager.kubeconfig root@MASTERIP:/etc/kubernetes/</span><br><span class="line"></span><br><span class="line"># 创建service文件</span><br><span class="line"># vi /etc/systemd/system/kube-controller-manager.service</span><br><span class="line"></span><br><span class="line"># 启动服务</span><br><span class="line">systemctl daemon-reload &amp;&amp; systemctl enable kube-controller-manager &amp;&amp; systemctl restart kube-controller-manager</span><br><span class="line"></span><br><span class="line"># 查看日志</span><br><span class="line">journalctl -f -u kube-controller-manager</span><br><span class="line"></span><br><span class="line"># 查看leader</span><br><span class="line">kubectl get endpoints kube-controller-manager -n kube-system -o yaml</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>scheduler</p>
<ul>
<li>启动后通过竞选产生一个leader，其他节点阻塞</li>
<li>当leader不可用后剩余节点再竞选，保证高可用<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"># 创建证书和私钥</span><br><span class="line">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes scheduler-csr.json | cfssljson -bare kube-scheduler</span><br><span class="line"></span><br><span class="line"># 分发到目标节点</span><br><span class="line">scp kube-scheduler*.pem root@MASTERIP:/etc/kubernetes/pki/</span><br><span class="line"></span><br><span class="line"># 创建kubeconfig文件</span><br><span class="line"># 设置集群参数</span><br><span class="line">kubectl config set-cluster kubernetes</span><br><span class="line"># 设置客户端认证参数</span><br><span class="line">kubectl config set-credentials system:kube-scheduler</span><br><span class="line"># 设置上下文参数</span><br><span class="line">kubectl config set-context system:kube-scheduler</span><br><span class="line"># 设置默认上下文</span><br><span class="line">kubectl config use-context system:kube-scheduler</span><br><span class="line"># 分发到目标节点</span><br><span class="line">scp kube-scheduler.kubeconfig root@MASTERIP:/etc/kubernetes/</span><br><span class="line"></span><br><span class="line"># 创建service文件</span><br><span class="line"># vi /etc/systemd/system/kube-scheduler.service</span><br><span class="line"></span><br><span class="line"># 启动服务</span><br><span class="line">systemctl daemon-reload &amp;&amp; systemctl enable kube-scheduler &amp;&amp; systemctl restart kube-scheduler</span><br><span class="line"></span><br><span class="line"># 查看日志</span><br><span class="line">journalctl -f -u kube-scheduler</span><br><span class="line"></span><br><span class="line"># 查看leader</span><br><span class="line">kubectl get endpoints kube-scheduler -n kube-system -o yaml</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>kubelet(worker节点)</p>
<ul>
<li>下载所需镜像<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"># 创建bootstrap配置文件</span><br><span class="line"># 创建token</span><br><span class="line">export BOOTSTRAP_TOKEN=$(kubeadm token create ) </span><br><span class="line"># 设置集群参数</span><br><span class="line">kubectl config set-cluster kubernetes</span><br><span class="line"># 设置客户端认证参数</span><br><span class="line">kubectl config set-credentials kubelet-bootstrap</span><br><span class="line"># 设置上下文参数</span><br><span class="line">kubectl config set-context default </span><br><span class="line"># 设置默认上下文</span><br><span class="line">kubectl config use-context default </span><br><span class="line"># 分发到目标节点</span><br><span class="line">scp kubelet-bootstrap.kubeconfig root@WORKER:/etc/kubernetes/kubelet-bootstrap.kubeconfig</span><br><span class="line"># 分发CA到worker节点</span><br><span class="line">scp ca.pem root@WORKER:/etc/kubernetes/pki/</span><br><span class="line"></span><br><span class="line"># 分发kubelet配置文件</span><br><span class="line">scp kubelet.config.json root@WORKER:/etc/kubernetes/</span><br><span class="line"></span><br><span class="line"># 设置kubelet服务文件</span><br><span class="line">vi /etc/systemd/system/kubelet.service</span><br><span class="line"></span><br><span class="line"># bootstrap授权</span><br><span class="line">kubectl create clusterrolebinding kubelet-bootstrap --clusterrole=system:node-bootstrapper --group=system:bootstrappers</span><br><span class="line"></span><br><span class="line"># 启动服务</span><br><span class="line">systemctl daemon-reload &amp;&amp; systemctl enable kubelet &amp;&amp; systemctl restart kubelet</span><br><span class="line"></span><br><span class="line"># master上通过请求</span><br><span class="line">kubectl get csr</span><br><span class="line">kubectl certificate approve &lt;name&gt;</span><br><span class="line"></span><br><span class="line"># worer节点日志</span><br><span class="line">journalctl -f</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>kube-proxy（所有节点）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"># 创建证书和私钥</span><br><span class="line">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kube-proxy-csr.json | cfssljson -bare kube-proxy </span><br><span class="line"></span><br><span class="line"># 创建kubeconfig文件</span><br><span class="line"># 设置集群参数</span><br><span class="line">kubectl config set-cluster kubernetes</span><br><span class="line"># 设置客户端认证参数</span><br><span class="line">kubectl config set-credentials kube-proxy</span><br><span class="line"># 设置上下文参数</span><br><span class="line">kubectl config set-context default</span><br><span class="line"># 设置默认上下文</span><br><span class="line">kubectl config use-context default</span><br><span class="line"># 分发到目标节点</span><br><span class="line">scp kube-proxy.kubeconfig root@NODEIP:/etc/kubernetes/</span><br><span class="line"></span><br><span class="line"># 创建service文件</span><br><span class="line"># vi /etc/systemd/system/kube-proxy.service</span><br><span class="line"></span><br><span class="line"># 启动服务</span><br><span class="line">systemctl daemon-reload &amp;&amp; systemctl enable kube-proxy &amp;&amp; systemctl restart kube-proxy</span><br><span class="line"></span><br><span class="line"># 查看日志</span><br><span class="line">journalctl -f -u kube-proxy</span><br></pre></td></tr></table></figure>
</li>
<li><p>部署插件</p>
<ul>
<li>calico</li>
<li>coredns</li>
</ul>
</li>
</ul>
<h4 id="可用性测试-1"><a href="#可用性测试-1" class="headerlink" title="可用性测试"></a>可用性测试</h4><ul>
<li>kubectl apply -f nginx-ds.yaml</li>
<li>ping podIp</li>
<li>curl svcIp:svcPort</li>
<li>curl nodeIp:nodePort</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-ds-svc</span><br><span class="line">  labels:</span><br><span class="line">    app: nginx-ds-svc</span><br><span class="line">spec:</span><br><span class="line">  type: NodePort</span><br><span class="line">  selector:</span><br><span class="line">    app: nginx-ds</span><br><span class="line">  ports:</span><br><span class="line">  - name: http</span><br><span class="line">    port: 80</span><br><span class="line">    targetPort: 80</span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: DaemonSet</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-ds</span><br><span class="line">  labels:</span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: nginx-ds</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx-ds</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: my-nginx</span><br><span class="line">        image: nginx:1.7.9</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 80</span><br></pre></td></tr></table></figure>

<ul>
<li>kubectl apply -f pod-nginx.yaml</li>
<li>kubectl exec -it nginx bash</li>
<li>cat /etc/resolve.conf #查看DNS</li>
<li>ping svc-name #如果不通可以按如下修改proxy模式为ipvs</li>
<li>kubectl logs kube-proxy-hash -n kube-system #查看proxy模式</li>
<li>kubectl edit cm kube-proxy -n kube-system #默认kube-proxy模式为iptables，可修改mode为ipvs，同时需要ipvs模块配置</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx</span><br><span class="line">  labels:</span><br><span class="line">        app: nginx-ds</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: my-nginx</span><br><span class="line">    image: nginx:1.7.9</span><br><span class="line">    ports:</span><br><span class="line">    - containerPort: 80</span><br><span class="line"></span><br><span class="line"># ipvs模块配置</span><br><span class="line">cat &gt; /etc/sysconfig/modules/ipvs.modules &lt;&lt;EOF</span><br><span class="line">#!/bin/bash </span><br><span class="line">modprobe -- ip_vs </span><br><span class="line">modprobe -- ip_vs_rr </span><br><span class="line">modprobe -- ip_vs_wrr </span><br><span class="line">modprobe -- ip_vs_sh </span><br><span class="line">modprobe -- nf_conntrack_ipv4 </span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">#配置开机自加载并执行生效</span><br><span class="line">chmod 755 /etc/sysconfig/modules/ipvs.modules &amp;&amp; bash /etc/sysconfig/modules/ipvs.modules</span><br><span class="line"></span><br><span class="line">#查看是否加载</span><br><span class="line">lsmod | grep -e ip_vs -e nf_conntrack_ipv4</span><br><span class="line"></span><br><span class="line">#重启kube-proxy</span><br><span class="line">kubectl get pod -n kube-system | grep kube-proxy |awk &apos;&#123;system(&quot;kubectl delete pod &quot;$1&quot; -n kube-system&quot;)&#125;&apos;</span><br></pre></td></tr></table></figure>

<h4 id="dashboard-1"><a href="#dashboard-1" class="headerlink" title="dashboard"></a>dashboard</h4><ul>
<li>kubectl apply -f dashboard.yaml</li>
<li>bash dashboardToken.sh # 默认只支持token登陆<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># dashboardToken.sh</span><br><span class="line">#!/bin/bash</span><br><span class="line">kubectl describe secret -n kubernetes-dashboard $(kubectl get secret -n kubernetes-dashboard | grep dashboard-token | awk &apos;&#123;print $1&#125;&apos;) | grep -E &apos;^token&apos; | awk &apos;&#123;print $2&#125;&apos;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h3 id="业务迁移到k8s"><a href="#业务迁移到k8s" class="headerlink" title="业务迁移到k8s"></a>业务迁移到k8s</h3><h4 id="harbor"><a href="#harbor" class="headerlink" title="harbor"></a>harbor</h4><ul>
<li><p>采用比较简单的高可用方案</p>
<ul>
<li>nginx做负载均衡</li>
<li>harbor原生安装方式部署2个节点提供服务</li>
</ul>
</li>
<li><p>部署</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"># 服务节点</span><br><span class="line">wget &apos;https://github.com/goharbor/harbor/releases/download/v1.9.4/harbor-offline-installer-v1.9.4.tgz&apos;</span><br><span class="line">tar xzvf harbor-offline-installer-v1.9.4.tgz</span><br><span class="line">cd harbor</span><br><span class="line"># 修改hostname为当前ip</span><br><span class="line">vi harbor.cfg</span><br><span class="line"># 查看镜像等文件目录是否在主机最大空间目录下</span><br><span class="line">vi docker-compose.yml </span><br><span class="line">sh install.sh</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># nginx</span><br><span class="line">vi nginx.conf</span><br><span class="line">user nginx;</span><br><span class="line">worker_processes 1;</span><br><span class="line">error_log /var/log/nginx/error.log warn;</span><br><span class="line">pid /var/run/nginx.pid;</span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">  worker_connections 1024;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">stream &#123;</span><br><span class="line">  upstream hub &#123;</span><br><span class="line">    server 10.18.3.181:80;</span><br><span class="line">  &#125;</span><br><span class="line">  server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    proxy_pass hub;</span><br><span class="line">	  proxy_timeout 300s;</span><br><span class="line">	  proxy_connect_timeout 5s;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"># restart.sh</span><br><span class="line">#!/bin/bash</span><br><span class="line">docker stop harbornginx &amp;&amp; docker rm harbornginx</span><br><span class="line">docker run -itd --net=host --name harbornginx -v /root/harbor/nginx.conf:/etc/nginx/nginx.conf nginx</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用harbor</p>
<ul>
<li>本地配置host文件，域名指向ip</li>
<li>登陆harbor并新建kubernetes项目</li>
<li>docker tag nginx:latest 域名/项目名/镜像名:TAG</li>
<li>docker push 域名/项目名/镜像名:TAG</li>
<li>报错https则在/etc/docker/daemon.json中添加insecure-registries:[“域名”]并重启docker</li>
<li>配置harbor的同步规则，使2个仓库进行实时同步</li>
</ul>
</li>
</ul>
<h4 id="服务发现"><a href="#服务发现" class="headerlink" title="服务发现"></a>服务发现</h4><ul>
<li>集群内相互访问<ul>
<li>ClusterIPService通过DNS把name解析成CluseterIP访问集群pod</li>
<li>客户端通过headlessService拿到集群endpoints然后客户端自己实现</li>
</ul>
</li>
<li>集群内访问集群外<ul>
<li>直接配置ip+port</li>
<li>空的service + 同名的endpoint自动绑定，endpoint里配置外部服务</li>
</ul>
</li>
<li>集群外访问集群内<ul>
<li>NodePortService</li>
<li>HostPortService(HostNetwork)</li>
<li>Ingress<ul>
<li>Ingress(host+path到service的配置信息)</li>
<li>IngressController(Ingress-nginx)</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="部署ingress-nginx"><a href="#部署ingress-nginx" class="headerlink" title="部署ingress-nginx"></a>部署ingress-nginx</h4><ul>
<li>wget <a href="https://raw.githubusercontent.com/kubernetes/ingress-nginx/nginx-0.27.0/deploy/static/mandatory.yaml" target="_blank" rel="noopener">https://raw.githubusercontent.com/kubernetes/ingress-nginx/nginx-0.27.0/deploy/static/mandatory.yaml</a></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br></pre></td><td class="code"><pre><span class="line"># ingress-mandatory.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Namespace</span><br><span class="line">metadata:</span><br><span class="line">  name: ingress-nginx</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx</span><br><span class="line">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line">---</span><br><span class="line">kind: ConfigMap</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-configuration</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx</span><br><span class="line">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line">---</span><br><span class="line">kind: ConfigMap</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: tcp-services</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx</span><br><span class="line">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line">---</span><br><span class="line">kind: ConfigMap</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: udp-services</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx</span><br><span class="line">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-ingress-serviceaccount</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx</span><br><span class="line">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class="line">kind: ClusterRole</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-ingress-clusterrole</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx</span><br><span class="line">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line">rules:</span><br><span class="line">  - apiGroups:</span><br><span class="line">      - &quot;&quot;</span><br><span class="line">    resources:</span><br><span class="line">      - configmaps</span><br><span class="line">      - endpoints</span><br><span class="line">      - nodes</span><br><span class="line">      - pods</span><br><span class="line">      - secrets</span><br><span class="line">    verbs:</span><br><span class="line">      - list</span><br><span class="line">      - watch</span><br><span class="line">  - apiGroups:</span><br><span class="line">      - &quot;&quot;</span><br><span class="line">    resources:</span><br><span class="line">      - nodes</span><br><span class="line">    verbs:</span><br><span class="line">      - get</span><br><span class="line">  - apiGroups:</span><br><span class="line">      - &quot;&quot;</span><br><span class="line">    resources:</span><br><span class="line">      - services</span><br><span class="line">    verbs:</span><br><span class="line">      - get</span><br><span class="line">      - list</span><br><span class="line">      - watch</span><br><span class="line">  - apiGroups:</span><br><span class="line">      - &quot;&quot;</span><br><span class="line">    resources:</span><br><span class="line">      - events</span><br><span class="line">    verbs:</span><br><span class="line">      - create</span><br><span class="line">      - patch</span><br><span class="line">  - apiGroups:</span><br><span class="line">      - &quot;extensions&quot;</span><br><span class="line">      - &quot;networking.k8s.io&quot;</span><br><span class="line">    resources:</span><br><span class="line">      - ingresses</span><br><span class="line">    verbs:</span><br><span class="line">      - get</span><br><span class="line">      - list</span><br><span class="line">      - watch</span><br><span class="line">  - apiGroups:</span><br><span class="line">      - &quot;extensions&quot;</span><br><span class="line">      - &quot;networking.k8s.io&quot;</span><br><span class="line">    resources:</span><br><span class="line">      - ingresses/status</span><br><span class="line">    verbs:</span><br><span class="line">      - update</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class="line">kind: Role</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-ingress-role</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx</span><br><span class="line">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line">rules:</span><br><span class="line">  - apiGroups:</span><br><span class="line">      - &quot;&quot;</span><br><span class="line">    resources:</span><br><span class="line">      - configmaps</span><br><span class="line">      - pods</span><br><span class="line">      - secrets</span><br><span class="line">      - namespaces</span><br><span class="line">    verbs:</span><br><span class="line">      - get</span><br><span class="line">  - apiGroups:</span><br><span class="line">      - &quot;&quot;</span><br><span class="line">    resources:</span><br><span class="line">      - configmaps</span><br><span class="line">    resourceNames:</span><br><span class="line">      # Defaults to &quot;&lt;election-id&gt;-&lt;ingress-class&gt;&quot;</span><br><span class="line">      # Here: &quot;&lt;ingress-controller-leader&gt;-&lt;nginx&gt;&quot;</span><br><span class="line">      # This has to be adapted if you change either parameter</span><br><span class="line">      # when launching the nginx-ingress-controller.</span><br><span class="line">      - &quot;ingress-controller-leader-nginx&quot;</span><br><span class="line">    verbs:</span><br><span class="line">      - get</span><br><span class="line">      - update</span><br><span class="line">  - apiGroups:</span><br><span class="line">      - &quot;&quot;</span><br><span class="line">    resources:</span><br><span class="line">      - configmaps</span><br><span class="line">    verbs:</span><br><span class="line">      - create</span><br><span class="line">  - apiGroups:</span><br><span class="line">      - &quot;&quot;</span><br><span class="line">    resources:</span><br><span class="line">      - endpoints</span><br><span class="line">    verbs:</span><br><span class="line">      - get</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class="line">kind: RoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-ingress-role-nisa-binding</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx</span><br><span class="line">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: Role</span><br><span class="line">  name: nginx-ingress-role</span><br><span class="line">subjects:</span><br><span class="line">  - kind: ServiceAccount</span><br><span class="line">    name: nginx-ingress-serviceaccount</span><br><span class="line">    namespace: ingress-nginx</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-ingress-clusterrole-nisa-binding</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx</span><br><span class="line">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: nginx-ingress-clusterrole</span><br><span class="line">subjects:</span><br><span class="line">  - kind: ServiceAccount</span><br><span class="line">    name: nginx-ingress-serviceaccount</span><br><span class="line">    namespace: ingress-nginx</span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-ingress-controller</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx</span><br><span class="line">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app.kubernetes.io/name: ingress-nginx</span><br><span class="line">      app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app.kubernetes.io/name: ingress-nginx</span><br><span class="line">        app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line">      annotations:</span><br><span class="line">        prometheus.io/port: &quot;10254&quot;</span><br><span class="line">        prometheus.io/scrape: &quot;true&quot;</span><br><span class="line">    spec:</span><br><span class="line">      # wait up to five minutes for the drain of connections</span><br><span class="line">      terminationGracePeriodSeconds: 300</span><br><span class="line">      serviceAccountName: nginx-ingress-serviceaccount</span><br><span class="line">      hostNetwork: true</span><br><span class="line">      nodeSelector:</span><br><span class="line">        ingressController: &quot;true&quot;</span><br><span class="line">      # tolerations: #增加容忍，可分配到master节点</span><br><span class="line">      # - key: &quot;node-role.kubernetes.io/master&quot;</span><br><span class="line">        # operator: &quot;Exists&quot;</span><br><span class="line">        # effect: &quot;NoSchedule&quot;</span><br><span class="line">      containers:</span><br><span class="line">        - name: nginx-ingress-controller</span><br><span class="line">          image: registry.cn-hangzhou.aliyuncs.com/google_containers/nginx-ingress-controller:0.24.1</span><br><span class="line">          args:</span><br><span class="line">            - /nginx-ingress-controller</span><br><span class="line">            - --configmap=$(POD_NAMESPACE)/nginx-configuration</span><br><span class="line">            - --tcp-services-configmap=$(POD_NAMESPACE)/tcp-services</span><br><span class="line">            - --udp-services-configmap=$(POD_NAMESPACE)/udp-services</span><br><span class="line">            - --publish-service=$(POD_NAMESPACE)/ingress-nginx</span><br><span class="line">            - --annotations-prefix=nginx.ingress.kubernetes.io</span><br><span class="line">            - --http-port=80 #默认80</span><br><span class="line">            - --https-port=433 #默认443</span><br><span class="line">          securityContext:</span><br><span class="line">            allowPrivilegeEscalation: true</span><br><span class="line">            capabilities:</span><br><span class="line">              drop:</span><br><span class="line">                - ALL</span><br><span class="line">              add:</span><br><span class="line">                - NET_BIND_SERVICE</span><br><span class="line">            # www-data -&gt; 33</span><br><span class="line">            runAsUser: 33</span><br><span class="line">          env:</span><br><span class="line">            - name: POD_NAME</span><br><span class="line">              valueFrom:</span><br><span class="line">                fieldRef:</span><br><span class="line">                  fieldPath: metadata.name</span><br><span class="line">            - name: POD_NAMESPACE</span><br><span class="line">              valueFrom:</span><br><span class="line">                fieldRef:</span><br><span class="line">                  fieldPath: metadata.namespace</span><br><span class="line">          ports:</span><br><span class="line">            - name: http</span><br><span class="line">              containerPort: 80</span><br><span class="line">            - name: https</span><br><span class="line">              containerPort: 433</span><br><span class="line">          livenessProbe:</span><br><span class="line">            failureThreshold: 3</span><br><span class="line">            httpGet:</span><br><span class="line">              path: /healthz</span><br><span class="line">              port: 10254</span><br><span class="line">              scheme: HTTP</span><br><span class="line">            initialDelaySeconds: 10</span><br><span class="line">            periodSeconds: 10</span><br><span class="line">            successThreshold: 1</span><br><span class="line">            timeoutSeconds: 10</span><br><span class="line">          readinessProbe:</span><br><span class="line">            failureThreshold: 3</span><br><span class="line">            httpGet:</span><br><span class="line">              path: /healthz</span><br><span class="line">              port: 10254</span><br><span class="line">              scheme: HTTP</span><br><span class="line">            periodSeconds: 10</span><br><span class="line">            successThreshold: 1</span><br><span class="line">            timeoutSeconds: 10</span><br><span class="line">          lifecycle:</span><br><span class="line">            preStop:</span><br><span class="line">              exec:</span><br><span class="line">                command:</span><br><span class="line">                  - /wait-shutdown</span><br></pre></td></tr></table></figure>

<ul>
<li>kubectl apply -f ingress-nginx-mandatory.yaml</li>
<li>kubectl get all -n ingress-nginx</li>
<li>wget <a href="https://raw.githubusercontent.com/kubernetes/ingress-nginx/nginx-0.27.0/deploy/static/provider/baremetal/service-nodeport.yaml" target="_blank" rel="noopener">https://raw.githubusercontent.com/kubernetes/ingress-nginx/nginx-0.27.0/deploy/static/provider/baremetal/service-nodeport.yaml</a></li>
<li>kubectl apply -f service-nodeport.yaml #暴露NodePort的80/443</li>
<li>kubectl label node m1 app=ingress #通过label限制HostPort</li>
<li>vi ingress-nginx-mandatory.yaml #暴露HostPort，deployment的spec.hostNetwork=true,spec.nodeSelector={app:ingress}</li>
<li>kubectl get all -n ingress-nginx</li>
<li>kubectl apply -f ingress-demo.yaml #测试<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"># ingress-demo.yaml</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-static</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      name: nginx-static</span><br><span class="line">  replicas: 1</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">       name: nginx-static</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">       - name: nginx-static</span><br><span class="line">         image: nginx:latest</span><br><span class="line">         volumeMounts:</span><br><span class="line">          - mountPath: /etc/localtime</span><br><span class="line">            name: vol-localtime</span><br><span class="line">            readOnly: true</span><br><span class="line">         ports:</span><br><span class="line">          - containerPort: 80</span><br><span class="line">            name: http</span><br><span class="line">      volumes:</span><br><span class="line">         - name: vol-localtime</span><br><span class="line">           hostPath:</span><br><span class="line">            path: /etc/localtime</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-static</span><br><span class="line">  labels:</span><br><span class="line">   name: nginx-static</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - port: 80</span><br><span class="line">    protocol: TCP</span><br><span class="line">    targetPort: 80</span><br><span class="line">    name: http</span><br><span class="line">  selector:</span><br><span class="line">    name: nginx-static</span><br><span class="line">---</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: submodule-checker-ingress</span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io/ingress.class: &quot;nginx&quot;</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: ingress.ceair.com</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path:</span><br><span class="line">        backend:</span><br><span class="line">          serviceName: nginx-static</span><br><span class="line">          servicePort: 80</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h4 id="业务迁移实施步骤"><a href="#业务迁移实施步骤" class="headerlink" title="业务迁移实施步骤"></a>业务迁移实施步骤</h4><ul>
<li>做基础镜像</li>
<li>通过Dockerfile做业务镜像</li>
<li>通过yaml文件做调度</li>
</ul>
<h3 id="重要资源对象"><a href="#重要资源对象" class="headerlink" title="重要资源对象"></a>重要资源对象</h3><h4 id="namespace"><a href="#namespace" class="headerlink" title="namespace"></a>namespace</h4><ul>
<li>集群的共享和隔离<ul>
<li>只是逻辑隔离</li>
<li>对serviceName可以通过/etc/resolve.conf隔离，对serviceIp/podIp无法隔离</li>
</ul>
</li>
<li>隔离<ul>
<li>资源对象的隔离<ul>
<li>service</li>
<li>deployment</li>
<li>pod</li>
</ul>
</li>
<li>资源配额的隔离<ul>
<li>cpu</li>
<li>memory</li>
</ul>
</li>
</ul>
</li>
<li>切换默认命名空间<ul>
<li>kubectl config set-context ctx-dev –cluster=kubernetes –user=admin –namespace=dev –kubeconfig=/root/.kube/config</li>
<li>kubectl config use-context ctx-dev –kubeconfig=/root/.kube/config</li>
<li>kubectl get all</li>
<li>想完全隔离命名空间下的资源需要创建不同的user并做不同的绑定</li>
</ul>
</li>
<li>划分方式<ul>
<li>按环境划分: dev/test</li>
<li>按项目划分: pr1/pr2</li>
<li>多维度划分: pr1-dev/pr2-test</li>
</ul>
</li>
</ul>
<h4 id="resources"><a href="#resources" class="headerlink" title="resources"></a>resources</h4><ul>
<li>内容<ul>
<li>cpu</li>
<li>memory</li>
<li>gpu</li>
<li>persistantStorage</li>
</ul>
</li>
<li>核心设计<ul>
<li>requests(最低要求)<ul>
<li>memory: 100Mi(Mi|Gi分别为M|G)</li>
<li>cpu: 100m(1核心=1000m)</li>
</ul>
</li>
<li>limits(最高限额)<ul>
<li>memery: 100Mi</li>
<li>cpu: 200m</li>
</ul>
</li>
</ul>
</li>
<li>当pod内有进程占用内存比较大超过limits限制，pod会尝试杀掉占用内存大的进程，因为内存是不可压缩资源，只能杀掉</li>
<li>当pod内有进程占用cpu比较多超过limits限制，docker最多可分配limits的cpu给容器，而不会杀掉pod，因为cpu是可压缩资源</li>
<li>服务等级<ul>
<li>如果requests与limits相等，此类型服务等级比较高</li>
<li>如果没有配置requests和limits，此类型服务等级低，遇到资源竞争时首先杀掉此类型的资源</li>
<li>如果limits大于request，则按需分配</li>
</ul>
</li>
<li>资源管控(保证系统的稳定性)<ul>
<li>k8s使用LimitRange管理pod/container的resource使用范围</li>
<li>k8s使用ResourceQuota管理namespaces/configmaps/services等资源的数量限制</li>
<li>k8s使用eviction进行资源不足时的pod驱逐<ul>
<li>策略<ul>
<li>–eviction-soft=memory.available&lt;1.5Gi</li>
<li>–eviction-soft-grace-period=memory.avaiilable=1m30s</li>
<li>–eviction-hard=memory.available&lt;100Mi,nodefs.available&lt;1Gi,nodefs.inodesFree&lt;5%</li>
</ul>
</li>
<li>磁盘紧缺时<ul>
<li>删除死掉的pod</li>
<li>删除没用的镜像</li>
<li>按优先级、资源占用情况驱逐pod</li>
</ul>
</li>
<li>内存紧缺时<ul>
<li>驱逐不可靠的pod</li>
<li>驱逐基本可靠的pod</li>
<li>驱逐可靠的pod</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="label"><a href="#label" class="headerlink" title="label"></a>label</h4><ul>
<li>本质就是key=value</li>
<li>使用方式<ul>
<li>选择器<ul>
<li>selector</li>
<li>nodeSelector</li>
</ul>
</li>
<li>匹配方式<ul>
<li>matchLabels</li>
<li>matchExpressions<ul>
<li>key</li>
<li>operator</li>
<li>value</li>
</ul>
</li>
</ul>
</li>
<li>命令行<ul>
<li>-l</li>
</ul>
</li>
</ul>
</li>
<li>不同的deployment的同label的pod是分开的，但service不会分开   </li>
</ul>
<h3 id="调度与编排"><a href="#调度与编排" class="headerlink" title="调度与编排"></a>调度与编排</h3><h4 id="健康检查"><a href="#健康检查" class="headerlink" title="健康检查"></a>健康检查</h4><ul>
<li>方式<ul>
<li>livnessProbe</li>
<li>readinessProbe</li>
</ul>
</li>
<li>配置<ul>
<li>exec|httpGet|tcpSocket</li>
<li>initialDelaySeconds</li>
<li>periodSeconds</li>
<li>failureThreshold</li>
<li>successThreshold</li>
<li>timeoutSeconds</li>
</ul>
</li>
</ul>
<h4 id="scheduler"><a href="#scheduler" class="headerlink" title="scheduler"></a>scheduler</h4><ul>
<li>调度策略<ul>
<li>预选策略<ul>
<li>predicate</li>
<li>硬性指标不符合的都排除，剩下的可调度</li>
</ul>
</li>
<li>优选策略<ul>
<li>priority</li>
<li>在可调度的节点上进行评分，选择最高分进行node和pod的绑定</li>
</ul>
</li>
</ul>
</li>
<li>亲和性<ul>
<li>affinity<ul>
<li>nodeAffinity<ul>
<li>requiredXXX 必须满足</li>
<li>preferredXXX 最好满足</li>
</ul>
</li>
<li>podAffinity<ul>
<li>requiredXXX</li>
<li>preferredXXX</li>
</ul>
</li>
<li>nodeAntiAffinity<ul>
<li>requiredXXX</li>
<li>preferredXXX</li>
</ul>
</li>
<li>podAntiAffinity<ul>
<li>requiredXXX</li>
<li>preferredXXX</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>污点<ul>
<li>node打上污点，除非pod显示声明容忍，否则不可匹配</li>
<li>tolerations 污点容忍<ul>
<li>key</li>
<li>operator</li>
<li>value</li>
<li>effect</li>
</ul>
</li>
<li>污点构成<ul>
<li>key</li>
<li>value</li>
<li>effect<ul>
<li>NoSchedule #后面的pod不会调度过来，不影响已有的</li>
<li>PreferNoSchedule</li>
<li>NoExecute #如有已经调度的则会根据容忍时间进行驱逐</li>
</ul>
</li>
</ul>
</li>
<li>kubectl taint node NAME key=value:effect</li>
</ul>
</li>
</ul>
<h4 id="部署策略"><a href="#部署策略" class="headerlink" title="部署策略"></a>部署策略</h4><ul>
<li>重建<ul>
<li>Deployment.spec.strategy.type=Recreate</li>
<li>服务先停止后重建，会影响线上服务</li>
<li>适用于快速删除一批pod并重建</li>
</ul>
</li>
<li>滚动更新 RollingUpdate<ul>
<li>Deployment.spec.strategy.type=RollingUpdate</li>
<li>Deployment.spec.strategy.rollingUpdate.maxSurge=25% #滚动更新时最多新创建数量，默认25%</li>
<li>Deployment.spec.startegy.rollingUpdate.maxUnavailable=25% #滚动更新时最多不可用数量，默认25%</li>
<li>kubectl rollout pause deploy NAME #暂停滚动更新</li>
<li>kubectl rollout resume deploy NAME #恢复滚动更新</li>
<li>kubectl rollout undo deploy NAME #回退滚动更新</li>
</ul>
</li>
<li>蓝绿部署<ul>
<li>网络入口ingress/service不变，部署不同的deployment实现蓝绿</li>
<li>通过切割service的selector完成切换</li>
</ul>
</li>
<li>金丝雀部署<ul>
<li>在蓝绿的基础上，service接入不同版本的deployment，实现流量按比例分配</li>
</ul>
</li>
</ul>
<h4 id="pod"><a href="#pod" class="headerlink" title="pod"></a>pod</h4><ul>
<li>设计思想<ul>
<li>容器是单进程模型，一个容器尽量只跑一个服务</li>
<li>pod是个逻辑概念，本质上还是容器的隔离</li>
<li>pod通过第一个pause容器解决了容器依赖的问题</li>
<li>pod是共享网络/存储/hosts文件的一组容器，是k8s最小的调度单位</li>
<li>hosts文件是通过pod.spec.hostAliases.ip和pod.spec.hostAliases.hostnames配置</li>
<li>pod可以通过配置pod.spec.hostNetwork和pod.spec.hostPID配置pod是否使用主机的相关信息</li>
<li>pod里的容器可以配置生命周期钩子函数<ul>
<li>pod.spec.containers[0].lifecycle.postStart.exec # 和entrypoint并行</li>
<li>pod.spec.containers[0].lifecycle.preStop.exec # 串行，执行完钩子后退出容器</li>
</ul>
</li>
</ul>
</li>
<li>生命周期<ul>
<li>Pendding</li>
<li>ContainerCreating</li>
<li>Running</li>
<li>Ready</li>
<li>Succeeded</li>
<li>Failed</li>
<li>CrashLoopBackOff</li>
<li>Unknown</li>
</ul>
</li>
<li>ProjectedVolume<ul>
<li>在pod运行时需要的文件可以通过apiServer把ProjectedVolume投射进来</li>
<li>常见使用<ul>
<li>Secret</li>
<li>ConfigMap</li>
<li>DownwardAPI</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="日志和监控"><a href="#日志和监控" class="headerlink" title="日志和监控"></a>日志和监控</h3><h4 id="日志方案"><a href="#日志方案" class="headerlink" title="日志方案"></a>日志方案</h4><ul>
<li>问题<ul>
<li>容器的stdout/stderr默认保存在/var/lib/docker/cantainers/NAME/NAME-json.log</li>
<li>pod重启后应用的日志文件会丢失</li>
</ul>
</li>
<li>常见方案<ul>
<li>远程日志，应用直接对接远程日志</li>
<li>sidecar，pod内专门的一个容器转发日志，性能较低</li>
<li>logAgent，通常是ds部署在主机上，转发所有pod的日志，需要日志文件挂载到主机</li>
</ul>
</li>
<li>实践 <ul>
<li>logPilot作为logAgent的一种智能采集工具</li>
<li>logPilot + elasticSearch + kibana</li>
</ul>
</li>
</ul>
<h4 id="监控入门"><a href="#监控入门" class="headerlink" title="监控入门"></a>监控入门</h4><h2 id="部署实战"><a href="#部署实战" class="headerlink" title="部署实战"></a>部署实战</h2><h2 id="监控落地"><a href="#监控落地" class="headerlink" title="监控落地"></a>监控落地</h2><h1 id="istio"><a href="#istio" class="headerlink" title="istio"></a>istio</h1><h2 id="架构原理"><a href="#架构原理" class="headerlink" title="架构原理"></a>架构原理</h2><h2 id="核心组件"><a href="#核心组件" class="headerlink" title="核心组件"></a>核心组件</h2><h2 id="智能路由"><a href="#智能路由" class="headerlink" title="智能路由"></a>智能路由</h2><h2 id="指标收集和查询"><a href="#指标收集和查询" class="headerlink" title="指标收集和查询"></a>指标收集和查询</h2><h2 id="分布式追踪"><a href="#分布式追踪" class="headerlink" title="分布式追踪"></a>分布式追踪</h2><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2>
            </div>
          

    
      <footer class="post-footer">
		

        
        
  <nav class="post-nav">
    
      <a class="prev" href="/flutter/">
        <i class="iconfont icon-left"></i>
        <span class="prev-text nav-default">flutter</span>
        <span class="prev-text nav-mobile">Prev</span>
      </a>
    
    
      <a class="next" href="/cli/">
        <span class="next-text nav-default">cli</span>
        <span class="prev-text nav-mobile">Next</span>
        <i class="iconfont icon-right"></i>
      </a>
    
  </nav>

        
  <div class="comments" id="comments">
    
  </div>


      </footer>
    
  </article>

    </div>

      </div>

      <footer id="colophon"><span class="copyright-year">
    
        &copy;
    
        2019 -
    
    2020
    <span class="footer-author">prief.</span>
    <span class="power-by">
        Powered by <a class="hexo-link" href="https://hexo.io/">Hexo</a> and <a class="theme-link" href="https://github.com/frostfan/hexo-theme-polarbear">Polar Bear</a>
    </span>
</span>

      </footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div>
    


    




  
    <script type="text/javascript" src="/lib/jquery/jquery-3.1.1.min.js"></script>
  

  

    <script type="text/javascript" src="/js/src/theme.js?v=1.1"></script>
<script type="text/javascript" src="/js/src/bootstrap.js?v=1.1"></script>

  </body>
</html>
